<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Klass Messenger üòà</title>
  <style>
    :root{--accent:#2563eb}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f4f6f8;color:#111}
    header{background:#0f172a;color:#fff;padding:12px 16px}
    .container{max-width:1100px;margin:18px auto;padding:12px}
    .grid{display:grid;grid-template-columns:260px 260px 1fr;gap:12px}
    .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(10,10,10,.06)}
    .list{height:520px;overflow:auto}
    .chat-window{display:flex;flex-direction:column;height:520px}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px}
    .msg-row{display:flex;gap:8px;align-items:flex-end}
    .msg-row.me{justify-content:flex-end}
    .bubble{max-width:72%;padding:8px;border-radius:10px}
    .me .bubble{background:#DCFCE7}
    .them .bubble{background:#EEF2FF}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover}
    .controls{display:flex;gap:8px;padding-top:8px;align-items:center}
    input,button,textarea,select{padding:8px;border-radius:8px;border:1px solid #d0d6db}
    button{background:var(--accent);color:#fff;border:none}
    .small{font-size:12px;color:#666}
    .file-thumb{max-width:220px;display:block;margin-top:6px;border-radius:6px}
    .meta{font-size:12px;color:#666;margin-top:4px}
    .top-notice{position:fixed;left:50%;transform:translateX(-50%);top:12px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:999}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    @media(max-width:980px){ .grid{grid-template-columns:1fr} .list{height:160px} .chat-window{height:420px} }
  </style>
</head>
<body>
  <header>
    <strong>Klass Messenger üòà</strong>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card" id="authCard">
        <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
        <div id="auth-panel">
          <input id="email" placeholder="Email" autocomplete="username" />
          <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="current-password" />
          <input id="displayName" placeholder="–ò–º—è (–ø—É–±–ª–∏—á–Ω–æ–µ)" />
          <label style="display:flex;gap:8px;align-items:center"><input id="avatarInput" type="file" accept="image/*" /> <span class="small">–ê–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
          <div class="actions">
            <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <button id="btnLogin">–í–æ–π—Ç–∏</button>
            <button id="btnGuest">–ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥</button>
            <button id="btnReset">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
            <button id="btnGoogle" style="background:#DB4437">–í–æ–π—Ç–∏ —Å Google</button>
          </div>
          <p class="small">–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–∫–ª—é—á–∏—Ç–µ Authentication + Realtime Database –≤ Firebase Console. Google Sign-In –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á—ë–Ω (Authentication ‚Üí Sign-in method ‚Üí Google), –∏ –≤ Authorized domains –¥–æ–±–∞–≤–ª–µ–Ω –¥–æ–º –≤–∞—à–µ–≥–æ GitHub Pages (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>yourname.github.io</code>).</p>
        </div>
        <div id="user-panel" style="display:none">
          <div style="display:flex;gap:8px;align-items:center">
            <img id="meAvatar" class="avatar" src="" style="display:none" />
            <div>
              <strong id="meName"></strong>
              <div class="small" id="meEmail"></div>
            </div>
          </div>
          <div style="margin-top:8px" class="actions">
            <button id="btnLogout">–í—ã–π—Ç–∏</button>
            <button id="btnCreateGroup">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
            <button id="btnMyGroups">–ú–æ–∏ –≥—Ä—É–ø–ø—ã</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/email" style="flex:1" />
          <button id="btnSearch">–ü–æ–∏—Å–∫</button>
        </div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card chat-window">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong id="chatTitle">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</strong>
            <div class="small" id="chatSub"></div>
          </div>
          <div class="actions">
            <select id="modeSelect"><option value="pm">1-–Ω–∞-1</option><option value="group">–ì—Ä—É–ø–ø–∞</option></select>
            <select id="groupsSelect" style="display:none"></select>
            <button id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="controls">
          <button id="callBtn" class="call-btn" style="background:#10b981">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
          <button id="endCallBtn" class="call-btn" style="background:#ef4444;display:none">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>

          <input id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1" />
          <input id="fileInput" type="file" />
          <button id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <p class="small" style="margin-top:12px">–ì—Ä—É–ø–ø—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Realtime Database. –§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∏–¥–µ base64 –≤ –±–∞–∑–µ (–¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è).</p>
  </div>

  <div id="notice" class="top-notice"></div>

  <script type="module">
    // ============ –¢–í–û–Ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ==============
    const firebaseConfig = {
      apiKey: "AIzaSyDTwQJ4z3vuj_3BFSfUCryooN3IYH-MKsE",
      authDomain: "best-messenger-9db3f.firebaseapp.com",
      databaseURL: "https://best-messenger-9db3f-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "best-messenger-9db3f",
      storageBucket: "best-messenger-9db3f.firebasestorage.app",
      messagingSenderId: "626528479187",
      appId: "1:626528479187:web:7e7b094416ce8d98e57126"
    };
    // ======================================================

    const useFirebase = !!(firebaseConfig && firebaseConfig.apiKey);
    const LOCAL_KEY = 'klass_messenger_v3_local';

    // UI refs
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const displayNameEl = document.getElementById('displayName');
    const avatarInput = document.getElementById('avatarInput');
    const btnRegister = document.getElementById('btnRegister');
    const btnLogin = document.getElementById('btnLogin');
    const btnGuest = document.getElementById('btnGuest');
    const btnReset = document.getElementById('btnReset');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnLogout = document.getElementById('btnLogout');
    const authPanel = document.getElementById('auth-panel');
    const userPanel = document.getElementById('user-panel');
    const meName = document.getElementById('meName');
    const meEmail = document.getElementById('meEmail');
    const meAvatar = document.getElementById('meAvatar');

    const searchInput = document.getElementById('searchInput');
    const btnSearch = document.getElementById('btnSearch');
    const usersList = document.getElementById('usersList');

    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const fileInput = document.getElementById('fileInput');
    const btnSend = document.getElementById('btnSend');

    const chatTitle = document.getElementById('chatTitle');
    const chatSub = document.getElementById('chatSub');
    const modeSelect = document.getElementById('modeSelect');
    const groupsSelect = document.getElementById('groupsSelect');
    const btnCreateGroup = document.getElementById('btnCreateGroup');
    const btnMyGroups = document.getElementById('btnMyGroups');
    const btnRefresh = document.getElementById('btnRefresh');

    const notice = document.getElementById('notice');
    function showNotice(text, time=3000){ notice.textContent = text; notice.style.display='block'; setTimeout(()=>notice.style.display='none', time); }

    // helpers local
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)) || {users:{},groups:{},chats:{}} }catch(e){return {users:{},groups:{},chats:{}} } }
    function saveLocal(d){ localStorage.setItem(LOCAL_KEY, JSON.stringify(d)); }
    function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>\\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
    function timeStr(ts){ const d=new Date(ts); return d.toLocaleString(); }

    let currentUser = null; let activeChatUid = null; let activeGroupId = null;

    // firebase vars
    let app, auth, db;

    async function init(){
      if(useFirebase){
        try{
          const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
          const authMod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js');
          app = initializeApp(firebaseConfig);
          auth = authMod.getAuth(app);
          db = dbMod.getDatabase(app);
          setupFirebase(authMod, dbMod);
          console.log('Firebase ready');
        }catch(e){ console.error('Firebase init failed', e); showNotice('Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º'); startLocal(); }
      }else{ startLocal(); }
    }

    // ---------------- Firebase implementation ----------------
    function setupFirebase(authMod, dbMod){
      const { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } = authMod;
      const { ref, set, push, onValue, get } = dbMod;

      btnRegister.onclick = async ()=>{
        const email = emailEl.value.trim(); const pass = passEl.value; const displayName = displayNameEl.value.trim()||email.split('@')[0];
        if(!email||!pass){ showNotice('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
        let avatarData = null; if(avatarInput.files && avatarInput.files[0]) avatarData = await fileToDataURL(avatarInput.files[0]);
        try{
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          try{ await updateProfile(cred.user, { displayName }); }catch(e){}
          await set(ref(db,'users/'+cred.user.uid), { uid:cred.user.uid, email, displayName, avatar:avatarData||null });
          showNotice('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤–æ—à–ª–∏');
        }catch(err){ console.error(err); if(err.code==='auth/email-already-in-use'){ try{ await signInWithEmailAndPassword(auth,email,pass); showNotice('Email —É–∂–µ –µ—Å—Ç—å ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥'); }catch(e){ showNotice('Email –∑–∞–Ω—è—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ö–æ–¥'); } } else showNotice(err.message||'–û—à–∏–±–∫–∞'); }
      };

      btnLogin.onclick = async ()=>{
        const email = emailEl.value.trim(); const pass = passEl.value;
        if(!email||!pass){ showNotice('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
        try{ await signInWithEmailAndPassword(auth, email, pass); showNotice('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); }catch(err){ console.error(err); showNotice(err.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); }
      };

      btnReset.onclick = async ()=>{
        const email = prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:'); if(!email) return; try{ await sendPasswordResetEmail(auth,email); alert('–ü–∏—Å—å–º–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }catch(e){ alert('–û—à–∏–±–∫–∞: '+(e.message||e)); }
      };

      btnGoogle.onclick = async ()=>{
        try{
          const provider = new GoogleAuthProvider();
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          // create or update user record in DB
          const snap = await get(ref(db,'users/'+user.uid));
          const existing = snap.val();
          const avatar = (user.photoURL)?user.photoURL:null;
          const displayName = user.displayName || user.email.split('@')[0];
          await set(ref(db,'users/'+user.uid), { uid:user.uid, email:user.email, displayName, avatar });
          showNotice('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google –≤—ã–ø–æ–ª–Ω–µ–Ω');
        }catch(e){ console.error(e); showNotice('–û—à–∏–±–∫–∞ Google-–≤—Ö–æ–¥–∞'); }
      };

      btnGuest.onclick = ()=>{ const g = { uid:uid(), email:'guest@local', displayName:'–ì–æ—Å—Ç—å_'+Math.random().toString(36).slice(2,6), avatar:null, guest:true }; currentUser=g; onLoginLocalLike(); showNotice('–í–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

      btnLogout.onclick = async ()=>{ try{ await signOut(auth); }catch(e){ console.log(e); currentUser=null; authPanel.style.display=''; userPanel.style.display='none'; usersList.innerHTML=''; messagesEl.innerHTML=''; } };

      onAuthStateChanged(auth, async user=>{
        if(user){ const snap = await get(ref(db,'users/'+user.uid)); const data = snap.val() || { uid:user.uid, email:user.email, displayName:user.displayName||user.email, avatar:user.photoURL||null }; currentUser = data; onLoginFirebase(); }
        else { currentUser=null; activeChatUid=null; activeGroupId=null; authPanel.style.display=''; userPanel.style.display='none'; usersList.innerHTML=''; messagesEl.innerHTML=''; }
      });

      async function onLoginFirebase(){ authPanel.style.display='none'; userPanel.style.display='block'; meName.textContent=currentUser.displayName; meEmail.textContent=currentUser.email; if(currentUser.avatar){ meAvatar.src=currentUser.avatar; meAvatar.style.display='inline-block'; } else meAvatar.style.display='none'; await set(ref(db,'users/'+currentUser.uid), currentUser); loadUsersFirebase(); loadMyGroups(); }

      async function loadUsersFirebase(){ const snap = await get(ref(db,'users')); const data = snap.val()||{}; renderUsers(Object.values(data)); }

      btnSearch.onclick = async ()=>{ const q=(searchInput.value||'').trim().toLowerCase(); if(!q){ loadUsersFirebase(); return; } const snap = await get(ref(db,'users')); const arr = Object.values(snap.val()||{}).filter(u=> (u.displayName||u.email||'').toLowerCase().includes(q)); renderUsers(arr); };

      function renderUsers(arr){ usersList.innerHTML=''; arr.sort((a,b)=>(a.displayName||'').localeCompare(b.displayName||'')); arr.forEach(u=>{ if(!u||u.uid===currentUser.uid) return; const el=document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.innerHTML = `${u.avatar?'<img src="'+u.avatar+'" class="avatar"/>':''}<div style="flex:1"><strong>${escapeHtml(u.displayName||u.email)}</strong><div class="small">${escapeHtml(u.email||'')}</div></div>`; el.onclick = ()=>{ modeSelect.value='pm'; groupsSelect.style.display='none'; openChatFirebase(u.uid,u.displayName||u.email); }; usersList.appendChild(el); }); }

      function makeChatId(a,b){ return [a,b].sort().join('_'); }

      function openChatFirebase(uid,name){ activeGroupId=null; activeChatUid=uid; chatTitle.textContent = name; chatSub.textContent = '–õ–∏—á–Ω—ã–π —á–∞—Ç'; messagesEl.innerHTML=''; const chatId = makeChatId(currentUser.uid,uid); const msgsRef = ref(db,'chats/'+chatId+'/messages'); onValue(msgsRef, snap=>{ const v = snap.val()||{}; const arr = Object.values(v); messagesEl.innerHTML=''; arr.forEach(m=>renderMsg(m)); messagesEl.scrollTop = messagesEl.scrollHeight; }); }

      // groups
      btnCreateGroup.onclick = async ()=>{ const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:'); if(!name) return; const desc = prompt('–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):')||''; const groupId = uid(); const members = [currentUser.email]; await set(ref(db,'groups/'+groupId), { id:groupId, name, desc, owner:currentUser.uid, members }); showNotice('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞'); loadMyGroups(); }

      async function loadMyGroups(){ const snap = await get(ref(db,'groups')); const data = snap.val()||{}; const groups = Object.values(data).filter(g=> (g.members||[]).includes(currentUser.email)); groupsSelect.innerHTML=''; groupsSelect.style.display='inline-block'; groups.forEach(g=>{ const opt = document.createElement('option'); opt.value=g.id; opt.textContent = g.name; groupsSelect.appendChild(opt); }); if(groups.length===0){ groupsSelect.style.display='none'; }
      }

      btnMyGroups.onclick = ()=>{ loadMyGroups(); showNotice('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –≤–∞—à–∏ –≥—Ä—É–ø–ø—ã'); }

      groupsSelect.onchange = ()=>{ const id = groupsSelect.value; if(!id) return; openGroup(id); }

      async function openGroup(id){ activeChatUid=null; activeGroupId=id; const snap = await get(ref(db,'groups/'+id)); const g = snap.val(); chatTitle.textContent = g.name; chatSub.textContent = g.desc||('–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: '+(g.members||[]).length); messagesEl.innerHTML=''; const msgsRef = ref(db,'groups/'+id+'/messages'); onValue(msgsRef, snap=>{ const v = snap.val()||{}; const arr = Object.values(v); messagesEl.innerHTML=''; arr.forEach(m=>renderMsg(m)); messagesEl.scrollTop = messagesEl.scrollHeight; }); }

      btnSend.onclick = async ()=>{ const text = msgInput.value.trim(); if(!text && !fileInput.files.length) return; if(!activeChatUid && !activeGroupId){ showNotice('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—É'); return; } const payload = { from: currentUser.uid, author: currentUser.displayName, email: currentUser.email, ts: Date.now(), text: text||'' };
        if(fileInput.files.length){ const data = await fileToDataURL(fileInput.files[0]); payload.file = { name:fileInput.files[0].name, type:fileInput.files[0].type, data }; }
        if(activeChatUid){ const chatId = makeChatId(currentUser.uid, activeChatUid); await push(ref(db,'chats/'+chatId+'/messages'), payload); }
        else if(activeGroupId){ await push(ref(db,'groups/'+activeGroupId+'/messages'), payload); }
        msgInput.value=''; fileInput.value=''; };

      function renderMsg(m){ const row = document.createElement('div'); const mine = m.from===currentUser.uid; row.className = 'msg-row '+(mine?'me':''); const avatarImg = document.createElement('img'); avatarImg.className='avatar'; avatarImg.style.display='none'; const bubble = document.createElement('div'); bubble.className='bubble'; if(m.file){ if(m.file.type && m.file.type.startsWith('image/')){ const img=document.createElement('img'); img.src = m.file.data; img.className='file-thumb'; bubble.appendChild(img); } else { const a=document.createElement('a'); a.href=m.file.data; a.download=m.file.name; a.textContent = '–°–∫–∞—á–∞—Ç—å: '+m.file.name; a.className='small'; bubble.appendChild(a); } }
        if(m.text) bubble.insertBefore(document.createTextNode(m.text), bubble.firstChild);
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (m.author?m.author+' ‚Ä¢ ':'') + timeStr(m.ts);
        bubble.appendChild(meta);
        row.appendChild(avatarImg);
        row.appendChild(bubble);
        messagesEl.appendChild(row);
        // try to load author's avatar
        if(m.from){ get(ref(db,'users/'+m.from)).then(snap=>{ const u=snap.val(); if(u && u.avatar){ avatarImg.src = u.avatar; avatarImg.style.display='block'; } else avatarImg.style.display='none'; }); }
      }

      btnRefresh.onclick = ()=>{ if(activeGroupId) openGroup(activeGroupId); else if(activeChatUid) openChatFirebase(activeChatUid, chatTitle.textContent); else loadUsersFirebase(); };

    }

    // ---------------- Local fallback (guest/demo) ----------------
    function startLocal(){
      const data = loadLocal();
      btnRegister.onclick = async ()=>{ const email = emailEl.value.trim(); const pass = passEl.value; const displayName=displayNameEl.value.trim()||email.split('@')[0]; if(!email||!pass){ showNotice('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; } if(Object.values(data.users).some(u=>u.email===email)){ showNotice('Email –∑–∞–Ω—è—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)'); return; } const id=uid(); let avatar=null; if(avatarInput.files && avatarInput.files[0]) avatar = await fileToDataURL(avatarInput.files[0]); const user={uid:id,email,displayName,avatar}; data.users[id]=user; saveLocal(data); currentUser=user; onLoginLocal(); showNotice('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ'); };
      btnLogin.onclick = ()=>{ const email=emailEl.value.trim(); const u=Object.values(data.users).find(x=>x.email===email); if(!u){ showNotice('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)'); return; } currentUser=u; onLoginLocal(); showNotice('–í—Ö–æ–¥ –ª–æ–∫–∞–ª—å–Ω–æ'); };
      btnGuest.onclick = ()=>{ const id=uid(); const user={uid:id,email:'guest@local',displayName:'–ì–æ—Å—Ç—å_'+id.slice(-4),avatar:null}; currentUser=user; onLoginLocal(); showNotice('–í–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å'); };
      btnReset.onclick = ()=>{ const email=prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ):'); if(email) alert('–õ–æ–∫–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–∏–º—É–ª—è—Ü–∏—è) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); };
      btnGoogle.onclick = ()=>{ alert('Google Sign-In –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ'); };
      btnLogout.onclick = ()=>{ currentUser=null; activeChatUid=null; activeGroupId=null; authPanel.style.display=''; userPanel.style.display='none'; usersList.innerHTML=''; messagesEl.innerHTML=''; };

      function onLoginLocal(){ authPanel.style.display='none'; userPanel.style.display='block'; meName.textContent=currentUser.displayName; meEmail.textContent=currentUser.email; if(currentUser.avatar){ meAvatar.src=currentUser.avatar; meAvatar.style.display='inline-block'; } else meAvatar.style.display='none'; renderUsersLocal(); renderGroupsLocal(); }

      function renderUsersLocal(filterArr){ usersList.innerHTML=''; const arr = filterArr || Object.values(data.users).sort((a,b)=>(a.displayName||'').localeCompare(b.displayName||'')); arr.forEach(u=>{ if(u.uid===currentUser.uid) return; const el=document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.innerHTML = `${u.avatar?'<img src="'+u.avatar+'" class="avatar"/>':''}<div style="flex:1"><strong>${escapeHtml(u.displayName)}</strong><div class="small">${escapeHtml(u.email)}</div></div>`; el.onclick=()=>{ modeSelect.value='pm'; groupsSelect.style.display='none'; openChatLocal(u.uid,u.displayName); }; usersList.appendChild(el); }); }

      function renderGroupsLocal(){ const gs = Object.values(data.groups||{}).filter(g=> (g.members||[]).includes(currentUser.email)); groupsSelect.innerHTML=''; gs.forEach(g=>{ const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; groupsSelect.appendChild(opt); }); if(gs.length) groupsSelect.style.display='inline-block'; }

      btnSearch.onclick = ()=>{ const q=(searchInput.value||'').trim().toLowerCase(); if(!q){ renderUsersLocal(); return; } const arr = Object.values(data.users).filter(u=> (u.displayName||u.email||'').toLowerCase().includes(q)); renderUsersLocal(arr); };

      btnCreateGroup.onclick = ()=>{ const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã'); if(!name) return; const id=uid(); const desc=prompt('–û–ø–∏—Å–∞–Ω–∏–µ')||''; data.groups[id]={ id, name, desc, owner:currentUser.uid, members:[currentUser.email] }; saveLocal(data); renderGroupsLocal(); showNotice('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

      btnMyGroups.onclick = ()=>{ renderGroupsLocal(); showNotice('–í–∞—à–∏ –≥—Ä—É–ø–ø—ã (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

      function makeChatId(a,b){ return [a,b].sort().join('_'); }
      function openChatLocal(uid,name){ activeGroupId=null; activeChatUid=uid; messagesEl.innerHTML=''; const chatId=makeChatId(currentUser.uid,uid); const msgs = data.chats[chatId]||[]; msgs.forEach(m=>renderMsgLocal(m)); chatTitle.textContent=name; chatSub.textContent='–õ–∏—á–Ω—ã–π —á–∞—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)'; }

      function openGroupLocal(id){ activeChatUid=null; activeGroupId=id; messagesEl.innerHTML=''; const g = data.groups[id]; const msgs = g.messages||[]; msgs.forEach(m=>renderMsgLocal(m)); chatTitle.textContent=g.name; chatSub.textContent=g.desc||('–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: '+(g.members||[]).length); }

      btnSend.onclick = async ()=>{ const text = msgInput.value.trim(); if(!text && !fileInput.files.length) return; if(!activeChatUid && !activeGroupId){ showNotice('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—É'); return; } const m = { id:Date.now()+Math.random(), from:currentUser.uid, author:currentUser.displayName, email:currentUser.email, ts:Date.now(), text:text||'' };
        if(fileInput.files.length){ const d = await fileToDataURL(fileInput.files[0]); m.file={ name:fileInput.files[0].name, type:fileInput.files[0].type, data:d }; }
        if(activeChatUid){ const chatId=makeChatId(currentUser.uid,activeChatUid); data.chats[chatId]=data.chats[chatId]||[]; data.chats[chatId].push(m); saveLocal(data); renderMsgLocal(m); }
        else { const g = data.groups[activeGroupId]; g.messages = g.messages||[]; g.messages.push(m); saveLocal(data); renderMsgLocal(m); }
        msgInput.value=''; fileInput.value=''; };

      function renderMsgLocal(m){ const row=document.createElement('div'); row.className=(m.from===currentUser.uid?'msg-row me':'msg-row'); const avatarImg=document.createElement('img'); avatarImg.className='avatar'; avatarImg.style.display='none'; const bubble=document.createElement('div'); bubble.className='bubble'; if(m.file){ if(m.file.type && m.file.type.startsWith('image/')){ const img=document.createElement('img'); img.src=m.file.data; img.className='file-thumb'; bubble.appendChild(img); } else { const a=document.createElement('a'); a.href=m.file.data; a.download=m.file.name; a.textContent='–°–∫–∞—á–∞—Ç—å: '+m.file.name; a.className='small'; bubble.appendChild(a); } }
        if(m.text) bubble.insertBefore(document.createTextNode(m.text), bubble.firstChild);
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(m.author?m.author+' ‚Ä¢ ':'')+timeStr(m.ts); bubble.appendChild(meta);
        row.appendChild(avatarImg); row.appendChild(bubble); messagesEl.appendChild(row); const u = Object.values(loadLocal().users||{}).find(x=>x.uid===m.from); if(u && u.avatar){ avatarImg.src=u.avatar; avatarImg.style.display='block'; } }

      renderUsersLocal(); renderGroupsLocal();
    }

    // helper: convert file to data URL
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const reader=new FileReader(); reader.onload=()=>res(reader.result); reader.onerror=rej; reader.readAsDataURL(file); }); }

    // start
    init();
  </script>

  <audio id="remoteAudio" autoplay></audio>

<script>
// --- Audio-only WebRTC (uses Firebase Realtime Database for signaling) ---
(async function(){
  if(!window.firebase){ console.warn('Firebase not initialized yet'); return; }
  const db = firebase.database();
  const auth = firebase.auth();
  const callBtn = document.getElementById('callBtn');
  const endCallBtn = document.getElementById('endCallBtn');
  const remoteAudio = document.getElementById('remoteAudio');

  let pc = null;
  let localStream = null;
  let callRef = null;

  const servers = { iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] };

  function cleanupCall(){
    if(pc){ try{ pc.close(); }catch(e){} pc = null; }
    if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream = null; }
    if(callRef){ try{ callRef.remove(); }catch(e){} callRef = null; }
    endCallBtn.style.display = 'none';
    callBtn.style.display = 'inline-block';
  }

  async function startCall(targetUid){
    if(!auth.currentUser){ alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å–æ–≤–µ—Ä—à–∞—Ç—å –∑–≤–æ–Ω–∫–∏'); return; }
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }catch(e){ alert('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω'); return; }

    pc = new RTCPeerConnection(servers);
    pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };
    pc.onicecandidate = event => {
      if(event.candidate && callRef){
        callRef.child('offerCandidates').push(event.candidate.toJSON());
      }
    };
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    // create offer
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // create call entry
    callRef = db.ref('webrtc_calls').push();
    await callRef.set({ from: auth.currentUser.uid, to: targetUid, status: 'offer', offer: { type: offer.type, sdp: offer.sdp } });

    // listen for answer
    callRef.child('answer').on('value', snap=>{
      const a = snap.val();
      if(a && pc && !pc.currentRemoteDescription){
        pc.setRemoteDescription(new RTCSessionDescription(a));
      }
    });

    // listen for answer candidates
    callRef.child('answerCandidates').on('child_added', snap=>{
      const c = snap.val();
      try{ pc.addIceCandidate(new RTCIceCandidate(c)); }catch(e){}
    });

    // listen for callee status change (rejected)
    callRef.child('status').on('value', snap=>{
      const s = snap.val();
      if(s === 'rejected'){ alert('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω—ë–Ω'); cleanupCall(); }
    });

    endCallBtn.style.display = 'inline-block';
    callBtn.style.display = 'none';
    showNotice('–í—ã–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  }

  async function answerCall(callId, callData){
    if(!auth.currentUser){ return; }
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }catch(e){ alert('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –Ω–µ —Ä–∞–∑—Ä–µ—à—ë–Ω'); return; }

    callRef = db.ref('webrtc_calls/' + callId);
    pc = new RTCPeerConnection(servers);
    pc.ontrack = e => { remoteAudio.srcObject = e.streams[0]; };
    pc.onicecandidate = event => {
      if(event.candidate && callRef){ callRef.child('answerCandidates').push(event.candidate.toJSON()); }
    };
    localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

    // set remote offer
    await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await callRef.child('answer').set({ type: answer.type, sdp: answer.sdp });

    // listen for offer candidates
    callRef.child('offerCandidates').on('child_added', snap=>{
      const c = snap.val();
      try{ pc.addIceCandidate(new RTCIceCandidate(c)); }catch(e){} 
    });

    endCallBtn.style.display = 'inline-block';
    callBtn.style.display = 'none';
    showNotice('–ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç');
  }

  // Watch for incoming calls for current user
  auth.onAuthStateChanged(user=>{
    if(!user) return;
    const uid = user.uid;
    const callsRef = db.ref('webrtc_calls');
    callsRef.on('child_added', snap=>{
      const id = snap.key;
      const data = snap.val();
      if(data && data.to === uid && data.status === 'offer' && !data.handled){
        // show incoming notification
        incoming.style.display = 'block';
        incomingText.textContent = '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫ –æ—Ç ' + (data.fromDisplay || data.from);
        // accept/reject handlers are set elsewhere; attach here temporarily
        window._currentIncoming = { id, data };
      }
    });
  });

  // accept/reject buttons wired to global incoming object
  window.acceptCallHandler = async function(){ 
    const inc = window._currentIncoming; if(!inc) return;
    incoming.style.display = 'none';
    await db.ref('webrtc_calls/'+inc.id+'/handled').set(true);
    await answerCall(inc.id, inc.data);
  };
  window.rejectCallHandler = async function(){ const inc = window._currentIncoming; if(!inc) return; incoming.style.display = 'none'; await db.ref('webrtc_calls/'+inc.id+'/status').set('rejected'); };

  // attach to UI buttons if present
  if(document.getElementById('acceptCall')) document.getElementById('acceptCall').onclick = window.acceptCallHandler;
  if(document.getElementById('rejectCall')) document.getElementById('rejectCall').onclick = window.rejectCallHandler;

  // wire top-level call buttons
  if(callBtn) callBtn.onclick = async ()=>{
    const target = prompt('–í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∑–≤–æ–Ω–∫–∞:');
    if(!target) return;
    // resolve to uid if possible
    try{
      const usersSnap = await db.ref('users').once('value');
      const users = usersSnap.val() || {};
      let found = null;
      Object.values(users).forEach(u=>{ if(u.email===target || u.uid===target) found = u; });
      if(found) await startCall(found.uid);
      else { if(confirm('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–æ–∑–≤–æ–Ω–∏—Ç—å –ø–æ –≤–≤–µ–¥—ë–Ω–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é?')) await startCall(target); }
    }catch(e){ console.error(e); showNotice('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'); }
  };
  if(endCallBtn) endCallBtn.onclick = cleanupCall;

})();
</script>

</body>
</html>
