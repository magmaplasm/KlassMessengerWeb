<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Clicker Game - Админ Панель</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fdbb2d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .admin-btn {
            background: rgba(220, 53, 69, 0.7);
        }
        
        .admin-btn:hover {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
            .chat-section, .friends-section, .cases-section, .trade-section {
                grid-column: 1 / -1;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .game-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .admin-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .friends-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .cases-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .trade-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-controls {
                grid-template-columns: 1fr;
            }
        }
        
        .admin-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-panel h3 {
            margin-bottom: 15px;
            color: #fdbb2d;
        }
        
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .click-area {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #fdbb2d, #b21f1f);
            border-radius: 50%;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.1s ease;
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .click-area:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .click-area.blocked {
            background: linear-gradient(135deg, #666, #333);
            cursor: not-allowed;
        }
        
        .click-area.blocked:active {
            transform: scale(1);
        }
        
        .blocked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            text-align: center;
            padding: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .trend-indicator {
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .trend-up {
            color: #4CAF50;
        }
        
        .trend-down {
            color: #F44336;
        }
        
        .trend-neutral {
            color: #FFC107;
        }
        
        .cps-warning {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 10px;
            min-height: 24px;
        }
        
        .leaderboard-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .leaderboard {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .leaderboard-item.current-user {
            background: rgba(253, 187, 45, 0.3);
            border-left: 5px solid #fdbb2d;
        }
        
        .rank {
            font-weight: bold;
            width: 30px;
        }
        
        .player-name {
            flex: 1;
            margin: 0 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player-score {
            font-weight: bold;
        }
        
        .auth-modal, .nickname-modal, .admin-modal, .event-modal, .clicks-modal, .friends-modal, .case-result-modal, .admin-code-modal, .trade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .auth-form, .nickname-form, .admin-form, .event-form, .clicks-form, .friends-form, .case-result-content, .admin-code-form, .trade-form {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .trade-form {
            max-width: 600px;
        }
        
        .case-result-content {
            text-align: center;
            max-width: 400px;
            animation: caseOpen 0.5s ease;
        }
        
        @keyframes caseOpen {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .auth-form h2, .nickname-form h2, .admin-form h2, .event-form h2, .clicks-form h2, .friends-form h2, .case-result-content h2, .admin-code-form h2, .trade-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .auth-form input, .nickname-form input, .admin-form input, .event-form input, .event-form select, .clicks-form input, .friends-form input, .admin-code-form input, .trade-form input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .auth-buttons, .nickname-buttons, .admin-buttons, .event-buttons, .clicks-buttons, .friends-buttons, .case-result-buttons, .admin-code-buttons, .trade-buttons {
            display: flex;
            gap: 10px;
        }
        
        .auth-buttons button, .nickname-buttons button, .admin-buttons button, .event-buttons button, .clicks-buttons button, .friends-buttons button, .case-result-buttons button, .admin-code-buttons button, .trade-buttons button {
            flex: 1;
        }
        
        .close-modal {
            background: rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .game-info {
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .change-nickname {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #fdbb2d;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .leaderboard-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .leaderboard-controls button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .leaderboard-controls button.active {
            background: rgba(253, 187, 45, 0.5);
        }
        
        .cps-meter {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 10px;
            overflow-y: hidden;
        }
        
        .cps-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
        
        .event-notification {
            background: rgba(76, 175, 80, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .admin-quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-with-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .action-with-input input {
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Чат стили */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 400px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            word-wrap: break-word;
        }
        
        .chat-message.admin-action {
            background: rgba(220, 53, 69, 0.3);
            border-left: 3px solid #dc3545;
        }
        
        .chat-message.system {
            background: rgba(255, 193, 7, 0.3);
            border-left: 3px solid #FFC107;
            font-style: italic;
        }
        
        .message-sender {
            font-weight: bold;
            margin-right: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-text {
            margin-top: 3px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .send-button {
            padding: 12px 20px;
            white-space: nowrap;
        }
        
        /* Галочки */
        .verified-badge {
            color: #1DA1F2;
            font-size: 0.9rem;
        }
        
        .admin-badge-chat {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.6rem;
            margin-left: 5px;
        }
        
        .user-with-badge {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Система друзей */
        .friends-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 300px;
        }
        
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .friend-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .friend-actions {
            display: flex;
            gap: 5px;
        }
        
        .friend-actions button {
            padding: 5px 10px;
            font-size: 0.7rem;
        }
        
        .friends-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .friends-controls button {
            flex: 1;
        }
        
        .trend-chart {
            height: 100px;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            position: relative;
        }
        
        .trend-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80%;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }
        
        .trend-bar {
            width: 8px;
            background: linear-gradient(to top, #4CAF50, #FFC107);
            border-radius: 2px;
            transition: height 0.3s ease;
        }
        
        /* Стили для кейсов */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .case-item {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .case-item:hover {
            transform: translateY(-5px);
            border-color: #fdbb2d;
            box-shadow: 0 10px 20px rgba(253, 187, 45, 0.3);
        }
        
        .case-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .case-price {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .case-chances {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .upgrades-list {
            margin-top: 20px;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .upgrade-rarity-common { color: #ffffff; }
        .upgrade-rarity-uncommon { color: #4CAF50; }
        .upgrade-rarity-rare { color: #2196F3; }
        .upgrade-rarity-epic { color: #9C27B0; }
        .upgrade-rarity-legendary { color: #FF9800; }
        
        .bonus-display {
            background: rgba(253, 187, 45, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        .case-premium {
            border-color: #FFD700;
            background: linear-gradient(135deg, #1a2a6c, #9C27B0);
        }

        .case-legendary {
            border-color: #FF9800;
            background: linear-gradient(135deg, #1a2a6c, #FF9800);
        }

        /* Стили для трейда */
        .trade-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .trade-side {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .trade-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #fdbb2d;
        }

        .trade-items {
            min-height: 200px;
            margin-bottom: 15px;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .trade-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .trade-controls button {
            flex: 1;
        }

        .trade-offers {
            margin-top: 20px;
        }

        .trade-offer {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .trade-offer-info {
            margin-bottom: 10px;
        }

        .trade-offer-actions {
            display: flex;
            gap: 10px;
        }

        .trade-offer-actions button {
            flex: 1;
        }

        .selected-upgrade {
            background: rgba(253, 187, 45, 0.3);
            border: 1px solid #fdbb2d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">FireClicker <span class="admin-badge" id="adminBadge" style="display: none;">ADMIN</span></div>
            <div class="user-info">
                <div id="userDisplay" class="user-display" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Пользователь</span>
                    <span id="userVerified" class="verified-badge" style="display: none;">✓</span>
                </div>
                <div class="auth-section">
                    <button id="adminPanelBtn" class="admin-btn admin-only">Админ Панель</button>
                    <button id="loginBtn">Войти</button>
                    <button id="registerBtn">Регистрация</button>
                    <button id="logoutBtn" style="display: none;">Выйти</button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="game-section">
                <h2 class="section-title">Кликер</h2>
                <div id="eventNotification" class="event-notification" style="display: none;">
                    <!-- Уведомление о событии будет здесь -->
                </div>
                <div class="click-area" id="clickArea">
                    <span id="clickText">КЛИКАЙ!</span>
                    <div class="blocked-overlay" id="blockedOverlay" style="display: none;">СЛИШКОМ БЫСТРО!</div>
                </div>
                <div class="cps-meter">
                    <div class="cps-fill" id="cpsFill"></div>
                </div>
                <div class="cps-warning" id="cpsWarning"></div>
                <div class="stats">
                    <div class="stat">
                        <div>Клики</div>
                        <div class="stat-value" id="clickCount">0</div>
                    </div>
                    <div class="stat">
                        <div>Лучший результат</div>
                        <div class="stat-value" id="bestScore">0</div>
                    </div>
                    <div class="stat">
                        <div>Кликов/сек</div>
                        <div class="stat-value" id="cpsValue">0</div>
                    </div>
                </div>
                <div class="bonus-display" id="bonusDisplay" style="display: none;">
                    Бонус к клику: +<span id="bonusValue">0</span>
                </div>
                <div class="game-info">
                    <p>Войдите в аккаунт, чтобы сохранить свой прогресс и попасть в лидерборд!</p>
                    <p>Ограничение: не более 12 кликов в секунду</p>
                    <div class="change-nickname" id="changeNickname" style="display: none;">Изменить никнейм</div>
                </div>
            </div>
            
            <div class="cases-section">
                <h2 class="section-title">Кейсы с улучшениями</h2>
                <div class="cases-grid">
                    <div class="case-item" id="basicCase">
                        <div class="case-name">📦 Базовый кейс</div>
                        <div class="case-price">Цена: 250 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +0.1 | 25% +0.2 | 8% +0.5 | 2% +1.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item" id="advancedCase">
                        <div class="case-name">⚡ Продвинутый кейс</div>
                        <div class="case-price">Цена: 750 кликов</div>
                        <div class="case-chances">
                            Шансы: 50% +0.2 | 30% +0.5 | 15% +1.0 | 5% +2.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item case-premium" id="premiumCase">
                        <div class="case-name">💎 Премиум кейс</div>
                        <div class="case-price">Цена: 1500 кликов</div>
                        <div class="case-chances">
                            Шансы: 40% +0.5 | 35% +1.0 | 20% +2.0 | 5% +3.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item case-legendary" id="legendaryCase">
                        <div class="case-name">🌟 Легендарный кейс</div>
                        <div class="case-price">Цена: 3000 кликов</div>
                        <div class="case-chances">
                            Шансы: 30% +1.0 | 40% +2.0 | 25% +3.0 | 5% +5.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                </div>
                
                <div class="upgrades-list" id="upgradesList">
                    <h3 style="margin-bottom: 15px;">Ваши улучшения</h3>
                    <!-- Список улучшений будет здесь -->
                </div>
            </div>
            
            <div class="trade-section">
                <h2 class="section-title">Обмен с игроками</h2>
                <div class="trade-controls">
                    <button id="createTradeBtn">Создать обмен</button>
                    <button id="refreshTrades">Обновить список</button>
                </div>
                <div class="trade-offers" id="tradeOffers">
                    <!-- Список предложений обмена будет здесь -->
                </div>
            </div>
            
            <div class="leaderboard-section">
                <h2 class="section-title">Лидерборд</h2>
                <div class="leaderboard-controls">
                    <button id="showTop10" class="active">Топ-10</button>
                    <button id="showTop25">Топ-25</button>
                    <button id="showAll">Все игроки</button>
                </div>
                <ul class="leaderboard" id="leaderboard">
                    <!-- Лидерборд будет заполнен через JS -->
                </ul>
            </div>
            
            <div class="friends-section">
                <h2 class="section-title">Друзья</h2>
                <div class="friends-controls">
                    <button id="addFriendBtn">Добавить друга</button>
                    <button id="refreshFriends">Обновить</button>
                </div>
                <div class="friends-list" id="friendsList">
                    <!-- Список друзей будет здесь -->
                </div>
            </div>
            
            <div class="chat-section">
                <h2 class="section-title">Чат</h2>
                <div class="chat-messages" id="chatMessages">
                    <!-- Сообщения чата будут здесь -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Введите сообщение..." maxlength="200">
                    <button class="send-button" id="sendMessage">Отправить</button>
                </div>
            </div>
            
            <div class="admin-section admin-only" id="adminSection">
                <h2 class="section-title">Админ Панель</h2>
                <div class="admin-controls">
                    <div class="admin-panel">
                        <h3>Управление пользователями</h3>
                        <div class="user-list" id="userList">
                            <!-- Список пользователей будет заполнен через JS -->
                        </div>
                        <button id="refreshUsers">Обновить список</button>
                    </div>
                    
                    <div class="admin-panel">
                        <h3>Быстрые действия с кликами</h3>
                        <div class="admin-quick-actions">
                            <div class="action-with-input">
                                <input type="number" id="clicksToOnlineInput" placeholder="Кол-во кликов" value="1000">
                                <button id="addClicksToOnline">Добавить онлайн</button>
                            </div>
                            <div class="action-with-input">
                                <input type="number" id="clicksToMeInput" placeholder="Кол-во кликов" value="5000">
                                <button id="addMyClicks">Добавить себе</button>
                            </div>
                            <div class="action-with-input">
                                <input type="number" id="clicksToAllInput" placeholder="Кол-во кликов" value="1000">
                                <button id="addClicksToAll">Добавить всем</button>
                            </div>
                            <button id="createEvent" class="admin-only">Создать ивент</button>
                            <button id="resetAllScores">Обнулить все</button>
                            <button id="deleteInactive">Удалить неактивных</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="auth-modal" id="authModal">
        <div class="auth-form">
            <h2 id="authModalTitle">Вход</h2>
            <input type="email" id="authEmail" placeholder="Email">
            <input type="password" id="authPassword" placeholder="Пароль">
            <div class="auth-buttons">
                <button id="authSubmit">Войти</button>
                <button id="authCancel">Отмена</button>
            </div>
            <div class="close-modal" id="closeAuthModal">×</div>
        </div>
    </div>
    
    <div class="nickname-modal" id="nicknameModal">
        <div class="nickname-form">
            <h2>Установить никнейм</h2>
            <input type="text" id="nicknameInput" placeholder="Введите ваш никнейм" maxlength="15">
            <div class="nickname-buttons">
                <button id="saveNickname">Сохранить</button>
                <button id="cancelNickname">Отмена</button>
            </div>
            <div class="close-modal" id="closeNicknameModal">×</div>
        </div>
    </div>
    
    <div class="admin-modal" id="adminModal">
        <div class="admin-form">
            <h2 id="adminModalTitle">Редактирование пользователя</h2>
            <div id="adminUserInfo" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;"></div>
            <input type="number" id="adminClicksInput" placeholder="Новое количество кликов">
            <input type="number" id="adminBestScoreInput" placeholder="Новый лучший результат">
            <div class="admin-buttons">
                <button id="adminSave">Сохранить</button>
                <button id="adminDelete">Удалить аккаунт</button>
                <button id="toggleVerified">Переключить галочку</button>
                <button id="adminCancel">Отмена</button>
            </div>
            <div class="close-modal" id="closeAdminModal">×</div>
        </div>
    </div>
    
    <div class="event-modal" id="eventModal">
        <div class="event-form">
            <h2>Создание события</h2>
            <select id="eventMultiplier">
                <option value="2">2x - Двойные клики</option>
                <option value="3">3x - Тройные клики</option>
                <option value="5">5x - Пятерные клики</option>
                <option value="10">10x - Десятерные клики</option>
            </select>
            <select id="eventDuration">
                <option value="5">5 минут</option>
                <option value="10">10 минут</option>
                <option value="30">30 минут</option>
                <option value="60">1 час</option>
                <option value="120">2 часа</option>
                <option value="360">6 часов</option>
                <option value="720">12 часов</option>
                <option value="1440">24 часа</option>
            </select>
            <div class="event-buttons">
                <button id="startEvent">Запустить событие</button>
                <button id="stopEvent">Остановить событие</button>
                <button id="cancelEvent">Отмена</button>
            </div>
            <div class="close-modal" id="closeEventModal">×</div>
        </div>
    </div>
    
    <div class="clicks-modal" id="customClicksModal">
        <div class="clicks-form">
            <h2 id="customClicksTitle">Добавление кликов</h2>
            <input type="number" id="customClicksInput" placeholder="Введите количество кликов">
            <div class="clicks-buttons">
                <button id="confirmCustomClicks">Добавить</button>
                <button id="cancelCustomClicks">Отмена</button>
            </div>
            <div class="close-modal" id="closeCustomClicksModal">×</div>
        </div>
    </div>
    
    <div class="friends-modal" id="friendsModal">
        <div class="friends-form">
            <h2>Добавить друга</h2>
            <input type="text" id="friendSearchInput" placeholder="Введите email или никнейм">
            <div class="friends-buttons">
                <button id="searchFriend">Найти</button>
                <button id="cancelFriend">Отмена</button>
            </div>
            <div id="friendSearchResults" style="margin-top: 15px;">
                <!-- Результаты поиска будут здесь -->
            </div>
            <div class="close-modal" id="closeFriendsModal">×</div>
        </div>
    </div>

    <!-- Новые модальные окна для кейсов и кода админа -->
    <div class="case-result-modal" id="caseResultModal">
        <div class="case-result-content">
            <h2 id="caseResultTitle">Результат открытия кейса</h2>
            <div id="caseResultContent" style="font-size: 1.2rem; margin: 20px 0;"></div>
            <div class="case-result-buttons">
                <button id="closeCaseResult">Закрыть</button>
            </div>
        </div>
    </div>
    
    <div class="admin-code-modal" id="adminCodeModal">
        <div class="admin-code-form">
            <h2>Подтверждение администратора</h2>
            <p>Введите код подтверждения для доступа к админ-панели:</p>
            <input type="text" id="adminCodeInput" placeholder="Код подтверждения">
            <div class="admin-code-buttons">
                <button id="confirmAdminCode">Подтвердить</button>
                <button id="cancelAdminCode">Отмена</button>
            </div>
            <div class="close-modal" id="closeAdminCodeModal">×</div>
        </div>
    </div>

    <!-- Модальное окно для обмена -->
    <div class="trade-modal" id="tradeModal">
        <div class="trade-form">
            <h2 id="tradeModalTitle">Создание обмена</h2>
            <div class="trade-container">
                <div class="trade-side">
                    <h3>Вы отдаете:</h3>
                    <div class="trade-items" id="myTradeItems">
                        <!-- Ваши предметы для обмена -->
                    </div>
                    <div class="action-with-input">
                        <input type="number" id="myClicksInput" placeholder="Клики для обмена" min="0">
                        <button id="addMyUpgrade">Добавить улучшение</button>
                    </div>
                </div>
                <div class="trade-arrow">⇄</div>
                <div class="trade-side">
                    <h3>Вы получаете:</h3>
                    <div class="trade-items" id="theirTradeItems">
                        <!-- Предметы другого игрока -->
                    </div>
                    <div class="action-with-input">
                        <input type="number" id="theirClicksInput" placeholder="Клики для получения" min="0">
                        <button id="addTheirUpgrade">Добавить улучшение</button>
                    </div>
                </div>
            </div>
            <div class="action-with-input">
                <input type="text" id="tradePlayerInput" placeholder="Имя игрока для обмена">
            </div>
            <div class="trade-buttons">
                <button id="sendTradeOffer">Отправить предложение</button>
                <button id="cancelTrade">Отмена</button>
            </div>
            <div class="close-modal" id="closeTradeModal">×</div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD4mvrBrKNEmPQ7JDfbnEGAxb9ETen8KsA",
            authDomain: "clicking-697ae.firebaseapp.com",
            projectId: "clicking-697ae",
            storageBucket: "clicking-697ae.firebasestorage.app",
            messagingSenderId: "479295856325",
            appId: "1:479295856325:web:dc0b0dcf661cd66941daac",
            databaseURL: "https://clicking-697ae-default-rtdb.firebaseio.com/"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Состояние игры
        let gameState = {
            clicks: 0,
            bestScore: 0,
            clickMultiplier: 1,
            previousClicks: 0,
            previousBestScore: 0,
            previousCPS: 0,
            clickHistory: []
        };

        // Система улучшений
        let upgrades = {
            totalBonus: 0,
            items: []
        };

        // Система обмена
        let currentTrade = {
            myItems: [],
            myClicks: 0,
            theirItems: [],
            theirClicks: 0,
            targetPlayer: null
        };

        // Код подтверждения для админа
        const ADMIN_CONFIRMATION_CODE = "ADMIN2024";

        // Настройки лидерборда
        let leaderboardLimit = 10;

        // Система защиты от быстрых кликов
        const MAX_CPS = 12;
        let clickTimestamps = [];
        let currentCPS = 0;
        let isBlocked = false;
        let blockTimeout = null;

        // Админские настройки
        const ADMIN_EMAILS = ['magmaplasm@gmail.com'];
        let isAdmin = false;
        let selectedUser = null;
        let currentAction = null;

        // DOM элементы
        const clickArea = document.getElementById('clickArea');
        const clickText = document.getElementById('clickText');
        const blockedOverlay = document.getElementById('blockedOverlay');
        const clickCount = document.getElementById('clickCount');
        const bestScore = document.getElementById('bestScore');
        const cpsValue = document.getElementById('cpsValue');
        const cpsWarning = document.getElementById('cpsWarning');
        const cpsFill = document.getElementById('cpsFill');
        const leaderboard = document.getElementById('leaderboard');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminSection = document.getElementById('adminSection');
        const adminBadge = document.getElementById('adminBadge');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmit = document.getElementById('authSubmit');
        const authCancel = document.getElementById('authCancel');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const userDisplay = document.getElementById('userDisplay');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userVerified = document.getElementById('userVerified');
        const changeNickname = document.getElementById('changeNickname');
        const nicknameModal = document.getElementById('nicknameModal');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNickname = document.getElementById('saveNickname');
        const cancelNickname = document.getElementById('cancelNickname');
        const closeNicknameModal = document.getElementById('closeNicknameModal');
        const showTop10 = document.getElementById('showTop10');
        const showTop25 = document.getElementById('showTop25');
        const showAll = document.getElementById('showAll');
        const eventNotification = document.getElementById('eventNotification');
        const userList = document.getElementById('userList');
        const refreshUsers = document.getElementById('refreshUsers');
        const resetAllScores = document.getElementById('resetAllScores');
        const addClicksToAll = document.getElementById('addClicksToAll');
        const deleteInactive = document.getElementById('deleteInactive');
        const addClicksToOnline = document.getElementById('addClicksToOnline');
        const addMyClicks = document.getElementById('addMyClicks');
        const createEvent = document.getElementById('createEvent');
        const adminModal = document.getElementById('adminModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminUserInfo = document.getElementById('adminUserInfo');
        const adminClicksInput = document.getElementById('adminClicksInput');
        const adminBestScoreInput = document.getElementById('adminBestScoreInput');
        const adminSave = document.getElementById('adminSave');
        const adminDelete = document.getElementById('adminDelete');
        const toggleVerified = document.getElementById('toggleVerified');
        const adminCancel = document.getElementById('adminCancel');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const eventModal = document.getElementById('eventModal');
        const eventMultiplier = document.getElementById('eventMultiplier');
        const eventDuration = document.getElementById('eventDuration');
        const startEvent = document.getElementById('startEvent');
        const stopEvent = document.getElementById('stopEvent');
        const cancelEvent = document.getElementById('cancelEvent');
        const closeEventModal = document.getElementById('closeEventModal');
        const customClicksModal = document.getElementById('customClicksModal');
        const customClicksTitle = document.getElementById('customClicksTitle');
        const customClicksInput = document.getElementById('customClicksInput');
        const confirmCustomClicks = document.getElementById('confirmCustomClicks');
        const cancelCustomClicks = document.getElementById('cancelCustomClicks');
        const closeCustomClicksModal = document.getElementById('closeCustomClicksModal');
        const clicksToOnlineInput = document.getElementById('clicksToOnlineInput');
        const clicksToMeInput = document.getElementById('clicksToMeInput');
        const clicksToAllInput = document.getElementById('clicksToAllInput');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessage = document.getElementById('sendMessage');
        const friendsList = document.getElementById('friendsList');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const refreshFriends = document.getElementById('refreshFriends');
        const friendsModal = document.getElementById('friendsModal');
        const friendSearchInput = document.getElementById('friendSearchInput');
        const searchFriend = document.getElementById('searchFriend');
        const cancelFriend = document.getElementById('cancelFriend');
        const closeFriendsModal = document.getElementById('closeFriendsModal');
        const friendSearchResults = document.getElementById('friendSearchResults');
        const bonusDisplay = document.getElementById('bonusDisplay');
        const bonusValue = document.getElementById('bonusValue');

        // Новые DOM элементы для кейсов и кода админа
        const basicCase = document.getElementById('basicCase');
        const advancedCase = document.getElementById('advancedCase');
        const premiumCase = document.getElementById('premiumCase');
        const legendaryCase = document.getElementById('legendaryCase');
        const upgradesList = document.getElementById('upgradesList');
        const caseResultModal = document.getElementById('caseResultModal');
        const caseResultTitle = document.getElementById('caseResultTitle');
        const caseResultContent = document.getElementById('caseResultContent');
        const closeCaseResult = document.getElementById('closeCaseResult');
        const adminCodeModal = document.getElementById('adminCodeModal');
        const adminCodeInput = document.getElementById('adminCodeInput');
        const confirmAdminCode = document.getElementById('confirmAdminCode');
        const cancelAdminCode = document.getElementById('cancelAdminCode');
        const closeAdminCodeModal = document.getElementById('closeAdminCodeModal');

        // DOM элементы для трейда
        const tradeSection = document.getElementById('tradeSection');
        const createTradeBtn = document.getElementById('createTradeBtn');
        const refreshTrades = document.getElementById('refreshTrades');
        const tradeOffers = document.getElementById('tradeOffers');
        const tradeModal = document.getElementById('tradeModal');
        const tradeModalTitle = document.getElementById('tradeModalTitle');
        const myTradeItems = document.getElementById('myTradeItems');
        const theirTradeItems = document.getElementById('theirTradeItems');
        const myClicksInput = document.getElementById('myClicksInput');
        const theirClicksInput = document.getElementById('theirClicksInput');
        const addMyUpgrade = document.getElementById('addMyUpgrade');
        const addTheirUpgrade = document.getElementById('addTheirUpgrade');
        const tradePlayerInput = document.getElementById('tradePlayerInput');
        const sendTradeOffer = document.getElementById('sendTradeOffer');
        const cancelTrade = document.getElementById('cancelTrade');
        const closeTradeModal = document.getElementById('closeTradeModal');

        // Инициализация приложения
        function initApp() {
            // Слушатели аутентификации
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Пользователь вошел в систему
                    handleUserLogin(user);
                } else {
                    // Пользователь вышел из системы
                    handleUserLogout();
                }
            });

            // Слушатели событий
            setupEventListeners();
            
            // Загрузка лидерборда
            loadLeaderboard();
            
            // Загрузка чата
            loadChat();
            
            // Загрузка начального состояния игры
            loadGameState();
            
            // Проверка активных событий
            checkActiveEvent();
            
            // Инициализация системы кейсов
            initCasesSystem();
            
            // Инициализация системы обмена
            initTradeSystem();
            
            // Обновление CPS каждую секунду
            setInterval(updateCPS, 1000);
            
            // Проверка событий каждые 5 секунд
            setInterval(checkActiveEvent, 5000);
        }

        // Обработка входа пользователя
        function handleUserLogin(user) {
            console.log("Пользователь вошел:", user.email);
            
            // Проверка на админа
            isAdmin = ADMIN_EMAILS.includes(user.email);
            
            // Обновление UI
            loginBtn.style.display = 'none';
            registerBtn.style.display = 'none';
            logoutBtn.style.display = 'block';
            userDisplay.style.display = 'flex';
            
            if (isAdmin) {
                adminPanelBtn.style.display = 'block';
                adminBadge.style.display = 'inline';
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
            }
            
            // Загрузка данных пользователя
            loadUserData(user.uid);
            
            // Загрузка улучшений
            loadUpgrades();
            
            // Загрузка списка пользователей для админа
            if (isAdmin) {
                loadUserList();
            }
            
            // Загрузка друзей
            loadFriends();
            
            // Загрузка предложений обмена
            loadTradeOffers();
        }

        // Обработка выхода пользователя
        function handleUserLogout() {
            console.log("Пользователь вышел");
            
            // Сохранение состояния игры перед выходом
            if (auth.currentUser) {
                saveGameState();
            }
            
            // Сброс состояния
            gameState.clicks = 0;
            gameState.bestScore = 0;
            gameState.clickMultiplier = 1;
            gameState.previousClicks = 0;
            gameState.previousBestScore = 0;
            gameState.previousCPS = 0;
            gameState.clickHistory = [];
            
            // Сброс улучшений
            upgrades = {
                totalBonus: 0,
                items: []
            };
            
            // Сброс обмена
            currentTrade = {
                myItems: [],
                myClicks: 0,
                theirItems: [],
                theirClicks: 0,
                targetPlayer: null
            };
            
            // Обновление UI
            loginBtn.style.display = 'block';
            registerBtn.style.display = 'block';
            logoutBtn.style.display = 'none';
            userDisplay.style.display = 'none';
            adminPanelBtn.style.display = 'none';
            adminBadge.style.display = 'none';
            adminSection.style.display = 'none';
            changeNickname.style.display = 'none';
            userVerified.style.display = 'none';
            bonusDisplay.style.display = 'none';
            
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // Обновление отображения
            updateGameDisplay();
            
            // Перезагрузка лидерборда
            loadLeaderboard();
        }

        // Настройка слушателей событий
        function setupEventListeners() {
            // Кликер
            clickArea.addEventListener('click', handleClick);
            
            // Аутентификация
            loginBtn.addEventListener('click', () => showAuthModal('login'));
            registerBtn.addEventListener('click', () => showAuthModal('register'));
            logoutBtn.addEventListener('click', handleLogout);
            authSubmit.addEventListener('click', handleAuthSubmit);
            authCancel.addEventListener('click', hideAuthModal);
            closeAuthModal.addEventListener('click', hideAuthModal);
            
            // Никнейм
            changeNickname.addEventListener('click', showNicknameModal);
            saveNickname.addEventListener('click', saveNicknameHandler);
            cancelNickname.addEventListener('click', hideNicknameModal);
            closeNicknameModal.addEventListener('click', hideNicknameModal);
            
            // Лидерборд
            showTop10.addEventListener('click', () => changeLeaderboardLimit(10));
            showTop25.addEventListener('click', () => changeLeaderboardLimit(25));
            showAll.addEventListener('click', () => changeLeaderboardLimit(0));
            
            // Админ панель
            adminPanelBtn.addEventListener('click', toggleAdminPanel);
            refreshUsers.addEventListener('click', loadUserList);
            resetAllScores.addEventListener('click', resetAllScoresHandler);
            addClicksToAll.addEventListener('click', () => showCustomClicksModal('all'));
            deleteInactive.addEventListener('click', deleteInactiveUsers);
            addClicksToOnline.addEventListener('click', () => addClicksToOnlineHandler());
            addMyClicks.addEventListener('click', () => addMyClicksHandler());
            createEvent.addEventListener('click', showEventModal);
            
            // Модалки админа
            adminSave.addEventListener('click', saveUserChanges);
            adminDelete.addEventListener('click', deleteUser);
            toggleVerified.addEventListener('click', toggleUserVerified);
            adminCancel.addEventListener('click', hideAdminModal);
            closeAdminModal.addEventListener('click', hideAdminModal);
            
            // Модалка событий
            startEvent.addEventListener('click', startEventHandler);
            stopEvent.addEventListener('click', stopEventHandler);
            cancelEvent.addEventListener('click', hideEventModal);
            closeEventModal.addEventListener('click', hideEventModal);
            
            // Модалка кастомных кликов
            confirmCustomClicks.addEventListener('click', confirmCustomClicksHandler);
            cancelCustomClicks.addEventListener('click', hideCustomClicksModal);
            closeCustomClicksModal.addEventListener('click', hideCustomClicksModal);
            
            // Чат
            sendMessage.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Друзья
            addFriendBtn.addEventListener('click', showFriendsModal);
            refreshFriends.addEventListener('click', loadFriends);
            searchFriend.addEventListener('click', searchFriendHandler);
            cancelFriend.addEventListener('click', hideFriendsModal);
            closeFriendsModal.addEventListener('click', hideFriendsModal);
        }

        // Инициализация системы кейсов
        function initCasesSystem() {
            // Обработчики событий для кейсов
            basicCase.addEventListener('click', () => openCase('basic'));
            advancedCase.addEventListener('click', () => openCase('advanced'));
            premiumCase.addEventListener('click', () => openCase('premium'));
            legendaryCase.addEventListener('click', () => openCase('legendary'));
            closeCaseResult.addEventListener('click', hideCaseResult);
            
            // Обработчики для кода админа
            confirmAdminCode.addEventListener('click', verifyAdminCode);
            cancelAdminCode.addEventListener('click', hideAdminCodeModal);
            closeAdminCodeModal.addEventListener('click', hideAdminCodeModal);
        }

        // Инициализация системы обмена
        function initTradeSystem() {
            // Обработчики событий для обмена
            createTradeBtn.addEventListener('click', showTradeModal);
            refreshTrades.addEventListener('click', loadTradeOffers);
            addMyUpgrade.addEventListener('click', () => addUpgradeToTrade('my'));
            addTheirUpgrade.addEventListener('click', () => addUpgradeToTrade('their'));
            sendTradeOffer.addEventListener('click', sendTradeOfferHandler);
            cancelTrade.addEventListener('click', hideTradeModal);
            closeTradeModal.addEventListener('click', hideTradeModal);
            
            // Обновление кликов в обмене при изменении
            myClicksInput.addEventListener('input', updateTradeClicks);
            theirClicksInput.addEventListener('input', updateTradeClicks);
        }

        // Загрузка улучшений пользователя
        function loadUpgrades() {
            if (!auth.currentUser) return;
            
            const upgradesRef = database.ref('userUpgrades/' + auth.currentUser.uid);
            upgradesRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    upgrades = data;
                    renderUpgradesList();
                    updateBonusDisplay();
                }
            });
        }

        // Отрисовка списка улучшений
        function renderUpgradesList() {
            upgradesList.innerHTML = '<h3 style="margin-bottom: 15px;">Ваши улучшения</h3>';
            
            if (upgrades.items && upgrades.items.length > 0) {
                upgrades.items.forEach((upgrade, index) => {
                    const upgradeItem = document.createElement('div');
                    upgradeItem.className = 'upgrade-item';
                    
                    let rarityClass = 'upgrade-rarity-common';
                    if (upgrade.value === 0.2) rarityClass = 'upgrade-rarity-uncommon';
                    else if (upgrade.value === 0.5) rarityClass = 'upgrade-rarity-rare';
                    else if (upgrade.value === 1.0) rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.value >= 2.0) rarityClass = 'upgrade-rarity-legendary';
                    
                    upgradeItem.innerHTML = `
                        <div>
                            <span class="${rarityClass}">Улучшение +${upgrade.value}</span>
                        </div>
                        <div>
                            <small>${new Date(upgrade.timestamp).toLocaleDateString('ru-RU')}</small>
                        </div>
                    `;
                    
                    upgradesList.appendChild(upgradeItem);
                });
                
                const totalBonusItem = document.createElement('div');
                totalBonusItem.className = 'upgrade-item';
                totalBonusItem.style.background = 'rgba(253, 187, 45, 0.3)';
                totalBonusItem.innerHTML = `
                    <div><strong>Общий бонус к клику</strong></div>
                    <div><strong>+${upgrades.totalBonus || 0}</strong></div>
                `;
                upgradesList.appendChild(totalBonusItem);
            } else {
                upgradesList.innerHTML += '<div style="text-align: center; padding: 20px;">У вас пока нет улучшений</div>';
            }
        }

        // Обновление отображения бонуса
        function updateBonusDisplay() {
            if (upgrades.totalBonus > 0) {
                bonusValue.textContent = upgrades.totalBonus.toFixed(1);
                bonusDisplay.style.display = 'block';
            } else {
                bonusDisplay.style.display = 'none';
            }
        }

        // Открытие кейса
        function openCase(caseType) {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы открывать кейсы');
                return;
            }
            
            let casePrice, caseName, caseElement;
            let chances = [];
            
            switch(caseType) {
                case 'basic':
                    casePrice = 250;
                    caseName = 'Базовый кейс';
                    caseElement = basicCase;
                    chances = [
                        { value: 0.1, probability: 65 },
                        { value: 0.2, probability: 25 },
                        { value: 0.5, probability: 8 },
                        { value: 1.0, probability: 2 }
                    ];
                    break;
                case 'advanced':
                    casePrice = 750;
                    caseName = 'Продвинутый кейс';
                    caseElement = advancedCase;
                    chances = [
                        { value: 0.2, probability: 50 },
                        { value: 0.5, probability: 30 },
                        { value: 1.0, probability: 15 },
                        { value: 2.0, probability: 5 }
                    ];
                    break;
                case 'premium':
                    casePrice = 1500;
                    caseName = 'Премиум кейс';
                    caseElement = premiumCase;
                    chances = [
                        { value: 0.5, probability: 40 },
                        { value: 1.0, probability: 35 },
                        { value: 2.0, probability: 20 },
                        { value: 3.0, probability: 5 }
                    ];
                    break;
                case 'legendary':
                    casePrice = 3000;
                    caseName = 'Легендарный кейс';
                    caseElement = legendaryCase;
                    chances = [
                        { value: 1.0, probability: 30 },
                        { value: 2.0, probability: 40 },
                        { value: 3.0, probability: 25 },
                        { value: 5.0, probability: 5 }
                    ];
                    break;
                default:
                    return;
            }
            
            if (gameState.clicks < casePrice) {
                alert(`Недостаточно кликов! Нужно ${casePrice} кликов.`);
                return;
            }
            
            if (!confirm(`Открыть ${caseName} за ${casePrice} кликов?`)) {
                return;
            }
            
            // Спин анимация
            caseElement.style.opacity = '0.7';
            caseElement.querySelector('button').textContent = 'Открывается...';
            
            // Имитация открытия кейса с задержкой
            setTimeout(() => {
                // Вычисление выпавшего улучшения
                const random = Math.random() * 100;
                let upgradeValue, rarity, rarityName;
                let cumulativeProbability = 0;
                
                for (let chance of chances) {
                    cumulativeProbability += chance.probability;
                    if (random <= cumulativeProbability) {
                        upgradeValue = chance.value;
                        break;
                    }
                }
                
                // Определение редкости
                if (upgradeValue === 0.1) {
                    rarity = 'common';
                    rarityName = 'Обычное';
                } else if (upgradeValue === 0.2) {
                    rarity = 'uncommon';
                    rarityName = 'Необычное';
                } else if (upgradeValue === 0.5) {
                    rarity = 'rare';
                    rarityName = 'Редкое';
                } else if (upgradeValue === 1.0) {
                    rarity = 'epic';
                    rarityName = 'Эпическое';
                } else if (upgradeValue === 2.0) {
                    rarity = 'epic';
                    rarityName = 'Эпическое';
                } else if (upgradeValue === 3.0) {
                    rarity = 'legendary';
                    rarityName = 'Легендарное';
                } else if (upgradeValue === 5.0) {
                    rarity = 'legendary';
                    rarityName = 'Легендарное';
                }
                
                // Списание кликов
                gameState.clicks -= casePrice;
                updateGameDisplay();
                saveGameState();
                
                // Добавление улучшения
                addUpgrade(upgradeValue, rarity, rarityName);
                
                // Показ результата
                showCaseResult(upgradeValue, rarity, rarityName, caseName);
                
                // Восстановление кнопки
                caseElement.style.opacity = '1';
                caseElement.querySelector('button').textContent = 'Открыть кейс';
            }, 1500);
        }

        // Добавление улучшения
        function addUpgrade(value, rarity, rarityName) {
            if (!upgrades.items) {
                upgrades.items = [];
            }
            
            const newUpgrade = {
                value: value,
                rarity: rarity,
                rarityName: rarityName,
                timestamp: Date.now()
            };
            
            upgrades.items.push(newUpgrade);
            upgrades.totalBonus = (upgrades.totalBonus || 0) + value;
            
            // Сохранение в базе данных
            if (auth.currentUser) {
                const upgradesRef = database.ref('userUpgrades/' + auth.currentUser.uid);
                upgradesRef.set(upgrades);
            }
            
            // Обновление отображения
            renderUpgradesList();
            updateBonusDisplay();
        }

        // Показать результат открытия кейса
        function showCaseResult(value, rarity, rarityName, caseName) {
            let rarityColor = '#ffffff';
            if (rarity === 'uncommon') rarityColor = '#4CAF50';
            else if (rarity === 'rare') rarityColor = '#2196F3';
            else if (rarity === 'epic') rarityColor = '#9C27B0';
            else if (rarity === 'legendary') rarityColor = '#FF9800';
            
            caseResultTitle.textContent = `Результат: ${caseName}`;
            caseResultContent.innerHTML = `
                <div style="font-size: 1.5rem; color: ${rarityColor}; margin: 10px 0;">
                    ${rarityName} улучшение!
                </div>
                <div style="font-size: 2rem; font-weight: bold; color: #fdbb2d; margin: 15px 0;">
                    +${value} к клику
                </div>
                <div>Теперь каждый ваш клик будет приносить дополнительные клики!</div>
            `;
            
            caseResultModal.style.display = 'flex';
        }

        // Скрыть результат открытия кейса
        function hideCaseResult() {
            caseResultModal.style.display = 'none';
        }

        // Показать модальное окно кода админа
        function showAdminCodeModal() {
            adminCodeModal.style.display = 'flex';
            adminCodeInput.value = '';
        }

        // Скрыть модальное окно кода админа
        function hideAdminCodeModal() {
            adminCodeModal.style.display = 'none';
        }

        // Проверка кода админа
        function verifyAdminCode() {
            const enteredCode = adminCodeInput.value.trim();
            
            if (enteredCode === ADMIN_CONFIRMATION_CODE) {
                hideAdminCodeModal();
                adminSection.style.display = 'block';
                loadUserList();
            } else {
                alert('Неверный код подтверждения!');
            }
        }

        // Показать модальное окно обмена
        function showTradeModal() {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы создавать обмены');
                return;
            }
            
            // Сброс текущего обмена
            currentTrade = {
                myItems: [],
                myClicks: 0,
                theirItems: [],
                theirClicks: 0,
                targetPlayer: null
            };
            
            // Обновление UI
            myClicksInput.value = '';
            theirClicksInput.value = '';
            tradePlayerInput.value = '';
            updateTradeDisplay();
            
            tradeModal.style.display = 'flex';
        }

        // Скрыть модальное окно обмена
        function hideTradeModal() {
            tradeModal.style.display = 'none';
        }

        // Добавление улучшения в обмен
        function addUpgradeToTrade(side) {
            if (!upgrades.items || upgrades.items.length === 0) {
                alert('У вас нет улучшений для обмена');
                return;
            }
            
            // Создаем список доступных улучшений
            let availableUpgrades = [];
            upgrades.items.forEach((upgrade, index) => {
                // Проверяем, не добавлено ли уже это улучшение в обмен
                const alreadyAdded = currentTrade.myItems.some(item => 
                    Math.abs(item.value - upgrade.value) < 0.001 && 
                    item.rarity === upgrade.rarity
                );
                
                if (!alreadyAdded) {
                    availableUpgrades.push({
                        index: index,
                        value: upgrade.value,
                        rarity: upgrade.rarity,
                        rarityName: upgrade.rarityName
                    });
                }
            });
            
            if (availableUpgrades.length === 0) {
                alert('Все ваши улучшения уже добавлены в обмен');
                return;
            }
            
            // Создаем диалог выбора улучшения
            let upgradeList = "Выберите улучшение (введите номер):\n";
            availableUpgrades.forEach((upg, i) => {
                upgradeList += `${i + 1}. +${upg.value} (${upg.rarityName})\n`;
            });
            
            const choice = parseInt(prompt(upgradeList));
            if (isNaN(choice) || choice < 1 || choice > availableUpgrades.length) {
                alert('Неверный выбор');
                return;
            }
            
            const selectedUpgrade = availableUpgrades[choice - 1];
            
            if (side === 'my') {
                currentTrade.myItems.push({
                    value: selectedUpgrade.value,
                    rarity: selectedUpgrade.rarity,
                    rarityName: selectedUpgrade.rarityName
                });
            } else {
                currentTrade.theirItems.push({
                    value: selectedUpgrade.value,
                    rarity: selectedUpgrade.rarity,
                    rarityName: selectedUpgrade.rarityName
                });
            }
            
            updateTradeDisplay();
        }

        // Обновление кликов в обмене
        function updateTradeClicks() {
            const myClicks = parseInt(myClicksInput.value) || 0;
            const theirClicks = parseInt(theirClicksInput.value) || 0;
            
            // Проверка на отрицательные значения
            currentTrade.myClicks = Math.max(0, myClicks);
            currentTrade.theirClicks = Math.max(0, theirClicks);
            
            // Обновляем поля ввода
            myClicksInput.value = currentTrade.myClicks;
            theirClicksInput.value = currentTrade.theirClicks;
            
            updateTradeDisplay();
        }

        // Обновление отображения обмена
        function updateTradeDisplay() {
            // Очистка списков
            myTradeItems.innerHTML = '';
            theirTradeItems.innerHTML = '';
            
            // Отображение ваших предметов
            currentTrade.myItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <span>+${item.value} (${item.rarityName})</span>
                    <button onclick="removeTradeItem('my', ${index})">×</button>
                `;
                myTradeItems.appendChild(itemElement);
            });
            
            // Отображение ваших кликов
            if (currentTrade.myClicks > 0) {
                const clicksElement = document.createElement('div');
                clicksElement.className = 'trade-item';
                clicksElement.innerHTML = `
                    <span>${currentTrade.myClicks} кликов</span>
                    <button onclick="removeTradeClicks('my')">×</button>
                `;
                myTradeItems.appendChild(clicksElement);
            }
            
            // Отображение предметов другого игрока
            currentTrade.theirItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <span>+${item.value} (${item.rarityName})</span>
                    <button onclick="removeTradeItem('their', ${index})">×</button>
                `;
                theirTradeItems.appendChild(itemElement);
            });
            
            // Отображение кликов другого игрока
            if (currentTrade.theirClicks > 0) {
                const clicksElement = document.createElement('div');
                clicksElement.className = 'trade-item';
                clicksElement.innerHTML = `
                    <span>${currentTrade.theirClicks} кликов</span>
                    <button onclick="removeTradeClicks('their')">×</button>
                `;
                theirTradeItems.appendChild(clicksElement);
            }
            
            // Если списки пустые, показываем сообщение
            if (myTradeItems.children.length === 0) {
                myTradeItems.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.7;">Пусто</div>';
            }
            
            if (theirTradeItems.children.length === 0) {
                theirTradeItems.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.7;">Пусто</div>';
            }
        }

        // Удаление предмета из обмена
        function removeTradeItem(side, index) {
            if (side === 'my') {
                currentTrade.myItems.splice(index, 1);
            } else {
                currentTrade.theirItems.splice(index, 1);
            }
            updateTradeDisplay();
        }

        // Удаление кликов из обмена
        function removeTradeClicks(side) {
            if (side === 'my') {
                currentTrade.myClicks = 0;
                myClicksInput.value = '';
            } else {
                currentTrade.theirClicks = 0;
                theirClicksInput.value = '';
            }
            updateTradeDisplay();
        }

        // Отправка предложения обмена
        function sendTradeOfferHandler() {
            const targetPlayerName = tradePlayerInput.value.trim();
            if (!targetPlayerName) {
                alert('Введите имя игрока для обмена');
                return;
            }
            
            if (currentTrade.myItems.length === 0 && currentTrade.myClicks === 0) {
                alert('Вы не предлагаете ничего для обмена');
                return;
            }
            
            if (currentTrade.theirItems.length === 0 && currentTrade.theirClicks === 0) {
                alert('Вы не запрашиваете ничего для обмена');
                return;
            }
            
            // Проверка своих кликов
            if (currentTrade.myClicks > gameState.clicks) {
                alert('У вас недостаточно кликов для этого обмена');
                return;
            }
            
            // Поиск игрока по имени
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                let targetUser = null;
                
                for (let userId in users) {
                    if (userId === auth.currentUser.uid) continue;
                    
                    const userNickname = users[userId].nickname || users[userId].email.split('@')[0];
                    if (userNickname.toLowerCase() === targetPlayerName.toLowerCase()) {
                        targetUser = {
                            id: userId,
                            ...users[userId]
                        };
                        break;
                    }
                }
                
                if (!targetUser) {
                    alert('Игрок с таким именем не найден');
                    return;
                }
                
                // Создание предложения обмена
                const tradeRef = database.ref('trades').push();
                const tradeData = {
                    fromUserId: auth.currentUser.uid,
                    fromUserName: userName.textContent,
                    toUserId: targetUser.id,
                    toUserName: targetUser.nickname || targetUser.email.split('@')[0],
                    myItems: currentTrade.myItems.map(item => ({
                        value: item.value,
                        rarity: item.rarity,
                        rarityName: item.rarityName
                    })),
                    myClicks: currentTrade.myClicks,
                    theirItems: currentTrade.theirItems.map(item => ({
                        value: item.value,
                        rarity: item.rarity,
                        rarityName: item.rarityName
                    })),
                    theirClicks: currentTrade.theirClicks,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                tradeRef.set(tradeData).then(() => {
                    alert('Предложение обмена отправлено!');
                    hideTradeModal();
                    loadTradeOffers();
                }).catch(error => {
                    console.error('Ошибка отправки обмена:', error);
                    alert('Ошибка при отправке предложения обмена');
                });
            });
        }

        // Загрузка предложений обмена
        function loadTradeOffers() {
            if (!auth.currentUser) return;
            
            const tradesRef = database.ref('trades');
            tradesRef.on('value', snapshot => {
                const trades = snapshot.val();
                tradeOffers.innerHTML = '';
                
                if (trades) {
                    Object.keys(trades).forEach(tradeId => {
                        const trade = trades[tradeId];
                        
                        // Показываем только относящиеся к текущему пользователю обмены
                        if (trade.fromUserId === auth.currentUser.uid || trade.toUserId === auth.currentUser.uid) {
                            addTradeOfferToList(tradeId, trade);
                        }
                    });
                } else {
                    tradeOffers.innerHTML = '<div style="text-align: center; padding: 20px;">Нет активных предложений обмена</div>';
                }
            });
        }

        // Добавление предложения обмена в список
        function addTradeOfferToList(tradeId, trade) {
            const isOutgoing = trade.fromUserId === auth.currentUser.uid;
            const otherUserName = isOutgoing ? trade.toUserName : trade.fromUserName;
            
            const tradeElement = document.createElement('div');
            tradeElement.className = 'trade-offer';
            tradeElement.id = `trade-${tradeId}`;
            
            let tradeInfo = `
                <div class="trade-offer-info">
                    <strong>${isOutgoing ? 'Исходящее' : 'Входящее'} предложение</strong><br>
                    <small>С игроком: ${otherUserName}</small><br>
                    <small>Статус: ${getTradeStatusText(trade.status)}</small>
                </div>
            `;
            
            if (trade.status === 'pending') {
                if (isOutgoing) {
                    tradeInfo += `
                        <div class="trade-offer-actions">
                            <button onclick="cancelTradeOffer('${tradeId}')">Отменить</button>
                        </div>
                    `;
                } else {
                    tradeInfo += `
                        <div class="trade-offer-actions">
                            <button onclick="acceptTradeOffer('${tradeId}')">Принять</button>
                            <button onclick="rejectTradeOffer('${tradeId}')">Отклонить</button>
                        </div>
                    `;
                }
            }
            
            tradeElement.innerHTML = tradeInfo;
            tradeOffers.appendChild(tradeElement);
        }

        // Получение текста статуса обмена
        function getTradeStatusText(status) {
            switch(status) {
                case 'pending': return 'Ожидание';
                case 'accepted': return 'Принят';
                case 'rejected': return 'Отклонен';
                case 'cancelled': return 'Отменен';
                default: return status;
            }
        }

        // Принятие предложения обмена
        function acceptTradeOffer(tradeId) {
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.once('value').then(snapshot => {
                const trade = snapshot.val();
                
                if (!trade || trade.status !== 'pending') {
                    alert('Предложение обмена больше не действительно');
                    return;
                }
                
                // Проверка, что текущий пользователь - получатель
                if (trade.toUserId !== auth.currentUser.uid) {
                    alert('Вы не можете принять это предложение обмена');
                    return;
                }
                
                // Проверка ресурсов у обоих игроков
                const fromUserRef = database.ref('users/' + trade.fromUserId);
                const toUserRef = database.ref('users/' + trade.toUserId);
                
                Promise.all([
                    fromUserRef.once('value'),
                    toUserRef.once('value'),
                    database.ref('userUpgrades/' + trade.fromUserId).once('value'),
                    database.ref('userUpgrades/' + trade.toUserId).once('value')
                ]).then(([fromUserSnap, toUserSnap, fromUpgradesSnap, toUpgradesSnap]) => {
                    const fromUser = fromUserSnap.val();
                    const toUser = toUserSnap.val();
                    const fromUpgrades = fromUpgradesSnap.val() || { items: [], totalBonus: 0 };
                    const toUpgrades = toUpgradesSnap.val() || { items: [], totalBonus: 0 };
                    
                    // Проверка кликов
                    if (fromUser.clicks < trade.myClicks) {
                        alert('У отправителя недостаточно кликов для обмена');
                        return Promise.reject('Недостаточно кликов у отправителя');
                    }
                    
                    if (toUser.clicks < trade.theirClicks) {
                        alert('У вас недостаточно кликов для обмена');
                        return Promise.reject('Недостаточно кликов у получателя');
                    }
                    
                    // Проверка улучшений у отправителя
                    const fromUpgradesCopy = [...fromUpgrades.items];
                    let fromBonusToRemove = 0;
                    
                    for (let tradeItem of trade.myItems) {
                        // Ищем улучшение с таким же значением
                        const upgradeIndex = fromUpgradesCopy.findIndex(upg => 
                            Math.abs(upg.value - tradeItem.value) < 0.001 && 
                            upg.rarity === tradeItem.rarity
                        );
                        
                        if (upgradeIndex === -1) {
                            alert('У отправителя нет одного из улучшений для обмена');
                            return Promise.reject('Недостаточно улучшений у отправителя');
                        }
                        
                        // Удаляем найденное улучшение
                        const removedUpgrade = fromUpgradesCopy.splice(upgradeIndex, 1)[0];
                        fromBonusToRemove += removedUpgrade.value;
                    }
                    
                    // Проверка улучшений у получателя
                    const toUpgradesCopy = [...toUpgrades.items];
                    let toBonusToRemove = 0;
                    
                    for (let tradeItem of trade.theirItems) {
                        // Ищем улучшение с таким же значением
                        const upgradeIndex = toUpgradesCopy.findIndex(upg => 
                            Math.abs(upg.value - tradeItem.value) < 0.001 && 
                            upg.rarity === tradeItem.rarity
                        );
                        
                        if (upgradeIndex === -1) {
                            alert('У вас нет одного из улучшений для обмена');
                            return Promise.reject('Недостаточно улучшений у получателя');
                        }
                        
                        // Удаляем найденное улучшение
                        const removedUpgrade = toUpgradesCopy.splice(upgradeIndex, 1)[0];
                        toBonusToRemove += removedUpgrade.value;
                    }
                    
                    // Выполнение обмена
                    // 1. Обмен кликами
                    const fromNewClicks = fromUser.clicks - trade.myClicks + trade.theirClicks;
                    const toNewClicks = toUser.clicks - trade.theirClicks + trade.myClicks;
                    
                    // 2. Обмен улучшениями
                    // Добавляем улучшения получателю (от отправителя)
                    trade.myItems.forEach(tradeItem => {
                        toUpgradesCopy.push({
                            value: tradeItem.value,
                            rarity: tradeItem.rarity,
                            rarityName: tradeItem.rarityName,
                            timestamp: Date.now()
                        });
                    });
                    
                    // Добавляем улучшения отправителю (от получателя)
                    trade.theirItems.forEach(tradeItem => {
                        fromUpgradesCopy.push({
                            value: tradeItem.value,
                            rarity: tradeItem.rarity,
                            rarityName: tradeItem.rarityName,
                            timestamp: Date.now()
                        });
                    });
                    
                    // Пересчитываем бонусы
                    const fromNewBonus = fromUpgradesCopy.reduce((sum, upg) => sum + upg.value, 0);
                    const toNewBonus = toUpgradesCopy.reduce((sum, upg) => sum + upg.value, 0);
                    
                    // Обновление данных в базе
                    return Promise.all([
                        fromUserRef.update({ 
                            clicks: Math.max(0, fromNewClicks),
                            bestScore: Math.max(fromUser.bestScore, Math.max(0, fromNewClicks))
                        }),
                        toUserRef.update({ 
                            clicks: Math.max(0, toNewClicks),
                            bestScore: Math.max(toUser.bestScore, Math.max(0, toNewClicks))
                        }),
                        database.ref('userUpgrades/' + trade.fromUserId).set({
                            items: fromUpgradesCopy,
                            totalBonus: fromNewBonus
                        }),
                        database.ref('userUpgrades/' + trade.toUserId).set({
                            items: toUpgradesCopy,
                            totalBonus: toNewBonus
                        }),
                        tradeRef.update({ status: 'accepted' })
                    ]);
                }).then(() => {
                    alert('Обмен успешно завершен!');
                    loadTradeOffers();
                    
                    // Обновление локального состояния
                    if (auth.currentUser) {
                        loadUserData(auth.currentUser.uid);
                        loadUpgrades();
                    }
                }).catch(error => {
                    console.error('Ошибка при обмене:', error);
                    if (typeof error === 'string') {
                        alert(error);
                    } else {
                        alert('Произошла ошибка при выполнении обмена');
                    }
                });
            });
        }

        // Отклонение предложения обмена
        function rejectTradeOffer(tradeId) {
            if (!confirm('Отклонить предложение обмена?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.update({ status: 'rejected' }).then(() => {
                alert('Предложение обмена отклонено');
                loadTradeOffers();
            });
        }

        // Отмена предложения обмена
        function cancelTradeOffer(tradeId) {
            if (!confirm('Отменить предложение обмена?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.update({ status: 'cancelled' }).then(() => {
                alert('Предложение обмена отменено');
                loadTradeOffers();
            });
        }

        // Обработка клика с учетом улучшений
        function handleClick() {
            if (isBlocked) return;
            
            const now = Date.now();
            clickTimestamps.push(now);
            
            // Удаление старых кликов (старше 1 секунды)
            clickTimestamps = clickTimestamps.filter(timestamp => now - timestamp < 1000);
            
            // Проверка CPS
            currentCPS = clickTimestamps.length;
            if (currentCPS > MAX_CPS) {
                blockUser();
                return;
            }
            
            // Обновление состояния игры с учетом улучшений
            const baseClickValue = 1 * gameState.clickMultiplier;
            const upgradeBonus = upgrades.totalBonus || 0;
            const clickValue = baseClickValue + upgradeBonus;
            
            gameState.clicks += clickValue;
            
            if (gameState.clicks > gameState.bestScore) {
                gameState.bestScore = gameState.clicks;
            }
            
            // Обновление отображения
            updateGameDisplay();
            
            // Сохранение состояния
            saveGameState();
            
            // Анимация клика
            animateClick();
        }

        // Переключение админ панели с проверкой кода
        function toggleAdminPanel() {
            if (!isAdmin) {
                alert('У вас нет прав администратора');
                return;
            }
            
            // Если админ, но код еще не введен, показываем модальное окно
            if (adminSection.style.display === 'none' || !adminSection.style.display) {
                showAdminCodeModal();
            } else {
                adminSection.style.display = 'none';
            }
        }

        // Сброс всех результатов и улучшений
        function resetAllScoresHandler() {
            if (!confirm('Вы уверены, что хотите обнулить все результаты и улучшения? Это действие нельзя отменить.')) {
                return;
            }
            
            const usersRef = database.ref('users');
            const upgradesRef = database.ref('userUpgrades');
            
            Promise.all([
                usersRef.once('value'),
                upgradesRef.once('value')
            ]).then(([usersSnapshot, upgradesSnapshot]) => {
                const usersUpdates = {};
                const upgradesUpdates = {};
                
                // Подготовка обновлений для пользователей
                const users = usersSnapshot.val();
                if (users) {
                    for (let userId in users) {
                        usersUpdates[`${userId}/clicks`] = 0;
                        usersUpdates[`${userId}/bestScore`] = 0;
                    }
                }
                
                // Подготовка обновлений для улучшений
                const upgrades = upgradesSnapshot.val();
                if (upgrades) {
                    for (let userId in upgrades) {
                        upgradesUpdates[`${userId}/totalBonus`] = 0;
                        upgradesUpdates[`${userId}/items`] = [];
                    }
                }
                
                // Выполняем все обновления
                return Promise.all([
                    usersUpdates ? usersRef.update(usersUpdates) : Promise.resolve(),
                    upgradesUpdates ? upgradesRef.update(upgradesUpdates) : Promise.resolve()
                ]);
            }).then(() => {
                alert('Все результаты и улучшения обнулены');
                loadUserList();
                loadLeaderboard();
                
                // Сброс локального состояния
                if (auth.currentUser) {
                    gameState.clicks = 0;
                    gameState.bestScore = 0;
                    upgrades.totalBonus = 0;
                    upgrades.items = [];
                    updateGameDisplay();
                    renderUpgradesList();
                    updateBonusDisplay();
                    saveGameState();
                }
            }).catch(error => {
                console.error('Ошибка при обнулении:', error);
                alert('Произошла ошибка при обнулении данных');
            });
        }

        // Блокировка пользователя за слишком быстрые клики
        function blockUser() {
            isBlocked = true;
            clickArea.classList.add('blocked');
            blockedOverlay.style.display = 'flex';
            cpsWarning.textContent = `СЛИШКОМ БЫСТРО! Подождите ${MAX_CPS/2} секунд`;
            
            blockTimeout = setTimeout(() => {
                isBlocked = false;
                clickArea.classList.remove('blocked');
                blockedOverlay.style.display = 'none';
                cpsWarning.textContent = '';
                clickTimestamps = [];
            }, (MAX_CPS/2) * 1000);
        }

        // Обновление CPS
        function updateCPS() {
            const now = Date.now();
            clickTimestamps = clickTimestamps.filter(timestamp => now - timestamp < 1000);
            currentCPS = clickTimestamps.length;
            
            cpsValue.textContent = currentCPS;
            
            // Обновление индикатора CPS
            const cpsPercentage = Math.min((currentCPS / MAX_CPS) * 100, 100);
            cpsFill.style.width = `${cpsPercentage}%`;
            
            // Цвет индикатора в зависимости от CPS
            if (currentCPS > MAX_CPS * 0.8) {
                cpsFill.style.background = 'linear-gradient(90deg, #FFC107, #F44336)';
            } else if (currentCPS > MAX_CPS * 0.5) {
                cpsFill.style.background = 'linear-gradient(90deg, #4CAF50, #FFC107)';
            } else {
                cpsFill.style.background = 'linear-gradient(90deg, #4CAF50, #4CAF50)';
            }
        }

        // Анимация клика
        function animateClick() {
            clickText.style.transform = 'scale(1.1)';
            setTimeout(() => {
                clickText.style.transform = 'scale(1)';
            }, 100);
        }

        // Обновление отображения игры
        function updateGameDisplay() {
            clickCount.textContent = Math.floor(gameState.clicks);
            bestScore.textContent = Math.floor(gameState.bestScore);
        }

        // Загрузка состояния игры
        function loadGameState() {
            // Если пользователь авторизован, загружаем из Firebase
            if (auth.currentUser) {
                loadUserData(auth.currentUser.uid);
            } else {
                // Иначе загружаем из localStorage
                const savedState = localStorage.getItem('clickerGameState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    gameState.clicks = parsedState.clicks || 0;
                    gameState.bestScore = parsedState.bestScore || 0;
                    updateGameDisplay();
                }
            }
        }

        // Сохранение состояния игры
        function saveGameState() {
            if (auth.currentUser) {
                // Сохраняем в Firebase
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.update({
                    clicks: Math.floor(gameState.clicks),
                    bestScore: Math.floor(gameState.bestScore),
                    lastActive: Date.now()
                });
            } else {
                // Сохраняем в localStorage
                localStorage.setItem('clickerGameState', JSON.stringify({
                    clicks: gameState.clicks,
                    bestScore: gameState.bestScore
                }));
            }
        }

        // Загрузка данных пользователя
        function loadUserData(userId) {
            const userRef = database.ref('users/' + userId);
            userRef.on('value', snapshot => {
                const userData = snapshot.val();
                if (userData) {
                    gameState.clicks = userData.clicks || 0;
                    gameState.bestScore = userData.bestScore || 0;
                    
                    // Обновление UI пользователя
                    userName.textContent = userData.nickname || userData.email.split('@')[0];
                    userAvatar.textContent = (userData.nickname || userData.email[0]).toUpperCase();
                    
                    if (userData.verified) {
                        userVerified.style.display = 'inline';
                    } else {
                        userVerified.style.display = 'none';
                    }
                    
                    changeNickname.style.display = 'block';
                    
                    updateGameDisplay();
                }
            });
        }

        // Загрузка лидерборда
        function loadLeaderboard() {
            const usersRef = database.ref('users');
            usersRef.orderByChild('bestScore').limitToLast(leaderboardLimit === 0 ? 1000 : leaderboardLimit).on('value', snapshot => {
                const users = snapshot.val();
                const leaderboardArray = [];
                
                for (let userId in users) {
                    if (users[userId].bestScore > 0) {
                        leaderboardArray.push({
                            id: userId,
                            email: users[userId].email,
                            nickname: users[userId].nickname,
                            clicks: users[userId].clicks || 0,
                            bestScore: users[userId].bestScore || 0,
                            verified: users[userId].verified || false
                        });
                    }
                }
                
                // Сортировка по bestScore (по убыванию)
                leaderboardArray.sort((a, b) => b.bestScore - a.bestScore);
                
                // Ограничение количества записей
                if (leaderboardLimit > 0) {
                    leaderboardArray.splice(leaderboardLimit);
                }
                
                // Отрисовка лидерборда
                renderLeaderboard(leaderboardArray);
            });
        }

        // Отрисовка лидерборда
        function renderLeaderboard(users) {
            leaderboard.innerHTML = '';
            
            users.forEach((user, index) => {
                const isCurrentUser = auth.currentUser && user.id === auth.currentUser.uid;
                const listItem = document.createElement('li');
                listItem.className = `leaderboard-item ${isCurrentUser ? 'current-user' : ''}`;
                
                listItem.innerHTML = `
                    <div class="rank">${index + 1}</div>
                    <div class="player-name">
                        <span>${user.nickname || user.email.split('@')[0]}</span>
                        ${user.verified ? '<span class="verified-badge">✓</span>' : ''}
                        ${isCurrentUser ? '<span style="color: #fdbb2d; margin-left: 5px;">(Вы)</span>' : ''}
                    </div>
                    <div class="player-score">${Math.floor(user.bestScore)}</div>
                `;
                
                if (isAdmin) {
                    const adminBtn = document.createElement('button');
                    adminBtn.textContent = 'Ред.';
                    adminBtn.style.padding = '5px 10px';
                    adminBtn.style.fontSize = '0.7rem';
                    adminBtn.addEventListener('click', () => editUser(user));
                    listItem.appendChild(adminBtn);
                }
                
                leaderboard.appendChild(listItem);
            });
            
            // Если нет пользователей
            if (users.length === 0) {
                const listItem = document.createElement('li');
                listItem.className = 'leaderboard-item';
                listItem.innerHTML = '<div style="text-align: center; width: 100%;">Нет данных для отображения</div>';
                leaderboard.appendChild(listItem);
            }
        }

        // Изменение лимита лидерборда
        function changeLeaderboardLimit(limit) {
            leaderboardLimit = limit;
            
            // Обновление активной кнопки
            showTop10.classList.remove('active');
            showTop25.classList.remove('active');
            showAll.classList.remove('active');
            
            if (limit === 10) showTop10.classList.add('active');
            if (limit === 25) showTop25.classList.add('active');
            if (limit === 0) showAll.classList.add('active');
            
            // Перезагрузка лидерборда
            loadLeaderboard();
        }

        // Показать модальное окно аутентификации
        function showAuthModal(type) {
            authModal.style.display = 'flex';
            if (type === 'login') {
                authModalTitle.textContent = 'Вход в аккаунт';
                authSubmit.textContent = 'Войти';
            } else {
                authModalTitle.textContent = 'Регистрация аккаунта';
                authSubmit.textContent = 'Зарегистрироваться';
            }
            
            currentAction = type;
        }

        // Скрыть модальное окно аутентификации
        function hideAuthModal() {
            authModal.style.display = 'none';
            authEmail.value = '';
            authPassword.value = '';
        }

        // Обработка аутентификации
        function handleAuthSubmit() {
            const email = authEmail.value;
            const password = authPassword.value;
            
            if (!email || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            if (currentAction === 'login') {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        hideAuthModal();
                    })
                    .catch(error => {
                        alert('Ошибка входа: ' + error.message);
                    });
            } else {
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        // Создание записи пользователя в базе данных
                        const user = userCredential.user;
                        const userRef = database.ref('users/' + user.uid);
                        
                        userRef.set({
                            email: email,
                            nickname: email.split('@')[0],
                            clicks: 0,
                            bestScore: 0,
                            registered: Date.now(),
                            lastActive: Date.now(),
                            verified: false
                        });
                        
                        hideAuthModal();
                        showNicknameModal();
                    })
                    .catch(error => {
                        alert('Ошибка регистрации: ' + error.message);
                    });
            }
        }

        // Выход из системы
        function handleLogout() {
            auth.signOut();
        }

        // Показать модальное окно изменения никнейма
        function showNicknameModal() {
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.once('value').then(snapshot => {
                    const userData = snapshot.val();
                    nicknameInput.value = userData.nickname || '';
                    nicknameModal.style.display = 'flex';
                });
            }
        }

        // Скрыть модальное окно изменения никнейма
        function hideNicknameModal() {
            nicknameModal.style.display = 'none';
        }

        // Сохранение никнейма
        function saveNicknameHandler() {
            const nickname = nicknameInput.value.trim();
            
            if (!nickname) {
                alert('Пожалуйста, введите никнейм');
                return;
            }
            
            if (nickname.length > 15) {
                alert('Никнейм не может быть длиннее 15 символов');
                return;
            }
            
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.update({
                    nickname: nickname
                }).then(() => {
                    hideNicknameModal();
                    userName.textContent = nickname;
                    userAvatar.textContent = nickname[0].toUpperCase();
                });
            }
        }

        // Загрузка списка пользователей
        function loadUserList() {
            if (!isAdmin) return;
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const usersArray = [];
                
                for (let userId in users) {
                    usersArray.push({
                        id: userId,
                        email: users[userId].email,
                        nickname: users[userId].nickname,
                        clicks: users[userId].clicks || 0,
                        bestScore: users[userId].bestScore || 0,
                        verified: users[userId].verified || false,
                        lastActive: users[userId].lastActive || 0
                    });
                }
                
                // Сортировка по последней активности
                usersArray.sort((a, b) => b.lastActive - a.lastActive);
                
                // Отрисовка списка пользователей
                renderUserList(usersArray);
            });
        }

        // Отрисовка списка пользователей
        function renderUserList(users) {
            userList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString('ru-RU') : 'Никогда';
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div>${user.nickname || user.email.split('@')[0]} ${user.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">Клики: ${user.clicks} | Лучший: ${user.bestScore} | Активен: ${lastActive}</div>
                    </div>
                    <div class="user-actions">
                        <button class="edit-user">Ред.</button>
                    </div>
                `;
                
                const editBtn = userItem.querySelector('.edit-user');
                editBtn.addEventListener('click', () => editUser(user));
                
                userList.appendChild(userItem);
            });
        }

        // Редактирование пользователя
        function editUser(user) {
            selectedUser = user;
            adminModalTitle.textContent = `Редактирование: ${user.nickname || user.email.split('@')[0]}`;
            adminUserInfo.innerHTML = `
                <div>Email: ${user.email}</div>
                <div>Никнейм: ${user.nickname || 'Не установлен'}</div>
                <div>Клики: ${user.clicks}</div>
                <div>Лучший результат: ${user.bestScore}</div>
                <div>Верифицирован: ${user.verified ? 'Да' : 'Нет'}</div>
            `;
            adminClicksInput.value = user.clicks;
            adminBestScoreInput.value = user.bestScore;
            adminModal.style.display = 'flex';
        }

        // Скрыть модальное окно админа
        function hideAdminModal() {
            adminModal.style.display = 'none';
            selectedUser = null;
        }

        // Сохранение изменений пользователя
        function saveUserChanges() {
            if (!selectedUser) return;
            
            const newClicks = parseInt(adminClicksInput.value) || 0;
            const newBestScore = parseInt(adminBestScoreInput.value) || 0;
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.update({
                clicks: newClicks,
                bestScore: newBestScore
            }).then(() => {
                alert('Изменения сохранены');
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // Удаление пользователя
        function deleteUser() {
            if (!selectedUser || !confirm(`Вы уверены, что хотите удалить пользователя ${selectedUser.email}?`)) {
                return;
            }
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.remove().then(() => {
                alert('Пользователь удален');
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // Переключение верификации пользователя
        function toggleUserVerified() {
            if (!selectedUser) return;
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.update({
                verified: !selectedUser.verified
            }).then(() => {
                alert(`Верификация ${!selectedUser.verified ? 'включена' : 'отключена'}`);
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // Удаление неактивных пользователей
        function deleteInactiveUsers() {
            if (!confirm('Удалить всех пользователей, которые не были активны более 30 дней?')) {
                return;
            }
            
            const monthAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const usersRef = database.ref('users');
            
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                let deletedCount = 0;
                
                for (let userId in users) {
                    if (!users[userId].lastActive || users[userId].lastActive < monthAgo) {
                        usersRef.child(userId).remove();
                        deletedCount++;
                    }
                }
                
                alert(`Удалено ${deletedCount} неактивных пользователей`);
                loadUserList();
                loadLeaderboard();
            });
        }

        // Показать модальное окно кастомных кликов
        function showCustomClicksModal(type) {
            currentAction = type;
            
            if (type === 'all') {
                customClicksTitle.textContent = 'Добавить клики всем пользователям';
            } else if (type === 'online') {
                customClicksTitle.textContent = 'Добавить клики онлайн пользователям';
            } else if (type === 'me') {
                customClicksTitle.textContent = 'Добавить клики себе';
            }
            
            customClicksModal.style.display = 'flex';
        }

        // Скрыть модальное окно кастомных кликов
        function hideCustomClicksModal() {
            customClicksModal.style.display = 'none';
            customClicksInput.value = '';
        }

        // Обработка добавления кастомных кликов
        function confirmCustomClicksHandler() {
            const clicksToAdd = parseInt(customClicksInput.value) || 0;
            
            if (clicksToAdd <= 0) {
                alert('Пожалуйста, введите положительное число');
                return;
            }
            
            if (currentAction === 'all') {
                addClicksToAllUsers(clicksToAdd);
            } else if (currentAction === 'online') {
                addClicksToOnlineUsers(clicksToAdd);
            } else if (currentAction === 'me') {
                addClicksToMe(clicksToAdd);
            }
            
            hideCustomClicksModal();
        }

        // Добавление кликов всем пользователям
        function addClicksToAllUsers(clicksToAdd) {
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const updates = {};
                
                for (let userId in users) {
                    const currentClicks = users[userId].clicks || 0;
                    const currentBest = users[userId].bestScore || 0;
                    const newClicks = currentClicks + clicksToAdd;
                    const newBest = Math.max(currentBest, newClicks);
                    
                    updates[`${userId}/clicks`] = newClicks;
                    updates[`${userId}/bestScore`] = newBest;
                }
                
                usersRef.update(updates).then(() => {
                    alert(`Добавлено ${clicksToAdd} кликов всем пользователям`);
                    loadUserList();
                    loadLeaderboard();
                    
                    // Обновление локального состояния
                    if (auth.currentUser) {
                        gameState.clicks += clicksToAdd;
                        gameState.bestScore = Math.max(gameState.bestScore, gameState.clicks);
                        updateGameDisplay();
                        saveGameState();
                    }
                });
            });
        }

        // Добавление кликов онлайн пользователям
        function addClicksToOnlineUsers(clicksToAdd) {
            // В реальном приложении здесь была бы логика определения онлайн пользователей
            // Для демонстрации добавим клики всем пользователям с последней активностью за последние 10 минут
            const tenMinutesAgo = Date.now() - (10 * 60 * 1000);
            const usersRef = database.ref('users');
            
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const updates = {};
                let affectedUsers = 0;
                
                for (let userId in users) {
                    if (users[userId].lastActive && users[userId].lastActive > tenMinutesAgo) {
                        const currentClicks = users[userId].clicks || 0;
                        const currentBest = users[userId].bestScore || 0;
                        const newClicks = currentClicks + clicksToAdd;
                        const newBest = Math.max(currentBest, newClicks);
                        
                        updates[`${userId}/clicks`] = newClicks;
                        updates[`${userId}/bestScore`] = newBest;
                        affectedUsers++;
                    }
                }
                
                usersRef.update(updates).then(() => {
                    alert(`Добавлено ${clicksToAdd} кликов ${affectedUsers} онлайн пользователям`);
                    loadUserList();
                    loadLeaderboard();
                    
                    // Обновление локального состояния
                    if (auth.currentUser) {
                        gameState.clicks += clicksToAdd;
                        gameState.bestScore = Math.max(gameState.bestScore, gameState.clicks);
                        updateGameDisplay();
                        saveGameState();
                    }
                });
            });
        }

        // Добавление кликов себе
        function addClicksToMe(clicksToAdd) {
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.once('value').then(snapshot => {
                    const userData = snapshot.val();
                    const currentClicks = userData.clicks || 0;
                    const currentBest = userData.bestScore || 0;
                    const newClicks = currentClicks + clicksToAdd;
                    const newBest = Math.max(currentBest, newClicks);
                    
                    userRef.update({
                        clicks: newClicks,
                        bestScore: newBest
                    }).then(() => {
                        alert(`Добавлено ${clicksToAdd} кликов вашему аккаунту`);
                        
                        // Обновление локального состояния
                        gameState.clicks = newClicks;
                        gameState.bestScore = newBest;
                        updateGameDisplay();
                    });
                });
            }
        }

        // Обработчики быстрых действий с кликами
        function addClicksToOnlineHandler() {
            const clicksToAdd = parseInt(clicksToOnlineInput.value) || 0;
            if (clicksToAdd > 0) {
                addClicksToOnlineUsers(clicksToAdd);
            }
        }

        function addMyClicksHandler() {
            const clicksToAdd = parseInt(clicksToMeInput.value) || 0;
            if (clicksToAdd > 0) {
                addClicksToMe(clicksToAdd);
            }
        }

        // Показать модальное окно событий
        function showEventModal() {
            if (!isAdmin) {
                alert('Только администраторы могут создавать события');
                return;
            }
            eventModal.style.display = 'flex';
        }

        // Скрыть модальное окно событий
        function hideEventModal() {
            eventModal.style.display = 'none';
        }

        // Запуск события
        function startEventHandler() {
            const multiplier = parseFloat(eventMultiplier.value);
            const duration = parseInt(eventDuration.value);
            
            if (!isAdmin) {
                alert('Только администраторы могут запускать события');
                return;
            }
            
            // Сохранение события в базу данных
            const eventRef = database.ref('currentEvent');
            const eventData = {
                multiplier: multiplier,
                endTime: Date.now() + (duration * 60 * 1000),
                active: true,
                startedBy: auth.currentUser.email,
                startTime: Date.now(),
                duration: duration
            };
            
            eventRef.set(eventData).then(() => {
                alert(`Событие запущено! Множитель: ${multiplier}x, Длительность: ${duration} минут`);
                hideEventModal();
                showEventNotification(eventData);
                
                // Отправка сообщения в чат о запуске события
                sendSystemMessage(`🎉 Администратор запустил событие! Все клики умножаются на ${multiplier}x на ${duration} минут!`);
            });
        }

        // Остановка события
        function stopEventHandler() {
            if (!isAdmin) {
                alert('Только администраторы могут останавливать события');
                return;
            }
            
            const eventRef = database.ref('currentEvent');
            eventRef.update({
                active: false
            }).then(() => {
                alert('Событие остановлено');
                hideEventModal();
                eventNotification.style.display = 'none';
                gameState.clickMultiplier = 1;
                
                // Отправка сообщения в чат об остановке события
                sendSystemMessage('Событие завершено. Множитель кликов сброшен.');
            });
        }

        // Проверка активного события
        function checkActiveEvent() {
            const eventRef = database.ref('currentEvent');
            eventRef.once('value').then(snapshot => {
                const eventData = snapshot.val();
                
                if (eventData && eventData.active) {
                    const timeLeft = eventData.endTime - Date.now();
                    
                    if (timeLeft > 0) {
                        // Событие активно
                        gameState.clickMultiplier = eventData.multiplier;
                        showEventNotification(eventData);
                    } else {
                        // Событие истекло
                        gameState.clickMultiplier = 1;
                        eventRef.update({ active: false });
                        eventNotification.style.display = 'none';
                    }
                } else {
                    // Нет активного события
                    gameState.clickMultiplier = 1;
                    eventNotification.style.display = 'none';
                }
            });
        }

        // Показать уведомление о событии
        function showEventNotification(eventData) {
            const timeLeft = Math.max(0, eventData.endTime - Date.now());
            const minutes = Math.floor(timeLeft / (60 * 1000));
            const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
            
            eventNotification.innerHTML = `
                <strong>АКТИВНОЕ СОБЫТИЕ!</strong> Все клики умножаются на ${eventData.multiplier}x! 
                Осталось времени: <span id="eventTimer">${minutes}:${seconds < 10 ? '0' : ''}${seconds}</span>
                ${isAdmin ? `<br><button onclick="stopEventHandler()" style="margin-top: 5px; padding: 5px 10px; font-size: 0.8rem;">Остановить</button>` : ''}
            `;
            eventNotification.style.display = 'block';
            
            // Таймер обратного отсчета
            const eventTimer = setInterval(() => {
                const timeLeft = Math.max(0, eventData.endTime - Date.now());
                const minutes = Math.floor(timeLeft / (60 * 1000));
                const seconds = Math.floor((timeLeft % (60 * 1000)) / 1000);
                
                const timerElement = document.getElementById('eventTimer');
                if (timerElement) {
                    timerElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(eventTimer);
                    eventNotification.style.display = 'none';
                    gameState.clickMultiplier = 1;
                }
            }, 1000);
        }

        // Загрузка и отображение чата
        function loadChat() {
            const chatRef = database.ref('chat').limitToLast(50);
            chatRef.on('value', snapshot => {
                const messages = snapshot.val();
                chatMessages.innerHTML = '';
                
                if (messages) {
                    const messagesArray = Object.values(messages);
                    messagesArray.sort((a, b) => a.timestamp - b.timestamp);
                    
                    messagesArray.forEach(message => {
                        addMessageToChat(message);
                    });
                }
                
                // Прокрутка вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Добавление сообщения в чат
        function addMessageToChat(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.type === 'admin' ? 'admin-action' : ''} ${message.type === 'system' ? 'system' : ''}`;
            
            const senderSpan = document.createElement('div');
            senderSpan.className = 'message-sender';
            
            const senderName = document.createElement('span');
            senderName.textContent = message.senderName;
            
            senderSpan.appendChild(senderName);
            
            if (message.verified) {
                const verifiedBadge = document.createElement('span');
                verifiedBadge.className = 'verified-badge';
                verifiedBadge.textContent = '✓';
                senderSpan.appendChild(verifiedBadge);
            }
            
            if (message.type === 'admin') {
                const adminBadge = document.createElement('span');
                adminBadge.className = 'admin-badge-chat';
                adminBadge.textContent = 'ADMIN';
                senderSpan.appendChild(adminBadge);
            }
            
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message.text;
            
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(textDiv);
            
            chatMessages.appendChild(messageDiv);
        }

        // Отправка сообщения в чат
        function sendChatMessage() {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы отправлять сообщения');
                return;
            }
            
            const messageText = chatInput.value.trim();
            if (!messageText) return;
            
            if (messageText.length > 200) {
                alert('Сообщение не может быть длиннее 200 символов');
                return;
            }
            
            // Получение данных пользователя
            const userRef = database.ref('users/' + auth.currentUser.uid);
            userRef.once('value').then(snapshot => {
                const userData = snapshot.val();
                
                // Сохранение сообщения
                const chatRef = database.ref('chat').push();
                chatRef.set({
                    senderId: auth.currentUser.uid,
                    senderName: userData.nickname || userData.email.split('@')[0],
                    text: messageText,
                    timestamp: Date.now(),
                    type: isAdmin ? 'admin' : 'user',
                    verified: userData.verified || false
                }).then(() => {
                    chatInput.value = '';
                });
            });
        }

        // Отправка системного сообщения
        function sendSystemMessage(message) {
            const chatRef = database.ref('chat').push();
            chatRef.set({
                senderId: 'system',
                senderName: 'Система',
                text: message,
                timestamp: Date.now(),
                type: 'system',
                verified: false
            });
        }

        // Загрузка списка друзей
        function loadFriends() {
            if (!auth.currentUser) return;
            
            const friendsRef = database.ref('friends/' + auth.currentUser.uid);
            friendsRef.on('value', snapshot => {
                const friends = snapshot.val();
                friendsList.innerHTML = '';
                
                if (friends) {
                    // Получение данных о каждом друге
                    Object.keys(friends).forEach(friendId => {
                        const userRef = database.ref('users/' + friendId);
                        userRef.once('value').then(snapshot => {
                            const userData = snapshot.val();
                            if (userData) {
                                addFriendToList(friendId, userData, friends[friendId]);
                            }
                        });
                    });
                } else {
                    friendsList.innerHTML = '<div style="text-align: center; padding: 20px;">У вас пока нет друзей</div>';
                }
            });
        }

        // Добавление друга в список
        function addFriendToList(friendId, userData, status) {
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            friendItem.id = `friend-${friendId}`;
            
            const friendInfo = document.createElement('div');
            friendInfo.className = 'friend-info';
            
            const friendAvatar = document.createElement('div');
            friendAvatar.className = 'friend-avatar';
            friendAvatar.textContent = (userData.nickname || userData.email[0]).toUpperCase();
            
            const friendName = document.createElement('div');
            friendName.innerHTML = `
                <div>${userData.nickname || userData.email.split('@')[0]} ${userData.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                <div style="font-size: 0.8rem; opacity: 0.7;">Клики: ${userData.clicks || 0} | Лучший: ${userData.bestScore || 0}</div>
            `;
            
            friendInfo.appendChild(friendAvatar);
            friendInfo.appendChild(friendName);
            
            const friendActions = document.createElement('div');
            friendActions.className = 'friend-actions';
            
            if (status === 'pending') {
                const acceptBtn = document.createElement('button');
                acceptBtn.textContent = 'Принять';
                acceptBtn.addEventListener('click', () => acceptFriendRequest(friendId));
                
                const declineBtn = document.createElement('button');
                declineBtn.textContent = 'Отклонить';
                declineBtn.addEventListener('click', () => removeFriend(friendId));
                
                friendActions.appendChild(acceptBtn);
                friendActions.appendChild(declineBtn);
            } else {
                const removeBtn = document.createElement('button');
                removeBtn.textContent = 'Удалить';
                removeBtn.addEventListener('click', () => removeFriend(friendId));
                
                friendActions.appendChild(removeBtn);
            }
            
            friendItem.appendChild(friendInfo);
            friendItem.appendChild(friendActions);
            
            friendsList.appendChild(friendItem);
        }

        // Показать модальное окно добавления друга
        function showFriendsModal() {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы добавлять друзей');
                return;
            }
            
            friendsModal.style.display = 'flex';
            friendSearchResults.innerHTML = '';
        }

        // Скрыть модальное окно добавления друга
        function hideFriendsModal() {
            friendsModal.style.display = 'none';
            friendSearchInput.value = '';
            friendSearchResults.innerHTML = '';
        }

        // Поиск друга
        function searchFriendHandler() {
            const searchTerm = friendSearchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                alert('Введите email или никнейм для поиска');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const results = [];
                
                for (let userId in users) {
                    if (userId === auth.currentUser.uid) continue; // Пропустить себя
                    
                    const user = users[userId];
                    const emailMatch = user.email.toLowerCase().includes(searchTerm);
                    const nicknameMatch = user.nickname && user.nickname.toLowerCase().includes(searchTerm);
                    
                    if (emailMatch || nicknameMatch) {
                        results.push({
                            id: userId,
                            email: user.email,
                            nickname: user.nickname,
                            clicks: user.clicks || 0,
                            bestScore: user.bestScore || 0,
                            verified: user.verified || false
                        });
                    }
                }
                
                displayFriendSearchResults(results);
            });
        }

        // Отображение результатов поиска друзей
        function displayFriendSearchResults(results) {
            friendSearchResults.innerHTML = '';
            
            if (results.length === 0) {
                friendSearchResults.innerHTML = '<div style="text-align: center; padding: 10px;">Пользователи не найдены</div>';
                return;
            }
            
            results.forEach(user => {
                const resultItem = document.createElement('div');
                resultItem.className = 'user-item';
                resultItem.style.marginBottom = '10px';
                
                resultItem.innerHTML = `
                    <div class="user-info">
                        <div>${user.nickname || user.email.split('@')[0]} ${user.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">Клики: ${user.clicks} | Лучший: ${user.bestScore}</div>
                    </div>
                    <div class="user-actions">
                        <button class="add-friend">Добавить</button>
                    </div>
                `;
                
                const addBtn = resultItem.querySelector('.add-friend');
                addBtn.addEventListener('click', () => sendFriendRequest(user.id));
                
                friendSearchResults.appendChild(resultItem);
            });
        }

        // Отправка запроса на дружбу
        function sendFriendRequest(friendId) {
            const myFriendsRef = database.ref('friends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('friends/' + friendId + '/' + auth.currentUser.uid);
            
            // Проверка, не отправили ли мы уже запрос
            myFriendsRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    alert('Вы уже отправили запрос этому пользователю');
                    return;
                }
                
                // Отправка запроса
                myFriendsRef.set('pending').then(() => {
                    theirFriendsRef.set('request').then(() => {
                        alert('Запрос на дружбу отправлен');
                        hideFriendsModal();
                    });
                });
            });
        }

        // Принятие запроса на дружбу
        function acceptFriendRequest(friendId) {
            const myFriendsRef = database.ref('friends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('friends/' + friendId + '/' + auth.currentUser.uid);
            
            myFriendsRef.set('accepted').then(() => {
                theirFriendsRef.set('accepted').then(() => {
                    alert('Запрос на дружбу принят');
                    loadFriends();
                });
            });
        }

        // Удаление друга
        function removeFriend(friendId) {
            if (!confirm('Удалить этого пользователя из друзей?')) {
                return;
            }
            
            const myFriendsRef = database.ref('friends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('friends/' + friendId + '/' + auth.currentUser.uid);
            
            myFriendsRef.remove().then(() => {
                theirFriendsRef.remove().then(() => {
                    alert('Пользователь удален из друзей');
                    loadFriends();
                });
            });
        }

        // Запуск приложения
        initApp();
    </script>
</body>
</html>