<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>FireChat - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FireChat">
    <meta name="application-name" content="FireChat">
    <meta name="msapplication-TileColor" content="#f97316">
    <meta name="description" content="–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–∞ Firebase">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkZpcmVDaGF0IC0g0JzQtdGB0YHQtdC90LTQttC10YAiLAogICJzaG9ydF9uYW1lIjogIkZpcmVDaGF0IiwKICAiZGVzY3JpcHRpb24iOiAi0JzQtdGB0YHQtdC90LTQttC10YAg0L3QsCBGaXJlYmFzZSIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzExMTgyNyIsCiAgInRoZW1lX2NvbG9yIjogIiMxZjI5MzciLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCwlM0NzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCclM0UlM0NyZWN0IHdpZHRoPScxMDAnIGhlaWdodD0nMTAwJyByeD0nMjAnIGZpbGw9JyVjMmY5NzMxNiclMkYlM0UlM0N0ZXh0IHg9JzUwJyB5PSc2NScgZm9udC1zaXplPSc1MCcgdGV4dC1hbmNob3I9J21pZGRsZSclM0UlRjAlOUYlOTQlQTUlM0MlMkZ0ZXh0JTNFJTNDJTJGc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0KfQ==">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .message-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        .online-pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .loader {
            border: 3px solid #374151;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="loader mx-auto mb-4"></div>
            <p class="text-gray-400">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</p>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="authScreen" class="min-h-screen flex items-center justify-center p-4 hidden">
        <div class="bg-gray-800 rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-white mb-2">üî• FireChat</h1>
                <p class="text-gray-400">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</p>
            </div>
            
            <div id="authTabs" class="flex mb-6 bg-gray-700 rounded-xl p-1">
                <button onclick="showTab('login')" id="loginTab" class="flex-1 py-2 rounded-lg text-white font-medium bg-orange-500">–í—Ö–æ–¥</button>
                <button onclick="showTab('register')" id="registerTab" class="flex-1 py-2 rounded-lg text-gray-400 font-medium">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            </div>
            
            <form id="authForm" class="space-y-4">
                <div id="nameField" class="hidden">
                    <label class="block text-sm font-medium text-gray-300 mb-2">–ò–º—è</label>
                    <input type="text" id="userName" placeholder="–í–∞—à–µ –∏–º—è" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                    <input type="email" id="userEmail" placeholder="example@mail.com" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">–ü–∞—Ä–æ–ª—å</label>
                    <input type="password" id="userPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                
                <div id="authError" class="text-red-400 text-sm hidden"></div>
                
                <button type="submit" id="authBtn" class="w-full py-4 bg-gradient-to-r from-orange-500 to-yellow-500 text-white font-semibold rounded-xl hover:opacity-90 transition-opacity disabled:opacity-50">
                    <span id="authBtnText">–í–æ–π—Ç–∏</span>
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-gray-500 text-sm">Powered by Firebase üî•</p>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
    <div id="chatScreen" class="min-h-screen flex hidden">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div id="sidebar" class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col max-md:absolute max-md:z-50 max-md:h-full max-md:hidden">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-xl font-bold text-white">üî• FireChat</h1>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleSidebar()" class="md:hidden p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                        <button onclick="logout()" class="p-2 text-gray-400 hover:text-white rounded-lg hover:bg-gray-700" title="–í—ã–π—Ç–∏">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <div class="flex items-center space-x-3 p-3 bg-gray-700/50 rounded-xl">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center text-white font-bold" id="userAvatar">U</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium truncate" id="currentUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</p>
                        <p class="text-green-400 text-sm flex items-center">
                            <span class="w-2 h-2 bg-green-400 rounded-full mr-2 online-pulse"></span>
                            –í —Å–µ—Ç–∏
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="p-4">
                <div class="relative">
                    <input type="text" id="searchUsers" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π..." oninput="searchUsers(this.value)" class="w-full px-4 py-3 pl-10 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500">
                    <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="flex-1 overflow-y-auto scrollbar-thin px-4" id="usersList">
                <p class="text-gray-500 text-sm mb-2">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω</p>
            </div>
            
            <!-- –û–±—â–∏–π —á–∞—Ç -->
            <div class="p-4 border-t border-gray-700">
                <button onclick="openChat('general', '–û–±—â–∏–π —á–∞—Ç')" id="generalChatBtn" class="w-full flex items-center space-x-3 p-3 bg-gradient-to-r from-orange-500/20 to-yellow-500/20 rounded-xl hover:from-orange-500/30 hover:to-yellow-500/30 transition-colors border border-orange-500/30">
                    <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <div class="flex-1 text-left">
                        <p class="text-white font-medium">–û–±—â–∏–π —á–∞—Ç</p>
                        <p class="text-gray-400 text-sm">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>
                    </div>
                    <span id="generalUnread" class="hidden bg-orange-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                </button>
            </div>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="flex-1 flex flex-col bg-gray-900">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
            <div id="chatHeader" class="p-4 bg-gray-800 border-b border-gray-700 flex items-center space-x-4">
                <button onclick="toggleSidebar()" class="md:hidden p-2 text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
                <div id="chatInfo" class="flex items-center space-x-3">
                    <div id="chatAvatar" class="w-10 h-10 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center text-white font-bold">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-white font-semibold" id="chatTitle">–û–±—â–∏–π —á–∞—Ç</h2>
                        <p class="text-gray-400 text-sm" id="chatSubtitle">–û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></p>
                    </div>
                </div>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-thin" id="messagesContainer">
                <div class="flex justify-center">
                    <span class="px-4 py-2 bg-gray-800 rounded-full text-gray-400 text-sm">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!</span>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
            <div id="typingIndicator" class="px-4 py-2 hidden">
                <div class="flex items-center space-x-2 text-gray-400">
                    <div class="typing-indicator flex space-x-1">
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                    </div>
                    <span class="text-sm" id="typingUser">–ö—Ç–æ-—Ç–æ –ø–µ—á–∞—Ç–∞–µ—Ç...</span>
                </div>
            </div>

            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
            <div class="p-4 bg-gray-800 border-t border-gray-700">
                <form id="messageForm" class="flex items-center space-x-4">
                    <button type="button" onclick="addEmoji()" class="p-3 text-gray-400 hover:text-white rounded-xl hover:bg-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </button>
                    <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-orange-500" autocomplete="off">
                    <button type="submit" class="p-3 bg-gradient-to-r from-orange-500 to-yellow-500 text-white rounded-xl hover:opacity-90 transition-opacity">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Emoji picker -->
    <div id="emojiPicker" class="hidden fixed bottom-24 left-4 bg-gray-800 rounded-xl p-3 shadow-2xl border border-gray-700 z-50">
        <div class="grid grid-cols-8 gap-2">
            <button onclick="insertEmoji('üòÄ')" class="text-2xl hover:bg-gray-700 rounded p-1">üòÄ</button>
            <button onclick="insertEmoji('üòÇ')" class="text-2xl hover:bg-gray-700 rounded p-1">üòÇ</button>
            <button onclick="insertEmoji('üòç')" class="text-2xl hover:bg-gray-700 rounded p-1">üòç</button>
            <button onclick="insertEmoji('ü§î')" class="text-2xl hover:bg-gray-700 rounded p-1">ü§î</button>
            <button onclick="insertEmoji('üòé')" class="text-2xl hover:bg-gray-700 rounded p-1">üòé</button>
            <button onclick="insertEmoji('üëç')" class="text-2xl hover:bg-gray-700 rounded p-1">üëç</button>
            <button onclick="insertEmoji('‚ù§Ô∏è')" class="text-2xl hover:bg-gray-700 rounded p-1">‚ù§Ô∏è</button>
            <button onclick="insertEmoji('üî•')" class="text-2xl hover:bg-gray-700 rounded p-1">üî•</button>
            <button onclick="insertEmoji('üëã')" class="text-2xl hover:bg-gray-700 rounded p-1">üëã</button>
            <button onclick="insertEmoji('üéâ')" class="text-2xl hover:bg-gray-700 rounded p-1">üéâ</button>
            <button onclick="insertEmoji('üí™')" class="text-2xl hover:bg-gray-700 rounded p-1">üí™</button>
            <button onclick="insertEmoji('üôè')" class="text-2xl hover:bg-gray-700 rounded p-1">üôè</button>
            <button onclick="insertEmoji('üòä')" class="text-2xl hover:bg-gray-700 rounded p-1">üòä</button>
            <button onclick="insertEmoji('ü§ù')" class="text-2xl hover:bg-gray-700 rounded p-1">ü§ù</button>
            <button onclick="insertEmoji('‚ú®')" class="text-2xl hover:bg-gray-700 rounded p-1">‚ú®</button>
            <button onclick="insertEmoji('üöÄ')" class="text-2xl hover:bg-gray-700 rounded p-1">üöÄ</button>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDz77Oq7_-xFhsidbjrsqAqdkmPW7IbRss",
            authDomain: "messengerdod.firebaseapp.com",
            // –ü–æ–ø—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π URL, –Ω–æ –µ—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏
            databaseURL: "https://messengerdod-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "messengerdod",
            storageBucket: "messengerdod.firebasestorage.app",
            messagingSenderId: "788226343834",
            appId: "1:788226343834:web:5d6b540d088ab8f703b023",
            measurementId: "G-J5Z80F7RY4"
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let app = {
            auth: null,
            database: null,
            currentUser: null,
            currentChat: null, // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ null
            currentChatName: '–û–±—â–∏–π —á–∞—Ç',
            messages: {},
            users: {},
            activeListeners: [] // –ú–∞—Å—Å–∏–≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        function initApp() {
            try {
                firebase.initializeApp(firebaseConfig);
                app.auth = firebase.auth();
                app.database = firebase.database();
                
                setupAuthListener();
                checkDatabaseConnection();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', error);
                alert('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase: ' + error.message);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
        function checkDatabaseConnection() {
            const connectedRef = app.database.ref('.info/connected');
            let isConnected = false;
            
            connectedRef.on('value', (snap) => {
                if (snap.val() === true) {
                    isConnected = true;
                    console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö');
                    document.getElementById('dbErrorBanner')?.remove();
                } else {
                    console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
                }
            });

            setTimeout(() => {
                if (!isConnected && app.currentUser) {
                    showDbError();
                }
            }, 5000);
        }

        function showDbError() {
            if (document.getElementById('dbErrorBanner')) return;
            
            const banner = document.createElement('div');
            banner.id = 'dbErrorBanner';
            banner.className = 'fixed top-0 left-0 w-full bg-red-600 text-white p-4 z-[100] shadow-lg flex justify-between items-center';
            banner.innerHTML = `
                <div>
                    <p class="font-bold">‚ö†Ô∏è –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</p>
                    <p class="text-sm opacity-90">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å–æ–∑–¥–∞–ª–∏ –ª–∏ –≤—ã Realtime Database –≤ –∫–æ–Ω—Å–æ–ª–∏ Firebase –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ URL.</p>
                </div>
                <button onclick="this.parentElement.remove()" class="p-2 hover:bg-red-700 rounded">‚úï</button>
            `;
            document.body.appendChild(banner);
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function setupAuthListener() {
            app.auth.onAuthStateChanged(async user => {
                if (user) {
                    app.currentUser = user;
                    
                    // –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ
                    const userRef = app.database.ref('users/' + user.uid);
                    const snapshot = await userRef.once('value');
                    
                    if (!snapshot.exists()) {
                        // –°–æ–∑–¥–∞—ë–º –ø—Ä–æ—Ñ–∏–ª—å –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                        await userRef.set({
                            name: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            online: true,
                            lastSeen: firebase.database.ServerValue.TIMESTAMP,
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    } else {
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–Ω–ª–∞–π–Ω
                        await userRef.update({
                            online: true,
                            lastSeen: firebase.database.ServerValue.TIMESTAMP
                        });
                    }
                    
                    showScreen('chat');
                    setupPresence();
                    loadUsers();
                    openChat('general', '–û–±—â–∏–π —á–∞—Ç');
                } else {
                    app.currentUser = null;
                    showScreen('auth');
                }
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        function showScreen(screen) {
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('chatScreen').classList.add('hidden');
            
            if (screen === 'auth') {
                document.getElementById('authScreen').classList.remove('hidden');
            } else if (screen === 'chat') {
                document.getElementById('chatScreen').classList.remove('hidden');
                updateUserInfo();
            }
        }

        // –¢–∞–±—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function showTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const nameField = document.getElementById('nameField');
            const authBtnText = document.getElementById('authBtnText');
            
            if (tab === 'login') {
                loginTab.classList.add('bg-orange-500', 'text-white');
                loginTab.classList.remove('text-gray-400');
                registerTab.classList.remove('bg-orange-500', 'text-white');
                registerTab.classList.add('text-gray-400');
                nameField.classList.add('hidden');
                authBtnText.textContent = '–í–æ–π—Ç–∏';
            } else {
                registerTab.classList.add('bg-orange-500', 'text-white');
                registerTab.classList.remove('text-gray-400');
                loginTab.classList.remove('bg-orange-500', 'text-white');
                loginTab.classList.add('text-gray-400');
                nameField.classList.remove('hidden');
                authBtnText.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        document.getElementById('authForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('userEmail').value;
            const password = document.getElementById('userPassword').value;
            const name = document.getElementById('userName').value;
            const isRegister = !document.getElementById('nameField').classList.contains('hidden');
            const errorDiv = document.getElementById('authError');
            const authBtn = document.getElementById('authBtn');
            
            try {
                errorDiv.classList.add('hidden');
                authBtn.disabled = true;
                
                if (isRegister) {
                    if (!name.trim()) {
                        throw { code: 'auth/name-required' };
                    }
                    const userCredential = await app.auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({ displayName: name });
                    await app.database.ref('users/' + userCredential.user.uid).set({
                        name: name,
                        email: email,
                        online: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    });
                } else {
                    await app.auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                errorDiv.textContent = getErrorMessage(error.code);
                errorDiv.classList.remove('hidden');
            } finally {
                authBtn.disabled = false;
            }
        });

        // –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
        function getErrorMessage(code) {
            const messages = {
                'auth/email-already-in-use': '–≠—Ç–æ—Ç email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
                'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
                'auth/weak-password': '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º —Å–ª–∞–±—ã–π (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)',
                'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
                'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
                'auth/invalid-credential': '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
                'auth/name-required': '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è',
                'auth/too-many-requests': '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ'
            };
            return messages[code] || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + code;
        }

        // –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function setupPresence() {
            const userStatusRef = app.database.ref('users/' + app.currentUser.uid);
            const connectedRef = app.database.ref('.info/connected');
            
            connectedRef.on('value', snapshot => {
                if (snapshot.val() === true) {
                    userStatusRef.update({ 
                        online: true,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP 
                    });
                    userStatusRef.onDisconnect().update({
                        online: false,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                }
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        function updateUserInfo() {
            if (!app.currentUser) return;
            
            const name = app.currentUser.displayName || app.currentUser.email.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('currentUserName').textContent = name;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function loadUsers() {
            const usersRef = app.database.ref('users');
            document.getElementById('usersList').innerHTML = '<div class="loader mx-auto my-4 w-6 h-6 border-2"></div>';
            
            usersRef.on('value', snapshot => {
                const users = snapshot.val() || {};
                app.users = users;
                renderUsersList(users);
                updateOnlineCount();
            }, error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                document.getElementById('usersList').innerHTML = 
                    '<p class="text-red-400 text-sm text-center py-4">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º.<br>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.</p>';
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUsersList(users, filter = '') {
            const container = document.getElementById('usersList');
            container.innerHTML = '<p class="text-gray-500 text-sm mb-2">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</p>';
            
            const sortedUsers = Object.entries(users)
                .filter(([uid]) => uid !== app.currentUser.uid)
                .filter(([uid, user]) => {
                    if (!filter) return true;
                    return user.name?.toLowerCase().includes(filter.toLowerCase()) || 
                           user.email?.toLowerCase().includes(filter.toLowerCase());
                })
                .sort((a, b) => (b[1].online ? 1 : 0) - (a[1].online ? 1 : 0));
            
            if (sortedUsers.length === 0) {
                container.innerHTML += '<p class="text-gray-500 text-sm text-center py-4">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            sortedUsers.forEach(([uid, user]) => {
                const userDiv = document.createElement('div');
                userDiv.className = 'flex items-center space-x-3 p-3 rounded-xl hover:bg-gray-700/50 cursor-pointer transition-colors mb-2';
                userDiv.onclick = () => openPrivateChat(uid, user.name || user.email);
                
                const initial = (user.name || user.email || 'U').charAt(0).toUpperCase();
                const statusClass = user.online ? 'bg-green-400' : 'bg-gray-500';
                
                userDiv.innerHTML = `
                    <div class="relative">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">${initial}</div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 ${statusClass} rounded-full border-2 border-gray-800"></span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-medium truncate">${user.name || user.email}</p>
                        <p class="text-gray-400 text-sm">${user.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏'}</p>
                    </div>
                `;
                
                container.appendChild(userDiv);
            });
        }

        // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function searchUsers(query) {
            renderUsersList(app.users, query);
        }

        // –°—á–µ—Ç—á–∏–∫ –æ–Ω–ª–∞–π–Ω
        function updateOnlineCount() {
            const count = Object.values(app.users).filter(u => u.online).length;
            document.getElementById('onlineCount').textContent = count;
        }

        // –û—Ç–∫–ª—é—á–∏—Ç—å –≤—Å–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
        function detachAllListeners() {
            app.activeListeners.forEach(ref => {
                try {
                    ref.off();
                } catch(e) {
                    console.warn('–û—à–∏–±–∫–∞ –æ—Ç–ø–∏—Å–∫–∏:', e);
                }
            });
            app.activeListeners = [];
        }

        // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        function openChat(chatId, chatName, isPrivate = false, partnerUserId = null) {
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç:', chatId, chatName);
            
            // –ü–æ–ª–Ω–∞—è –æ—Ç–ø–∏—Å–∫–∞ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —á–∞—Ç–∞
            detachAllListeners();
            
            app.currentChat = chatId;
            app.currentChatName = chatName;
            app.currentChatPartner = partnerUserId;
            
            document.getElementById('chatTitle').textContent = chatName;
            
            if (isPrivate && partnerUserId) {
                const user = app.users[partnerUserId];
                document.getElementById('chatSubtitle').textContent = user?.online ? '–í —Å–µ—Ç–∏' : '–ù–µ –≤ —Å–µ—Ç–∏';
                document.getElementById('chatAvatar').innerHTML = chatName.charAt(0).toUpperCase();
                document.getElementById('chatAvatar').className = 'w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold';
            } else {
                document.getElementById('chatSubtitle').innerHTML = '–û–Ω–ª–∞–π–Ω: <span id="onlineCount">' + Object.values(app.users).filter(u => u.online).length + '</span>';
                document.getElementById('chatAvatar').className = 'w-10 h-10 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center text-white font-bold';
                document.getElementById('chatAvatar').innerHTML = `<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>`;
            }
            
            // –û—á–∏—Å—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '<div class="flex justify-center"><span class="px-4 py-2 bg-gray-800 rounded-full text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</span></div>';
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
            loadMessages(chatId);
            
            // –°–∫—Ä—ã—Ç—å sidebar –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
            }
        }

        // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —á–∞—Ç
        function openPrivateChat(userId, userName) {
            const chatId = [app.currentUser.uid, userId].sort().join('_');
            openChat('private_' + chatId, userName, true, userId);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages(chatId) {
            const container = document.getElementById('messagesContainer');
            container.innerHTML = ''; // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π chatId –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            const expectedChatId = chatId;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            const loader = document.createElement('div');
            loader.id = 'messagesLoader';
            loader.className = 'flex justify-center py-4';
            loader.innerHTML = '<span class="px-4 py-2 bg-gray-800 rounded-full text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</span>';
            container.appendChild(loader);
            
            const messagesRef = app.database.ref('messages/' + chatId);
            
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            messagesRef.orderByChild('timestamp').limitToLast(100).once('value', snapshot => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç –Ω–µ —Å–º–µ–Ω–∏–ª—Å—è –ø–æ–∫–∞ –≥—Ä—É–∑–∏–ª–∏—Å—å
                if (app.currentChat !== expectedChatId) {
                    console.log('–ß–∞—Ç —Å–º–µ–Ω–∏–ª—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    return;
                }
                
                const loaderEl = document.getElementById('messagesLoader');
                if (loaderEl) loaderEl.remove();
                
                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                container.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach(child => {
                        const msg = child.val();
                        msg.id = child.key;
                        messages.push(msg);
                    });
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º
                    messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                    messages.forEach(msg => displayMessage(msg, expectedChatId));
                } else {
                    container.innerHTML = '<div class="flex justify-center"><span class="px-4 py-2 bg-gray-800 rounded-full text-gray-400 text-sm">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</span></div>';
                }
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const newMsgRef = app.database.ref('messages/' + chatId);
                newMsgRef.orderByChild('timestamp').startAt(Date.now()).on('child_added', newSnapshot => {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –≤—Å—ë –µ—â—ë —Ç–µ–∫—É—â–∏–π —á–∞—Ç
                    if (app.currentChat !== expectedChatId) {
                        return;
                    }
                    
                    const message = newSnapshot.val();
                    message.id = newSnapshot.key;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—â—ë –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ
                    if (!document.querySelector(`[data-message-id="${message.id}"]`)) {
                        // –£–±–∏—Ä–∞–µ–º "–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ" –µ—Å–ª–∏ –µ—Å—Ç—å
                        const emptyMsg = container.querySelector('.text-gray-400');
                        if (emptyMsg && emptyMsg.textContent === '–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!') {
                            emptyMsg.closest('div').remove();
                        }
                        displayMessage(message, expectedChatId);
                    }
                });
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è –æ—Ç–ø–∏—Å–∫–∏
                app.activeListeners.push(newMsgRef);
                
            }, error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                container.innerHTML = '<div class="flex justify-center"><span class="px-4 py-2 bg-red-900/50 text-red-400 rounded-full text-sm">–û—à–∏–±–∫–∞: ' + error.message + '</span></div>';
            });
            
            // –°–ª—É—à–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∏
            setupTypingListener(chatId);
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(message, expectedChatId = null) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞
            if (expectedChatId && app.currentChat !== expectedChatId) {
                return;
            }
            
            const container = document.getElementById('messagesContainer');
            const isOwn = message.userId === app.currentUser.uid;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
            if (document.querySelector(`[data-message-id="${message.id}"]`)) {
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isOwn ? 'justify-end' : 'justify-start'} message-enter`;
            messageDiv.setAttribute('data-message-id', message.id);
            
            const time = message.timestamp ? new Date(message.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }) : '';
            
            // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            let senderName = message.userName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            if (!isOwn && app.users[message.userId]) {
                senderName = app.users[message.userId].name || app.users[message.userId].email || senderName;
            }
            
            messageDiv.innerHTML = `
                <div class="max-w-xs lg:max-w-md xl:max-w-lg">
                    ${!isOwn ? `<p class="text-xs text-gray-400 mb-1 ml-2">${escapeHtml(senderName)}</p>` : ''}
                    <div class="${isOwn ? 'bg-gradient-to-r from-orange-500 to-yellow-500' : 'bg-gray-700'} rounded-2xl px-4 py-3 ${isOwn ? 'rounded-tr-sm' : 'rounded-tl-sm'}">
                        <p class="text-white break-words">${escapeHtml(message.text)}</p>
                        <p class="text-xs ${isOwn ? 'text-orange-100' : 'text-gray-400'} text-right mt-1">${time}</p>
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        document.getElementById('messageForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            const message = {
                text: text,
                userId: app.currentUser.uid,
                userName: app.currentUser.displayName || app.currentUser.email.split('@')[0] || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                timestamp: firebase.database.ServerValue.TIMESTAMP
            };
            
            try {
                await app.database.ref('messages/' + app.currentChat).push(message);
                input.value = '';
                
                // –£–±—Ä–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
                app.database.ref('typing/' + app.currentChat + '/' + app.currentUser.uid).remove();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            }
        });

        // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏
        let typingTimeout;
        document.getElementById('messageInput').addEventListener('input', () => {
            if (!app.currentUser) return;
            
            app.database.ref('typing/' + app.currentChat + '/' + app.currentUser.uid).set({
                name: app.currentUser.displayName || app.currentUser.email.split('@')[0],
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                app.database.ref('typing/' + app.currentChat + '/' + app.currentUser.uid).remove();
            }, 2000);
        });

        // –°–ª—É—à–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∏
        function setupTypingListener(chatId) {
            app.database.ref('typing/' + chatId).on('value', snapshot => {
                const typing = snapshot.val() || {};
                const typingUsers = Object.entries(typing)
                    .filter(([uid]) => uid !== app.currentUser.uid)
                    .map(([uid, data]) => data.name);
                
                const indicator = document.getElementById('typingIndicator');
                const typingUser = document.getElementById('typingUser');
                
                if (typingUsers.length > 0) {
                    indicator.classList.remove('hidden');
                    if (typingUsers.length === 1) {
                        typingUser.textContent = typingUsers[0] + ' –ø–µ—á–∞—Ç–∞–µ—Ç...';
                    } else {
                        typingUser.textContent = typingUsers.length + ' —á–µ–ª–æ–≤–µ–∫ –ø–µ—á–∞—Ç–∞—é—Ç...';
                    }
                } else {
                    indicator.classList.add('hidden');
                }
            });
        }

        // Emoji
        function addEmoji() {
            const picker = document.getElementById('emojiPicker');
            picker.classList.toggle('hidden');
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            document.getElementById('emojiPicker').classList.add('hidden');
        }

        // –ó–∞–∫—Ä—ã—Ç—å emoji picker –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#emojiPicker') && !e.target.closest('button[onclick="addEmoji()"]')) {
                document.getElementById('emojiPicker').classList.add('hidden');
            }
        });

        // –í—ã—Ö–æ–¥
        async function logout() {
            console.log('–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞...');
            
            // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö —Å–ª—É—à–∞—Ç–µ–ª–µ–π
            try {
                Object.keys(app.messageListeners).forEach(chatId => {
                    app.database.ref('messages/' + chatId).off();
                    app.database.ref('typing/' + chatId).off();
                });
                app.database.ref('users').off();
                app.database.ref('.info/connected').off();
            } catch (e) {
                console.warn('–û—à–∏–±–∫–∞ –æ—Ç–ø–∏—Å–∫–∏:', e);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ñ—Ñ–ª–∞–π–Ω
            try {
                if (app.currentUser && app.database) {
                    await app.database.ref('users/' + app.currentUser.uid).update({ 
                        online: false,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP 
                    });
                }
            } catch (error) {
                console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
            }
            
            // –í—ã—Ö–æ–¥–∏–º
            try {
                await app.auth.signOut();
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ signOut:', e);
            }
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.reload();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('hidden');
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', initApp);

        // ========== PWA INSTALLATION ==========
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        function showInstallButton() {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –µ—Å–ª–∏ –µ—ë –µ—â—ë –Ω–µ—Ç
            if (document.getElementById('installBtn')) return;
            
            const btn = document.createElement('button');
            btn.id = 'installBtn';
            btn.className = 'fixed bottom-4 right-4 z-50 bg-gradient-to-r from-orange-500 to-yellow-500 text-white px-4 py-3 rounded-xl shadow-lg flex items-center space-x-2 hover:opacity-90 transition-opacity';
            btn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                </svg>
                <span>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</span>
            `;
            btn.onclick = installApp;
            document.body.appendChild(btn);
        }

        async function installApp() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
            
            deferredPrompt = null;
            document.getElementById('installBtn')?.remove();
        }

        window.addEventListener('appinstalled', () => {
            console.log('FireChat —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
            document.getElementById('installBtn')?.remove();
        });

        // Service Worker —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:text/javascript;base64,' + btoa(`
                const CACHE_NAME = 'firechat-v1';
                const urlsToCache = ['/'];
                
                self.addEventListener('install', (event) => {
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                });
                
                self.addEventListener('fetch', (event) => {
                    event.respondWith(
                        fetch(event.request).catch(() => caches.match(event.request))
                    );
                });
            `)).catch(err => console.log('SW –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', err));
        }
    </script>
</body>
</html>
