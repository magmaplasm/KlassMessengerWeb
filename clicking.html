<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Clicker Game - Админ Панель</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fdbb2d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .admin-btn {
            background: rgba(220, 53, 69, 0.7);
        }
        
        .admin-btn:hover {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
            .chat-section, .friends-section, .cases-section, .trade-section {
                grid-column: 1 / -1;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .game-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .admin-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .friends-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .cases-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .trade-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-controls {
                grid-template-columns: 1fr;
            }
        }
        
        .admin-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-panel h3 {
            margin-bottom: 15px;
            color: #fdbb2d;
        }
        
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .click-area {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #fdbb2d, #b21f1f);
            border-radius: 50%;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.1s ease;
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .click-area:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .click-area.blocked {
            background: linear-gradient(135deg, #666, #333);
            cursor: not-allowed;
        }
        
        .click-area.blocked:active {
            transform: scale(1);
        }
        
        .blocked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            text-align: center;
            padding: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .trend-indicator {
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .trend-up {
            color: #4CAF50;
        }
        
        .trend-down {
            color: #F44336;
        }
        
        .trend-neutral {
            color: #FFC107;
        }
        
        .cps-warning {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 10px;
            min-height: 24px;
        }
        
        .leaderboard-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .leaderboard {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .leaderboard-item.current-user {
            background: rgba(253, 187, 45, 0.3);
            border-left: 5px solid #fdbb2d;
        }
        
        .rank {
            font-weight: bold;
            width: 30px;
        }
        
        .player-name {
            flex: 1;
            margin: 0 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player-score {
            font-weight: bold;
        }
        
        .auth-modal, .nickname-modal, .admin-modal, .event-modal, .clicks-modal, .friends-modal, .case-result-modal, .admin-code-modal, .trade-modal, .inventory-modal, .give-upgrade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .auth-form, .nickname-form, .admin-form, .event-form, .clicks-form, .friends-form, .case-result-content, .admin-code-form, .trade-form, .inventory-content, .give-upgrade-form {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .trade-form {
            max-width: 600px;
        }
        
        .inventory-content {
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .case-result-content {
            text-align: center;
            max-width: 400px;
            animation: caseOpen 0.5s ease;
        }
        
        @keyframes caseOpen {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .auth-form h2, .nickname-form h2, .admin-form h2, .event-form h2, .clicks-form h2, .friends-form h2, .case-result-content h2, .admin-code-form h2, .trade-form h2, .inventory-content h2, .give-upgrade-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .auth-form input, .nickname-form input, .admin-form input, .event-form input, .event-form select, .clicks-form input, .friends-form input, .admin-code-form input, .trade-form input, .give-upgrade-form input, .give-upgrade-form select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .auth-buttons, .nickname-buttons, .admin-buttons, .event-buttons, .clicks-buttons, .friends-buttons, .case-result-buttons, .admin-code-buttons, .trade-buttons, .give-upgrade-buttons {
            display: flex;
            gap: 10px;
        }
        
        .auth-buttons button, .nickname-buttons button, .admin-buttons button, .event-buttons button, .clicks-buttons button, .friends-buttons button, .case-result-buttons button, .admin-code-buttons button, .trade-buttons button, .give-upgrade-buttons button {
            flex: 1;
        }
        
        .close-modal {
            background: rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .game-info {
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .change-nickname {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #fdbb2d;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .leaderboard-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .leaderboard-controls button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .leaderboard-controls button.active {
            background: rgba(253, 187, 45, 0.5);
        }
        
        .cps-meter {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 10px;
            overflow-y: hidden;
        }
        
        .cps-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
        
        .event-notification {
            background: rgba(76, 175, 80, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .admin-quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-with-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .action-with-input input {
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Чат стили */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 400px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            word-wrap: break-word;
        }
        
        .chat-message.admin-action {
            background: rgba(220, 53, 69, 0.3);
            border-left: 3px solid #dc3545;
        }
        
        .chat-message.system {
            background: rgba(255, 193, 7, 0.3);
            border-left: 3px solid #FFC107;
            font-style: italic;
        }
        
        .message-sender {
            font-weight: bold;
            margin-right: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-text {
            margin-top: 3px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .send-button {
            padding: 12px 20px;
            white-space: nowrap;
        }
        
        /* Галочки */
        .verified-badge {
            color: #1DA1F2;
            font-size: 0.9rem;
        }
        
        .admin-badge-chat {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.6rem;
            margin-left: 5px;
        }
        
        .user-with-badge {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Система друзей */
        .friends-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 300px;
        }
        
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .friend-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .friend-actions {
            display: flex;
            gap: 5px;
        }
        
        .friend-actions button {
            padding: 5px 10px;
            font-size: 0.7rem;
        }
        
        .friends-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .friends-controls button {
            flex: 1;
        }
        
        .trend-chart {
            height: 100px;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            position: relative;
        }
        
        .trend-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80%;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }
        
        .trend-bar {
            width: 8px;
            background: linear-gradient(to top, #4CAF50, #FFC107);
            border-radius: 2px;
            transition: height 0.3s ease;
        }
        
        /* Стили для кейсов */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .case-item {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .case-item:hover {
            transform: translateY(-5px);
            border-color: #fdbb2d;
            box-shadow: 0 10px 20px rgba(253, 187, 45, 0.3);
        }
        
        .case-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .case-price {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .case-chances {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .case-mythical {
            border-color: #9C27B0;
            background: linear-gradient(135deg, #1a2a6c, #9C27B0);
        }
        
        .case-divine {
            border-color: #00BCD4;
            background: linear-gradient(135deg, #1a2a6c, #00BCD4);
        }
        
        .upgrades-list {
            margin-top: 20px;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .upgrade-rarity-common { color: #ffffff; }
        .upgrade-rarity-uncommon { color: #4CAF50; }
        .upgrade-rarity-rare { color: #2196F3; }
        .upgrade-rarity-epic { color: #9C27B0; }
        .upgrade-rarity-legendary { color: #FF9800; }
        .upgrade-rarity-mythical { color: #9C27B0; }
        .upgrade-rarity-divine { color: #00BCD4; }
        
        .bonus-display {
            background: rgba(253, 187, 45, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        .case-premium {
            border-color: #FFD700;
            background: linear-gradient(135deg, #1a2a6c, #9C27B0);
        }

        .case-legendary {
            border-color: #FF9800;
            background: linear-gradient(135deg, #1a2a6c, #FF9800);
        }

        /* Стили для трейда */
        .trade-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .trade-side {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .trade-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #fdbb2d;
        }

        .trade-items {
            min-height: 200px;
            margin-bottom: 15px;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .trade-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .trade-controls button {
            flex: 1;
        }

        .trade-offers {
            margin-top: 20px;
        }

        .trade-offer {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .trade-offer-info {
            margin-bottom: 10px;
        }

        .trade-offer-actions {
            display: flex;
            gap: 10px;
        }

        .trade-offer-actions button {
            flex: 1;
        }

        .selected-upgrade {
            background: rgba(253, 187, 45, 0.3);
            border: 1px solid #fdbb2d;
        }

        /* Стили для инвентаря в обмене */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .inventory-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .inventory-item:hover {
            transform: translateY(-3px);
            border-color: #fdbb2d;
        }
        
        .inventory-item.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        /* Стили для выдачи улучшений */
        .user-search-results {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            display: none;
        }

        .user-search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .user-search-result-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .view-all-btn {
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">FireClicker <span class="admin-badge" id="adminBadge" style="display: none;">ADMIN</span></div>
            <div class="user-info">
                <div id="userDisplay" class="user-display" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Пользователь</span>
                    <span id="userVerified" class="verified-badge" style="display: none;">✓</span>
                </div>
                <div class="auth-section">
                    <button id="adminPanelBtn" class="admin-btn admin-only">Админ Панель</button>
                    <button id="loginBtn">Войти</button>
                    <button id="registerBtn">Регистрация</button>
                    <button id="logoutBtn" style="display: none;">Выйти</button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="game-section">
                <h2 class="section-title">Кликер</h2>
                <div id="eventNotification" class="event-notification" style="display: none;">
                    <!-- Уведомление о событии будет здесь -->
                </div>
                <div class="click-area" id="clickArea">
                    <span id="clickText">КЛИКАЙ!</span>
                    <div class="blocked-overlay" id="blockedOverlay" style="display: none;">СЛИШКОМ БЫСТРО!</div>
                </div>
                <div class="cps-meter">
                    <div class="cps-fill" id="cpsFill"></div>
                </div>
                <div class="cps-warning" id="cpsWarning"></div>
                <div class="stats">
                    <div class="stat">
                        <div>Клики</div>
                        <div class="stat-value" id="clickCount">0</div>
                    </div>
                    <div class="stat">
                        <div>Лучший результат</div>
                        <div class="stat-value" id="bestScore">0</div>
                    </div>
                    <div class="stat">
                        <div>Кликов/сек</div>
                        <div class="stat-value" id="cpsValue">0</div>
                    </div>
                </div>
                <div class="bonus-display" id="bonusDisplay" style="display: none;">
                    Бонус к клику: +<span id="bonusValue">0</span>
                </div>
                <div class="game-info">
                    <p>Войдите в аккаунт, чтобы сохранить свой прогресс и попасть в лидерборд!</p>
                    <p>Ограничение: не более 12 кликов в секунду</p>
                    <div class="change-nickname" id="changeNickname" style="display: none;">Изменить никнейм</div>
                </div>
            </div>
            
            <div class="cases-section">
                <h2 class="section-title">Кейсы с улучшениями</h2>
                <div class="cases-grid">
                    <div class="case-item" id="basicCase">
                        <div class="case-name">📦 Базовый кейс</div>
                        <div class="case-price">Цена: 500 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +0.1 | 25% +0.2 | 8% +0.5 | 2% +1.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item" id="advancedCase">
                        <div class="case-name">⚡ Продвинутый кейс</div>
                        <div class="case-price">Цена: 1500 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +0.2 | 25% +0.5 | 8% +1.0 | 2% +2.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item case-premium" id="premiumCase">
                        <div class="case-name">💎 Премиум кейс</div>
                        <div class="case-price">Цена: 3000 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +0.5 | 25% +1.0 | 8% +2.0 | 2% +3.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item case-legendary" id="legendaryCase">
                        <div class="case-name">🌟 Легендарный кейс</div>
                        <div class="case-price">Цена: 6000 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +1.0 | 25% +2.0 | 8% +3.0 | 2% +5.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <!-- Новые кейсы -->
                    <div class="case-item case-mythical" id="mythicalCase">
                        <div class="case-name">🔮 Мифический кейс</div>
                        <div class="case-price">Цена: 10000 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +2.0 | 25% +3.0 | 8% +5.0 | 2% +8.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                    
                    <div class="case-item case-divine" id="divineCase">
                        <div class="case-name">✨ Божественный кейс</div>
                        <div class="case-price">Цена: 25000 кликов</div>
                        <div class="case-chances">
                            Шансы: 65% +5.0 | 25% +8.0 | 8% +10.0 | 2% +15.0
                        </div>
                        <button>Открыть кейс</button>
                    </div>
                </div>
                
                <div class="upgrades-list" id="upgradesList">
                    <h3 style="margin-bottom: 15px;">Ваши улучшения</h3>
                    <!-- Список улучшений будет здесь -->
                    <div id="upgradesContainer"></div>
                    <button id="viewAllUpgrades" class="view-all-btn" style="display: none;">Посмотреть все</button>
                </div>
            </div>
            
            <div class="trade-section">
                <h2 class="section-title">Обмен с игроками</h2>
                <div class="trade-controls">
                    <button id="createTradeBtn">Создать обмен</button>
                    <button id="refreshTrades">Обновить список</button>
                </div>
                <div class="trade-offers" id="tradeOffers">
                    <!-- Список предложений обмена будет здесь -->
                </div>
                <button id="viewAllTrades" class="view-all-btn" style="display: none;">Посмотреть все</button>
            </div>
            
            <div class="leaderboard-section">
                <h2 class="section-title">Лидерборд</h2>
                <div class="leaderboard-controls">
                    <button id="showTop10" class="active">Топ-10</button>
                    <button id="showTop25">Топ-25</button>
                    <button id="showAll">Все игроки</button>
                </div>
                <ul class="leaderboard" id="leaderboard">
                    <!-- Лидерборд будет заполнен через JS -->
                </ul>
            </div>
            
            <div class="friends-section">
                <h2 class="section-title">Друзья</h2>
                <div class="friends-controls">
                    <button id="addFriendBtn">Добавить друга</button>
                    <button id="refreshFriends">Обновить</button>
                </div>
                <div class="friends-list" id="friendsList">
                    <!-- Список друзей будет здесь -->
                </div>
            </div>
            
            <div class="chat-section">
                <h2 class="section-title">Чат</h2>
                <div class="chat-messages" id="chatMessages">
                    <!-- Сообщения чата будут здесь -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Введите сообщение..." maxlength="200">
                    <button class="send-button" id="sendMessage">Отправить</button>
                </div>
            </div>
            
            <div class="admin-section admin-only" id="adminSection">
                <h2 class="section-title">Админ Панель</h2>
                <div class="admin-controls">
                    <div class="admin-panel">
                        <h3>Управление пользователями</h3>
                        <div class="user-list" id="userList">
                            <!-- Список пользователей будет заполнен через JS -->
                        </div>
                        <button id="refreshUsers">Обновить список</button>
                    </div>
                    
                    <div class="admin-panel">
                        <h3>Быстрые действия с кликами</h3>
                        <div class="admin-quick-actions">
                            <div class="action-with-input">
                                <input type="number" id="clicksToOnlineInput" placeholder="Кол-во кликов" value="1000">
                                <button id="addClicksToOnline">Добавить онлайн</button>
                            </div>
                            <div class="action-with-input">
                                <input type="number" id="clicksToMeInput" placeholder="Кол-во кликов" value="5000">
                                <button id="addMyClicks">Добавить себе</button>
                            </div>
                            <div class="action-with-input">
                                <input type="number" id="clicksToAllInput" placeholder="Кол-во кликов" value="1000">
                                <button id="addClicksToAll">Добавить всем</button>
                            </div>
                            <button id="createEvent" class="admin-only">Создать ивент</button>
                            <button id="resetAllScores">Обнулить все</button>
                            <button id="deleteInactive">Удалить неактивных</button>
                            <button id="giveUpgradeBtn" class="admin-only">Выдать улучшение</button>
                            <button id="giveUpgradeToAll" class="admin-only">Раздать улучшение всем</button>
                            <button id="giveUpgradeToOnline" class="admin-only">Раздать улучшение всем онлайн</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="auth-modal" id="authModal">
        <div class="auth-form">
            <h2 id="authModalTitle">Вход</h2>
            <input type="email" id="authEmail" placeholder="Email">
            <input type="password" id="authPassword" placeholder="Пароль">
            <div class="auth-buttons">
                <button id="authSubmit">Войти</button>
                <button id="authCancel">Отмена</button>
            </div>
            <div class="close-modal" id="closeAuthModal">×</div>
        </div>
    </div>
    
    <div class="nickname-modal" id="nicknameModal">
        <div class="nickname-form">
            <h2>Установить никнейм</h2>
            <input type="text" id="nicknameInput" placeholder="Введите ваш никнейм" maxlength="15">
            <div class="nickname-buttons">
                <button id="saveNickname">Сохранить</button>
                <button id="cancelNickname">Отмена</button>
            </div>
            <div class="close-modal" id="closeNicknameModal">×</div>
        </div>
    </div>
    
    <div class="admin-modal" id="adminModal">
        <div class="admin-form">
            <h2 id="adminModalTitle">Редактирование пользователя</h2>
            <div id="adminUserInfo" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;"></div>
            <input type="number" id="adminClicksInput" placeholder="Новое количество кликов">
            <input type="number" id="adminBestScoreInput" placeholder="Новый лучший результат">
            <div class="admin-buttons">
                <button id="adminSave">Сохранить</button>
                <button id="adminDelete">Удалить аккаунт</button>
                <button id="toggleVerified">Переключить галочку</button>
                <button id="adminCancel">Отмена</button>
            </div>
            <div class="close-modal" id="closeAdminModal">×</div>
        </div>
    </div>
    
    <div class="event-modal" id="eventModal">
        <div class="event-form">
            <h2>Создание события</h2>
            <select id="eventMultiplier">
                <option value="2">2x - Двойные клики</option>
                <option value="3">3x - Тройные клики</option>
                <option value="5">5x - Пятерные клики</option>
                <option value="10">10x - Десятерные клики</option>
            </select>
            <select id="eventDuration">
                <option value="5">5 минут</option>
                <option value="10">10 минут</option>
                <option value="30">30 минут</option>
                <option value="60">1 час</option>
                <option value="120">2 часа</option>
                <option value="360">6 часов</option>
                <option value="720">12 часов</option>
                <option value="1440">24 часа</option>
            </select>
            <div class="event-buttons">
                <button id="startEvent">Запустить событие</button>
                <button id="stopEvent">Остановить событие</button>
                <button id="cancelEvent">Отмена</button>
            </div>
            <div class="close-modal" id="closeEventModal">×</div>
        </div>
    </div>
    
    <div class="clicks-modal" id="customClicksModal">
        <div class="clicks-form">
            <h2 id="customClicksTitle">Добавление кликов</h2>
            <input type="number" id="customClicksInput" placeholder="Введите количество кликов">
            <div class="clicks-buttons">
                <button id="confirmCustomClicks">Добавить</button>
                <button id="cancelCustomClicks">Отмена</button>
            </div>
            <div class="close-modal" id="closeCustomClicksModal">×</div>
        </div>
    </div>
    
    <div class="friends-modal" id="friendsModal">
        <div class="friends-form">
            <h2>Добавить друга</h2>
            <input type="text" id="friendSearchInput" placeholder="Введите email или никнейм">
            <div class="friends-buttons">
                <button id="searchFriend">Найти</button>
                <button id="cancelFriend">Отмена</button>
            </div>
            <div id="friendSearchResults" style="margin-top: 15px;">
                <!-- Результаты поиска будут здесь -->
            </div>
            <div class="close-modal" id="closeFriendsModal">×</div>
        </div>
    </div>

    <!-- Новые модальные окна для кейсов и кода админа -->
    <div class="case-result-modal" id="caseResultModal">
        <div class="case-result-content">
            <h2 id="caseResultTitle">Результат открытия кейса</h2>
            <div id="caseResultContent" style="font-size: 1.2rem; margin: 20px 0;"></div>
            <div class="case-result-buttons">
                <button id="closeCaseResult">Закрыть</button>
            </div>
        </div>
    </div>
    
    <div class="admin-code-modal" id="adminCodeModal">
        <div class="admin-code-form">
            <h2>Подтверждение администратора</h2>
            <p>Введите код подтверждения для доступа к админ-панели:</p>
            <input type="text" id="adminCodeInput" placeholder="Код подтверждения">
            <div class="admin-code-buttons">
                <button id="confirmAdminCode">Подтвердить</button>
                <button id="cancelAdminCode">Отмена</button>
            </div>
            <div class="close-modal" id="closeAdminCodeModal">×</div>
        </div>
    </div>

    <!-- Модальное окно для обмена -->
    <div class="trade-modal" id="tradeModal">
        <div class="trade-form">
            <h2 id="tradeModalTitle">Создание обмена</h2>
            <div class="trade-container">
                <div class="trade-side">
                    <h3>Вы отдаете:</h3>
                    <div class="trade-items" id="myTradeItems">
                        <!-- Ваши предметы для обмена -->
                    </div>
                    <div class="action-with-input">
                        <input type="number" id="myClicksInput" placeholder="Клики для обмена" min="0">
                        <button id="addMyUpgrade">Добавить улучшение</button>
                    </div>
                </div>
                <div class="trade-arrow">⇄</div>
                <div class="trade-side">
                    <h3>Вы получаете:</h3>
                    <div class="trade-items" id="theirTradeItems">
                        <!-- Предметы другого игрока -->
                    </div>
                    <div class="action-with-input">
                        <input type="number" id="theirClicksInput" placeholder="Клики для получения" min="0">
                        <button id="addTheirUpgrade">Добавить улучшение</button>
                    </div>
                </div>
            </div>
            <div class="action-with-input">
                <input type="text" id="tradePlayerInput" placeholder="Имя игрока для обмена">
            </div>
            <div class="trade-buttons">
                <button id="sendTradeOffer">Отправить предложение</button>
                <button id="cancelTrade">Отмена</button>
            </div>
            <div class="close-modal" id="closeTradeModal">×</div>
        </div>
    </div>

    <!-- Модальное окно для инвентаря -->
    <div class="inventory-modal" id="inventoryModal">
        <div class="inventory-content">
            <h2 id="inventoryModalTitle">Выберите улучшения</h2>
            <div class="inventory-grid" id="inventoryGrid">
                <!-- Список улучшений будет здесь -->
            </div>
            <div class="trade-buttons" style="margin-top: 20px;">
                <button id="confirmInventorySelection">Подтвердить выбор</button>
                <button id="cancelInventorySelection">Отмена</button>
            </div>
            <div class="close-modal" id="closeInventoryModal">×</div>
        </div>
    </div>

    <!-- Модальное окно для выдачи улучшений -->
    <div class="give-upgrade-modal" id="giveUpgradeModal">
        <div class="give-upgrade-form">
            <h2>Выдать улучшение</h2>
            <div class="action-with-input">
                <input type="text" id="upgradeUserSearch" placeholder="Поиск пользователя по нику или email">
                <div id="upgradeUserResults" class="user-search-results"></div>
            </div>
            <div id="selectedUpgradeUser" style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                Выбран пользователь: <span id="selectedUserName"></span>
                <button onclick="clearSelectedUser()" style="margin-left: 10px;">×</button>
            </div>
            <select id="upgradeTypeSelect">
                <option value="0.1">Обычное (+0.1)</option>
                <option value="0.2">Необычное (+0.2)</option>
                <option value="0.5">Редкое (+0.5)</option>
                <option value="1.0">Эпическое (+1.0)</option>
                <option value="2.0">Эпическое (+2.0)</option>
                <option value="3.0">Легендарное (+3.0)</option>
                <option value="5.0">Легендарное (+5.0)</option>
                <option value="8.0">Мифическое (+8.0)</option>
                <option value="10.0">Мифическое (+10.0)</option>
                <option value="15.0">Божественное (+15.0)</option>
            </select>
            <input type="number" id="upgradeQuantity" placeholder="Количество" value="1" min="1">
            <div class="give-upgrade-buttons">
                <button id="confirmGiveUpgrade">Выдать</button>
                <button id="cancelGiveUpgrade">Отмена</button>
            </div>
            <div class="close-modal" id="closeGiveUpgradeModal">×</div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD4mvrBrKNEmPQ7JDfbnEGAxb9ETen8KsA",
            authDomain: "clicking-697ae.firebaseapp.com",
            projectId: "clicking-697ae",
            storageBucket: "clicking-697ae.firebasestorage.app",
            messagingSenderId: "479295856325",
            appId: "1:479295856325:web:dc0b0dcf661cd66941daac",
            databaseURL: "https://clicking-697ae-default-rtdb.firebaseio.com/"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Состояние игры
        let gameState = {
            clicks: 0,
            bestScore: 0,
            clickMultiplier: 1,
            previousClicks: 0,
            previousBestScore: 0,
            previousCPS: 0,
            clickHistory: []
        };

        // Система улучшений
        let upgrades = {
            totalBonus: 0,
            items: []
        };

        // Система обмена
        let currentTrade = {
            myItems: [],
            myClicks: 0,
            theirItems: [],
            theirClicks: 0,
            targetPlayer: null
        };

        // Для инвентаря в обмене
        let currentInventorySide = null; // 'my' или 'their'
        let selectedInventoryItems = [];

        // Для выдачи улучшений
        let selectedUserForUpgrade = null;

        // Код подтверждения для админа
        const ADMIN_CONFIRMATION_CODE = "ADMIN2024";

        // Настройки лидерборда
        let leaderboardLimit = 10;

        // Система защиты от быстрых кликов
        const MAX_CPS = 12;
        let clickTimestamps = [];
        let currentCPS = 0;
        let isBlocked = false;
        let blockTimeout = null;

        // Админские настройки
        const ADMIN_EMAILS = ['magmaplasm@gmail.com'];
        let isAdmin = false;
        let selectedUser = null;
        let currentAction = null;

        // Новые переменные для ограничения отображения
        let showAllUpgrades = false;
        let showAllTrades = false;

        // DOM элементы
        const clickArea = document.getElementById('clickArea');
        const clickText = document.getElementById('clickText');
        const blockedOverlay = document.getElementById('blockedOverlay');
        const clickCount = document.getElementById('clickCount');
        const bestScore = document.getElementById('bestScore');
        const cpsValue = document.getElementById('cpsValue');
        const cpsWarning = document.getElementById('cpsWarning');
        const cpsFill = document.getElementById('cpsFill');
        const leaderboard = document.getElementById('leaderboard');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminSection = document.getElementById('adminSection');
        const adminBadge = document.getElementById('adminBadge');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmit = document.getElementById('authSubmit');
        const authCancel = document.getElementById('authCancel');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const userDisplay = document.getElementById('userDisplay');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userVerified = document.getElementById('userVerified');
        const changeNickname = document.getElementById('changeNickname');
        const nicknameModal = document.getElementById('nicknameModal');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNickname = document.getElementById('saveNickname');
        const cancelNickname = document.getElementById('cancelNickname');
        const closeNicknameModal = document.getElementById('closeNicknameModal');
        const showTop10 = document.getElementById('showTop10');
        const showTop25 = document.getElementById('showTop25');
        const showAll = document.getElementById('showAll');
        const eventNotification = document.getElementById('eventNotification');
        const userList = document.getElementById('userList');
        const refreshUsers = document.getElementById('refreshUsers');
        const resetAllScores = document.getElementById('resetAllScores');
        const addClicksToAll = document.getElementById('addClicksToAll');
        const deleteInactive = document.getElementById('deleteInactive');
        const addClicksToOnline = document.getElementById('addClicksToOnline');
        const addMyClicks = document.getElementById('addMyClicks');
        const createEvent = document.getElementById('createEvent');
        const adminModal = document.getElementById('adminModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminUserInfo = document.getElementById('adminUserInfo');
        const adminClicksInput = document.getElementById('adminClicksInput');
        const adminBestScoreInput = document.getElementById('adminBestScoreInput');
        const adminSave = document.getElementById('adminSave');
        const adminDelete = document.getElementById('adminDelete');
        const toggleVerified = document.getElementById('toggleVerified');
        const adminCancel = document.getElementById('adminCancel');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const eventModal = document.getElementById('eventModal');
        const eventMultiplier = document.getElementById('eventMultiplier');
        const eventDuration = document.getElementById('eventDuration');
        const startEvent = document.getElementById('startEvent');
        const stopEvent = document.getElementById('stopEvent');
        const cancelEvent = document.getElementById('cancelEvent');
        const closeEventModal = document.getElementById('closeEventModal');
        const customClicksModal = document.getElementById('customClicksModal');
        const customClicksTitle = document.getElementById('customClicksTitle');
        const customClicksInput = document.getElementById('customClicksInput');
        const confirmCustomClicks = document.getElementById('confirmCustomClicks');
        const cancelCustomClicks = document.getElementById('cancelCustomClicks');
        const closeCustomClicksModal = document.getElementById('closeCustomClicksModal');
        const clicksToOnlineInput = document.getElementById('clicksToOnlineInput');
        const clicksToMeInput = document.getElementById('clicksToMeInput');
        const clicksToAllInput = document.getElementById('clicksToAllInput');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessage = document.getElementById('sendMessage');
        const friendsList = document.getElementById('friendsList');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const refreshFriends = document.getElementById('refreshFriends');
        const friendsModal = document.getElementById('friendsModal');
        const friendSearchInput = document.getElementById('friendSearchInput');
        const searchFriend = document.getElementById('searchFriend');
        const cancelFriend = document.getElementById('cancelFriend');
        const closeFriendsModal = document.getElementById('closeFriendsModal');
        const friendSearchResults = document.getElementById('friendSearchResults');
        const bonusDisplay = document.getElementById('bonusDisplay');
        const bonusValue = document.getElementById('bonusValue');

        // Новые DOM элементы для кейсов и кода админа
        const basicCase = document.getElementById('basicCase');
        const advancedCase = document.getElementById('advancedCase');
        const premiumCase = document.getElementById('premiumCase');
        const legendaryCase = document.getElementById('legendaryCase');
        const mythicalCase = document.getElementById('mythicalCase');
        const divineCase = document.getElementById('divineCase');
        const upgradesList = document.getElementById('upgradesList');
        const upgradesContainer = document.getElementById('upgradesContainer');
        const viewAllUpgrades = document.getElementById('viewAllUpgrades');
        const caseResultModal = document.getElementById('caseResultModal');
        const caseResultTitle = document.getElementById('caseResultTitle');
        const caseResultContent = document.getElementById('caseResultContent');
        const closeCaseResult = document.getElementById('closeCaseResult');
        const adminCodeModal = document.getElementById('adminCodeModal');
        const adminCodeInput = document.getElementById('adminCodeInput');
        const confirmAdminCode = document.getElementById('confirmAdminCode');
        const cancelAdminCode = document.getElementById('cancelAdminCode');
        const closeAdminCodeModal = document.getElementById('closeAdminCodeModal');

        // DOM элементы для трейда
        const createTradeBtn = document.getElementById('createTradeBtn');
        const refreshTrades = document.getElementById('refreshTrades');
        const tradeOffers = document.getElementById('tradeOffers');
        const viewAllTrades = document.getElementById('viewAllTrades');
        const tradeModal = document.getElementById('tradeModal');
        const myTradeItems = document.getElementById('myTradeItems');
        const theirTradeItems = document.getElementById('theirTradeItems');
        const myClicksInput = document.getElementById('myClicksInput');
        const theirClicksInput = document.getElementById('theirClicksInput');
        const addMyUpgrade = document.getElementById('addMyUpgrade');
        const addTheirUpgrade = document.getElementById('addTheirUpgrade');
        const tradePlayerInput = document.getElementById('tradePlayerInput');
        const sendTradeOffer = document.getElementById('sendTradeOffer');
        const cancelTrade = document.getElementById('cancelTrade');
        const closeTradeModal = document.getElementById('closeTradeModal');

        // DOM элементы для инвентаря
        const inventoryModal = document.getElementById('inventoryModal');
        const inventoryModalTitle = document.getElementById('inventoryModalTitle');
        const inventoryGrid = document.getElementById('inventoryGrid');
        const confirmInventorySelection = document.getElementById('confirmInventorySelection');
        const cancelInventorySelection = document.getElementById('cancelInventorySelection');
        const closeInventoryModal = document.getElementById('closeInventoryModal');

        // DOM элементы для выдачи улучшений
        const giveUpgradeBtn = document.getElementById('giveUpgradeBtn');
        const giveUpgradeToAll = document.getElementById('giveUpgradeToAll');
        const giveUpgradeToOnline = document.getElementById('giveUpgradeToOnline');
        const giveUpgradeModal = document.getElementById('giveUpgradeModal');
        const upgradeUserSearch = document.getElementById('upgradeUserSearch');
        const upgradeUserResults = document.getElementById('upgradeUserResults');
        const selectedUpgradeUser = document.getElementById('selectedUpgradeUser');
        const selectedUserName = document.getElementById('selectedUserName');
        const upgradeTypeSelect = document.getElementById('upgradeTypeSelect');
        const upgradeQuantity = document.getElementById('upgradeQuantity');
        const confirmGiveUpgrade = document.getElementById('confirmGiveUpgrade');
        const cancelGiveUpgrade = document.getElementById('cancelGiveUpgrade');
        const closeGiveUpgradeModal = document.getElementById('closeGiveUpgradeModal');

        // Инициализация приложения
        function initApp() {
            // Слушатели аутентификации
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Пользователь вошел в систему
                    handleUserLogin(user);
                } else {
                    // Пользователь вышел из системы
                    handleUserLogout();
                }
            });

            // Слушатели событий
            setupEventListeners();
            
            // Загрузка лидерборда
            loadLeaderboard();
            
            // Загрузка чата
            loadChat();
            
            // Загрузка начального состояния игры
            loadGameState();
            
            // Проверка активных событий
            checkActiveEvent();
            
            // Инициализация системы кейсов
            initCasesSystem();
            
            // Инициализация системы обмена
            initTradeSystem();
            
            // Инициализация системы выдачи улучшений
            initGiveUpgradeSystem();
            
            // Обновление CPS каждую секунду
            setInterval(updateCPS, 1000);
            
            // Проверка событий каждые 5 секунд
            setInterval(checkActiveEvent, 5000);
        }

        // Инициализация системы выдачи улучшений
        function initGiveUpgradeSystem() {
            giveUpgradeBtn.addEventListener('click', showGiveUpgradeModal);
            giveUpgradeToAll.addEventListener('click', giveUpgradeToAllHandler);
            giveUpgradeToOnline.addEventListener('click', giveUpgradeToOnlineHandler);
            cancelGiveUpgrade.addEventListener('click', hideGiveUpgradeModal);
            closeGiveUpgradeModal.addEventListener('click', hideGiveUpgradeModal);
            confirmGiveUpgrade.addEventListener('click', giveUpgradeHandler);
            
            // Поиск пользователей при вводе
            upgradeUserSearch.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                if (searchTerm.length < 2) {
                    upgradeUserResults.style.display = 'none';
                    return;
                }

                const usersRef = database.ref('users');
                usersRef.once('value').then(snapshot => {
                    const users = snapshot.val();
                    const results = [];
                    for (let userId in users) {
                        const user = users[userId];
                        const emailMatch = user.email.toLowerCase().includes(searchTerm);
                        const nicknameMatch = user.nickname && user.nickname.toLowerCase().includes(searchTerm);
                        if (emailMatch || nicknameMatch) {
                            results.push({ id: userId, ...user });
                        }
                    }
                    displayUpgradeUserResults(results);
                });
            });
        }

        // Раздать улучшение всем пользователям
        function giveUpgradeToAllHandler() {
            if (!isAdmin) {
                alert('Только администраторы могут выдавать улучшения');
                return;
            }

            const upgradeValue = parseFloat(upgradeTypeSelect.value);
            const quantity = parseInt(upgradeQuantity.value) || 1;
            const { rarity, rarityName } = getRarityByValue(upgradeValue);

            if (!confirm(`Раздать улучшение ${rarityName} (+${upgradeValue}) в количестве ${quantity} всем пользователям?`)) {
                return;
            }

            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const promises = [];

                for (let userId in users) {
                    for (let i = 0; i < quantity; i++) {
                        promises.push(addUpgradeToUser(userId, upgradeValue, rarity, rarityName));
                    }
                }

                return Promise.all(promises);
            }).then(() => {
                alert(`Улучшение успешно выдано всем пользователям!`);
            }).catch(error => {
                console.error('Ошибка выдачи улучшений всем:', error);
                alert('Произошла ошибка при выдаче улучшений');
            });
        }

        // Раздать улучшение онлайн пользователям
        function giveUpgradeToOnlineHandler() {
            if (!isAdmin) {
                alert('Только администраторы могут выдавать улучшения');
                return;
            }

            const upgradeValue = parseFloat(upgradeTypeSelect.value);
            const quantity = parseInt(upgradeQuantity.value) || 1;
            const { rarity, rarityName } = getRarityByValue(upgradeValue);
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);

            if (!confirm(`Раздать улучшение ${rarityName} (+${upgradeValue}) в количестве ${quantity} всем онлайн пользователям?`)) {
                return;
            }

            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const promises = [];

                for (let userId in users) {
                    if (users[userId].lastActive && users[userId].lastActive > fiveMinutesAgo) {
                        for (let i = 0; i < quantity; i++) {
                            promises.push(addUpgradeToUser(userId, upgradeValue, rarity, rarityName));
                        }
                    }
                }

                return Promise.all(promises);
            }).then(() => {
                alert(`Улучшение успешно выдано всем онлайн пользователям!`);
            }).catch(error => {
                console.error('Ошибка выдачи улучшений онлайн:', error);
                alert('Произошла ошибка при выдаче улучшений');
            });
        }

        // Показать модальное окно выдачи улучшений
        function showGiveUpgradeModal() {
            if (!isAdmin) {
                alert('Только администраторы могут выдавать улучшения');
                return;
            }
            giveUpgradeModal.style.display = 'flex';
            selectedUserForUpgrade = null;
            selectedUpgradeUser.style.display = 'none';
            upgradeUserSearch.value = '';
            upgradeTypeSelect.value = '0.1';
            upgradeQuantity.value = '1';
        }

        // Скрыть модальное окно выдачи улучшений
        function hideGiveUpgradeModal() {
            giveUpgradeModal.style.display = 'none';
        }

        // Отображение результатов поиска пользователей для выдачи улучшений
        function displayUpgradeUserResults(results) {
            upgradeUserResults.innerHTML = '';
            if (results.length === 0) {
                upgradeUserResults.innerHTML = '<div class="user-search-result-item">Пользователи не найдены</div>';
            } else {
                results.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-search-result-item';
                    div.textContent = user.nickname || user.email.split('@')[0];
                    div.dataset.userId = user.id;
                    div.dataset.userName = user.nickname || user.email.split('@')[0];
                    div.addEventListener('click', function() {
                        selectedUserForUpgrade = { id: this.dataset.userId, name: this.dataset.userName };
                        selectedUpgradeUser.style.display = 'block';
                        selectedUserName.textContent = this.dataset.userName;
                        upgradeUserResults.style.display = 'none';
                        upgradeUserSearch.value = '';
                    });
                    upgradeUserResults.appendChild(div);
                });
            }
            upgradeUserResults.style.display = 'block';
        }

        // Очистка выбранного пользователя
        window.clearSelectedUser = function() {
            selectedUserForUpgrade = null;
            selectedUpgradeUser.style.display = 'none';
        }

        // Обработчик выдачи улучшения
        function giveUpgradeHandler() {
            const upgradeValue = parseFloat(upgradeTypeSelect.value);
            const quantity = parseInt(upgradeQuantity.value) || 1;
            const { rarity, rarityName } = getRarityByValue(upgradeValue);

            let targetUserId = selectedUserForUpgrade ? selectedUserForUpgrade.id : auth.currentUser.uid;
            let targetUserName = selectedUserForUpgrade ? selectedUserForUpgrade.name : (userName.textContent || 'себе');

            if (!confirm(`Выдать улучшение ${rarityName} (+${upgradeValue}) в количестве ${quantity} пользователю ${targetUserName}?`)) {
                return;
            }

            for (let i = 0; i < quantity; i++) {
                addUpgradeToUser(targetUserId, upgradeValue, rarity, rarityName);
            }

            hideGiveUpgradeModal();
            alert(`Улучшение успешно выдано пользователю ${targetUserName}!`);
        }

        // Функция для получения редкости по значению улучшения
        function getRarityByValue(value) {
            if (value === 0.1) return { rarity: 'common', rarityName: 'Обычное' };
            if (value === 0.2) return { rarity: 'uncommon', rarityName: 'Необычное' };
            if (value === 0.5) return { rarity: 'rare', rarityName: 'Редкое' };
            if (value === 1.0) return { rarity: 'epic', rarityName: 'Эпическое' };
            if (value === 2.0) return { rarity: 'epic', rarityName: 'Эпическое' };
            if (value === 3.0) return { rarity: 'legendary', rarityName: 'Легендарное' };
            if (value === 5.0) return { rarity: 'legendary', rarityName: 'Легендарное' };
            if (value === 8.0) return { rarity: 'mythical', rarityName: 'Мифическое' };
            if (value === 10.0) return { rarity: 'mythical', rarityName: 'Мифическое' };
            if (value === 15.0) return { rarity: 'divine', rarityName: 'Божественное' };
            return { rarity: 'common', rarityName: 'Обычное' };
        }

        // Добавление улучшения пользователю
        function addUpgradeToUser(userId, upgradeValue, rarity, rarityName) {
            const upgradesRef = database.ref('userUpgrades/' + userId);
            return upgradesRef.once('value').then(snapshot => {
                const upgrades = snapshot.val() || { totalBonus: 0, items: [] };
                if (!upgrades.items) {
                    upgrades.items = [];
                }

                const newUpgrade = {
                    value: upgradeValue,
                    rarity: rarity,
                    rarityName: rarityName,
                    timestamp: Date.now()
                };

                upgrades.items.push(newUpgrade);
                upgrades.totalBonus = (upgrades.totalBonus || 0) + upgradeValue;

                return upgradesRef.set(upgrades);
            }).then(() => {
                console.log('Улучшение успешно выдано пользователю:', userId);
            }).catch(error => {
                console.error('Ошибка выдачи улучшения:', error);
            });
        }

        // Обработка входа пользователя
        function handleUserLogin(user) {
            console.log("Пользователь вошел:", user.email);
            
            // Проверка на админа
            isAdmin = ADMIN_EMAILS.includes(user.email);
            
            // Обновление UI
            loginBtn.style.display = 'none';
            registerBtn.style.display = 'none';
            logoutBtn.style.display = 'block';
            userDisplay.style.display = 'flex';
            
            if (isAdmin) {
                adminPanelBtn.style.display = 'block';
                adminBadge.style.display = 'inline';
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
            }
            
            // Загрузка данных пользователя
            loadUserData(user.uid);
            
            // Загрузка улучшений
            loadUpgrades();
            
            // Загрузка списка пользователей для админа
            if (isAdmin) {
                loadUserList();
            }
            
            // Загрузка друзей
            loadFriends();
            
            // Загрузка предложений обмена
            loadTradeOffers();
        }

        // Обработка выхода пользователя
        function handleUserLogout() {
            console.log("Пользователь вышел");
            
            // Сохранение состояния игры перед выходом
            if (auth.currentUser) {
                saveGameState();
            }
            
            // Сброс состояния
            gameState.clicks = 0;
            gameState.bestScore = 0;
            gameState.clickMultiplier = 1;
            gameState.previousClicks = 0;
            gameState.previousBestScore = 0;
            gameState.previousCPS = 0;
            gameState.clickHistory = [];
            
            // Сброс улучшений
            upgrades = {
                totalBonus: 0,
                items: []
            };
            
            // Сброс обмена
            currentTrade = {
                myItems: [],
                myClicks: 0,
                theirItems: [],
                theirClicks: 0,
                targetPlayer: null
            };
            
            // Обновление UI
            loginBtn.style.display = 'block';
            registerBtn.style.display = 'block';
            logoutBtn.style.display = 'none';
            userDisplay.style.display = 'none';
            adminPanelBtn.style.display = 'none';
            adminBadge.style.display = 'none';
            adminSection.style.display = 'none';
            changeNickname.style.display = 'none';
            userVerified.style.display = 'none';
            bonusDisplay.style.display = 'none';
            
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // Обновление отображения
            updateGameDisplay();
            
            // Перезагрузка лидерборда
            loadLeaderboard();
        }

        // Настройка слушателей событий
        function setupEventListeners() {
            // Кликер
            clickArea.addEventListener('click', handleClick);
            
            // Аутентификация
            loginBtn.addEventListener('click', () => showAuthModal('login'));
            registerBtn.addEventListener('click', () => showAuthModal('register'));
            logoutBtn.addEventListener('click', handleLogout);
            authSubmit.addEventListener('click', handleAuthSubmit);
            authCancel.addEventListener('click', hideAuthModal);
            closeAuthModal.addEventListener('click', hideAuthModal);
            
            // Никнейм
            changeNickname.addEventListener('click', showNicknameModal);
            saveNickname.addEventListener('click', saveNicknameHandler);
            cancelNickname.addEventListener('click', hideNicknameModal);
            closeNicknameModal.addEventListener('click', hideNicknameModal);
            
            // Лидерборд
            showTop10.addEventListener('click', () => changeLeaderboardLimit(10));
            showTop25.addEventListener('click', () => changeLeaderboardLimit(25));
            showAll.addEventListener('click', () => changeLeaderboardLimit(0));
            
            // Админ панель
            adminPanelBtn.addEventListener('click', toggleAdminPanel);
            refreshUsers.addEventListener('click', loadUserList);
            resetAllScores.addEventListener('click', resetAllScoresHandler);
            addClicksToAll.addEventListener('click', () => showCustomClicksModal('all'));
            deleteInactive.addEventListener('click', deleteInactiveUsers);
            addClicksToOnline.addEventListener('click', () => addClicksToOnlineHandler());
            addMyClicks.addEventListener('click', () => addMyClicksHandler());
            createEvent.addEventListener('click', showEventModal);
            
            // Модалки админа
            adminSave.addEventListener('click', saveUserChanges);
            adminDelete.addEventListener('click', deleteUser);
            toggleVerified.addEventListener('click', toggleUserVerified);
            adminCancel.addEventListener('click', hideAdminModal);
            closeAdminModal.addEventListener('click', hideAdminModal);
            
            // Модалка событий
            startEvent.addEventListener('click', startEventHandler);
            stopEvent.addEventListener('click', stopEventHandler);
            cancelEvent.addEventListener('click', hideEventModal);
            closeEventModal.addEventListener('click', hideEventModal);
            
            // Модалка кастомных кликов
            confirmCustomClicks.addEventListener('click', confirmCustomClicksHandler);
            cancelCustomClicks.addEventListener('click', hideCustomClicksModal);
            closeCustomClicksModal.addEventListener('click', hideCustomClicksModal);
            
            // Чат
            sendMessage.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // Друзья
            addFriendBtn.addEventListener('click', showFriendsModal);
            refreshFriends.addEventListener('click', loadFriends);
            searchFriend.addEventListener('click', searchFriendHandler);
            cancelFriend.addEventListener('click', hideFriendsModal);
            closeFriendsModal.addEventListener('click', hideFriendsModal);
            
            // Кнопки "Посмотреть все"
            viewAllUpgrades.addEventListener('click', toggleAllUpgradesView);
            viewAllTrades.addEventListener('click', toggleAllTradesView);
        }

        // Инициализация системы кейсов
        function initCasesSystem() {
            // Обработчики событий для кейсов
            basicCase.addEventListener('click', () => openCase('basic'));
            advancedCase.addEventListener('click', () => openCase('advanced'));
            premiumCase.addEventListener('click', () => openCase('premium'));
            legendaryCase.addEventListener('click', () => openCase('legendary'));
            mythicalCase.addEventListener('click', () => openCase('mythical'));
            divineCase.addEventListener('click', () => openCase('divine'));
            closeCaseResult.addEventListener('click', hideCaseResult);
            
            // Обработчики для кода админа
            confirmAdminCode.addEventListener('click', verifyAdminCode);
            cancelAdminCode.addEventListener('click', hideAdminCodeModal);
            closeAdminCodeModal.addEventListener('click', hideAdminCodeModal);
        }

        // Инициализация системы обмена
        function initTradeSystem() {
            // Обработчики событий для обмена
            createTradeBtn.addEventListener('click', showTradeModal);
            refreshTrades.addEventListener('click', loadTradeOffers);
            addMyUpgrade.addEventListener('click', () => showInventoryModal('my'));
            addTheirUpgrade.addEventListener('click', () => showInventoryModal('their'));
            sendTradeOffer.addEventListener('click', sendTradeOfferHandler);
            cancelTrade.addEventListener('click', hideTradeModal);
            closeTradeModal.addEventListener('click', hideTradeModal);
            
            // Обработчики для инвентаря
            confirmInventorySelection.addEventListener('click', confirmInventorySelectionHandler);
            cancelInventorySelection.addEventListener('click', hideInventoryModal);
            closeInventoryModal.addEventListener('click', hideInventoryModal);
            
            // Обновление кликов в обмене при изменении
            myClicksInput.addEventListener('input', updateTradeClicks);
            theirClicksInput.addEventListener('input', updateTradeClicks);
        }

        // Загрузка улучшений пользователя
        function loadUpgrades() {
            if (!auth.currentUser) return;
            
            const upgradesRef = database.ref('userUpgrades/' + auth.currentUser.uid);
            upgradesRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    upgrades = data;
                    // Гарантируем, что items всегда является массивом
                    if (!upgrades.items) {
                        upgrades.items = [];
                    }
                    if (!upgrades.totalBonus) {
                        upgrades.totalBonus = 0;
                    }
                    renderUpgradesList();
                    updateBonusDisplay();
                } else {
                    // Если данных нет, инициализируем пустые улучшения
                    upgrades = {
                        totalBonus: 0,
                        items: []
                    };
                    renderUpgradesList();
                    updateBonusDisplay();
                }
            });
        }

        // Отрисовка списка улучшений
        function renderUpgradesList() {
            upgradesContainer.innerHTML = '';
            
            if (upgrades.items && upgrades.items.length > 0) {
                // Сортируем улучшения по значению (по убыванию)
                const sortedUpgrades = [...upgrades.items].sort((a, b) => b.value - a.value);
                
                // Ограничиваем количество отображаемых улучшений, если не показываем все
                const displayUpgrades = showAllUpgrades ? sortedUpgrades : sortedUpgrades.slice(0, 5);
                
                displayUpgrades.forEach((upgrade, index) => {
                    const upgradeItem = document.createElement('div');
                    upgradeItem.className = 'upgrade-item';
                    
                    let rarityClass = 'upgrade-rarity-common';
                    if (upgrade.value === 0.2) rarityClass = 'upgrade-rarity-uncommon';
                    else if (upgrade.value === 0.5) rarityClass = 'upgrade-rarity-rare';
                    else if (upgrade.value === 1.0) rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.value === 2.0) rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.value === 3.0) rarityClass = 'upgrade-rarity-legendary';
                    else if (upgrade.value === 5.0) rarityClass = 'upgrade-rarity-legendary';
                    else if (upgrade.value === 8.0) rarityClass = 'upgrade-rarity-mythical';
                    else if (upgrade.value === 10.0) rarityClass = 'upgrade-rarity-mythical';
                    else if (upgrade.value === 15.0) rarityClass = 'upgrade-rarity-divine';
                    
                    upgradeItem.innerHTML = `
                        <div>
                            <span class="${rarityClass}">Улучшение +${upgrade.value}</span>
                        </div>
                        <div>
                            <small>${new Date(upgrade.timestamp).toLocaleDateString('ru-RU')}</small>
                        </div>
                    `;
                    
                    upgradesContainer.appendChild(upgradeItem);
                });
                
                // Показываем кнопку "Посмотреть все", если улучшений больше 5
                if (upgrades.items.length > 5) {
                    viewAllUpgrades.style.display = 'block';
                    viewAllUpgrades.textContent = showAllUpgrades ? 'Скрыть' : 'Посмотреть все';
                } else {
                    viewAllUpgrades.style.display = 'none';
                }
                
                const totalBonusItem = document.createElement('div');
                totalBonusItem.className = 'upgrade-item';
                totalBonusItem.style.background = 'rgba(253, 187, 45, 0.3)';
                totalBonusItem.innerHTML = `
                    <div><strong>Общий бонус к клику</strong></div>
                    <div><strong>+${upgrades.totalBonus || 0}</strong></div>
                `;
                upgradesContainer.appendChild(totalBonusItem);
            } else {
                upgradesContainer.innerHTML = '<div style="text-align: center; padding: 20px;">У вас пока нет улучшений</div>';
                viewAllUpgrades.style.display = 'none';
            }
        }

        // Переключение отображения всех улучшений
        function toggleAllUpgradesView() {
            showAllUpgrades = !showAllUpgrades;
            renderUpgradesList();
        }

        // Переключение отображения всех обменов
        function toggleAllTradesView() {
            showAllTrades = !showAllTrades;
            viewAllTrades.textContent = showAllTrades ? 'Скрыть' : 'Посмотреть все';
            loadTradeOffers();
        }

        // Обновление отображения бонуса
        function updateBonusDisplay() {
            if (upgrades.totalBonus > 0) {
                bonusValue.textContent = upgrades.totalBonus.toFixed(1);
                bonusDisplay.style.display = 'block';
            } else {
                bonusDisplay.style.display = 'none';
            }
        }

        // Открытие кейса
        function openCase(caseType) {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы открывать кейсы');
                return;
            }
            
            let casePrice, caseName, caseElement;
            let chances = [];
            
            switch(caseType) {
                case 'basic':
                    casePrice = 500;
                    caseName = 'Базовый кейс';
                    caseElement = basicCase;
                    chances = [
                        { value: 0.1, probability: 65 },
                        { value: 0.2, probability: 25 },
                        { value: 0.5, probability: 8 },
                        { value: 1.0, probability: 2 }
                    ];
                    break;
                case 'advanced':
                    casePrice = 1500;
                    caseName = 'Продвинутый кейс';
                    caseElement = advancedCase;
                    chances = [
                        { value: 0.2, probability: 65 },
                        { value: 0.5, probability: 25 },
                        { value: 1.0, probability: 8 },
                        { value: 2.0, probability: 2 }
                    ];
                    break;
                case 'premium':
                    casePrice = 3000;
                    caseName = 'Премиум кейс';
                    caseElement = premiumCase;
                    chances = [
                        { value: 0.5, probability: 65 },
                        { value: 1.0, probability: 25 },
                        { value: 2.0, probability: 8 },
                        { value: 3.0, probability: 2 }
                    ];
                    break;
                case 'legendary':
                    casePrice = 6000;
                    caseName = 'Легендарный кейс';
                    caseElement = legendaryCase;
                    chances = [
                        { value: 1.0, probability: 65 },
                        { value: 2.0, probability: 25 },
                        { value: 3.0, probability: 8 },
                        { value: 5.0, probability: 2 }
                    ];
                    break;
                case 'mythical':
                    casePrice = 10000;
                    caseName = 'Мифический кейс';
                    caseElement = mythicalCase;
                    chances = [
                        { value: 2.0, probability: 65 },
                        { value: 3.0, probability: 25 },
                        { value: 5.0, probability: 8 },
                        { value: 8.0, probability: 2 }
                    ];
                    break;
                case 'divine':
                    casePrice = 25000;
                    caseName = 'Божественный кейс';
                    caseElement = divineCase;
                    chances = [
                        { value: 5.0, probability: 65 },
                        { value: 8.0, probability: 25 },
                        { value: 10.0, probability: 8 },
                        { value: 15.0, probability: 2 }
                    ];
                    break;
                default:
                    return;
            }
            
            if (gameState.clicks < casePrice) {
                alert(`Недостаточно кликов! Нужно ${casePrice} кликов.`);
                return;
            }
            
            if (!confirm(`Открыть ${caseName} за ${casePrice} кликов?`)) {
                return;
            }
            
            // Спин анимация
            caseElement.style.opacity = '0.7';
            caseElement.querySelector('button').textContent = 'Открывается...';
            
            // Имитация открытия кейса с задержкой
            setTimeout(() => {
                // Вычисление выпавшего улучшения
                const random = Math.random() * 100;
                let upgradeValue, rarity, rarityName;
                let cumulativeProbability = 0;
                
                for (let chance of chances) {
                    cumulativeProbability += chance.probability;
                    if (random <= cumulativeProbability) {
                        upgradeValue = chance.value;
                        break;
                    }
                }
                
                // Определение редкости
                if (upgradeValue === 0.1) {
                    rarity = 'common';
                    rarityName = 'Обычное';
                } else if (upgradeValue === 0.2) {
                    rarity = 'uncommon';
                    rarityName = 'Необычное';
                } else if (upgradeValue === 0.5) {
                    rarity = 'rare';
                    rarityName = 'Редкое';
                } else if (upgradeValue === 1.0) {
                    rarity = 'epic';
                    rarityName = 'Эпическое';
                } else if (upgradeValue === 2.0) {
                    rarity = 'epic';
                    rarityName = 'Эпическое';
                } else if (upgradeValue === 3.0) {
                    rarity = 'legendary';
                    rarityName = 'Легендарное';
                } else if (upgradeValue === 5.0) {
                    rarity = 'legendary';
                    rarityName = 'Легендарное';
                } else if (upgradeValue === 8.0) {
                    rarity = 'mythical';
                    rarityName = 'Мифическое';
                } else if (upgradeValue === 10.0) {
                    rarity = 'mythical';
                    rarityName = 'Мифическое';
                } else if (upgradeValue === 15.0) {
                    rarity = 'divine';
                    rarityName = 'Божественное';
                }
                
                // Списание кликов
                gameState.clicks -= casePrice;
                updateGameDisplay();
                saveGameState();
                
                // Добавление улучшения
                addUpgrade(upgradeValue, rarity, rarityName);
                
                // Показ результата
                showCaseResult(upgradeValue, rarity, rarityName, caseName);
                
                // Восстановление кнопки
                caseElement.style.opacity = '1';
                caseElement.querySelector('button').textContent = 'Открыть кейс';
            }, 1500);
        }

        // Добавление улучшения
        function addUpgrade(value, rarity, rarityName) {
            if (!upgrades.items) {
                upgrades.items = [];
            }
            
            const newUpgrade = {
                value: value,
                rarity: rarity,
                rarityName: rarityName,
                timestamp: Date.now()
            };
            
            upgrades.items.push(newUpgrade);
            upgrades.totalBonus = (upgrades.totalBonus || 0) + value;
            
            // Сохранение в базе данных
            if (auth.currentUser) {
                const upgradesRef = database.ref('userUpgrades/' + auth.currentUser.uid);
                upgradesRef.set(upgrades);
            }
            
            // Обновление отображения
            renderUpgradesList();
            updateBonusDisplay();
        }

        // Показать результат открытия кейса
        function showCaseResult(value, rarity, rarityName, caseName) {
            let rarityColor = '#ffffff';
            if (rarity === 'uncommon') rarityColor = '#4CAF50';
            else if (rarity === 'rare') rarityColor = '#2196F3';
            else if (rarity === 'epic') rarityColor = '#9C27B0';
            else if (rarity === 'legendary') rarityColor = '#FF9800';
            else if (rarity === 'mythical') rarityColor = '#9C27B0';
            else if (rarity === 'divine') rarityColor = '#00BCD4';
            
            caseResultTitle.textContent = `Результат: ${caseName}`;
            caseResultContent.innerHTML = `
                <div style="font-size: 1.5rem; color: ${rarityColor}; margin: 10px 0;">
                    ${rarityName} улучшение!
                </div>
                <div style="font-size: 2rem; font-weight: bold; color: #fdbb2d; margin: 15px 0;">
                    +${value} к клику
                </div>
                <div>Теперь каждый ваш клик будет приносить дополнительные клики!</div>
            `;
            
            caseResultModal.style.display = 'flex';
        }

        // Скрыть результат открытия кейса
        function hideCaseResult() {
            caseResultModal.style.display = 'none';
        }

        // Показать модальное окно кода админа
        function showAdminCodeModal() {
            adminCodeModal.style.display = 'flex';
            adminCodeInput.value = '';
        }

        // Скрыть модальное окно кода админа
        function hideAdminCodeModal() {
            adminCodeModal.style.display = 'none';
        }

        // Проверка кода админа
        function verifyAdminCode() {
            const enteredCode = adminCodeInput.value.trim();
            
            if (enteredCode === ADMIN_CONFIRMATION_CODE) {
                hideAdminCodeModal();
                adminSection.style.display = 'block';
                loadUserList();
            } else {
                alert('Неверный код подтверждения!');
            }
        }

        // Показать модальное окно инвентаря
        function showInventoryModal(side) {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы использовать обмен');
                return;
            }
            
            if (!upgrades.items || upgrades.items.length === 0) {
                alert('У вас нет улучшений для обмена');
                return;
            }
            
            currentInventorySide = side;
            selectedInventoryItems = [];
            
            // Заголовок в зависимости от стороны
            inventoryModalTitle.textContent = side === 'my' ? 
                'Выберите улучшения для обмена' : 
                'Выберите улучшения, которые хотите получить';
            
            // Заполнение сетки инвентаря
            inventoryGrid.innerHTML = '';
            
            upgrades.items.forEach((upgrade, index) => {
                // Проверяем, не добавлено ли уже это улучшение в обмен
                const alreadyAdded = currentTrade.myItems.some(item => 
                    Math.abs(item.value - upgrade.value) < 0.001 && 
                    item.rarity === upgrade.rarity
                );
                
                if (!alreadyAdded) {
                    const inventoryItem = document.createElement('div');
                    inventoryItem.className = 'inventory-item';
                    inventoryItem.dataset.index = index;
                    
                    let rarityClass = 'upgrade-rarity-common';
                    if (upgrade.rarity === 'uncommon') rarityClass = 'upgrade-rarity-uncommon';
                    else if (upgrade.rarity === 'rare') rarityClass = 'upgrade-rarity-rare';
                    else if (upgrade.rarity === 'epic') rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.rarity === 'legendary') rarityClass = 'upgrade-rarity-legendary';
                    else if (upgrade.rarity === 'mythical') rarityClass = 'upgrade-rarity-mythical';
                    else if (upgrade.rarity === 'divine') rarityClass = 'upgrade-rarity-divine';
                    
                    inventoryItem.innerHTML = `
                        <div class="${rarityClass}" style="font-weight: bold; margin-bottom: 5px;">+${upgrade.value}</div>
                        <div style="font-size: 0.8rem;">${upgrade.rarityName}</div>
                        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">${new Date(upgrade.timestamp).toLocaleDateString('ru-RU')}</div>
                    `;
                    
                    inventoryItem.addEventListener('click', () => {
                        inventoryItem.classList.toggle('selected');
                        const itemIndex = parseInt(inventoryItem.dataset.index);
                        
                        if (inventoryItem.classList.contains('selected')) {
                            selectedInventoryItems.push(itemIndex);
                        } else {
                            selectedInventoryItems = selectedInventoryItems.filter(idx => idx !== itemIndex);
                        }
                    });
                    
                    inventoryGrid.appendChild(inventoryItem);
                }
            });
            
            // Если все улучшения уже в обмене
            if (inventoryGrid.children.length === 0) {
                inventoryGrid.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1 / -1;">Все ваши улучшения уже добавлены в обмен</div>';
            }
            
            inventoryModal.style.display = 'flex';
        }

        // Скрыть модальное окно инвентаря
        function hideInventoryModal() {
            inventoryModal.style.display = 'none';
            selectedInventoryItems = [];
            currentInventorySide = null;
        }

        // Подтверждение выбора в инвентаре
        function confirmInventorySelectionHandler() {
            if (selectedInventoryItems.length === 0) {
                alert('Выберите хотя бы одно улучшение');
                return;
            }
            
            // Добавляем выбранные улучшения в обмен
            selectedInventoryItems.forEach(index => {
                const upgrade = upgrades.items[index];
                
                const tradeItem = {
                    value: upgrade.value,
                    rarity: upgrade.rarity,
                    rarityName: upgrade.rarityName,
                    timestamp: upgrade.timestamp
                };
                
                if (currentInventorySide === 'my') {
                    // Проверяем, не добавлено ли уже это улучшение
                    const alreadyAdded = currentTrade.myItems.some(item => 
                        Math.abs(item.value - upgrade.value) < 0.001 && 
                        item.rarity === upgrade.rarity
                    );
                    
                    if (!alreadyAdded) {
                        currentTrade.myItems.push(tradeItem);
                    }
                } else {
                    // Для запрашиваемых улучшений мы просто добавляем их в список
                    // без проверки на дубликаты, так как это то, что мы хотим получить
                    currentTrade.theirItems.push(tradeItem);
                }
            });
            
            updateTradeDisplay();
            hideInventoryModal();
        }

        // Показать модальное окно обмена
        function showTradeModal() {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы создавать обмены');
                return;
            }
            
            // Сброс текущего обмена
            currentTrade = {
                myItems: [],
                myClicks: 0,
                theirItems: [],
                theirClicks: 0,
                targetPlayer: null
            };
            
            // Обновление UI
            myClicksInput.value = '';
            theirClicksInput.value = '';
            tradePlayerInput.value = '';
            updateTradeDisplay();
            
            tradeModal.style.display = 'flex';
        }

        // Скрыть модальное окно обмена
        function hideTradeModal() {
            tradeModal.style.display = 'none';
        }

        // Обновление кликов в обмене
        function updateTradeClicks() {
            const myClicks = parseInt(myClicksInput.value) || 0;
            const theirClicks = parseInt(theirClicksInput.value) || 0;
            
            // Проверка на отрицательные значения
            currentTrade.myClicks = Math.max(0, myClicks);
            currentTrade.theirClicks = Math.max(0, theirClicks);
            
            // Обновляем поля ввода
            myClicksInput.value = currentTrade.myClicks;
            theirClicksInput.value = currentTrade.theirClicks;
            
            updateTradeDisplay();
        }

        // Обновление отображения обмена
        function updateTradeDisplay() {
            // Очистка списков
            myTradeItems.innerHTML = '';
            theirTradeItems.innerHTML = '';
            
            // Отображение ваших предметов
            currentTrade.myItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <span>+${item.value} (${item.rarityName})</span>
                    <button onclick="removeTradeItem('my', ${index})">×</button>
                `;
                myTradeItems.appendChild(itemElement);
            });
            
            // Отображение ваших кликов
            if (currentTrade.myClicks > 0) {
                const clicksElement = document.createElement('div');
                clicksElement.className = 'trade-item';
                clicksElement.innerHTML = `
                    <span>${currentTrade.myClicks} кликов</span>
                    <button onclick="removeTradeClicks('my')">×</button>
                `;
                myTradeItems.appendChild(clicksElement);
            }
            
            // Отображение предметов другого игрока
            currentTrade.theirItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <span>+${item.value} (${item.rarityName})</span>
                    <button onclick="removeTradeItem('their', ${index})">×</button>
                `;
                theirTradeItems.appendChild(itemElement);
            });
            
            // Отображение кликов другого игрока
            if (currentTrade.theirClicks > 0) {
                const clicksElement = document.createElement('div');
                clicksElement.className = 'trade-item';
                clicksElement.innerHTML = `
                    <span>${currentTrade.theirClicks} кликов</span>
                    <button onclick="removeTradeClicks('their')">×</button>
                `;
                theirTradeItems.appendChild(clicksElement);
            }
            
            // Если списки пустые, показываем сообщение
            if (myTradeItems.children.length === 0) {
                myTradeItems.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.7;">Пусто</div>';
            }
            
            if (theirTradeItems.children.length === 0) {
                theirTradeItems.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.7;">Пусто</div>';
            }
        }

        // Удаление предмета из обмена (глобальная функция)
        window.removeTradeItem = function(side, index) {
            if (side === 'my') {
                currentTrade.myItems.splice(index, 1);
            } else {
                currentTrade.theirItems.splice(index, 1);
            }
            updateTradeDisplay();
        };

        // Удаление кликов из обмена (глобальная функция)
        window.removeTradeClicks = function(side) {
            if (side === 'my') {
                currentTrade.myClicks = 0;
                myClicksInput.value = '';
            } else {
                currentTrade.theirClicks = 0;
                theirClicksInput.value = '';
            }
            updateTradeDisplay();
        };

        // Отправка предложения обмена
        function sendTradeOfferHandler() {
            const targetPlayerName = tradePlayerInput.value.trim();
            if (!targetPlayerName) {
                alert('Введите имя игрока для обмена');
                return;
            }
            
            if (currentTrade.myItems.length === 0 && currentTrade.myClicks === 0) {
                alert('Вы не предлагаете ничего для обмена');
                return;
            }
            
            if (currentTrade.theirItems.length === 0 && currentTrade.theirClicks === 0) {
                alert('Вы не запрашиваете ничего для обмена');
                return;
            }
            
            // Проверка своих кликов
            if (currentTrade.myClicks > gameState.clicks) {
                alert('У вас недостаточно кликов для этого обмена');
                return;
            }
            
            // Поиск игрока по имени
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                let targetUser = null;
                
                for (let userId in users) {
                    if (userId === auth.currentUser.uid) continue;
                    
                    const userNickname = users[userId].nickname || users[userId].email.split('@')[0];
                    if (userNickname.toLowerCase() === targetPlayerName.toLowerCase()) {
                        targetUser = {
                            id: userId,
                            ...users[userId]
                        };
                        break;
                    }
                }
                
                if (!targetUser) {
                    alert('Игрок с таким именем не найден');
                    return;
                }
                
                // Создание предложения обмена
                const tradeRef = database.ref('trades').push();
                const tradeData = {
                    fromUserId: auth.currentUser.uid,
                    fromUserName: userName.textContent,
                    toUserId: targetUser.id,
                    toUserName: targetUser.nickname || targetUser.email.split('@')[0],
                    myItems: currentTrade.myItems,
                    myClicks: currentTrade.myClicks,
                    theirItems: currentTrade.theirItems,
                    theirClicks: currentTrade.theirClicks,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                tradeRef.set(tradeData).then(() => {
                    alert('Предложение обмена отправлено!');
                    hideTradeModal();
                    loadTradeOffers();
                }).catch(error => {
                    console.error('Ошибка отправки обмена:', error);
                    alert('Ошибка при отправке предложения обмена');
                });
            });
        }

        // Загрузка предложений обмена
        function loadTradeOffers() {
            if (!auth.currentUser) return;
            
            const tradesRef = database.ref('trades');
            tradesRef.on('value', snapshot => {
                const trades = snapshot.val();
                tradeOffers.innerHTML = '';
                
                if (trades) {
                    // Преобразуем объект в массив и сортируем по времени (новые сначала)
                    const tradesArray = Object.keys(trades).map(tradeId => ({
                        id: tradeId,
                        ...trades[tradeId]
                    })).sort((a, b) => b.timestamp - a.timestamp);
                    
                    // Ограничиваем количество отображаемых обменов, если не показываем все
                    const displayTrades = showAllTrades ? tradesArray : tradesArray.slice(0, 5);
                    
                    let hasUserTrades = false;
                    
                    displayTrades.forEach(trade => {
                        // Показываем только относящиеся к текущему пользователю обмены
                        if (trade.fromUserId === auth.currentUser.uid || trade.toUserId === auth.currentUser.uid) {
                            addTradeOfferToList(trade.id, trade);
                            hasUserTrades = true;
                        }
                    });
                    
                    if (!hasUserTrades) {
                        tradeOffers.innerHTML = '<div style="text-align: center; padding: 20px;">Нет активных предложений обмена</div>';
                    }
                    
                    // Показываем кнопку "Посмотреть все", если обменов больше 5
                    if (tradesArray.length > 5) {
                        viewAllTrades.style.display = 'block';
                    } else {
                        viewAllTrades.style.display = 'none';
                    }
                } else {
                    tradeOffers.innerHTML = '<div style="text-align: center; padding: 20px;">Нет активных предложений обмена</div>';
                    viewAllTrades.style.display = 'none';
                }
            });
        }

        // Добавление предложения обмена в список
        function addTradeOfferToList(tradeId, trade) {
            const isOutgoing = trade.fromUserId === auth.currentUser.uid;
            const otherUserName = isOutgoing ? trade.toUserName : trade.fromUserName;
            
            const tradeElement = document.createElement('div');
            tradeElement.className = 'trade-offer';
            tradeElement.id = `trade-${tradeId}`;
            
            let tradeInfo = `
                <div class="trade-offer-info">
                    <strong>${isOutgoing ? 'Исходящее' : 'Входящее'} предложение</strong><br>
                    <small>С игроком: ${otherUserName}</small><br>
                    <small>Статус: ${getTradeStatusText(trade.status)}</small>
                </div>
            `;
            
            if (trade.status === 'pending') {
                if (isOutgoing) {
                    tradeInfo += `
                        <div class="trade-offer-actions">
                            <button onclick="cancelTradeOffer('${tradeId}')">Отменить</button>
                        </div>
                    `;
                } else {
                    tradeInfo += `
                        <div class="trade-offer-actions">
                            <button onclick="acceptTradeOffer('${tradeId}')">Принять</button>
                            <button onclick="rejectTradeOffer('${tradeId}')">Отклонить</button>
                        </div>
                    `;
                }
            }
            
            tradeElement.innerHTML = tradeInfo;
            tradeOffers.appendChild(tradeElement);
        }

        // Получение текста статуса обмена
        function getTradeStatusText(status) {
            switch(status) {
                case 'pending': return 'Ожидание';
                case 'accepted': return 'Принят';
                case 'rejected': return 'Отклонен';
                case 'cancelled': return 'Отменен';
                default: return status;
            }
        }

        // Автоматический обмен - обработка принятия обмена
        window.acceptTradeOffer = function(tradeId) {
            if (!confirm('Принять это предложение обмена?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            
            // Сначала получаем данные об обмене
            tradeRef.once('value').then(snapshot => {
                const trade = snapshot.val();
                
                if (!trade) {
                    alert('Предложение обмена не найдено');
                    return;
                }
                
                if (trade.status !== 'pending') {
                    alert('Это предложение обмена уже обработано');
                    return;
                }
                
                // Проверяем, есть ли у нас достаточно кликов и улучшений
                if (trade.toUserId !== auth.currentUser.uid) {
                    alert('Это предложение обмена не для вас');
                    return;
                }
                
                // Получаем данные обоих пользователей
                const fromUserRef = database.ref('users/' + trade.fromUserId);
                const toUserRef = database.ref('users/' + trade.toUserId);
                
                Promise.all([
                    fromUserRef.once('value'),
                    toUserRef.once('value'),
                    database.ref('userUpgrades/' + trade.fromUserId).once('value'),
                    database.ref('userUpgrades/' + trade.toUserId).once('value')
                ]).then(([fromUserSnap, toUserSnap, fromUpgradesSnap, toUpgradesSnap]) => {
                    const fromUser = fromUserSnap.val();
                    const toUser = toUserSnap.val();
                    const fromUpgrades = fromUpgradesSnap.val() || { items: [], totalBonus: 0 };
                    const toUpgrades = toUpgradesSnap.val() || { items: [], totalBonus: 0 };
                    
                    // Проверяем, есть ли у отправителя достаточно кликов
                    if (fromUser.clicks < trade.myClicks) {
                        alert('У отправителя недостаточно кликов для обмена');
                        tradeRef.update({ status: 'failed', reason: 'Недостаточно кликов у отправителя' });
                        return;
                    }
                    
                    // Проверяем, есть ли у получателя достаточно кликов
                    if (toUser.clicks < trade.theirClicks) {
                        alert('У вас недостаточно кликов для обмена');
                        tradeRef.update({ status: 'failed', reason: 'Недостаточно кликов у получателя' });
                        return;
                    }
                    
                    // Проверяем, есть ли у отправителя все указанные улучшения
                    const fromUserHasItems = trade.myItems.every(tradeItem => 
                        fromUpgrades.items && fromUpgrades.items.some(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        )
                    );
                    
                    if (!fromUserHasItems) {
                        alert('У отправителя нет указанных улучшений');
                        tradeRef.update({ status: 'failed', reason: 'У отправителя нет указанных улучшений' });
                        return;
                    }
                    
                    // Проверяем, есть ли у получателя все указанные улучшения
                    const toUserHasItems = trade.theirItems.every(tradeItem => 
                        toUpgrades.items && toUpgrades.items.some(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        )
                    );
                    
                    if (!toUserHasItems) {
                        alert('У вас нет указанных улучшений');
                        tradeRef.update({ status: 'failed', reason: 'У получателя нет указанных улучшений' });
                        return;
                    }
                    
                    // Выполняем обмен кликами
                    const fromUserNewClicks = fromUser.clicks - trade.myClicks + trade.theirClicks;
                    const toUserNewClicks = toUser.clicks - trade.theirClicks + trade.myClicks;
                    
                    // Обновляем клики
                    fromUserRef.update({ clicks: fromUserNewClicks });
                    toUserRef.update({ clicks: toUserNewClicks });
                    
                    // Выполняем обмен улучшениями
                    const fromUserNewUpgrades = { ...fromUpgrades };
                    const toUserNewUpgrades = { ...toUpgrades };
                    
                    // Инициализируем массивы items если они undefined
                    if (!fromUserNewUpgrades.items) fromUserNewUpgrades.items = [];
                    if (!toUserNewUpgrades.items) toUserNewUpgrades.items = [];
                    
                    // Удаляем улучшения у отправителя и добавляем ему улучшения получателя
                    trade.myItems.forEach(tradeItem => {
                        const index = fromUserNewUpgrades.items.findIndex(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        );
                        
                        if (index !== -1) {
                            fromUserNewUpgrades.items.splice(index, 1);
                            fromUserNewUpgrades.totalBonus = (fromUserNewUpgrades.totalBonus || 0) - tradeItem.value;
                        }
                    });
                    
                    trade.theirItems.forEach(tradeItem => {
                        fromUserNewUpgrades.items.push(tradeItem);
                        fromUserNewUpgrades.totalBonus = (fromUserNewUpgrades.totalBonus || 0) + tradeItem.value;
                    });
                    
                    // Удаляем улучшения у получателя и добавляем ему улучшения отправителя
                    trade.theirItems.forEach(tradeItem => {
                        const index = toUserNewUpgrades.items.findIndex(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        );
                        
                        if (index !== -1) {
                            toUserNewUpgrades.items.splice(index, 1);
                            toUserNewUpgrades.totalBonus = (toUserNewUpgrades.totalBonus || 0) - tradeItem.value;
                        }
                    });
                    
                    trade.myItems.forEach(tradeItem => {
                        toUserNewUpgrades.items.push(tradeItem);
                        toUserNewUpgrades.totalBonus = (toUserNewUpgrades.totalBonus || 0) + tradeItem.value;
                    });
                    
                    // Сохраняем обновленные улучшения
                    database.ref('userUpgrades/' + trade.fromUserId).set(fromUserNewUpgrades);
                    database.ref('userUpgrades/' + trade.toUserId).set(toUserNewUpgrades);
                    
                    // Обновляем статус обмена
                    tradeRef.update({ 
                        status: 'accepted',
                        completedAt: Date.now()
                    }).then(() => {
                        alert('Обмен успешно завершен!');
                        loadTradeOffers();
                        
                        // Обновляем локальное состояние, если мы участвовали в обмене
                        if (trade.fromUserId === auth.currentUser.uid || trade.toUserId === auth.currentUser.uid) {
                            loadUpgrades();
                            loadGameState();
                        }
                    });
                    
                }).catch(error => {
                    console.error('Ошибка при выполнении обмена:', error);
                    alert('Произошла ошибка при выполнении обмена');
                    tradeRef.update({ status: 'failed', reason: 'Ошибка при выполнении обмена' });
                });
                
            }).catch(error => {
                console.error('Ошибка при получении данных обмена:', error);
                alert('Произошла ошибка при принятии обмена');
            });
        };

        // Отклонение предложения обмена (глобальная функция)
        window.rejectTradeOffer = function(tradeId) {
            if (!confirm('Отклонить это предложение обмена?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.update({ status: 'rejected' }).then(() => {
                alert('Предложение обмена отклонено');
                loadTradeOffers();
            });
        };

        // Отмена предложения обмена (глобальная функция)
        window.cancelTradeOffer = function(tradeId) {
            if (!confirm('Отменить это предложение обмена?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.update({ status: 'cancelled' }).then(() => {
                alert('Предложение обмена отменено');
                loadTradeOffers();
            });
        };

        // Обработка клика с учетом улучшений
        function handleClick() {
            if (isBlocked) return;
            
            const now = Date.now();
            clickTimestamps.push(now);
            
            // Удаление старых кликов (старше 1 секунды)
            clickTimestamps = clickTimestamps.filter(timestamp => now - timestamp < 1000);
            
            // Проверка CPS
            currentCPS = clickTimestamps.length;
            if (currentCPS > MAX_CPS) {
                blockUser();
                return;
            }
            
            // Обновление состояния игры с учетом улучшений и множителя события
            const baseClickValue = 1;
            const upgradeBonus = upgrades.totalBonus || 0;
            const totalClickValue = (baseClickValue + upgradeBonus) * gameState.clickMultiplier;
            
            gameState.clicks += totalClickValue;
            
            if (gameState.clicks > gameState.bestScore) {
                gameState.bestScore = gameState.clicks;
            }
            
            // Обновление отображения
            updateGameDisplay();
            
            // Сохранение состояния
            saveGameState();
            
            // Анимация клика
            animateClick();
        }

        // Переключение админ панели с проверкой кода
        function toggleAdminPanel() {
            if (!isAdmin) {
                alert('У вас нет прав администратора');
                return;
            }
            
            // Если админ, но код еще не введен, показываем модальное окно
            if (adminSection.style.display === 'none' || !adminSection.style.display) {
                showAdminCodeModal();
            } else {
                adminSection.style.display = 'none';
            }
        }

        // Сброс всех результатов и улучшений
        function resetAllScoresHandler() {
            if (!confirm('Вы уверены, что хотите обнулить все результаты и улучшения? Это действие нельзя отменить.')) {
                return;
            }
            
            const usersRef = database.ref('users');
            const upgradesRef = database.ref('userUpgrades');
            
            Promise.all([
                usersRef.once('value'),
                upgradesRef.once('value')
            ]).then(([usersSnapshot, upgradesSnapshot]) => {
                const usersUpdates = {};
                const upgradesUpdates = {};
                
                // Подготовка обновлений для пользователей
                const users = usersSnapshot.val();
                if (users) {
                    for (let userId in users) {
                        usersUpdates[`${userId}/clicks`] = 0;
                        usersUpdates[`${userId}/bestScore`] = 0;
                    }
                }
                
                // Подготовка обновлений для улучшений
                const upgrades = upgradesSnapshot.val();
                if (upgrades) {
                    for (let userId in upgrades) {
                        upgradesUpdates[`${userId}/totalBonus`] = 0;
                        upgradesUpdates[`${userId}/items`] = [];
                    }
                }
                
                // Выполняем все обновления
                return Promise.all([
                    usersUpdates ? usersRef.update(usersUpdates) : Promise.resolve(),
                    upgradesUpdates ? upgradesRef.update(upgradesUpdates) : Promise.resolve()
                ]);
            }).then(() => {
                alert('Все результаты и улучшения обнулены');
                loadUserList();
                loadLeaderboard();
                
                // Сброс локального состояния
                if (auth.currentUser) {
                    gameState.clicks = 0;
                    gameState.bestScore = 0;
                    upgrades.totalBonus = 0;
                    upgrades.items = [];
                    updateGameDisplay();
                    renderUpgradesList();
                    updateBonusDisplay();
                    saveGameState();
                }
            }).catch(error => {
                console.error('Ошибка при обнулении:', error);
                alert('Произошла ошибка при обнулении данных');
            });
        }

        // Блокировка пользователя за слишком быстрые клики
        function blockUser() {
            isBlocked = true;
            clickArea.classList.add('blocked');
            blockedOverlay.style.display = 'flex';
            cpsWarning.textContent = `СЛИШКОМ БЫСТРО! Подождите ${MAX_CPS/2} секунд`;
            
            blockTimeout = setTimeout(() => {
                isBlocked = false;
                clickArea.classList.remove('blocked');
                blockedOverlay.style.display = 'none';
                cpsWarning.textContent = '';
                clickTimestamps = [];
            }, (MAX_CPS/2) * 1000);
        }

        // Обновление CPS
        function updateCPS() {
            const now = Date.now();
            clickTimestamps = clickTimestamps.filter(timestamp => now - timestamp < 1000);
            currentCPS = clickTimestamps.length;
            
            cpsValue.textContent = currentCPS;
            
            // Обновление индикатора CPS
            const cpsPercentage = Math.min((currentCPS / MAX_CPS) * 100, 100);
            cpsFill.style.width = `${cpsPercentage}%`;
            
            // Цвет индикатора в зависимости от CPS
            if (currentCPS > MAX_CPS * 0.8) {
                cpsFill.style.background = 'linear-gradient(90deg, #FFC107, #F44336)';
            } else if (currentCPS > MAX_CPS * 0.5) {
                cpsFill.style.background = 'linear-gradient(90deg, #4CAF50, #FFC107)';
            } else {
                cpsFill.style.background = 'linear-gradient(90deg, #4CAF50, #4CAF50)';
            }
        }

        // Анимация клика
        function animateClick() {
            clickText.style.transform = 'scale(1.1)';
            setTimeout(() => {
                clickText.style.transform = 'scale(1)';
            }, 100);
        }

        // Обновление отображения игры
        function updateGameDisplay() {
            clickCount.textContent = Math.floor(gameState.clicks);
            bestScore.textContent = Math.floor(gameState.bestScore);
        }

        // Загрузка состояния игры
        function loadGameState() {
            // Если пользователь авторизован, загружаем из Firebase
            if (auth.currentUser) {
                loadUserData(auth.currentUser.uid);
            } else {
                // Иначе загружаем из localStorage
                const savedState = localStorage.getItem('clickerGameState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    gameState.clicks = parsedState.clicks || 0;
                    gameState.bestScore = parsedState.bestScore || 0;
                    updateGameDisplay();
                }
            }
        }

        // Сохранение состояния игры
        function saveGameState() {
            if (auth.currentUser) {
                // Сохраняем в Firebase
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.update({
                    clicks: Math.floor(gameState.clicks),
                    bestScore: Math.floor(gameState.bestScore),
                    lastActive: Date.now()
                });
            } else {
                // Сохраняем в localStorage
                localStorage.setItem('clickerGameState', JSON.stringify({
                    clicks: gameState.clicks,
                    bestScore: gameState.bestScore
                }));
            }
        }

        // Загрузка данных пользователя
        function loadUserData(userId) {
            const userRef = database.ref('users/' + userId);
            userRef.on('value', snapshot => {
                const userData = snapshot.val();
                if (userData) {
                    gameState.clicks = userData.clicks || 0;
                    gameState.bestScore = userData.bestScore || 0;
                    
                    // Обновление UI пользователя
                    userName.textContent = userData.nickname || userData.email.split('@')[0];
                    userAvatar.textContent = (userData.nickname || userData.email[0]).toUpperCase();
                    
                    if (userData.verified) {
                        userVerified.style.display = 'inline';
                    } else {
                        userVerified.style.display = 'none';
                    }
                    
                    changeNickname.style.display = 'block';
                    
                    updateGameDisplay();
                }
            });
        }

        // Загрузка лидерборда
        function loadLeaderboard() {
            const usersRef = database.ref('users');
            usersRef.orderByChild('bestScore').limitToLast(leaderboardLimit === 0 ? 1000 : leaderboardLimit).on('value', snapshot => {
                const users = snapshot.val();
                const leaderboardArray = [];
                
                for (let userId in users) {
                    if (users[userId].bestScore > 0) {
                        leaderboardArray.push({
                            id: userId,
                            email: users[userId].email,
                            nickname: users[userId].nickname,
                            clicks: users[userId].clicks || 0,
                            bestScore: users[userId].bestScore || 0,
                            verified: users[userId].verified || false
                        });
                    }
                }
                
                // Сортировка по bestScore (по убыванию)
                leaderboardArray.sort((a, b) => b.bestScore - a.bestScore);
                
                // Ограничение количества записей
                if (leaderboardLimit > 0) {
                    leaderboardArray.splice(leaderboardLimit);
                }
                
                // Отрисовка лидерборда
                renderLeaderboard(leaderboardArray);
            });
        }

        // Отрисовка лидерборда
        function renderLeaderboard(users) {
            leaderboard.innerHTML = '';
            
            users.forEach((user, index) => {
                const isCurrentUser = auth.currentUser && user.id === auth.currentUser.uid;
                const listItem = document.createElement('li');
                listItem.className = `leaderboard-item ${isCurrentUser ? 'current-user' : ''}`;
                
                listItem.innerHTML = `
                    <div class="rank">${index + 1}</div>
                    <div class="player-name">
                        <span>${user.nickname || user.email.split('@')[0]}</span>
                        ${user.verified ? '<span class="verified-badge">✓</span>' : ''}
                        ${isCurrentUser ? '<span style="color: #fdbb2d; margin-left: 5px;">(Вы)</span>' : ''}
                    </div>
                    <div class="player-score">${Math.floor(user.bestScore)}</div>
                `;
                
                if (isAdmin) {
                    const adminBtn = document.createElement('button');
                    adminBtn.textContent = 'Ред.';
                    adminBtn.style.padding = '5px 10px';
                    adminBtn.style.fontSize = '0.7rem';
                    adminBtn.addEventListener('click', () => editUser(user));
                    listItem.appendChild(adminBtn);
                }
                
                leaderboard.appendChild(listItem);
            });
            
            // Если нет пользователей
            if (users.length === 0) {
                const listItem = document.createElement('li');
                listItem.className = 'leaderboard-item';
                listItem.innerHTML = '<div style="text-align: center; width: 100%;">Нет данных для отображения</div>';
                leaderboard.appendChild(listItem);
            }
        }

        // Изменение лимита лидерборда
        function changeLeaderboardLimit(limit) {
            leaderboardLimit = limit;
            
            // Обновление активной кнопки
            showTop10.classList.remove('active');
            showTop25.classList.remove('active');
            showAll.classList.remove('active');
            
            if (limit === 10) showTop10.classList.add('active');
            if (limit === 25) showTop25.classList.add('active');
            if (limit === 0) showAll.classList.add('active');
            
            // Перезагрузка лидерборда
            loadLeaderboard();
        }

        // Показать модальное окно аутентификации
        function showAuthModal(type) {
            authModal.style.display = 'flex';
            if (type === 'login') {
                authModalTitle.textContent = 'Вход в аккаунт';
                authSubmit.textContent = 'Войти';
            } else {
                authModalTitle.textContent = 'Регистрация аккаунта';
                authSubmit.textContent = 'Зарегистрироваться';
            }
            
            currentAction = type;
        }

        // Скрыть модальное окно аутентификации
        function hideAuthModal() {
            authModal.style.display = 'none';
            authEmail.value = '';
            authPassword.value = '';
        }

        // Обработка аутентификации
        function handleAuthSubmit() {
            const email = authEmail.value;
            const password = authPassword.value;
            
            if (!email || !password) {
                alert('Пожалуйста, заполните все поля');
                return;
            }
            
            if (currentAction === 'login') {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        hideAuthModal();
                    })
                    .catch(error => {
                        alert('Ошибка входа: ' + error.message);
                    });
            } else {
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        // Создание записи пользователя в базе данных
                        const user = userCredential.user;
                        const userRef = database.ref('users/' + user.uid);
                        
                        userRef.set({
                            email: email,
                            nickname: email.split('@')[0],
                            clicks: 0,
                            bestScore: 0,
                            registered: Date.now(),
                            lastActive: Date.now(),
                            verified: false
                        });
                        
                        hideAuthModal();
                        showNicknameModal();
                    })
                    .catch(error => {
                        alert('Ошибка регистрации: ' + error.message);
                    });
            }
        }

        // Выход из системы
        function handleLogout() {
            auth.signOut();
        }

        // Показать модальное окно изменения никнейма
        function showNicknameModal() {
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.once('value').then(snapshot => {
                    const userData = snapshot.val();
                    nicknameInput.value = userData.nickname || '';
                    nicknameModal.style.display = 'flex';
                });
            }
        }

        // Скрыть модальное окно изменения никнейма
        function hideNicknameModal() {
            nicknameModal.style.display = 'none';
        }

        // Сохранение никнейма
        function saveNicknameHandler() {
            const nickname = nicknameInput.value.trim();
            
            if (!nickname) {
                alert('Пожалуйста, введите никнейм');
                return;
            }
            
            if (nickname.length > 15) {
                alert('Никнейм не может быть длиннее 15 символов');
                return;
            }
            
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.update({
                    nickname: nickname
                }).then(() => {
                    hideNicknameModal();
                    userName.textContent = nickname;
                    userAvatar.textContent = nickname[0].toUpperCase();
                });
            }
        }

        // Загрузка списка пользователей
        function loadUserList() {
            if (!isAdmin) return;
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const usersArray = [];
                
                for (let userId in users) {
                    usersArray.push({
                        id: userId,
                        email: users[userId].email,
                        nickname: users[userId].nickname,
                        clicks: users[userId].clicks || 0,
                        bestScore: users[userId].bestScore || 0,
                        verified: users[userId].verified || false,
                        lastActive: users[userId].lastActive || 0
                    });
                }
                
                // Сортировка по последней активности
                usersArray.sort((a, b) => b.lastActive - a.lastActive);
                
                // Отрисовка списка пользователей
                renderUserList(usersArray);
            });
        }

        // Отрисовка списка пользователей
        function renderUserList(users) {
            userList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString('ru-RU') : 'Никогда';
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div>${user.nickname || user.email.split('@')[0]} ${user.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">Клики: ${user.clicks} | Лучший: ${user.bestScore} | Активен: ${lastActive}</div>
                    </div>
                    <div class="user-actions">
                        <button class="edit-user">Ред.</button>
                    </div>
                `;
                
                const editBtn = userItem.querySelector('.edit-user');
                editBtn.addEventListener('click', () => editUser(user));
                
                userList.appendChild(userItem);
            });
        }

        // Редактирование пользователя
        function editUser(user) {
            selectedUser = user;
            adminModalTitle.textContent = `Редактирование: ${user.nickname || user.email.split('@')[0]}`;
            adminUserInfo.innerHTML = `
                <div>Email: ${user.email}</div>
                <div>Никнейм: ${user.nickname || 'Не установлен'}</div>
                <div>Клики: ${user.clicks}</div>
                <div>Лучший результат: ${user.bestScore}</div>
                <div>Верифицирован: ${user.verified ? 'Да' : 'Нет'}</div>
            `;
            adminClicksInput.value = user.clicks;
            adminBestScoreInput.value = user.bestScore;
            adminModal.style.display = 'flex';
        }

        // Скрыть модальное окно админа
        function hideAdminModal() {
            adminModal.style.display = 'none';
            selectedUser = null;
        }

        // Сохранение изменений пользователя
        function saveUserChanges() {
            if (!selectedUser) return;
            
            const newClicks = parseInt(adminClicksInput.value) || 0;
            const newBestScore = parseInt(adminBestScoreInput.value) || 0;
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.update({
                clicks: newClicks,
                bestScore: newBestScore
            }).then(() => {
                alert('Изменения сохранены');
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // Удаление пользователя
        function deleteUser() {
            if (!selectedUser || !confirm(`Вы уверены, что хотите удалить пользователя ${selectedUser.email}?`)) {
                return;
            }
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.remove().then(() => {
                alert('Пользователь удален');
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // Переключение статуса верификации
        function toggleUserVerified() {
            if (!selectedUser) return;
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.update({
                verified: !selectedUser.verified
            }).then(() => {
                alert(`Статус верификации изменен на: ${!selectedUser.verified ? 'Да' : 'Нет'}`);
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // Показать модальное окно событий
        function showEventModal() {
            eventModal.style.display = 'flex';
        }

        // Скрыть модальное окно событий
        function hideEventModal() {
            eventModal.style.display = 'none';
        }

        // Запуск события
        function startEventHandler() {
            const multiplier = parseFloat(eventMultiplier.value);
            const duration = parseInt(eventDuration.value);
            
            if (!multiplier || !duration) {
                alert('Пожалуйста, выберите множитель и длительность');
                return;
            }
            
            const eventRef = database.ref('activeEvent');
            const eventData = {
                multiplier: multiplier,
                endTime: Date.now() + (duration * 60 * 1000),
                startedBy: auth.currentUser.uid,
                startedAt: Date.now()
            };
            
            eventRef.set(eventData).then(() => {
                alert(`Событие ${multiplier}x запущено на ${duration} минут!`);
                hideEventModal();
                checkActiveEvent();
            });
        }

        // Остановка события
        function stopEventHandler() {
            if (!confirm('Вы уверены, что хотите остановить текущее событие?')) {
                return;
            }
            
            const eventRef = database.ref('activeEvent');
            eventRef.remove().then(() => {
                alert('Событие остановлено');
                hideEventModal();
                checkActiveEvent();
            });
        }

        // Проверка активного события
        function checkActiveEvent() {
            const eventRef = database.ref('activeEvent');
            eventRef.once('value').then(snapshot => {
                const event = snapshot.val();
                
                if (event && event.endTime > Date.now()) {
                    // Событие активно
                    gameState.clickMultiplier = event.multiplier;
                    const timeLeft = Math.ceil((event.endTime - Date.now()) / 1000 / 60);
                    
                    eventNotification.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>🔥 АКТИВНОЕ СОБЫТИЕ: ${event.multiplier}x КЛИКИ! Осталось: ${timeLeft} мин.</div>
                            ${isAdmin ? '<button onclick="stopEventFromNotification()" style="padding: 5px 10px; font-size: 0.8rem;">Остановить</button>' : ''}
                        </div>
                    `;
                    eventNotification.style.display = 'block';
                } else {
                    // Событие неактивно
                    gameState.clickMultiplier = 1;
                    eventNotification.style.display = 'none';
                    
                    // Удаляем завершенное событие
                    if (event) {
                        eventRef.remove();
                    }
                }
            });
        }

        // Остановка события из уведомления
        window.stopEventFromNotification = function() {
            if (!isAdmin) return;
            
            const eventRef = database.ref('activeEvent');
            eventRef.remove().then(() => {
                alert('Событие остановлено');
                checkActiveEvent();
            });
        };

        // Показать модальное окно кастомных кликов
        function showCustomClicksModal(target) {
            if (!isAdmin) return;
            
            currentAction = target;
            customClicksModal.style.display = 'flex';
            
            if (target === 'all') {
                customClicksTitle.textContent = 'Добавить клики всем пользователям';
            } else if (target === 'online') {
                customClicksTitle.textContent = 'Добавить клики онлайн пользователям';
            } else if (target === 'me') {
                customClicksTitle.textContent = 'Добавить клики себе';
            }
            
            customClicksInput.value = '';
        }

        // Скрыть модальное окно кастомных кликов
        function hideCustomClicksModal() {
            customClicksModal.style.display = 'none';
            currentAction = null;
        }

        // Подтверждение добавления кликов
        function confirmCustomClicksHandler() {
            const clicksToAdd = parseInt(customClicksInput.value);
            
            if (!clicksToAdd || clicksToAdd <= 0) {
                alert('Пожалуйста, введите корректное количество кликов');
                return;
            }
            
            if (currentAction === 'all') {
                addClicksToAllHandler(clicksToAdd);
            } else if (currentAction === 'online') {
                addClicksToOnlineHandler(clicksToAdd);
            } else if (currentAction === 'me') {
                addMyClicksHandler(clicksToAdd);
            }
            
            hideCustomClicksModal();
        }

        // Добавление кликов всем пользователям
        function addClicksToAllHandler(clicksToAdd) {
            if (!isAdmin) return;
            
            if (!confirm(`Добавить ${clicksToAdd} кликов всем пользователям?`)) {
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const updates = {};
                
                for (let userId in users) {
                    const currentClicks = users[userId].clicks || 0;
                    const currentBestScore = users[userId].bestScore || 0;
                    
                    updates[`${userId}/clicks`] = currentClicks + clicksToAdd;
                    updates[`${userId}/bestScore`] = Math.max(currentBestScore, currentClicks + clicksToAdd);
                }
                
                return usersRef.update(updates);
            }).then(() => {
                alert(`${clicksToAdd} кликов добавлены всем пользователям`);
                loadUserList();
                loadLeaderboard();
                
                // Обновление локального состояния
                if (auth.currentUser) {
                    loadUserData(auth.currentUser.uid);
                }
            }).catch(error => {
                console.error('Ошибка добавления кликов:', error);
                alert('Произошла ошибка при добавлении кликов');
            });
        }

        // Добавление кликов онлайн пользователям
        function addClicksToOnlineHandler(clicksToAdd) {
            if (!isAdmin) {
                clicksToAdd = parseInt(clicksToOnlineInput.value) || 1000;
            }
            
            if (!confirm(`Добавить ${clicksToAdd} кликов онлайн пользователям?`)) {
                return;
            }
            
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            const usersRef = database.ref('users');
            
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const updates = {};
                
                for (let userId in users) {
                    if (users[userId].lastActive && users[userId].lastActive > fiveMinutesAgo) {
                        const currentClicks = users[userId].clicks || 0;
                        const currentBestScore = users[userId].bestScore || 0;
                        
                        updates[`${userId}/clicks`] = currentClicks + clicksToAdd;
                        updates[`${userId}/bestScore`] = Math.max(currentBestScore, currentClicks + clicksToAdd);
                    }
                }
                
                return usersRef.update(updates);
            }).then(() => {
                alert(`${clicksToAdd} кликов добавлены онлайн пользователям`);
                loadUserList();
                loadLeaderboard();
                
                // Обновление локального состояния
                if (auth.currentUser) {
                    loadUserData(auth.currentUser.uid);
                }
            }).catch(error => {
                console.error('Ошибка добавления кликов:', error);
                alert('Произошла ошибка при добавлении кликов');
            });
        }

        // Добавление кликов себе
        function addMyClicksHandler(clicksToAdd) {
            if (!isAdmin) {
                clicksToAdd = parseInt(clicksToMeInput.value) || 5000;
            }
            
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы добавить клики');
                return;
            }
            
            if (!confirm(`Добавить ${clicksToAdd} кликов себе?`)) {
                return;
            }
            
            const userRef = database.ref('users/' + auth.currentUser.uid);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                const currentClicks = user.clicks || 0;
                const currentBestScore = user.bestScore || 0;
                
                return userRef.update({
                    clicks: currentClicks + clicksToAdd,
                    bestScore: Math.max(currentBestScore, currentClicks + clicksToAdd)
                });
            }).then(() => {
                alert(`${clicksToAdd} кликов добавлены`);
                loadUserList();
                loadLeaderboard();
            }).catch(error => {
                console.error('Ошибка добавления кликов:', error);
                alert('Произошла ошибка при добавлении кликов');
            });
        }

        // Удаление неактивных пользователей
        function deleteInactiveUsers() {
            if (!isAdmin) return;
            
            if (!confirm('Удалить всех пользователей, неактивных более 30 дней?')) {
                return;
            }
            
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const usersRef = database.ref('users');
            
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const deletions = [];
                
                for (let userId in users) {
                    if (!users[userId].lastActive || users[userId].lastActive < thirtyDaysAgo) {
                        deletions.push(usersRef.child(userId).remove());
                    }
                }
                
                return Promise.all(deletions);
            }).then(() => {
                alert('Неактивные пользователи удалены');
                loadUserList();
                loadLeaderboard();
            }).catch(error => {
                console.error('Ошибка удаления пользователей:', error);
                alert('Произошла ошибка при удалении пользователей');
            });
        }

        // Загрузка чата
        function loadChat() {
            const chatRef = database.ref('chat').limitToLast(50);
            chatRef.on('value', snapshot => {
                const messages = snapshot.val();
                chatMessages.innerHTML = '';
                
                if (messages) {
                    const messagesArray = Object.keys(messages).map(key => ({
                        id: key,
                        ...messages[key]
                    })).sort((a, b) => a.timestamp - b.timestamp);
                    
                    messagesArray.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    // Прокрутка вниз
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // Добавление сообщения в чат
        function addMessageToChat(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${message.type === 'system' ? 'system' : ''} ${message.adminAction ? 'admin-action' : ''}`;
            messageElement.id = message.id;
            
            let senderHtml = '';
            if (message.type !== 'system') {
                senderHtml = `
                    <div class="message-sender">
                        <span class="user-with-badge">
                            ${message.senderName}
                            ${message.verified ? '<span class="verified-badge">✓</span>' : ''}
                            ${message.adminAction ? '<span class="admin-badge-chat">ADMIN</span>' : ''}
                        </span>
                    </div>
                `;
            }
            
            messageElement.innerHTML = `
                ${senderHtml}
                <div class="message-text">${message.text}</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 3px;">
                    ${new Date(message.timestamp).toLocaleTimeString('ru-RU')}
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
        }

        // Отправка сообщения в чат
        function sendChatMessage() {
            const messageText = chatInput.value.trim();
            
            if (!messageText) {
                alert('Введите сообщение');
                return;
            }
            
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы отправлять сообщения');
                return;
            }
            
            // Получение данных пользователя
            const userRef = database.ref('users/' + auth.currentUser.uid);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                
                // Создание сообщения
                const chatRef = database.ref('chat').push();
                const messageData = {
                    senderId: auth.currentUser.uid,
                    senderName: user.nickname || user.email.split('@')[0],
                    text: messageText,
                    timestamp: Date.now(),
                    verified: user.verified || false,
                    adminAction: isAdmin
                };
                
                return chatRef.set(messageData);
            }).then(() => {
                chatInput.value = '';
            }).catch(error => {
                console.error('Ошибка отправки сообщения:', error);
                alert('Ошибка при отправке сообщения');
            });
        }

        // Загрузка друзей
        function loadFriends() {
            if (!auth.currentUser) return;
            
            const friendsRef = database.ref('userFriends/' + auth.currentUser.uid);
            friendsRef.on('value', snapshot => {
                const friends = snapshot.val();
                friendsList.innerHTML = '';
                
                if (friends) {
                    const friendIds = Object.keys(friends);
                    
                    // Загрузка данных о каждом друге
                    friendIds.forEach(friendId => {
                        const userRef = database.ref('users/' + friendId);
                        userRef.once('value').then(snapshot => {
                            const friend = snapshot.val();
                            if (friend) {
                                addFriendToList(friendId, friend, friends[friendId].status);
                            }
                        });
                    });
                } else {
                    friendsList.innerHTML = '<div style="text-align: center; padding: 20px;">У вас пока нет друзей</div>';
                }
            });
        }

        // Добавление друга в список
        function addFriendToList(friendId, friend, status) {
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            friendItem.id = `friend-${friendId}`;
            
            const lastActive = friend.lastActive ? new Date(friend.lastActive).toLocaleDateString('ru-RU') : 'Никогда';
            const isOnline = friend.lastActive && (Date.now() - friend.lastActive < 5 * 60 * 1000);
            
            friendItem.innerHTML = `
                <div class="friend-info">
                    <div class="friend-avatar">${(friend.nickname || friend.email[0]).toUpperCase()}</div>
                    <div>
                        <div>${friend.nickname || friend.email.split('@')[0]} ${friend.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">
                            ${isOnline ? '<span style="color: #4CAF50;">● Онлайн</span>' : `Был(а): ${lastActive}`}
                        </div>
                    </div>
                </div>
                <div class="friend-actions">
                    ${status === 'pending' ? '<button onclick="acceptFriendRequest(\'' + friendId + '\')">Принять</button>' : ''}
                    <button onclick="removeFriend(\'' + friendId + '\')">${status === 'pending' ? 'Отклонить' : 'Удалить'}</button>
                </div>
            `;
            
            friendsList.appendChild(friendItem);
        }

        // Показать модальное окно друзей
        function showFriendsModal() {
            if (!auth.currentUser) {
                alert('Войдите в систему, чтобы добавлять друзей');
                return;
            }
            
            friendsModal.style.display = 'flex';
            friendSearchInput.value = '';
            friendSearchResults.innerHTML = '';
        }

        // Скрыть модальное окно друзей
        function hideFriendsModal() {
            friendsModal.style.display = 'none';
        }

        // Поиск друга
        function searchFriendHandler() {
            const searchTerm = friendSearchInput.value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('Введите email или никнейм для поиска');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const results = [];
                
                for (let userId in users) {
                    if (userId === auth.currentUser.uid) continue;
                    
                    const emailMatch = users[userId].email.toLowerCase().includes(searchTerm);
                    const nicknameMatch = users[userId].nickname && users[userId].nickname.toLowerCase().includes(searchTerm);
                    
                    if (emailMatch || nicknameMatch) {
                        results.push({
                            id: userId,
                            ...users[userId]
                        });
                    }
                }
                
                displayFriendSearchResults(results);
            });
        }

        // Отображение результатов поиска друзей
        function displayFriendSearchResults(results) {
            friendSearchResults.innerHTML = '';
            
            if (results.length === 0) {
                friendSearchResults.innerHTML = '<div style="text-align: center; padding: 10px;">Пользователи не найдены</div>';
                return;
            }
            
            results.forEach(user => {
                const resultItem = document.createElement('div');
                resultItem.className = 'friend-item';
                resultItem.style.marginBottom = '10px';
                
                resultItem.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${(user.nickname || user.email[0]).toUpperCase()}</div>
                        <div>
                            <div>${user.nickname || user.email.split('@')[0]} ${user.verified ? '<span class="verified-badge">✓</span>' : ''}</div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">Клики: ${user.clicks || 0}</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button onclick="sendFriendRequest('${user.id}')">Добавить</button>
                    </div>
                `;
                
                friendSearchResults.appendChild(resultItem);
            });
        }

        // Отправка запроса на добавление в друзья (глобальная функция)
        window.sendFriendRequest = function(friendId) {
            if (!auth.currentUser) return;
            
            const myFriendsRef = database.ref('userFriends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('userFriends/' + friendId + '/' + auth.currentUser.uid);
            
            // Проверяем, не отправлен ли уже запрос
            myFriendsRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    alert('Запрос на добавление в друзья уже отправлен или пользователь уже у вас в друзьях');
                    return;
                }
                
                // Отправляем запрос
                return Promise.all([
                    myFriendsRef.set({ status: 'pending', timestamp: Date.now() }),
                    theirFriendsRef.set({ status: 'requested', timestamp: Date.now() })
                ]);
            }).then(() => {
                alert('Запрос на добавление в друзья отправлен');
                hideFriendsModal();
                loadFriends();
            }).catch(error => {
                console.error('Ошибка отправки запроса:', error);
                alert('Ошибка при отправке запроса на добавление в друзья');
            });
        };

        // Принятие запроса на добавление в друзья (глобальная функция)
        window.acceptFriendRequest = function(friendId) {
            if (!auth.currentUser) return;
            
            const myFriendsRef = database.ref('userFriends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('userFriends/' + friendId + '/' + auth.currentUser.uid);
            
            Promise.all([
                myFriendsRef.update({ status: 'accepted' }),
                theirFriendsRef.update({ status: 'accepted' })
            ]).then(() => {
                alert('Запрос на добавление в друзья принят');
                loadFriends();
            }).catch(error => {
                console.error('Ошибка принятия запроса:', error);
                alert('Ошибка при принятии запроса на добавление в друзья');
            });
        };

        // Удаление друга (глобальная функция)
        window.removeFriend = function(friendId) {
            if (!auth.currentUser) return;
            
            if (!confirm('Вы уверены, что хотите удалить этого пользователя из друзей?')) {
                return;
            }
            
            const myFriendsRef = database.ref('userFriends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('userFriends/' + friendId + '/' + auth.currentUser.uid);
            
            Promise.all([
                myFriendsRef.remove(),
                theirFriendsRef.remove()
            ]).then(() => {
                alert('Пользователь удален из друзей');
                loadFriends();
            }).catch(error => {
                console.error('Ошибка удаления друга:', error);
                alert('Ошибка при удалении пользователя из друзей');
            });
        };

        // Запуск приложения
        initApp();
    </script>
</body>
</html>