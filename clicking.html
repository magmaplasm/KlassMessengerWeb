<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Clicker Game - –ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 30px;
        }
        
        .logo {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fdbb2d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .auth-section {
            display: flex;
            gap: 10px;
        }
        
        button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .admin-btn {
            background: rgba(220, 53, 69, 0.7);
        }
        
        .admin-btn:hover {
            background: rgba(220, 53, 69, 0.9);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
            .chat-section, .friends-section, .cases-section, .trade-section {
                grid-column: 1 / -1;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .game-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            text-align: center;
        }
        
        .admin-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .chat-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .friends-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }
        
        .cases-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .trade-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            grid-column: 1 / -1;
        }
        
        .admin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .admin-controls {
                grid-template-columns: 1fr;
            }
        }
        
        .admin-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
        }
        
        .admin-panel h3 {
            margin-bottom: 15px;
            color: #fdbb2d;
        }
        
        .user-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .user-actions {
            display: flex;
            gap: 8px;
        }
        
        .user-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .click-area {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #fdbb2d, #b21f1f);
            border-radius: 50%;
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.1s ease;
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .click-area:active {
            transform: scale(0.95);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .click-area.blocked {
            background: linear-gradient(135deg, #666, #333);
            cursor: not-allowed;
        }
        
        .click-area.blocked:active {
            transform: scale(1);
        }
        
        .blocked-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            text-align: center;
            padding: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .trend-indicator {
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .trend-up {
            color: #4CAF50;
        }
        
        .trend-down {
            color: #F44336;
        }
        
        .trend-neutral {
            color: #FFC107;
        }
        
        .cps-warning {
            color: #ff6b6b;
            font-weight: bold;
            margin-top: 10px;
            min-height: 24px;
        }
        
        .leaderboard-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .leaderboard {
            list-style: none;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        
        .leaderboard-item.current-user {
            background: rgba(253, 187, 45, 0.3);
            border-left: 5px solid #fdbb2d;
        }
        
        .rank {
            font-weight: bold;
            width: 30px;
        }
        
        .player-name {
            flex: 1;
            margin: 0 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .player-score {
            font-weight: bold;
        }
        
        .auth-modal, .nickname-modal, .admin-modal, .event-modal, .clicks-modal, .friends-modal, .case-result-modal, .admin-code-modal, .trade-modal, .inventory-modal, .give-upgrade-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .auth-form, .nickname-form, .admin-form, .event-form, .clicks-form, .friends-form, .case-result-content, .admin-code-form, .trade-form, .inventory-content, .give-upgrade-form {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
        }
        
        .trade-form {
            max-width: 600px;
        }
        
        .inventory-content {
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .case-result-content {
            text-align: center;
            max-width: 400px;
            animation: caseOpen 0.5s ease;
        }
        
        @keyframes caseOpen {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .auth-form h2, .nickname-form h2, .admin-form h2, .event-form h2, .clicks-form h2, .friends-form h2, .case-result-content h2, .admin-code-form h2, .trade-form h2, .inventory-content h2, .give-upgrade-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .auth-form input, .nickname-form input, .admin-form input, .event-form input, .event-form select, .clicks-form input, .friends-form input, .admin-code-form input, .trade-form input, .give-upgrade-form input, .give-upgrade-form select {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .auth-buttons, .nickname-buttons, .admin-buttons, .event-buttons, .clicks-buttons, .friends-buttons, .case-result-buttons, .admin-code-buttons, .trade-buttons, .give-upgrade-buttons {
            display: flex;
            gap: 10px;
        }
        
        .auth-buttons button, .nickname-buttons button, .admin-buttons button, .event-buttons button, .clicks-buttons button, .friends-buttons button, .case-result-buttons button, .admin-code-buttons button, .trade-buttons button, .give-upgrade-buttons button {
            flex: 1;
        }
        
        .close-modal {
            background: rgba(255, 255, 255, 0.1);
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .game-info {
            margin-top: 20px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .change-nickname {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #fdbb2d;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .leaderboard-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .leaderboard-controls button {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .leaderboard-controls button.active {
            background: rgba(253, 187, 45, 0.5);
        }
        
        .cps-meter {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 10px;
            overflow-y: hidden;
        }
        
        .cps-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #F44336);
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .admin-only {
            display: none;
        }
        
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 10px;
        }
        
        .event-notification {
            background: rgba(76, 175, 80, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #4CAF50;
        }
        
        .admin-quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-with-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .action-with-input input {
            padding: 8px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* –ß–∞—Ç —Å—Ç–∏–ª–∏ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 400px;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            word-wrap: break-word;
        }
        
        .chat-message.admin-action {
            background: rgba(220, 53, 69, 0.3);
            border-left: 3px solid #dc3545;
        }
        
        .chat-message.system {
            background: rgba(255, 193, 7, 0.3);
            border-left: 3px solid #FFC107;
            font-style: italic;
        }
        
        .message-sender {
            font-weight: bold;
            margin-right: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .message-text {
            margin-top: 3px;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
        }
        
        .send-button {
            padding: 12px 20px;
            white-space: nowrap;
        }
        
        /* –ì–∞–ª–æ—á–∫–∏ */
        .verified-badge {
            color: #1DA1F2;
            font-size: 0.9rem;
        }
        
        .admin-badge-chat {
            background: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.6rem;
            margin-left: 5px;
        }
        
        .user-with-badge {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* –°–∏—Å—Ç–µ–º–∞ –¥—Ä—É–∑–µ–π */
        .friends-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-height: 300px;
        }
        
        .friend-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .friend-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .friend-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .friend-actions {
            display: flex;
            gap: 5px;
        }
        
        .friend-actions button {
            padding: 5px 10px;
            font-size: 0.7rem;
        }
        
        .friends-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .friends-controls button {
            flex: 1;
        }
        
        .trend-chart {
            height: 100px;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 10px;
            position: relative;
        }
        
        .trend-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80%;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }
        
        .trend-bar {
            width: 8px;
            background: linear-gradient(to top, #4CAF50, #FFC107);
            border-radius: 2px;
            transition: height 0.3s ease;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–µ–π—Å–æ–≤ */
        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .case-item {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .case-item:hover {
            transform: translateY(-5px);
            border-color: #fdbb2d;
            box-shadow: 0 10px 20px rgba(253, 187, 45, 0.3);
        }
        
        .case-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #fdbb2d;
        }
        
        .case-price {
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .case-chances {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        
        .case-mythical {
            border-color: #9C27B0;
            background: linear-gradient(135deg, #1a2a6c, #9C27B0);
        }
        
        .case-divine {
            border-color: #00BCD4;
            background: linear-gradient(135deg, #1a2a6c, #00BCD4);
        }
        
        .upgrades-list {
            margin-top: 20px;
        }
        
        .upgrade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }
        
        .upgrade-rarity-common { color: #ffffff; }
        .upgrade-rarity-uncommon { color: #4CAF50; }
        .upgrade-rarity-rare { color: #2196F3; }
        .upgrade-rarity-epic { color: #9C27B0; }
        .upgrade-rarity-legendary { color: #FF9800; }
        .upgrade-rarity-mythical { color: #9C27B0; }
        .upgrade-rarity-divine { color: #00BCD4; }
        
        .bonus-display {
            background: rgba(253, 187, 45, 0.3);
            padding: 10px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }

        .case-premium {
            border-color: #FFD700;
            background: linear-gradient(135deg, #1a2a6c, #9C27B0);
        }

        .case-legendary {
            border-color: #FF9800;
            background: linear-gradient(135deg, #1a2a6c, #FF9800);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—Ä–µ–π–¥–∞ */
        .trade-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .trade-side {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .trade-arrow {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: #fdbb2d;
        }

        .trade-items {
            min-height: 200px;
            margin-bottom: 15px;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .trade-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .trade-controls button {
            flex: 1;
        }

        .trade-offers {
            margin-top: 20px;
        }

        .trade-offer {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .trade-offer-info {
            margin-bottom: 10px;
        }

        .trade-offer-actions {
            display: flex;
            gap: 10px;
        }

        .trade-offer-actions button {
            flex: 1;
        }

        .selected-upgrade {
            background: rgba(253, 187, 45, 0.3);
            border: 1px solid #fdbb2d;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –≤ –æ–±–º–µ–Ω–µ */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .inventory-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .inventory-item:hover {
            transform: translateY(-3px);
            border-color: #fdbb2d;
        }
        
        .inventory-item.selected {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π */
        .user-search-results {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 5px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            display: none;
        }

        .user-search-result-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .user-search-result-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .view-all-btn {
            margin-top: 10px;
            width: 100%;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">FireClicker <span class="admin-badge" id="adminBadge" style="display: none;">ADMIN</span></div>
            <div class="user-info">
                <div id="userDisplay" class="user-display" style="display: none;">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                    <span id="userVerified" class="verified-badge" style="display: none;">‚úì</span>
                </div>
                <div class="auth-section">
                    <button id="adminPanelBtn" class="admin-btn admin-only">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</button>
                    <button id="loginBtn">–í–æ–π—Ç–∏</button>
                    <button id="registerBtn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                    <button id="logoutBtn" style="display: none;">–í—ã–π—Ç–∏</button>
                </div>
            </div>
        </header>
        
        <div class="main-content">
            <div class="game-section">
                <h2 class="section-title">–ö–ª–∏–∫–µ—Ä</h2>
                <div id="eventNotification" class="event-notification" style="display: none;">
                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–±—ã—Ç–∏–∏ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                <div class="click-area" id="clickArea">
                    <span id="clickText">–ö–õ–ò–ö–ê–ô!</span>
                    <div class="blocked-overlay" id="blockedOverlay" style="display: none;">–°–õ–ò–®–ö–û–ú –ë–´–°–¢–†–û!</div>
                </div>
                <div class="cps-meter">
                    <div class="cps-fill" id="cpsFill"></div>
                </div>
                <div class="cps-warning" id="cpsWarning"></div>
                <div class="stats">
                    <div class="stat">
                        <div>–ö–ª–∏–∫–∏</div>
                        <div class="stat-value" id="clickCount">0</div>
                    </div>
                    <div class="stat">
                        <div>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
                        <div class="stat-value" id="bestScore">0</div>
                    </div>
                    <div class="stat">
                        <div>–ö–ª–∏–∫–æ–≤/—Å–µ–∫</div>
                        <div class="stat-value" id="cpsValue">0</div>
                    </div>
                </div>
                <div class="bonus-display" id="bonusDisplay" style="display: none;">
                    –ë–æ–Ω—É—Å –∫ –∫–ª–∏–∫—É: +<span id="bonusValue">0</span>
                </div>
                <div class="game-info">
                    <p>–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ –ø–æ–ø–∞—Å—Ç—å –≤ –ª–∏–¥–µ—Ä–±–æ—Ä–¥!</p>
                    <p>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: –Ω–µ –±–æ–ª–µ–µ 12 –∫–ª–∏–∫–æ–≤ –≤ —Å–µ–∫—É–Ω–¥—É</p>
                    <div class="change-nickname" id="changeNickname" style="display: none;">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º</div>
                </div>
            </div>
            
            <div class="cases-section">
                <h2 class="section-title">–ö–µ–π—Å—ã —Å —É–ª—É—á—à–µ–Ω–∏—è–º–∏</h2>
                <div class="cases-grid">
                    <div class="case-item" id="basicCase">
                        <div class="case-name">üì¶ –ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å</div>
                        <div class="case-price">–¶–µ–Ω–∞: 500 –∫–ª–∏–∫–æ–≤</div>
                        <div class="case-chances">
                            –®–∞–Ω—Å—ã: 65% +0.1 | 25% +0.2 | 8% +0.5 | 2% +1.0
                        </div>
                        <button>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
                    </div>
                    
                    <div class="case-item" id="advancedCase">
                        <div class="case-name">‚ö° –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫–µ–π—Å</div>
                        <div class="case-price">–¶–µ–Ω–∞: 1500 –∫–ª–∏–∫–æ–≤</div>
                        <div class="case-chances">
                            –®–∞–Ω—Å—ã: 65% +0.2 | 25% +0.5 | 8% +1.0 | 2% +2.0
                        </div>
                        <button>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
                    </div>
                    
                    <div class="case-item case-premium" id="premiumCase">
                        <div class="case-name">üíé –ü—Ä–µ–º–∏—É–º –∫–µ–π—Å</div>
                        <div class="case-price">–¶–µ–Ω–∞: 3000 –∫–ª–∏–∫–æ–≤</div>
                        <div class="case-chances">
                            –®–∞–Ω—Å—ã: 65% +0.5 | 25% +1.0 | 8% +2.0 | 2% +3.0
                        </div>
                        <button>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
                    </div>
                    
                    <div class="case-item case-legendary" id="legendaryCase">
                        <div class="case-name">üåü –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–µ–π—Å</div>
                        <div class="case-price">–¶–µ–Ω–∞: 6000 –∫–ª–∏–∫–æ–≤</div>
                        <div class="case-chances">
                            –®–∞–Ω—Å—ã: 65% +1.0 | 25% +2.0 | 8% +3.0 | 2% +5.0
                        </div>
                        <button>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
                    </div>
                    
                    <!-- –ù–æ–≤—ã–µ –∫–µ–π—Å—ã -->
                    <div class="case-item case-mythical" id="mythicalCase">
                        <div class="case-name">üîÆ –ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å</div>
                        <div class="case-price">–¶–µ–Ω–∞: 10000 –∫–ª–∏–∫–æ–≤</div>
                        <div class="case-chances">
                            –®–∞–Ω—Å—ã: 65% +2.0 | 25% +3.0 | 8% +5.0 | 2% +8.0
                        </div>
                        <button>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
                    </div>
                    
                    <div class="case-item case-divine" id="divineCase">
                        <div class="case-name">‚ú® –ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–µ–π—Å</div>
                        <div class="case-price">–¶–µ–Ω–∞: 25000 –∫–ª–∏–∫–æ–≤</div>
                        <div class="case-chances">
                            –®–∞–Ω—Å—ã: 65% +5.0 | 25% +8.0 | 8% +10.0 | 2% +15.0
                        </div>
                        <button>–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å</button>
                    </div>
                </div>
                
                <div class="upgrades-list" id="upgradesList">
                    <h3 style="margin-bottom: 15px;">–í–∞—à–∏ —É–ª—É—á—à–µ–Ω–∏—è</h3>
                    <!-- –°–ø–∏—Å–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                    <div id="upgradesContainer"></div>
                    <button id="viewAllUpgrades" class="view-all-btn" style="display: none;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button>
                </div>
            </div>
            
            <div class="trade-section">
                <h2 class="section-title">–û–±–º–µ–Ω —Å –∏–≥—Ä–æ–∫–∞–º–∏</h2>
                <div class="trade-controls">
                    <button id="createTradeBtn">–°–æ–∑–¥–∞—Ç—å –æ–±–º–µ–Ω</button>
                    <button id="refreshTrades">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                </div>
                <div class="trade-offers" id="tradeOffers">
                    <!-- –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±–º–µ–Ω–∞ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
                <button id="viewAllTrades" class="view-all-btn" style="display: none;">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ</button>
            </div>
            
            <div class="leaderboard-section">
                <h2 class="section-title">–õ–∏–¥–µ—Ä–±–æ—Ä–¥</h2>
                <div class="leaderboard-controls">
                    <button id="showTop10" class="active">–¢–æ–ø-10</button>
                    <button id="showTop25">–¢–æ–ø-25</button>
                    <button id="showAll">–í—Å–µ –∏–≥—Ä–æ–∫–∏</button>
                </div>
                <ul class="leaderboard" id="leaderboard">
                    <!-- –õ–∏–¥–µ—Ä–±–æ—Ä–¥ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ JS -->
                </ul>
            </div>
            
            <div class="friends-section">
                <h2 class="section-title">–î—Ä—É–∑—å—è</h2>
                <div class="friends-controls">
                    <button id="addFriendBtn">–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
                    <button id="refreshFriends">–û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
                <div class="friends-list" id="friendsList">
                    <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <div class="chat-section">
                <h2 class="section-title">–ß–∞—Ç</h2>
                <div class="chat-messages" id="chatMessages">
                    <!-- –°–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="200">
                    <button class="send-button" id="sendMessage">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            
            <div class="admin-section admin-only" id="adminSection">
                <h2 class="section-title">–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å</h2>
                <div class="admin-controls">
                    <div class="admin-panel">
                        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h3>
                        <div class="user-list" id="userList">
                            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω —á–µ—Ä–µ–∑ JS -->
                        </div>
                        <button id="refreshUsers">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
                    </div>
                    
                    <div class="admin-panel">
                        <h3>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å –∫–ª–∏–∫–∞–º–∏</h3>
                        <div class="admin-quick-actions">
                            <div class="action-with-input">
                                <input type="number" id="clicksToOnlineInput" placeholder="–ö–æ–ª-–≤–æ –∫–ª–∏–∫–æ–≤" value="1000">
                                <button id="addClicksToOnline">–î–æ–±–∞–≤–∏—Ç—å –æ–Ω–ª–∞–π–Ω</button>
                            </div>
                            <div class="action-with-input">
                                <input type="number" id="clicksToMeInput" placeholder="–ö–æ–ª-–≤–æ –∫–ª–∏–∫–æ–≤" value="5000">
                                <button id="addMyClicks">–î–æ–±–∞–≤–∏—Ç—å —Å–µ–±–µ</button>
                            </div>
                            <div class="action-with-input">
                                <input type="number" id="clicksToAllInput" placeholder="–ö–æ–ª-–≤–æ –∫–ª–∏–∫–æ–≤" value="1000">
                                <button id="addClicksToAll">–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ–º</button>
                            </div>
                            <button id="createEvent" class="admin-only">–°–æ–∑–¥–∞—Ç—å –∏–≤–µ–Ω—Ç</button>
                            <button id="resetAllScores">–û–±–Ω—É–ª–∏—Ç—å –≤—Å–µ</button>
                            <button id="deleteInactive">–£–¥–∞–ª–∏—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö</button>
                            <button id="giveUpgradeBtn" class="admin-only">–í—ã–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ</button>
                            <button id="giveUpgradeToAll" class="admin-only">–†–∞–∑–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –≤—Å–µ–º</button>
                            <button id="giveUpgradeToOnline" class="admin-only">–†–∞–∑–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –≤—Å–µ–º –æ–Ω–ª–∞–π–Ω</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div class="auth-modal" id="authModal">
        <div class="auth-form">
            <h2 id="authModalTitle">–í—Ö–æ–¥</h2>
            <input type="email" id="authEmail" placeholder="Email">
            <input type="password" id="authPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <div class="auth-buttons">
                <button id="authSubmit">–í–æ–π—Ç–∏</button>
                <button id="authCancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeAuthModal">√ó</div>
        </div>
    </div>
    
    <div class="nickname-modal" id="nicknameModal">
        <div class="nickname-form">
            <h2>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–∏–∫–Ω–µ–π–º</h2>
            <input type="text" id="nicknameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º" maxlength="15">
            <div class="nickname-buttons">
                <button id="saveNickname">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="cancelNickname">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeNicknameModal">√ó</div>
        </div>
    </div>
    
    <div class="admin-modal" id="adminModal">
        <div class="admin-form">
            <h2 id="adminModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
            <div id="adminUserInfo" style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;"></div>
            <input type="number" id="adminClicksInput" placeholder="–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤">
            <input type="number" id="adminBestScoreInput" placeholder="–ù–æ–≤—ã–π –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç">
            <div class="admin-buttons">
                <button id="adminSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="adminDelete">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                <button id="toggleVerified">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≥–∞–ª–æ—á–∫—É</button>
                <button id="adminCancel">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeAdminModal">√ó</div>
        </div>
    </div>
    
    <div class="event-modal" id="eventModal">
        <div class="event-form">
            <h2>–°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è</h2>
            <select id="eventMultiplier">
                <option value="2">2x - –î–≤–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏</option>
                <option value="3">3x - –¢—Ä–æ–π–Ω—ã–µ –∫–ª–∏–∫–∏</option>
                <option value="5">5x - –ü—è—Ç–µ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏</option>
                <option value="10">10x - –î–µ—Å—è—Ç–µ—Ä–Ω—ã–µ –∫–ª–∏–∫–∏</option>
            </select>
            <select id="eventDuration">
                <option value="5">5 –º–∏–Ω—É—Ç</option>
                <option value="10">10 –º–∏–Ω—É—Ç</option>
                <option value="30">30 –º–∏–Ω—É—Ç</option>
                <option value="60">1 —á–∞—Å</option>
                <option value="120">2 —á–∞—Å–∞</option>
                <option value="360">6 —á–∞—Å–æ–≤</option>
                <option value="720">12 —á–∞—Å–æ–≤</option>
                <option value="1440">24 —á–∞—Å–∞</option>
            </select>
            <div class="event-buttons">
                <button id="startEvent">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                <button id="stopEvent">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ</button>
                <button id="cancelEvent">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeEventModal">√ó</div>
        </div>
    </div>
    
    <div class="clicks-modal" id="customClicksModal">
        <div class="clicks-form">
            <h2 id="customClicksTitle">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤</h2>
            <input type="number" id="customClicksInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤">
            <div class="clicks-buttons">
                <button id="confirmCustomClicks">–î–æ–±–∞–≤–∏—Ç—å</button>
                <button id="cancelCustomClicks">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeCustomClicksModal">√ó</div>
        </div>
    </div>
    
    <div class="friends-modal" id="friendsModal">
        <div class="friends-form">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</h2>
            <input type="text" id="friendSearchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º">
            <div class="friends-buttons">
                <button id="searchFriend">–ù–∞–π—Ç–∏</button>
                <button id="cancelFriend">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div id="friendSearchResults" style="margin-top: 15px;">
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="close-modal" id="closeFriendsModal">√ó</div>
        </div>
    </div>

    <!-- –ù–æ–≤—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –¥–ª—è –∫–µ–π—Å–æ–≤ –∏ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–∞ -->
    <div class="case-result-modal" id="caseResultModal">
        <div class="case-result-content">
            <h2 id="caseResultTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞</h2>
            <div id="caseResultContent" style="font-size: 1.2rem; margin: 20px 0;"></div>
            <div class="case-result-buttons">
                <button id="closeCaseResult">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="admin-code-modal" id="adminCodeModal">
        <div class="admin-code-form">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
            <p>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:</p>
            <input type="text" id="adminCodeInput" placeholder="–ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">
            <div class="admin-code-buttons">
                <button id="confirmAdminCode">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button id="cancelAdminCode">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeAdminCodeModal">√ó</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±–º–µ–Ω–∞ -->
    <div class="trade-modal" id="tradeModal">
        <div class="trade-form">
            <h2 id="tradeModalTitle">–°–æ–∑–¥–∞–Ω–∏–µ –æ–±–º–µ–Ω–∞</h2>
            <div class="trade-container">
                <div class="trade-side">
                    <h3>–í—ã –æ—Ç–¥–∞–µ—Ç–µ:</h3>
                    <div class="trade-items" id="myTradeItems">
                        <!-- –í–∞—à–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –¥–ª—è –æ–±–º–µ–Ω–∞ -->
                    </div>
                    <div class="action-with-input">
                        <input type="number" id="myClicksInput" placeholder="–ö–ª–∏–∫–∏ –¥–ª—è –æ–±–º–µ–Ω–∞" min="0">
                        <button id="addMyUpgrade">–î–æ–±–∞–≤–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ</button>
                    </div>
                </div>
                <div class="trade-arrow">‚áÑ</div>
                <div class="trade-side">
                    <h3>–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ:</h3>
                    <div class="trade-items" id="theirTradeItems">
                        <!-- –ü—Ä–µ–¥–º–µ—Ç—ã –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞ -->
                    </div>
                    <div class="action-with-input">
                        <input type="number" id="theirClicksInput" placeholder="–ö–ª–∏–∫–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è" min="0">
                        <button id="addTheirUpgrade">–î–æ–±–∞–≤–∏—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ</button>
                    </div>
                </div>
            </div>
            <div class="action-with-input">
                <input type="text" id="tradePlayerInput" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞ –¥–ª—è –æ–±–º–µ–Ω–∞">
            </div>
            <div class="trade-buttons">
                <button id="sendTradeOffer">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
                <button id="cancelTrade">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeTradeModal">√ó</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è -->
    <div class="inventory-modal" id="inventoryModal">
        <div class="inventory-content">
            <h2 id="inventoryModalTitle">–í—ã–±–µ—Ä–∏—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è</h2>
            <div class="inventory-grid" id="inventoryGrid">
                <!-- –°–ø–∏—Å–æ–∫ —É–ª—É—á—à–µ–Ω–∏–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="trade-buttons" style="margin-top: 20px;">
                <button id="confirmInventorySelection">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–±–æ—Ä</button>
                <button id="cancelInventorySelection">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeInventoryModal">√ó</div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π -->
    <div class="give-upgrade-modal" id="giveUpgradeModal">
        <div class="give-upgrade-form">
            <h2>–í—ã–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ</h2>
            <div class="action-with-input">
                <input type="text" id="upgradeUserSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –Ω–∏–∫—É –∏–ª–∏ email">
                <div id="upgradeUserResults" class="user-search-results"></div>
            </div>
            <div id="selectedUpgradeUser" style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; display: none;">
                –í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: <span id="selectedUserName"></span>
                <button onclick="clearSelectedUser()" style="margin-left: 10px;">√ó</button>
            </div>
            <select id="upgradeTypeSelect">
                <option value="0.1">–û–±—ã—á–Ω–æ–µ (+0.1)</option>
                <option value="0.2">–ù–µ–æ–±—ã—á–Ω–æ–µ (+0.2)</option>
                <option value="0.5">–†–µ–¥–∫–æ–µ (+0.5)</option>
                <option value="1.0">–≠–ø–∏—á–µ—Å–∫–æ–µ (+1.0)</option>
                <option value="2.0">–≠–ø–∏—á–µ—Å–∫–æ–µ (+2.0)</option>
                <option value="3.0">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ (+3.0)</option>
                <option value="5.0">–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ (+5.0)</option>
                <option value="8.0">–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ (+8.0)</option>
                <option value="10.0">–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ (+10.0)</option>
                <option value="15.0">–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ (+15.0)</option>
            </select>
            <input type="number" id="upgradeQuantity" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" value="1" min="1">
            <div class="give-upgrade-buttons">
                <button id="confirmGiveUpgrade">–í—ã–¥–∞—Ç—å</button>
                <button id="cancelGiveUpgrade">–û—Ç–º–µ–Ω–∞</button>
            </div>
            <div class="close-modal" id="closeGiveUpgradeModal">√ó</div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD4mvrBrKNEmPQ7JDfbnEGAxb9ETen8KsA",
            authDomain: "clicking-697ae.firebaseapp.com",
            projectId: "clicking-697ae",
            storageBucket: "clicking-697ae.firebasestorage.app",
            messagingSenderId: "479295856325",
            appId: "1:479295856325:web:dc0b0dcf661cd66941daac",
            databaseURL: "https://clicking-697ae-default-rtdb.firebaseio.com/"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
        let gameState = {
            clicks: 0,
            bestScore: 0,
            clickMultiplier: 1,
            previousClicks: 0,
            previousBestScore: 0,
            previousCPS: 0,
            clickHistory: []
        };

        // –°–∏—Å—Ç–µ–º–∞ —É–ª—É—á—à–µ–Ω–∏–π
        let upgrades = {
            totalBonus: 0,
            items: []
        };

        // –°–∏—Å—Ç–µ–º–∞ –æ–±–º–µ–Ω–∞
        let currentTrade = {
            myItems: [],
            myClicks: 0,
            theirItems: [],
            theirClicks: 0,
            targetPlayer: null
        };

        // –î–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –≤ –æ–±–º–µ–Ω–µ
        let currentInventorySide = null; // 'my' –∏–ª–∏ 'their'
        let selectedInventoryItems = [];

        // –î–ª—è –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
        let selectedUserForUpgrade = null;

        // –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞
        const ADMIN_CONFIRMATION_CODE = "ADMIN2024";

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        let leaderboardLimit = 10;

        // –°–∏—Å—Ç–µ–º–∞ –∑–∞—â–∏—Ç—ã –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–æ–≤
        const MAX_CPS = 12;
        let clickTimestamps = [];
        let currentCPS = 0;
        let isBlocked = false;
        let blockTimeout = null;

        // –ê–¥–º–∏–Ω—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const ADMIN_EMAILS = ['magmaplasm@gmail.com'];
        let isAdmin = false;
        let selectedUser = null;
        let currentAction = null;

        // –ù–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        let showAllUpgrades = false;
        let showAllTrades = false;

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const clickArea = document.getElementById('clickArea');
        const clickText = document.getElementById('clickText');
        const blockedOverlay = document.getElementById('blockedOverlay');
        const clickCount = document.getElementById('clickCount');
        const bestScore = document.getElementById('bestScore');
        const cpsValue = document.getElementById('cpsValue');
        const cpsWarning = document.getElementById('cpsWarning');
        const cpsFill = document.getElementById('cpsFill');
        const leaderboard = document.getElementById('leaderboard');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminSection = document.getElementById('adminSection');
        const adminBadge = document.getElementById('adminBadge');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authEmail = document.getElementById('authEmail');
        const authPassword = document.getElementById('authPassword');
        const authSubmit = document.getElementById('authSubmit');
        const authCancel = document.getElementById('authCancel');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const userDisplay = document.getElementById('userDisplay');
        const userName = document.getElementById('userName');
        const userAvatar = document.getElementById('userAvatar');
        const userVerified = document.getElementById('userVerified');
        const changeNickname = document.getElementById('changeNickname');
        const nicknameModal = document.getElementById('nicknameModal');
        const nicknameInput = document.getElementById('nicknameInput');
        const saveNickname = document.getElementById('saveNickname');
        const cancelNickname = document.getElementById('cancelNickname');
        const closeNicknameModal = document.getElementById('closeNicknameModal');
        const showTop10 = document.getElementById('showTop10');
        const showTop25 = document.getElementById('showTop25');
        const showAll = document.getElementById('showAll');
        const eventNotification = document.getElementById('eventNotification');
        const userList = document.getElementById('userList');
        const refreshUsers = document.getElementById('refreshUsers');
        const resetAllScores = document.getElementById('resetAllScores');
        const addClicksToAll = document.getElementById('addClicksToAll');
        const deleteInactive = document.getElementById('deleteInactive');
        const addClicksToOnline = document.getElementById('addClicksToOnline');
        const addMyClicks = document.getElementById('addMyClicks');
        const createEvent = document.getElementById('createEvent');
        const adminModal = document.getElementById('adminModal');
        const adminModalTitle = document.getElementById('adminModalTitle');
        const adminUserInfo = document.getElementById('adminUserInfo');
        const adminClicksInput = document.getElementById('adminClicksInput');
        const adminBestScoreInput = document.getElementById('adminBestScoreInput');
        const adminSave = document.getElementById('adminSave');
        const adminDelete = document.getElementById('adminDelete');
        const toggleVerified = document.getElementById('toggleVerified');
        const adminCancel = document.getElementById('adminCancel');
        const closeAdminModal = document.getElementById('closeAdminModal');
        const eventModal = document.getElementById('eventModal');
        const eventMultiplier = document.getElementById('eventMultiplier');
        const eventDuration = document.getElementById('eventDuration');
        const startEvent = document.getElementById('startEvent');
        const stopEvent = document.getElementById('stopEvent');
        const cancelEvent = document.getElementById('cancelEvent');
        const closeEventModal = document.getElementById('closeEventModal');
        const customClicksModal = document.getElementById('customClicksModal');
        const customClicksTitle = document.getElementById('customClicksTitle');
        const customClicksInput = document.getElementById('customClicksInput');
        const confirmCustomClicks = document.getElementById('confirmCustomClicks');
        const cancelCustomClicks = document.getElementById('cancelCustomClicks');
        const closeCustomClicksModal = document.getElementById('closeCustomClicksModal');
        const clicksToOnlineInput = document.getElementById('clicksToOnlineInput');
        const clicksToMeInput = document.getElementById('clicksToMeInput');
        const clicksToAllInput = document.getElementById('clicksToAllInput');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessage = document.getElementById('sendMessage');
        const friendsList = document.getElementById('friendsList');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const refreshFriends = document.getElementById('refreshFriends');
        const friendsModal = document.getElementById('friendsModal');
        const friendSearchInput = document.getElementById('friendSearchInput');
        const searchFriend = document.getElementById('searchFriend');
        const cancelFriend = document.getElementById('cancelFriend');
        const closeFriendsModal = document.getElementById('closeFriendsModal');
        const friendSearchResults = document.getElementById('friendSearchResults');
        const bonusDisplay = document.getElementById('bonusDisplay');
        const bonusValue = document.getElementById('bonusValue');

        // –ù–æ–≤—ã–µ DOM —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–µ–π—Å–æ–≤ –∏ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–∞
        const basicCase = document.getElementById('basicCase');
        const advancedCase = document.getElementById('advancedCase');
        const premiumCase = document.getElementById('premiumCase');
        const legendaryCase = document.getElementById('legendaryCase');
        const mythicalCase = document.getElementById('mythicalCase');
        const divineCase = document.getElementById('divineCase');
        const upgradesList = document.getElementById('upgradesList');
        const upgradesContainer = document.getElementById('upgradesContainer');
        const viewAllUpgrades = document.getElementById('viewAllUpgrades');
        const caseResultModal = document.getElementById('caseResultModal');
        const caseResultTitle = document.getElementById('caseResultTitle');
        const caseResultContent = document.getElementById('caseResultContent');
        const closeCaseResult = document.getElementById('closeCaseResult');
        const adminCodeModal = document.getElementById('adminCodeModal');
        const adminCodeInput = document.getElementById('adminCodeInput');
        const confirmAdminCode = document.getElementById('confirmAdminCode');
        const cancelAdminCode = document.getElementById('cancelAdminCode');
        const closeAdminCodeModal = document.getElementById('closeAdminCodeModal');

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —Ç—Ä–µ–π–¥–∞
        const createTradeBtn = document.getElementById('createTradeBtn');
        const refreshTrades = document.getElementById('refreshTrades');
        const tradeOffers = document.getElementById('tradeOffers');
        const viewAllTrades = document.getElementById('viewAllTrades');
        const tradeModal = document.getElementById('tradeModal');
        const myTradeItems = document.getElementById('myTradeItems');
        const theirTradeItems = document.getElementById('theirTradeItems');
        const myClicksInput = document.getElementById('myClicksInput');
        const theirClicksInput = document.getElementById('theirClicksInput');
        const addMyUpgrade = document.getElementById('addMyUpgrade');
        const addTheirUpgrade = document.getElementById('addTheirUpgrade');
        const tradePlayerInput = document.getElementById('tradePlayerInput');
        const sendTradeOffer = document.getElementById('sendTradeOffer');
        const cancelTrade = document.getElementById('cancelTrade');
        const closeTradeModal = document.getElementById('closeTradeModal');

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        const inventoryModal = document.getElementById('inventoryModal');
        const inventoryModalTitle = document.getElementById('inventoryModalTitle');
        const inventoryGrid = document.getElementById('inventoryGrid');
        const confirmInventorySelection = document.getElementById('confirmInventorySelection');
        const cancelInventorySelection = document.getElementById('cancelInventorySelection');
        const closeInventoryModal = document.getElementById('closeInventoryModal');

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
        const giveUpgradeBtn = document.getElementById('giveUpgradeBtn');
        const giveUpgradeToAll = document.getElementById('giveUpgradeToAll');
        const giveUpgradeToOnline = document.getElementById('giveUpgradeToOnline');
        const giveUpgradeModal = document.getElementById('giveUpgradeModal');
        const upgradeUserSearch = document.getElementById('upgradeUserSearch');
        const upgradeUserResults = document.getElementById('upgradeUserResults');
        const selectedUpgradeUser = document.getElementById('selectedUpgradeUser');
        const selectedUserName = document.getElementById('selectedUserName');
        const upgradeTypeSelect = document.getElementById('upgradeTypeSelect');
        const upgradeQuantity = document.getElementById('upgradeQuantity');
        const confirmGiveUpgrade = document.getElementById('confirmGiveUpgrade');
        const cancelGiveUpgrade = document.getElementById('cancelGiveUpgrade');
        const closeGiveUpgradeModal = document.getElementById('closeGiveUpgradeModal');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function initApp() {
            // –°–ª—É—à–∞—Ç–µ–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
            auth.onAuthStateChanged(user => {
                if (user) {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª –≤ —Å–∏—Å—Ç–µ–º—É
                    handleUserLogin(user);
                } else {
                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                    handleUserLogout();
                }
            });

            // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
            loadLeaderboard();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
            loadChat();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
            loadGameState();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
            checkActiveEvent();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∫–µ–π—Å–æ–≤
            initCasesSystem();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±–º–µ–Ω–∞
            initTradeSystem();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
            initGiveUpgradeSystem();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CPS –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(updateCPS, 1000);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–±—ã—Ç–∏–π –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(checkActiveEvent, 5000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
        function initGiveUpgradeSystem() {
            giveUpgradeBtn.addEventListener('click', showGiveUpgradeModal);
            giveUpgradeToAll.addEventListener('click', giveUpgradeToAllHandler);
            giveUpgradeToOnline.addEventListener('click', giveUpgradeToOnlineHandler);
            cancelGiveUpgrade.addEventListener('click', hideGiveUpgradeModal);
            closeGiveUpgradeModal.addEventListener('click', hideGiveUpgradeModal);
            confirmGiveUpgrade.addEventListener('click', giveUpgradeHandler);
            
            // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –≤–≤–æ–¥–µ
            upgradeUserSearch.addEventListener('input', function() {
                const searchTerm = this.value.trim().toLowerCase();
                if (searchTerm.length < 2) {
                    upgradeUserResults.style.display = 'none';
                    return;
                }

                const usersRef = database.ref('users');
                usersRef.once('value').then(snapshot => {
                    const users = snapshot.val();
                    const results = [];
                    for (let userId in users) {
                        const user = users[userId];
                        const emailMatch = user.email.toLowerCase().includes(searchTerm);
                        const nicknameMatch = user.nickname && user.nickname.toLowerCase().includes(searchTerm);
                        if (emailMatch || nicknameMatch) {
                            results.push({ id: userId, ...user });
                        }
                    }
                    displayUpgradeUserResults(results);
                });
            });
        }

        // –†–∞–∑–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        function giveUpgradeToAllHandler() {
            if (!isAdmin) {
                alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –≤—ã–¥–∞–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è');
                return;
            }

            const upgradeValue = parseFloat(upgradeTypeSelect.value);
            const quantity = parseInt(upgradeQuantity.value) || 1;
            const { rarity, rarityName } = getRarityByValue(upgradeValue);

            if (!confirm(`–†–∞–∑–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ ${rarityName} (+${upgradeValue}) –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ ${quantity} –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                return;
            }

            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const promises = [];

                for (let userId in users) {
                    for (let i = 0; i < quantity; i++) {
                        promises.push(addUpgradeToUser(userId, upgradeValue, rarity, rarityName));
                    }
                }

                return Promise.all(promises);
            }).then(() => {
                alert(`–£–ª—É—á—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!`);
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π –≤—Å–µ–º:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ —É–ª—É—á—à–µ–Ω–∏–π');
            });
        }

        // –†–∞–∑–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        function giveUpgradeToOnlineHandler() {
            if (!isAdmin) {
                alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –≤—ã–¥–∞–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è');
                return;
            }

            const upgradeValue = parseFloat(upgradeTypeSelect.value);
            const quantity = parseInt(upgradeQuantity.value) || 1;
            const { rarity, rarityName } = getRarityByValue(upgradeValue);
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);

            if (!confirm(`–†–∞–∑–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ ${rarityName} (+${upgradeValue}) –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ ${quantity} –≤—Å–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                return;
            }

            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const promises = [];

                for (let userId in users) {
                    if (users[userId].lastActive && users[userId].lastActive > fiveMinutesAgo) {
                        for (let i = 0; i < quantity; i++) {
                            promises.push(addUpgradeToUser(userId, upgradeValue, rarity, rarityName));
                        }
                    }
                }

                return Promise.all(promises);
            }).then(() => {
                alert(`–£–ª—É—á—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ –≤—Å–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º!`);
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π –æ–Ω–ª–∞–π–Ω:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–¥–∞—á–µ —É–ª—É—á—à–µ–Ω–∏–π');
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
        function showGiveUpgradeModal() {
            if (!isAdmin) {
                alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –≤—ã–¥–∞–≤–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏—è');
                return;
            }
            giveUpgradeModal.style.display = 'flex';
            selectedUserForUpgrade = null;
            selectedUpgradeUser.style.display = 'none';
            upgradeUserSearch.value = '';
            upgradeTypeSelect.value = '0.1';
            upgradeQuantity.value = '1';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
        function hideGiveUpgradeModal() {
            giveUpgradeModal.style.display = 'none';
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏–π
        function displayUpgradeUserResults(results) {
            upgradeUserResults.innerHTML = '';
            if (results.length === 0) {
                upgradeUserResults.innerHTML = '<div class="user-search-result-item">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            } else {
                results.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-search-result-item';
                    div.textContent = user.nickname || user.email.split('@')[0];
                    div.dataset.userId = user.id;
                    div.dataset.userName = user.nickname || user.email.split('@')[0];
                    div.addEventListener('click', function() {
                        selectedUserForUpgrade = { id: this.dataset.userId, name: this.dataset.userName };
                        selectedUpgradeUser.style.display = 'block';
                        selectedUserName.textContent = this.dataset.userName;
                        upgradeUserResults.style.display = 'none';
                        upgradeUserSearch.value = '';
                    });
                    upgradeUserResults.appendChild(div);
                });
            }
            upgradeUserResults.style.display = 'block';
        }

        // –û—á–∏—Å—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        window.clearSelectedUser = function() {
            selectedUserForUpgrade = null;
            selectedUpgradeUser.style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏—è
        function giveUpgradeHandler() {
            const upgradeValue = parseFloat(upgradeTypeSelect.value);
            const quantity = parseInt(upgradeQuantity.value) || 1;
            const { rarity, rarityName } = getRarityByValue(upgradeValue);

            let targetUserId = selectedUserForUpgrade ? selectedUserForUpgrade.id : auth.currentUser.uid;
            let targetUserName = selectedUserForUpgrade ? selectedUserForUpgrade.name : (userName.textContent || '—Å–µ–±–µ');

            if (!confirm(`–í—ã–¥–∞—Ç—å —É–ª—É—á—à–µ–Ω–∏–µ ${rarityName} (+${upgradeValue}) –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ ${quantity} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserName}?`)) {
                return;
            }

            for (let i = 0; i < quantity; i++) {
                addUpgradeToUser(targetUserId, upgradeValue, rarity, rarityName);
            }

            hideGiveUpgradeModal();
            alert(`–£–ª—É—á—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${targetUserName}!`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–¥–∫–æ—Å—Ç–∏ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é —É–ª—É—á—à–µ–Ω–∏—è
        function getRarityByValue(value) {
            if (value === 0.1) return { rarity: 'common', rarityName: '–û–±—ã—á–Ω–æ–µ' };
            if (value === 0.2) return { rarity: 'uncommon', rarityName: '–ù–µ–æ–±—ã—á–Ω–æ–µ' };
            if (value === 0.5) return { rarity: 'rare', rarityName: '–†–µ–¥–∫–æ–µ' };
            if (value === 1.0) return { rarity: 'epic', rarityName: '–≠–ø–∏—á–µ—Å–∫–æ–µ' };
            if (value === 2.0) return { rarity: 'epic', rarityName: '–≠–ø–∏—á–µ—Å–∫–æ–µ' };
            if (value === 3.0) return { rarity: 'legendary', rarityName: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ' };
            if (value === 5.0) return { rarity: 'legendary', rarityName: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ' };
            if (value === 8.0) return { rarity: 'mythical', rarityName: '–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ' };
            if (value === 10.0) return { rarity: 'mythical', rarityName: '–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ' };
            if (value === 15.0) return { rarity: 'divine', rarityName: '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ' };
            return { rarity: 'common', rarityName: '–û–±—ã—á–Ω–æ–µ' };
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        function addUpgradeToUser(userId, upgradeValue, rarity, rarityName) {
            const upgradesRef = database.ref('userUpgrades/' + userId);
            return upgradesRef.once('value').then(snapshot => {
                const upgrades = snapshot.val() || { totalBonus: 0, items: [] };
                if (!upgrades.items) {
                    upgrades.items = [];
                }

                const newUpgrade = {
                    value: upgradeValue,
                    rarity: rarity,
                    rarityName: rarityName,
                    timestamp: Date.now()
                };

                upgrades.items.push(newUpgrade);
                upgrades.totalBonus = (upgrades.totalBonus || 0) + upgradeValue;

                return upgradesRef.set(upgrades);
            }).then(() => {
                console.log('–£–ª—É—á—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:', userId);
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –≤—ã–¥–∞—á–∏ —É–ª—É—á—à–µ–Ω–∏—è:', error);
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function handleUserLogin(user) {
            console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–æ—à–µ–ª:", user.email);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞
            isAdmin = ADMIN_EMAILS.includes(user.email);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            loginBtn.style.display = 'none';
            registerBtn.style.display = 'none';
            logoutBtn.style.display = 'block';
            userDisplay.style.display = 'flex';
            
            if (isAdmin) {
                adminPanelBtn.style.display = 'block';
                adminBadge.style.display = 'inline';
                document.querySelectorAll('.admin-only').forEach(el => {
                    el.style.display = 'block';
                });
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserData(user.uid);
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π
            loadUpgrades();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–¥–º–∏–Ω–∞
            if (isAdmin) {
                loadUserList();
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π
            loadFriends();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±–º–µ–Ω–∞
            loadTradeOffers();
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function handleUserLogout() {
            console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—à–µ–ª");
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
            if (auth.currentUser) {
                saveGameState();
            }
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
            gameState.clicks = 0;
            gameState.bestScore = 0;
            gameState.clickMultiplier = 1;
            gameState.previousClicks = 0;
            gameState.previousBestScore = 0;
            gameState.previousCPS = 0;
            gameState.clickHistory = [];
            
            // –°–±—Ä–æ—Å —É–ª—É—á—à–µ–Ω–∏–π
            upgrades = {
                totalBonus: 0,
                items: []
            };
            
            // –°–±—Ä–æ—Å –æ–±–º–µ–Ω–∞
            currentTrade = {
                myItems: [],
                myClicks: 0,
                theirItems: [],
                theirClicks: 0,
                targetPlayer: null
            };
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            loginBtn.style.display = 'block';
            registerBtn.style.display = 'block';
            logoutBtn.style.display = 'none';
            userDisplay.style.display = 'none';
            adminPanelBtn.style.display = 'none';
            adminBadge.style.display = 'none';
            adminSection.style.display = 'none';
            changeNickname.style.display = 'none';
            userVerified.style.display = 'none';
            bonusDisplay.style.display = 'none';
            
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = 'none';
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            updateGameDisplay();
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
            loadLeaderboard();
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –ö–ª–∏–∫–µ—Ä
            clickArea.addEventListener('click', handleClick);
            
            // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            loginBtn.addEventListener('click', () => showAuthModal('login'));
            registerBtn.addEventListener('click', () => showAuthModal('register'));
            logoutBtn.addEventListener('click', handleLogout);
            authSubmit.addEventListener('click', handleAuthSubmit);
            authCancel.addEventListener('click', hideAuthModal);
            closeAuthModal.addEventListener('click', hideAuthModal);
            
            // –ù–∏–∫–Ω–µ–π–º
            changeNickname.addEventListener('click', showNicknameModal);
            saveNickname.addEventListener('click', saveNicknameHandler);
            cancelNickname.addEventListener('click', hideNicknameModal);
            closeNicknameModal.addEventListener('click', hideNicknameModal);
            
            // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
            showTop10.addEventListener('click', () => changeLeaderboardLimit(10));
            showTop25.addEventListener('click', () => changeLeaderboardLimit(25));
            showAll.addEventListener('click', () => changeLeaderboardLimit(0));
            
            // –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å
            adminPanelBtn.addEventListener('click', toggleAdminPanel);
            refreshUsers.addEventListener('click', loadUserList);
            resetAllScores.addEventListener('click', resetAllScoresHandler);
            addClicksToAll.addEventListener('click', () => showCustomClicksModal('all'));
            deleteInactive.addEventListener('click', deleteInactiveUsers);
            addClicksToOnline.addEventListener('click', () => addClicksToOnlineHandler());
            addMyClicks.addEventListener('click', () => addMyClicksHandler());
            createEvent.addEventListener('click', showEventModal);
            
            // –ú–æ–¥–∞–ª–∫–∏ –∞–¥–º–∏–Ω–∞
            adminSave.addEventListener('click', saveUserChanges);
            adminDelete.addEventListener('click', deleteUser);
            toggleVerified.addEventListener('click', toggleUserVerified);
            adminCancel.addEventListener('click', hideAdminModal);
            closeAdminModal.addEventListener('click', hideAdminModal);
            
            // –ú–æ–¥–∞–ª–∫–∞ —Å–æ–±—ã—Ç–∏–π
            startEvent.addEventListener('click', startEventHandler);
            stopEvent.addEventListener('click', stopEventHandler);
            cancelEvent.addEventListener('click', hideEventModal);
            closeEventModal.addEventListener('click', hideEventModal);
            
            // –ú–æ–¥–∞–ª–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
            confirmCustomClicks.addEventListener('click', confirmCustomClicksHandler);
            cancelCustomClicks.addEventListener('click', hideCustomClicksModal);
            closeCustomClicksModal.addEventListener('click', hideCustomClicksModal);
            
            // –ß–∞—Ç
            sendMessage.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', e => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            // –î—Ä—É–∑—å—è
            addFriendBtn.addEventListener('click', showFriendsModal);
            refreshFriends.addEventListener('click', loadFriends);
            searchFriend.addEventListener('click', searchFriendHandler);
            cancelFriend.addEventListener('click', hideFriendsModal);
            closeFriendsModal.addEventListener('click', hideFriendsModal);
            
            // –ö–Ω–æ–ø–∫–∏ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ"
            viewAllUpgrades.addEventListener('click', toggleAllUpgradesView);
            viewAllTrades.addEventListener('click', toggleAllTradesView);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∫–µ–π—Å–æ–≤
        function initCasesSystem() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–µ–π—Å–æ–≤
            basicCase.addEventListener('click', () => openCase('basic'));
            advancedCase.addEventListener('click', () => openCase('advanced'));
            premiumCase.addEventListener('click', () => openCase('premium'));
            legendaryCase.addEventListener('click', () => openCase('legendary'));
            mythicalCase.addEventListener('click', () => openCase('mythical'));
            divineCase.addEventListener('click', () => openCase('divine'));
            closeCaseResult.addEventListener('click', hideCaseResult);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–æ–¥–∞ –∞–¥–º–∏–Ω–∞
            confirmAdminCode.addEventListener('click', verifyAdminCode);
            cancelAdminCode.addEventListener('click', hideAdminCodeModal);
            closeAdminCodeModal.addEventListener('click', hideAdminCodeModal);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –æ–±–º–µ–Ω–∞
        function initTradeSystem() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ–±–º–µ–Ω–∞
            createTradeBtn.addEventListener('click', showTradeModal);
            refreshTrades.addEventListener('click', loadTradeOffers);
            addMyUpgrade.addEventListener('click', () => showInventoryModal('my'));
            addTheirUpgrade.addEventListener('click', () => showInventoryModal('their'));
            sendTradeOffer.addEventListener('click', sendTradeOfferHandler);
            cancelTrade.addEventListener('click', hideTradeModal);
            closeTradeModal.addEventListener('click', hideTradeModal);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            confirmInventorySelection.addEventListener('click', confirmInventorySelectionHandler);
            cancelInventorySelection.addEventListener('click', hideInventoryModal);
            closeInventoryModal.addEventListener('click', hideInventoryModal);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –≤ –æ–±–º–µ–Ω–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            myClicksInput.addEventListener('input', updateTradeClicks);
            theirClicksInput.addEventListener('input', updateTradeClicks);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUpgrades() {
            if (!auth.currentUser) return;
            
            const upgradesRef = database.ref('userUpgrades/' + auth.currentUser.uid);
            upgradesRef.on('value', snapshot => {
                const data = snapshot.val();
                if (data) {
                    upgrades = data;
                    // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ items –≤—Å–µ–≥–¥–∞ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
                    if (!upgrades.items) {
                        upgrades.items = [];
                    }
                    if (!upgrades.totalBonus) {
                        upgrades.totalBonus = 0;
                    }
                    renderUpgradesList();
                    updateBonusDisplay();
                } else {
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
                    upgrades = {
                        totalBonus: 0,
                        items: []
                    };
                    renderUpgradesList();
                    updateBonusDisplay();
                }
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π
        function renderUpgradesList() {
            upgradesContainer.innerHTML = '';
            
            if (upgrades.items && upgrades.items.length > 0) {
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É–ª—É—á—à–µ–Ω–∏—è –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                const sortedUpgrades = [...upgrades.items].sort((a, b) => b.value - a.value);
                
                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π, –µ—Å–ª–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
                const displayUpgrades = showAllUpgrades ? sortedUpgrades : sortedUpgrades.slice(0, 5);
                
                displayUpgrades.forEach((upgrade, index) => {
                    const upgradeItem = document.createElement('div');
                    upgradeItem.className = 'upgrade-item';
                    
                    let rarityClass = 'upgrade-rarity-common';
                    if (upgrade.value === 0.2) rarityClass = 'upgrade-rarity-uncommon';
                    else if (upgrade.value === 0.5) rarityClass = 'upgrade-rarity-rare';
                    else if (upgrade.value === 1.0) rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.value === 2.0) rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.value === 3.0) rarityClass = 'upgrade-rarity-legendary';
                    else if (upgrade.value === 5.0) rarityClass = 'upgrade-rarity-legendary';
                    else if (upgrade.value === 8.0) rarityClass = 'upgrade-rarity-mythical';
                    else if (upgrade.value === 10.0) rarityClass = 'upgrade-rarity-mythical';
                    else if (upgrade.value === 15.0) rarityClass = 'upgrade-rarity-divine';
                    
                    upgradeItem.innerHTML = `
                        <div>
                            <span class="${rarityClass}">–£–ª—É—á—à–µ–Ω–∏–µ +${upgrade.value}</span>
                        </div>
                        <div>
                            <small>${new Date(upgrade.timestamp).toLocaleDateString('ru-RU')}</small>
                        </div>
                    `;
                    
                    upgradesContainer.appendChild(upgradeItem);
                });
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ", –µ—Å–ª–∏ —É–ª—É—á—à–µ–Ω–∏–π –±–æ–ª—å—à–µ 5
                if (upgrades.items.length > 5) {
                    viewAllUpgrades.style.display = 'block';
                    viewAllUpgrades.textContent = showAllUpgrades ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ';
                } else {
                    viewAllUpgrades.style.display = 'none';
                }
                
                const totalBonusItem = document.createElement('div');
                totalBonusItem.className = 'upgrade-item';
                totalBonusItem.style.background = 'rgba(253, 187, 45, 0.3)';
                totalBonusItem.innerHTML = `
                    <div><strong>–û–±—â–∏–π –±–æ–Ω—É—Å –∫ –∫–ª–∏–∫—É</strong></div>
                    <div><strong>+${upgrades.totalBonus || 0}</strong></div>
                `;
                upgradesContainer.appendChild(totalBonusItem);
            } else {
                upgradesContainer.innerHTML = '<div style="text-align: center; padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π</div>';
                viewAllUpgrades.style.display = 'none';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö —É–ª—É—á—à–µ–Ω–∏–π
        function toggleAllUpgradesView() {
            showAllUpgrades = !showAllUpgrades;
            renderUpgradesList();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –æ–±–º–µ–Ω–æ–≤
        function toggleAllTradesView() {
            showAllTrades = !showAllTrades;
            viewAllTrades.textContent = showAllTrades ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ';
            loadTradeOffers();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
        function updateBonusDisplay() {
            if (upgrades.totalBonus > 0) {
                bonusValue.textContent = upgrades.totalBonus.toFixed(1);
                bonusDisplay.style.display = 'block';
            } else {
                bonusDisplay.style.display = 'none';
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞
        function openCase(caseType) {
            if (!auth.currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∫–µ–π—Å—ã');
                return;
            }
            
            let casePrice, caseName, caseElement;
            let chances = [];
            
            switch(caseType) {
                case 'basic':
                    casePrice = 500;
                    caseName = '–ë–∞–∑–æ–≤—ã–π –∫–µ–π—Å';
                    caseElement = basicCase;
                    chances = [
                        { value: 0.1, probability: 65 },
                        { value: 0.2, probability: 25 },
                        { value: 0.5, probability: 8 },
                        { value: 1.0, probability: 2 }
                    ];
                    break;
                case 'advanced':
                    casePrice = 1500;
                    caseName = '–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∫–µ–π—Å';
                    caseElement = advancedCase;
                    chances = [
                        { value: 0.2, probability: 65 },
                        { value: 0.5, probability: 25 },
                        { value: 1.0, probability: 8 },
                        { value: 2.0, probability: 2 }
                    ];
                    break;
                case 'premium':
                    casePrice = 3000;
                    caseName = '–ü—Ä–µ–º–∏—É–º –∫–µ–π—Å';
                    caseElement = premiumCase;
                    chances = [
                        { value: 0.5, probability: 65 },
                        { value: 1.0, probability: 25 },
                        { value: 2.0, probability: 8 },
                        { value: 3.0, probability: 2 }
                    ];
                    break;
                case 'legendary':
                    casePrice = 6000;
                    caseName = '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –∫–µ–π—Å';
                    caseElement = legendaryCase;
                    chances = [
                        { value: 1.0, probability: 65 },
                        { value: 2.0, probability: 25 },
                        { value: 3.0, probability: 8 },
                        { value: 5.0, probability: 2 }
                    ];
                    break;
                case 'mythical':
                    casePrice = 10000;
                    caseName = '–ú–∏—Ñ–∏—á–µ—Å–∫–∏–π –∫–µ–π—Å';
                    caseElement = mythicalCase;
                    chances = [
                        { value: 2.0, probability: 65 },
                        { value: 3.0, probability: 25 },
                        { value: 5.0, probability: 8 },
                        { value: 8.0, probability: 2 }
                    ];
                    break;
                case 'divine':
                    casePrice = 25000;
                    caseName = '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–µ–π—Å';
                    caseElement = divineCase;
                    chances = [
                        { value: 5.0, probability: 65 },
                        { value: 8.0, probability: 25 },
                        { value: 10.0, probability: 8 },
                        { value: 15.0, probability: 2 }
                    ];
                    break;
                default:
                    return;
            }
            
            if (gameState.clicks < casePrice) {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤! –ù—É–∂–Ω–æ ${casePrice} –∫–ª–∏–∫–æ–≤.`);
                return;
            }
            
            if (!confirm(`–û—Ç–∫—Ä—ã—Ç—å ${caseName} –∑–∞ ${casePrice} –∫–ª–∏–∫–æ–≤?`)) {
                return;
            }
            
            // –°–ø–∏–Ω –∞–Ω–∏–º–∞—Ü–∏—è
            caseElement.style.opacity = '0.7';
            caseElement.querySelector('button').textContent = '–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...';
            
            // –ò–º–∏—Ç–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => {
                // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–ø–∞–≤—à–µ–≥–æ —É–ª—É—á—à–µ–Ω–∏—è
                const random = Math.random() * 100;
                let upgradeValue, rarity, rarityName;
                let cumulativeProbability = 0;
                
                for (let chance of chances) {
                    cumulativeProbability += chance.probability;
                    if (random <= cumulativeProbability) {
                        upgradeValue = chance.value;
                        break;
                    }
                }
                
                // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–µ–¥–∫–æ—Å—Ç–∏
                if (upgradeValue === 0.1) {
                    rarity = 'common';
                    rarityName = '–û–±—ã—á–Ω–æ–µ';
                } else if (upgradeValue === 0.2) {
                    rarity = 'uncommon';
                    rarityName = '–ù–µ–æ–±—ã—á–Ω–æ–µ';
                } else if (upgradeValue === 0.5) {
                    rarity = 'rare';
                    rarityName = '–†–µ–¥–∫–æ–µ';
                } else if (upgradeValue === 1.0) {
                    rarity = 'epic';
                    rarityName = '–≠–ø–∏—á–µ—Å–∫–æ–µ';
                } else if (upgradeValue === 2.0) {
                    rarity = 'epic';
                    rarityName = '–≠–ø–∏—á–µ—Å–∫–æ–µ';
                } else if (upgradeValue === 3.0) {
                    rarity = 'legendary';
                    rarityName = '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ';
                } else if (upgradeValue === 5.0) {
                    rarity = 'legendary';
                    rarityName = '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–æ–µ';
                } else if (upgradeValue === 8.0) {
                    rarity = 'mythical';
                    rarityName = '–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ';
                } else if (upgradeValue === 10.0) {
                    rarity = 'mythical';
                    rarityName = '–ú–∏—Ñ–∏—á–µ—Å–∫–æ–µ';
                } else if (upgradeValue === 15.0) {
                    rarity = 'divine';
                    rarityName = '–ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ';
                }
                
                // –°–ø–∏—Å–∞–Ω–∏–µ –∫–ª–∏–∫–æ–≤
                gameState.clicks -= casePrice;
                updateGameDisplay();
                saveGameState();
                
                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
                addUpgrade(upgradeValue, rarity, rarityName);
                
                // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                showCaseResult(upgradeValue, rarity, rarityName, caseName);
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
                caseElement.style.opacity = '1';
                caseElement.querySelector('button').textContent = '–û—Ç–∫—Ä—ã—Ç—å –∫–µ–π—Å';
            }, 1500);
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É–ª—É—á—à–µ–Ω–∏—è
        function addUpgrade(value, rarity, rarityName) {
            if (!upgrades.items) {
                upgrades.items = [];
            }
            
            const newUpgrade = {
                value: value,
                rarity: rarity,
                rarityName: rarityName,
                timestamp: Date.now()
            };
            
            upgrades.items.push(newUpgrade);
            upgrades.totalBonus = (upgrades.totalBonus || 0) + value;
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            if (auth.currentUser) {
                const upgradesRef = database.ref('userUpgrades/' + auth.currentUser.uid);
                upgradesRef.set(upgrades);
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            renderUpgradesList();
            updateBonusDisplay();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
        function showCaseResult(value, rarity, rarityName, caseName) {
            let rarityColor = '#ffffff';
            if (rarity === 'uncommon') rarityColor = '#4CAF50';
            else if (rarity === 'rare') rarityColor = '#2196F3';
            else if (rarity === 'epic') rarityColor = '#9C27B0';
            else if (rarity === 'legendary') rarityColor = '#FF9800';
            else if (rarity === 'mythical') rarityColor = '#9C27B0';
            else if (rarity === 'divine') rarityColor = '#00BCD4';
            
            caseResultTitle.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${caseName}`;
            caseResultContent.innerHTML = `
                <div style="font-size: 1.5rem; color: ${rarityColor}; margin: 10px 0;">
                    ${rarityName} —É–ª—É—á—à–µ–Ω–∏–µ!
                </div>
                <div style="font-size: 2rem; font-weight: bold; color: #fdbb2d; margin: 15px 0;">
                    +${value} –∫ –∫–ª–∏–∫—É
                </div>
                <div>–¢–µ–ø–µ—Ä—å –∫–∞–∂–¥—ã–π –≤–∞—à –∫–ª–∏–∫ –±—É–¥–µ—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–ª–∏–∫–∏!</div>
            `;
            
            caseResultModal.style.display = 'flex';
        }

        // –°–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–µ–π—Å–∞
        function hideCaseResult() {
            caseResultModal.style.display = 'none';
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–∞
        function showAdminCodeModal() {
            adminCodeModal.style.display = 'flex';
            adminCodeInput.value = '';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–∞
        function hideAdminCodeModal() {
            adminCodeModal.style.display = 'none';
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∞–¥–º–∏–Ω–∞
        function verifyAdminCode() {
            const enteredCode = adminCodeInput.value.trim();
            
            if (enteredCode === ADMIN_CONFIRMATION_CODE) {
                hideAdminCodeModal();
                adminSection.style.display = 'block';
                loadUserList();
            } else {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function showInventoryModal(side) {
            if (!auth.currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±–º–µ–Ω');
                return;
            }
            
            if (!upgrades.items || upgrades.items.length === 0) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π –¥–ª—è –æ–±–º–µ–Ω–∞');
                return;
            }
            
            currentInventorySide = side;
            selectedInventoryItems = [];
            
            // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–æ—Ä–æ–Ω—ã
            inventoryModalTitle.textContent = side === 'my' ? 
                '–í—ã–±–µ—Ä–∏—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è –¥–ª—è –æ–±–º–µ–Ω–∞' : 
                '–í—ã–±–µ—Ä–∏—Ç–µ —É–ª—É—á—à–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å';
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–µ—Ç–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            inventoryGrid.innerHTML = '';
            
            upgrades.items.forEach((upgrade, index) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–∏ —É–∂–µ —ç—Ç–æ —É–ª—É—á—à–µ–Ω–∏–µ –≤ –æ–±–º–µ–Ω
                const alreadyAdded = currentTrade.myItems.some(item => 
                    Math.abs(item.value - upgrade.value) < 0.001 && 
                    item.rarity === upgrade.rarity
                );
                
                if (!alreadyAdded) {
                    const inventoryItem = document.createElement('div');
                    inventoryItem.className = 'inventory-item';
                    inventoryItem.dataset.index = index;
                    
                    let rarityClass = 'upgrade-rarity-common';
                    if (upgrade.rarity === 'uncommon') rarityClass = 'upgrade-rarity-uncommon';
                    else if (upgrade.rarity === 'rare') rarityClass = 'upgrade-rarity-rare';
                    else if (upgrade.rarity === 'epic') rarityClass = 'upgrade-rarity-epic';
                    else if (upgrade.rarity === 'legendary') rarityClass = 'upgrade-rarity-legendary';
                    else if (upgrade.rarity === 'mythical') rarityClass = 'upgrade-rarity-mythical';
                    else if (upgrade.rarity === 'divine') rarityClass = 'upgrade-rarity-divine';
                    
                    inventoryItem.innerHTML = `
                        <div class="${rarityClass}" style="font-weight: bold; margin-bottom: 5px;">+${upgrade.value}</div>
                        <div style="font-size: 0.8rem;">${upgrade.rarityName}</div>
                        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 5px;">${new Date(upgrade.timestamp).toLocaleDateString('ru-RU')}</div>
                    `;
                    
                    inventoryItem.addEventListener('click', () => {
                        inventoryItem.classList.toggle('selected');
                        const itemIndex = parseInt(inventoryItem.dataset.index);
                        
                        if (inventoryItem.classList.contains('selected')) {
                            selectedInventoryItems.push(itemIndex);
                        } else {
                            selectedInventoryItems = selectedInventoryItems.filter(idx => idx !== itemIndex);
                        }
                    });
                    
                    inventoryGrid.appendChild(inventoryItem);
                }
            });
            
            // –ï—Å–ª–∏ –≤—Å–µ —É–ª—É—á—à–µ–Ω–∏—è —É–∂–µ –≤ –æ–±–º–µ–Ω–µ
            if (inventoryGrid.children.length === 0) {
                inventoryGrid.innerHTML = '<div style="text-align: center; padding: 20px; grid-column: 1 / -1;">–í—Å–µ –≤–∞—à–∏ —É–ª—É—á—à–µ–Ω–∏—è —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –æ–±–º–µ–Ω</div>';
            }
            
            inventoryModal.style.display = 'flex';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function hideInventoryModal() {
            inventoryModal.style.display = 'none';
            selectedInventoryItems = [];
            currentInventorySide = null;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
        function confirmInventorySelectionHandler() {
            if (selectedInventoryItems.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —É–ª—É—á—à–µ–Ω–∏–µ');
                return;
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –≤ –æ–±–º–µ–Ω
            selectedInventoryItems.forEach(index => {
                const upgrade = upgrades.items[index];
                
                const tradeItem = {
                    value: upgrade.value,
                    rarity: upgrade.rarity,
                    rarityName: upgrade.rarityName,
                    timestamp: upgrade.timestamp
                };
                
                if (currentInventorySide === 'my') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –ª–∏ —É–∂–µ —ç—Ç–æ —É–ª—É—á—à–µ–Ω–∏–µ
                    const alreadyAdded = currentTrade.myItems.some(item => 
                        Math.abs(item.value - upgrade.value) < 0.001 && 
                        item.rarity === upgrade.rarity
                    );
                    
                    if (!alreadyAdded) {
                        currentTrade.myItems.push(tradeItem);
                    }
                } else {
                    // –î–ª—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π –º—ã –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Å–ø–∏—Å–æ–∫
                    // –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Ç–æ, —á—Ç–æ –º—ã —Ö–æ—Ç–∏–º –ø–æ–ª—É—á–∏—Ç—å
                    currentTrade.theirItems.push(tradeItem);
                }
            });
            
            updateTradeDisplay();
            hideInventoryModal();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–º–µ–Ω–∞
        function showTradeModal() {
            if (!auth.currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±–º–µ–Ω—ã');
                return;
            }
            
            // –°–±—Ä–æ—Å —Ç–µ–∫—É—â–µ–≥–æ –æ–±–º–µ–Ω–∞
            currentTrade = {
                myItems: [],
                myClicks: 0,
                theirItems: [],
                theirClicks: 0,
                targetPlayer: null
            };
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
            myClicksInput.value = '';
            theirClicksInput.value = '';
            tradePlayerInput.value = '';
            updateTradeDisplay();
            
            tradeModal.style.display = 'flex';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–±–º–µ–Ω–∞
        function hideTradeModal() {
            tradeModal.style.display = 'none';
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –≤ –æ–±–º–µ–Ω–µ
        function updateTradeClicks() {
            const myClicks = parseInt(myClicksInput.value) || 0;
            const theirClicks = parseInt(theirClicksInput.value) || 0;
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            currentTrade.myClicks = Math.max(0, myClicks);
            currentTrade.theirClicks = Math.max(0, theirClicks);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
            myClicksInput.value = currentTrade.myClicks;
            theirClicksInput.value = currentTrade.theirClicks;
            
            updateTradeDisplay();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞
        function updateTradeDisplay() {
            // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–æ–≤
            myTradeItems.innerHTML = '';
            theirTradeItems.innerHTML = '';
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            currentTrade.myItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <span>+${item.value} (${item.rarityName})</span>
                    <button onclick="removeTradeItem('my', ${index})">√ó</button>
                `;
                myTradeItems.appendChild(itemElement);
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞—à–∏—Ö –∫–ª–∏–∫–æ–≤
            if (currentTrade.myClicks > 0) {
                const clicksElement = document.createElement('div');
                clicksElement.className = 'trade-item';
                clicksElement.innerHTML = `
                    <span>${currentTrade.myClicks} –∫–ª–∏–∫–æ–≤</span>
                    <button onclick="removeTradeClicks('my')">√ó</button>
                `;
                myTradeItems.appendChild(clicksElement);
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            currentTrade.theirItems.forEach((item, index) => {
                const itemElement = document.createElement('div');
                itemElement.className = 'trade-item';
                itemElement.innerHTML = `
                    <span>+${item.value} (${item.rarityName})</span>
                    <button onclick="removeTradeItem('their', ${index})">√ó</button>
                `;
                theirTradeItems.appendChild(itemElement);
            });
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –¥—Ä—É–≥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            if (currentTrade.theirClicks > 0) {
                const clicksElement = document.createElement('div');
                clicksElement.className = 'trade-item';
                clicksElement.innerHTML = `
                    <span>${currentTrade.theirClicks} –∫–ª–∏–∫–æ–≤</span>
                    <button onclick="removeTradeClicks('their')">√ó</button>
                `;
                theirTradeItems.appendChild(clicksElement);
            }
            
            // –ï—Å–ª–∏ —Å–ø–∏—Å–∫–∏ –ø—É—Å—Ç—ã–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (myTradeItems.children.length === 0) {
                myTradeItems.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.7;">–ü—É—Å—Ç–æ</div>';
            }
            
            if (theirTradeItems.children.length === 0) {
                theirTradeItems.innerHTML = '<div style="text-align: center; padding: 10px; opacity: 0.7;">–ü—É—Å—Ç–æ</div>';
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ –æ–±–º–µ–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.removeTradeItem = function(side, index) {
            if (side === 'my') {
                currentTrade.myItems.splice(index, 1);
            } else {
                currentTrade.theirItems.splice(index, 1);
            }
            updateTradeDisplay();
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –∏–∑ –æ–±–º–µ–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.removeTradeClicks = function(side) {
            if (side === 'my') {
                currentTrade.myClicks = 0;
                myClicksInput.value = '';
            } else {
                currentTrade.theirClicks = 0;
                theirClicksInput.value = '';
            }
            updateTradeDisplay();
        };

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞
        function sendTradeOfferHandler() {
            const targetPlayerName = tradePlayerInput.value.trim();
            if (!targetPlayerName) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∏–≥—Ä–æ–∫–∞ –¥–ª—è –æ–±–º–µ–Ω–∞');
                return;
            }
            
            if (currentTrade.myItems.length === 0 && currentTrade.myClicks === 0) {
                alert('–í—ã –Ω–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç–µ –Ω–∏—á–µ–≥–æ –¥–ª—è –æ–±–º–µ–Ω–∞');
                return;
            }
            
            if (currentTrade.theirItems.length === 0 && currentTrade.theirClicks === 0) {
                alert('–í—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç–µ –Ω–∏—á–µ–≥–æ –¥–ª—è –æ–±–º–µ–Ω–∞');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–∏—Ö –∫–ª–∏–∫–æ–≤
            if (currentTrade.myClicks > gameState.clicks) {
                alert('–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –æ–±–º–µ–Ω–∞');
                return;
            }
            
            // –ü–æ–∏—Å–∫ –∏–≥—Ä–æ–∫–∞ –ø–æ –∏–º–µ–Ω–∏
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                let targetUser = null;
                
                for (let userId in users) {
                    if (userId === auth.currentUser.uid) continue;
                    
                    const userNickname = users[userId].nickname || users[userId].email.split('@')[0];
                    if (userNickname.toLowerCase() === targetPlayerName.toLowerCase()) {
                        targetUser = {
                            id: userId,
                            ...users[userId]
                        };
                        break;
                    }
                }
                
                if (!targetUser) {
                    alert('–ò–≥—Ä–æ–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                // –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞
                const tradeRef = database.ref('trades').push();
                const tradeData = {
                    fromUserId: auth.currentUser.uid,
                    fromUserName: userName.textContent,
                    toUserId: targetUser.id,
                    toUserName: targetUser.nickname || targetUser.email.split('@')[0],
                    myItems: currentTrade.myItems,
                    myClicks: currentTrade.myClicks,
                    theirItems: currentTrade.theirItems,
                    theirClicks: currentTrade.theirClicks,
                    status: 'pending',
                    timestamp: Date.now()
                };
                
                tradeRef.set(tradeData).then(() => {
                    alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                    hideTradeModal();
                    loadTradeOffers();
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–º–µ–Ω–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞');
                });
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±–º–µ–Ω–∞
        function loadTradeOffers() {
            if (!auth.currentUser) return;
            
            const tradesRef = database.ref('trades');
            tradesRef.on('value', snapshot => {
                const trades = snapshot.val();
                tradeOffers.innerHTML = '';
                
                if (trades) {
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ–±—ä–µ–∫—Ç –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
                    const tradesArray = Object.keys(trades).map(tradeId => ({
                        id: tradeId,
                        ...trades[tradeId]
                    })).sort((a, b) => b.timestamp - a.timestamp);
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –æ–±–º–µ–Ω–æ–≤, –µ—Å–ª–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ
                    const displayTrades = showAllTrades ? tradesArray : tradesArray.slice(0, 5);
                    
                    let hasUserTrades = false;
                    
                    displayTrades.forEach(trade => {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±–º–µ–Ω—ã
                        if (trade.fromUserId === auth.currentUser.uid || trade.toUserId === auth.currentUser.uid) {
                            addTradeOfferToList(trade.id, trade);
                            hasUserTrades = true;
                        }
                    });
                    
                    if (!hasUserTrades) {
                        tradeOffers.innerHTML = '<div style="text-align: center; padding: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±–º–µ–Ω–∞</div>';
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ", –µ—Å–ª–∏ –æ–±–º–µ–Ω–æ–≤ –±–æ–ª—å—à–µ 5
                    if (tradesArray.length > 5) {
                        viewAllTrades.style.display = 'block';
                    } else {
                        viewAllTrades.style.display = 'none';
                    }
                } else {
                    tradeOffers.innerHTML = '<div style="text-align: center; padding: 20px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –æ–±–º–µ–Ω–∞</div>';
                    viewAllTrades.style.display = 'none';
                }
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫
        function addTradeOfferToList(tradeId, trade) {
            const isOutgoing = trade.fromUserId === auth.currentUser.uid;
            const otherUserName = isOutgoing ? trade.toUserName : trade.fromUserName;
            
            const tradeElement = document.createElement('div');
            tradeElement.className = 'trade-offer';
            tradeElement.id = `trade-${tradeId}`;
            
            let tradeInfo = `
                <div class="trade-offer-info">
                    <strong>${isOutgoing ? '–ò—Å—Ö–æ–¥—è—â–µ–µ' : '–í—Ö–æ–¥—è—â–µ–µ'} –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</strong><br>
                    <small>–° –∏–≥—Ä–æ–∫–æ–º: ${otherUserName}</small><br>
                    <small>–°—Ç–∞—Ç—É—Å: ${getTradeStatusText(trade.status)}</small>
                </div>
            `;
            
            if (trade.status === 'pending') {
                if (isOutgoing) {
                    tradeInfo += `
                        <div class="trade-offer-actions">
                            <button onclick="cancelTradeOffer('${tradeId}')">–û—Ç–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    `;
                } else {
                    tradeInfo += `
                        <div class="trade-offer-actions">
                            <button onclick="acceptTradeOffer('${tradeId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                            <button onclick="rejectTradeOffer('${tradeId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                        </div>
                    `;
                }
            }
            
            tradeElement.innerHTML = tradeInfo;
            tradeOffers.appendChild(tradeElement);
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞ –æ–±–º–µ–Ω–∞
        function getTradeStatusText(status) {
            switch(status) {
                case 'pending': return '–û–∂–∏–¥–∞–Ω–∏–µ';
                case 'accepted': return '–ü—Ä–∏–Ω—è—Ç';
                case 'rejected': return '–û—Ç–∫–ª–æ–Ω–µ–Ω';
                case 'cancelled': return '–û—Ç–º–µ–Ω–µ–Ω';
                default: return status;
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±–º–µ–Ω - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –æ–±–º–µ–Ω–∞
        window.acceptTradeOffer = function(tradeId) {
            if (!confirm('–ü—Ä–∏–Ω—è—Ç—å —ç—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            
            // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± –æ–±–º–µ–Ω–µ
            tradeRef.once('value').then(snapshot => {
                const trade = snapshot.val();
                
                if (!trade) {
                    alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    return;
                }
                
                if (trade.status !== 'pending') {
                    alert('–≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ');
                    return;
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –Ω–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–∏–π
                if (trade.toUserId !== auth.currentUser.uid) {
                    alert('–≠—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ –Ω–µ –¥–ª—è –≤–∞—Å');
                    return;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–±–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const fromUserRef = database.ref('users/' + trade.fromUserId);
                const toUserRef = database.ref('users/' + trade.toUserId);
                
                Promise.all([
                    fromUserRef.once('value'),
                    toUserRef.once('value'),
                    database.ref('userUpgrades/' + trade.fromUserId).once('value'),
                    database.ref('userUpgrades/' + trade.toUserId).once('value')
                ]).then(([fromUserSnap, toUserSnap, fromUpgradesSnap, toUpgradesSnap]) => {
                    const fromUser = fromUserSnap.val();
                    const toUser = toUserSnap.val();
                    const fromUpgrades = fromUpgradesSnap.val() || { items: [], totalBonus: 0 };
                    const toUpgrades = toUpgradesSnap.val() || { items: [], totalBonus: 0 };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤
                    if (fromUser.clicks < trade.myClicks) {
                        alert('–£ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞');
                        tradeRef.update({ status: 'failed', reason: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è' });
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤
                    if (toUser.clicks < trade.theirClicks) {
                        alert('–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ –¥–ª—è –æ–±–º–µ–Ω–∞');
                        tradeRef.update({ status: 'failed', reason: '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–ª–∏–∫–æ–≤ —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è' });
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
                    const fromUserHasItems = trade.myItems.every(tradeItem => 
                        fromUpgrades.items && fromUpgrades.items.some(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        )
                    );
                    
                    if (!fromUserHasItems) {
                        alert('–£ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π');
                        tradeRef.update({ status: 'failed', reason: '–£ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π' });
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
                    const toUserHasItems = trade.theirItems.every(tradeItem => 
                        toUpgrades.items && toUpgrades.items.some(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        )
                    );
                    
                    if (!toUserHasItems) {
                        alert('–£ –≤–∞—Å –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π');
                        tradeRef.update({ status: 'failed', reason: '–£ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –Ω–µ—Ç —É–∫–∞–∑–∞–Ω–Ω—ã—Ö —É–ª—É—á—à–µ–Ω–∏–π' });
                        return;
                    }
                    
                    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–º–µ–Ω –∫–ª–∏–∫–∞–º–∏
                    const fromUserNewClicks = fromUser.clicks - trade.myClicks + trade.theirClicks;
                    const toUserNewClicks = toUser.clicks - trade.theirClicks + trade.myClicks;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∏–∫–∏
                    fromUserRef.update({ clicks: fromUserNewClicks });
                    toUserRef.update({ clicks: toUserNewClicks });
                    
                    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–º–µ–Ω —É–ª—É—á—à–µ–Ω–∏—è–º–∏
                    const fromUserNewUpgrades = { ...fromUpgrades };
                    const toUserNewUpgrades = { ...toUpgrades };
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤—ã items –µ—Å–ª–∏ –æ–Ω–∏ undefined
                    if (!fromUserNewUpgrades.items) fromUserNewUpgrades.items = [];
                    if (!toUserNewUpgrades.items) toUserNewUpgrades.items = [];
                    
                    // –£–¥–∞–ª—è–µ–º —É–ª—É—á—à–µ–Ω–∏—è —É –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–º—É —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                    trade.myItems.forEach(tradeItem => {
                        const index = fromUserNewUpgrades.items.findIndex(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        );
                        
                        if (index !== -1) {
                            fromUserNewUpgrades.items.splice(index, 1);
                            fromUserNewUpgrades.totalBonus = (fromUserNewUpgrades.totalBonus || 0) - tradeItem.value;
                        }
                    });
                    
                    trade.theirItems.forEach(tradeItem => {
                        fromUserNewUpgrades.items.push(tradeItem);
                        fromUserNewUpgrades.totalBonus = (fromUserNewUpgrades.totalBonus || 0) + tradeItem.value;
                    });
                    
                    // –£–¥–∞–ª—è–µ–º —É–ª—É—á—à–µ–Ω–∏—è —É –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –µ–º—É —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                    trade.theirItems.forEach(tradeItem => {
                        const index = toUserNewUpgrades.items.findIndex(upgrade => 
                            Math.abs(upgrade.value - tradeItem.value) < 0.001 && 
                            upgrade.rarity === tradeItem.rarity
                        );
                        
                        if (index !== -1) {
                            toUserNewUpgrades.items.splice(index, 1);
                            toUserNewUpgrades.totalBonus = (toUserNewUpgrades.totalBonus || 0) - tradeItem.value;
                        }
                    });
                    
                    trade.myItems.forEach(tradeItem => {
                        toUserNewUpgrades.items.push(tradeItem);
                        toUserNewUpgrades.totalBonus = (toUserNewUpgrades.totalBonus || 0) + tradeItem.value;
                    });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
                    database.ref('userUpgrades/' + trade.fromUserId).set(fromUserNewUpgrades);
                    database.ref('userUpgrades/' + trade.toUserId).set(toUserNewUpgrades);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –æ–±–º–µ–Ω–∞
                    tradeRef.update({ 
                        status: 'accepted',
                        completedAt: Date.now()
                    }).then(() => {
                        alert('–û–±–º–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!');
                        loadTradeOffers();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –º—ã —É—á–∞—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –æ–±–º–µ–Ω–µ
                        if (trade.fromUserId === auth.currentUser.uid || trade.toUserId === auth.currentUser.uid) {
                            loadUpgrades();
                            loadGameState();
                        }
                    });
                    
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–±–º–µ–Ω–∞:', error);
                    alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–±–º–µ–Ω–∞');
                    tradeRef.update({ status: 'failed', reason: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –æ–±–º–µ–Ω–∞' });
                });
                
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ–±–º–µ–Ω–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ–±–º–µ–Ω–∞');
            });
        };

        // –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.rejectTradeOffer = function(tradeId) {
            if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.update({ status: 'rejected' }).then(() => {
                alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
                loadTradeOffers();
            });
        };

        // –û—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –æ–±–º–µ–Ω–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.cancelTradeOffer = function(tradeId) {
            if (!confirm('–û—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞?')) return;
            
            const tradeRef = database.ref('trades/' + tradeId);
            tradeRef.update({ status: 'cancelled' }).then(() => {
                alert('–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ');
                loadTradeOffers();
            });
        };

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ —Å —É—á–µ—Ç–æ–º —É–ª—É—á—à–µ–Ω–∏–π
        function handleClick() {
            if (isBlocked) return;
            
            const now = Date.now();
            clickTimestamps.push(now);
            
            // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫–ª–∏–∫–æ–≤ (—Å—Ç–∞—Ä—à–µ 1 —Å–µ–∫—É–Ω–¥—ã)
            clickTimestamps = clickTimestamps.filter(timestamp => now - timestamp < 1000);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ CPS
            currentCPS = clickTimestamps.length;
            if (currentCPS > MAX_CPS) {
                blockUser();
                return;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã —Å —É—á–µ—Ç–æ–º —É–ª—É—á—à–µ–Ω–∏–π –∏ –º–Ω–æ–∂–∏—Ç–µ–ª—è —Å–æ–±—ã—Ç–∏—è
            const baseClickValue = 1;
            const upgradeBonus = upgrades.totalBonus || 0;
            const totalClickValue = (baseClickValue + upgradeBonus) * gameState.clickMultiplier;
            
            gameState.clicks += totalClickValue;
            
            if (gameState.clicks > gameState.bestScore) {
                gameState.bestScore = gameState.clicks;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            updateGameDisplay();
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            saveGameState();
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
            animateClick();
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω –ø–∞–Ω–µ–ª–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–¥–∞
        function toggleAdminPanel() {
            if (!isAdmin) {
                alert('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                return;
            }
            
            // –ï—Å–ª–∏ –∞–¥–º–∏–Ω, –Ω–æ –∫–æ–¥ –µ—â–µ –Ω–µ –≤–≤–µ–¥–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            if (adminSection.style.display === 'none' || !adminSection.style.display) {
                showAdminCodeModal();
            } else {
                adminSection.style.display = 'none';
            }
        }

        // –°–±—Ä–æ—Å –≤—Å–µ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ —É–ª—É—á—à–µ–Ω–∏–π
        function resetAllScoresHandler() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–±–Ω—É–ª–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É–ª—É—á—à–µ–Ω–∏—è? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                return;
            }
            
            const usersRef = database.ref('users');
            const upgradesRef = database.ref('userUpgrades');
            
            Promise.all([
                usersRef.once('value'),
                upgradesRef.once('value')
            ]).then(([usersSnapshot, upgradesSnapshot]) => {
                const usersUpdates = {};
                const upgradesUpdates = {};
                
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const users = usersSnapshot.val();
                if (users) {
                    for (let userId in users) {
                        usersUpdates[`${userId}/clicks`] = 0;
                        usersUpdates[`${userId}/bestScore`] = 0;
                    }
                }
                
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏–π
                const upgrades = upgradesSnapshot.val();
                if (upgrades) {
                    for (let userId in upgrades) {
                        upgradesUpdates[`${userId}/totalBonus`] = 0;
                        upgradesUpdates[`${userId}/items`] = [];
                    }
                }
                
                // –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                return Promise.all([
                    usersUpdates ? usersRef.update(usersUpdates) : Promise.resolve(),
                    upgradesUpdates ? upgradesRef.update(upgradesUpdates) : Promise.resolve()
                ]);
            }).then(() => {
                alert('–í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —É–ª—É—á—à–µ–Ω–∏—è –æ–±–Ω—É–ª–µ–Ω—ã');
                loadUserList();
                loadLeaderboard();
                
                // –°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (auth.currentUser) {
                    gameState.clicks = 0;
                    gameState.bestScore = 0;
                    upgrades.totalBonus = 0;
                    upgrades.items = [];
                    updateGameDisplay();
                    renderUpgradesList();
                    updateBonusDisplay();
                    saveGameState();
                }
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
        }

        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞ —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä—ã–µ –∫–ª–∏–∫–∏
        function blockUser() {
            isBlocked = true;
            clickArea.classList.add('blocked');
            blockedOverlay.style.display = 'flex';
            cpsWarning.textContent = `–°–õ–ò–®–ö–û–ú –ë–´–°–¢–†–û! –ü–æ–¥–æ–∂–¥–∏—Ç–µ ${MAX_CPS/2} —Å–µ–∫—É–Ω–¥`;
            
            blockTimeout = setTimeout(() => {
                isBlocked = false;
                clickArea.classList.remove('blocked');
                blockedOverlay.style.display = 'none';
                cpsWarning.textContent = '';
                clickTimestamps = [];
            }, (MAX_CPS/2) * 1000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CPS
        function updateCPS() {
            const now = Date.now();
            clickTimestamps = clickTimestamps.filter(timestamp => now - timestamp < 1000);
            currentCPS = clickTimestamps.length;
            
            cpsValue.textContent = currentCPS;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ CPS
            const cpsPercentage = Math.min((currentCPS / MAX_CPS) * 100, 100);
            cpsFill.style.width = `${cpsPercentage}%`;
            
            // –¶–≤–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç CPS
            if (currentCPS > MAX_CPS * 0.8) {
                cpsFill.style.background = 'linear-gradient(90deg, #FFC107, #F44336)';
            } else if (currentCPS > MAX_CPS * 0.5) {
                cpsFill.style.background = 'linear-gradient(90deg, #4CAF50, #FFC107)';
            } else {
                cpsFill.style.background = 'linear-gradient(90deg, #4CAF50, #4CAF50)';
            }
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–ª–∏–∫–∞
        function animateClick() {
            clickText.style.transform = 'scale(1.1)';
            setTimeout(() => {
                clickText.style.transform = 'scale(1)';
            }, 100);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–≥—Ä—ã
        function updateGameDisplay() {
            clickCount.textContent = Math.floor(gameState.clicks);
            bestScore.textContent = Math.floor(gameState.bestScore);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        function loadGameState() {
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ Firebase
            if (auth.currentUser) {
                loadUserData(auth.currentUser.uid);
            } else {
                // –ò–Ω–∞—á–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ localStorage
                const savedState = localStorage.getItem('clickerGameState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    gameState.clicks = parsedState.clicks || 0;
                    gameState.bestScore = parsedState.bestScore || 0;
                    updateGameDisplay();
                }
            }
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        function saveGameState() {
            if (auth.currentUser) {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.update({
                    clicks: Math.floor(gameState.clicks),
                    bestScore: Math.floor(gameState.bestScore),
                    lastActive: Date.now()
                });
            } else {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
                localStorage.setItem('clickerGameState', JSON.stringify({
                    clicks: gameState.clicks,
                    bestScore: gameState.bestScore
                }));
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserData(userId) {
            const userRef = database.ref('users/' + userId);
            userRef.on('value', snapshot => {
                const userData = snapshot.val();
                if (userData) {
                    gameState.clicks = userData.clicks || 0;
                    gameState.bestScore = userData.bestScore || 0;
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    userName.textContent = userData.nickname || userData.email.split('@')[0];
                    userAvatar.textContent = (userData.nickname || userData.email[0]).toUpperCase();
                    
                    if (userData.verified) {
                        userVerified.style.display = 'inline';
                    } else {
                        userVerified.style.display = 'none';
                    }
                    
                    changeNickname.style.display = 'block';
                    
                    updateGameDisplay();
                }
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        function loadLeaderboard() {
            const usersRef = database.ref('users');
            usersRef.orderByChild('bestScore').limitToLast(leaderboardLimit === 0 ? 1000 : leaderboardLimit).on('value', snapshot => {
                const users = snapshot.val();
                const leaderboardArray = [];
                
                for (let userId in users) {
                    if (users[userId].bestScore > 0) {
                        leaderboardArray.push({
                            id: userId,
                            email: users[userId].email,
                            nickname: users[userId].nickname,
                            clicks: users[userId].clicks || 0,
                            bestScore: users[userId].bestScore || 0,
                            verified: users[userId].verified || false
                        });
                    }
                }
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ bestScore (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
                leaderboardArray.sort((a, b) => b.bestScore - a.bestScore);
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π
                if (leaderboardLimit > 0) {
                    leaderboardArray.splice(leaderboardLimit);
                }
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
                renderLeaderboard(leaderboardArray);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        function renderLeaderboard(users) {
            leaderboard.innerHTML = '';
            
            users.forEach((user, index) => {
                const isCurrentUser = auth.currentUser && user.id === auth.currentUser.uid;
                const listItem = document.createElement('li');
                listItem.className = `leaderboard-item ${isCurrentUser ? 'current-user' : ''}`;
                
                listItem.innerHTML = `
                    <div class="rank">${index + 1}</div>
                    <div class="player-name">
                        <span>${user.nickname || user.email.split('@')[0]}</span>
                        ${user.verified ? '<span class="verified-badge">‚úì</span>' : ''}
                        ${isCurrentUser ? '<span style="color: #fdbb2d; margin-left: 5px;">(–í—ã)</span>' : ''}
                    </div>
                    <div class="player-score">${Math.floor(user.bestScore)}</div>
                `;
                
                if (isAdmin) {
                    const adminBtn = document.createElement('button');
                    adminBtn.textContent = '–†–µ–¥.';
                    adminBtn.style.padding = '5px 10px';
                    adminBtn.style.fontSize = '0.7rem';
                    adminBtn.addEventListener('click', () => editUser(user));
                    listItem.appendChild(adminBtn);
                }
                
                leaderboard.appendChild(listItem);
            });
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            if (users.length === 0) {
                const listItem = document.createElement('li');
                listItem.className = 'leaderboard-item';
                listItem.innerHTML = '<div style="text-align: center; width: 100%;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                leaderboard.appendChild(listItem);
            }
        }

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
        function changeLeaderboardLimit(limit) {
            leaderboardLimit = limit;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            showTop10.classList.remove('active');
            showTop25.classList.remove('active');
            showAll.classList.remove('active');
            
            if (limit === 10) showTop10.classList.add('active');
            if (limit === 25) showTop25.classList.add('active');
            if (limit === 0) showAll.classList.add('active');
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞
            loadLeaderboard();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function showAuthModal(type) {
            authModal.style.display = 'flex';
            if (type === 'login') {
                authModalTitle.textContent = '–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç';
                authSubmit.textContent = '–í–æ–π—Ç–∏';
            } else {
                authModalTitle.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞';
                authSubmit.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            }
            
            currentAction = type;
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function hideAuthModal() {
            authModal.style.display = 'none';
            authEmail.value = '';
            authPassword.value = '';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function handleAuthSubmit() {
            const email = authEmail.value;
            const password = authPassword.value;
            
            if (!email || !password) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            if (currentAction === 'login') {
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => {
                        hideAuthModal();
                    })
                    .catch(error => {
                        alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                    });
            } else {
                auth.createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                        const user = userCredential.user;
                        const userRef = database.ref('users/' + user.uid);
                        
                        userRef.set({
                            email: email,
                            nickname: email.split('@')[0],
                            clicks: 0,
                            bestScore: 0,
                            registered: Date.now(),
                            lastActive: Date.now(),
                            verified: false
                        });
                        
                        hideAuthModal();
                        showNicknameModal();
                    })
                    .catch(error => {
                        alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                    });
            }
        }

        // –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function handleLogout() {
            auth.signOut();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞
        function showNicknameModal() {
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.once('value').then(snapshot => {
                    const userData = snapshot.val();
                    nicknameInput.value = userData.nickname || '';
                    nicknameModal.style.display = 'flex';
                });
            }
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∏–∫–Ω–µ–π–º–∞
        function hideNicknameModal() {
            nicknameModal.style.display = 'none';
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∏–∫–Ω–µ–π–º–∞
        function saveNicknameHandler() {
            const nickname = nicknameInput.value.trim();
            
            if (!nickname) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º');
                return;
            }
            
            if (nickname.length > 15) {
                alert('–ù–∏–∫–Ω–µ–π–º –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 15 —Å–∏–º–≤–æ–ª–æ–≤');
                return;
            }
            
            if (auth.currentUser) {
                const userRef = database.ref('users/' + auth.currentUser.uid);
                userRef.update({
                    nickname: nickname
                }).then(() => {
                    hideNicknameModal();
                    userName.textContent = nickname;
                    userAvatar.textContent = nickname[0].toUpperCase();
                });
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function loadUserList() {
            if (!isAdmin) return;
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const usersArray = [];
                
                for (let userId in users) {
                    usersArray.push({
                        id: userId,
                        email: users[userId].email,
                        nickname: users[userId].nickname,
                        clicks: users[userId].clicks || 0,
                        bestScore: users[userId].bestScore || 0,
                        verified: users[userId].verified || false,
                        lastActive: users[userId].lastActive || 0
                    });
                }
                
                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                usersArray.sort((a, b) => b.lastActive - a.lastActive);
                
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                renderUserList(usersArray);
            });
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function renderUserList(users) {
            userList.innerHTML = '';
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleDateString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
                
                userItem.innerHTML = `
                    <div class="user-info">
                        <div>${user.nickname || user.email.split('@')[0]} ${user.verified ? '<span class="verified-badge">‚úì</span>' : ''}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">–ö–ª–∏–∫–∏: ${user.clicks} | –õ—É—á—à–∏–π: ${user.bestScore} | –ê–∫—Ç–∏–≤–µ–Ω: ${lastActive}</div>
                    </div>
                    <div class="user-actions">
                        <button class="edit-user">–†–µ–¥.</button>
                    </div>
                `;
                
                const editBtn = userItem.querySelector('.edit-user');
                editBtn.addEventListener('click', () => editUser(user));
                
                userList.appendChild(userItem);
            });
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function editUser(user) {
            selectedUser = user;
            adminModalTitle.textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${user.nickname || user.email.split('@')[0]}`;
            adminUserInfo.innerHTML = `
                <div>Email: ${user.email}</div>
                <div>–ù–∏–∫–Ω–µ–π–º: ${user.nickname || '–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'}</div>
                <div>–ö–ª–∏–∫–∏: ${user.clicks}</div>
                <div>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${user.bestScore}</div>
                <div>–í–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω: ${user.verified ? '–î–∞' : '–ù–µ—Ç'}</div>
            `;
            adminClicksInput.value = user.clicks;
            adminBestScoreInput.value = user.bestScore;
            adminModal.style.display = 'flex';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∞–¥–º–∏–Ω–∞
        function hideAdminModal() {
            adminModal.style.display = 'none';
            selectedUser = null;
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function saveUserChanges() {
            if (!selectedUser) return;
            
            const newClicks = parseInt(adminClicksInput.value) || 0;
            const newBestScore = parseInt(adminBestScoreInput.value) || 0;
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.update({
                clicks: newClicks,
                bestScore: newBestScore
            }).then(() => {
                alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function deleteUser() {
            if (!selectedUser || !confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${selectedUser.email}?`)) {
                return;
            }
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.remove().then(() => {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω');
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function toggleUserVerified() {
            if (!selectedUser) return;
            
            const userRef = database.ref('users/' + selectedUser.id);
            userRef.update({
                verified: !selectedUser.verified
            }).then(() => {
                alert(`–°—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${!selectedUser.verified ? '–î–∞' : '–ù–µ—Ç'}`);
                hideAdminModal();
                loadUserList();
                loadLeaderboard();
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏–π
        function showEventModal() {
            eventModal.style.display = 'flex';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–±—ã—Ç–∏–π
        function hideEventModal() {
            eventModal.style.display = 'none';
        }

        // –ó–∞–ø—É—Å–∫ —Å–æ–±—ã—Ç–∏—è
        function startEventHandler() {
            const multiplier = parseFloat(eventMultiplier.value);
            const duration = parseInt(eventDuration.value);
            
            if (!multiplier || !duration) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å –∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å');
                return;
            }
            
            const eventRef = database.ref('activeEvent');
            const eventData = {
                multiplier: multiplier,
                endTime: Date.now() + (duration * 60 * 1000),
                startedBy: auth.currentUser.uid,
                startedAt: Date.now()
            };
            
            eventRef.set(eventData).then(() => {
                alert(`–°–æ–±—ã—Ç–∏–µ ${multiplier}x –∑–∞–ø—É—â–µ–Ω–æ –Ω–∞ ${duration} –º–∏–Ω—É—Ç!`);
                hideEventModal();
                checkActiveEvent();
            });
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è
        function stopEventHandler() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Å–æ–±—ã—Ç–∏–µ?')) {
                return;
            }
            
            const eventRef = database.ref('activeEvent');
            eventRef.remove().then(() => {
                alert('–°–æ–±—ã—Ç–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                hideEventModal();
                checkActiveEvent();
            });
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
        function checkActiveEvent() {
            const eventRef = database.ref('activeEvent');
            eventRef.once('value').then(snapshot => {
                const event = snapshot.val();
                
                if (event && event.endTime > Date.now()) {
                    // –°–æ–±—ã—Ç–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
                    gameState.clickMultiplier = event.multiplier;
                    const timeLeft = Math.ceil((event.endTime - Date.now()) / 1000 / 60);
                    
                    eventNotification.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>üî• –ê–ö–¢–ò–í–ù–û–ï –°–û–ë–´–¢–ò–ï: ${event.multiplier}x –ö–õ–ò–ö–ò! –û—Å—Ç–∞–ª–æ—Å—å: ${timeLeft} –º–∏–Ω.</div>
                            ${isAdmin ? '<button onclick="stopEventFromNotification()" style="padding: 5px 10px; font-size: 0.8rem;">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>' : ''}
                        </div>
                    `;
                    eventNotification.style.display = 'block';
                } else {
                    // –°–æ–±—ã—Ç–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ
                    gameState.clickMultiplier = 1;
                    eventNotification.style.display = 'none';
                    
                    // –£–¥–∞–ª—è–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
                    if (event) {
                        eventRef.remove();
                    }
                }
            });
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        window.stopEventFromNotification = function() {
            if (!isAdmin) return;
            
            const eventRef = database.ref('activeEvent');
            eventRef.remove().then(() => {
                alert('–°–æ–±—ã—Ç–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                checkActiveEvent();
            });
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
        function showCustomClicksModal(target) {
            if (!isAdmin) return;
            
            currentAction = target;
            customClicksModal.style.display = 'flex';
            
            if (target === 'all') {
                customClicksTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–∫–∏ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º';
            } else if (target === 'online') {
                customClicksTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–∫–∏ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º';
            } else if (target === 'me') {
                customClicksTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–∫–∏ —Å–µ–±–µ';
            }
            
            customClicksInput.value = '';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –∫–ª–∏–∫–æ–≤
        function hideCustomClicksModal() {
            customClicksModal.style.display = 'none';
            currentAction = null;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤
        function confirmCustomClicksHandler() {
            const clicksToAdd = parseInt(customClicksInput.value);
            
            if (!clicksToAdd || clicksToAdd <= 0) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–∫–æ–≤');
                return;
            }
            
            if (currentAction === 'all') {
                addClicksToAllHandler(clicksToAdd);
            } else if (currentAction === 'online') {
                addClicksToOnlineHandler(clicksToAdd);
            } else if (currentAction === 'me') {
                addMyClicksHandler(clicksToAdd);
            }
            
            hideCustomClicksModal();
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        function addClicksToAllHandler(clicksToAdd) {
            if (!isAdmin) return;
            
            if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å ${clicksToAdd} –∫–ª–∏–∫–æ–≤ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const updates = {};
                
                for (let userId in users) {
                    const currentClicks = users[userId].clicks || 0;
                    const currentBestScore = users[userId].bestScore || 0;
                    
                    updates[`${userId}/clicks`] = currentClicks + clicksToAdd;
                    updates[`${userId}/bestScore`] = Math.max(currentBestScore, currentClicks + clicksToAdd);
                }
                
                return usersRef.update(updates);
            }).then(() => {
                alert(`${clicksToAdd} –∫–ª–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
                loadUserList();
                loadLeaderboard();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (auth.currentUser) {
                    loadUserData(auth.currentUser.uid);
                }
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–∫–æ–≤');
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
        function addClicksToOnlineHandler(clicksToAdd) {
            if (!isAdmin) {
                clicksToAdd = parseInt(clicksToOnlineInput.value) || 1000;
            }
            
            if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å ${clicksToAdd} –∫–ª–∏–∫–æ–≤ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º?`)) {
                return;
            }
            
            const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
            const usersRef = database.ref('users');
            
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const updates = {};
                
                for (let userId in users) {
                    if (users[userId].lastActive && users[userId].lastActive > fiveMinutesAgo) {
                        const currentClicks = users[userId].clicks || 0;
                        const currentBestScore = users[userId].bestScore || 0;
                        
                        updates[`${userId}/clicks`] = currentClicks + clicksToAdd;
                        updates[`${userId}/bestScore`] = Math.max(currentBestScore, currentClicks + clicksToAdd);
                    }
                }
                
                return usersRef.update(updates);
            }).then(() => {
                alert(`${clicksToAdd} –∫–ª–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º`);
                loadUserList();
                loadLeaderboard();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (auth.currentUser) {
                    loadUserData(auth.currentUser.uid);
                }
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–∫–æ–≤');
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–∫–æ–≤ —Å–µ–±–µ
        function addMyClicksHandler(clicksToAdd) {
            if (!isAdmin) {
                clicksToAdd = parseInt(clicksToMeInput.value) || 5000;
            }
            
            if (!auth.currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–∫–∏');
                return;
            }
            
            if (!confirm(`–î–æ–±–∞–≤–∏—Ç—å ${clicksToAdd} –∫–ª–∏–∫–æ–≤ —Å–µ–±–µ?`)) {
                return;
            }
            
            const userRef = database.ref('users/' + auth.currentUser.uid);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                const currentClicks = user.clicks || 0;
                const currentBestScore = user.bestScore || 0;
                
                return userRef.update({
                    clicks: currentClicks + clicksToAdd,
                    bestScore: Math.max(currentBestScore, currentClicks + clicksToAdd)
                });
            }).then(() => {
                alert(`${clicksToAdd} –∫–ª–∏–∫–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω—ã`);
                loadUserList();
                loadLeaderboard();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–∫–æ–≤:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–∫–æ–≤');
            });
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function deleteInactiveUsers() {
            if (!isAdmin) return;
            
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–ª–µ–µ 30 –¥–Ω–µ–π?')) {
                return;
            }
            
            const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
            const usersRef = database.ref('users');
            
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const deletions = [];
                
                for (let userId in users) {
                    if (!users[userId].lastActive || users[userId].lastActive < thirtyDaysAgo) {
                        deletions.push(usersRef.child(userId).remove());
                    }
                }
                
                return Promise.all(deletions);
            }).then(() => {
                alert('–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª–µ–Ω—ã');
                loadUserList();
                loadLeaderboard();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞
        function loadChat() {
            const chatRef = database.ref('chat').limitToLast(50);
            chatRef.on('value', snapshot => {
                const messages = snapshot.val();
                chatMessages.innerHTML = '';
                
                if (messages) {
                    const messagesArray = Object.keys(messages).map(key => ({
                        id: key,
                        ...messages[key]
                    })).sort((a, b) => a.timestamp - b.timestamp);
                    
                    messagesArray.forEach(message => {
                        addMessageToChat(message);
                    });
                    
                    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function addMessageToChat(message) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-message ${message.type === 'system' ? 'system' : ''} ${message.adminAction ? 'admin-action' : ''}`;
            messageElement.id = message.id;
            
            let senderHtml = '';
            if (message.type !== 'system') {
                senderHtml = `
                    <div class="message-sender">
                        <span class="user-with-badge">
                            ${message.senderName}
                            ${message.verified ? '<span class="verified-badge">‚úì</span>' : ''}
                            ${message.adminAction ? '<span class="admin-badge-chat">ADMIN</span>' : ''}
                        </span>
                    </div>
                `;
            }
            
            messageElement.innerHTML = `
                ${senderHtml}
                <div class="message-text">${message.text}</div>
                <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 3px;">
                    ${new Date(message.timestamp).toLocaleTimeString('ru-RU')}
                </div>
            `;
            
            chatMessages.appendChild(messageElement);
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç
        function sendChatMessage() {
            const messageText = chatInput.value.trim();
            
            if (!messageText) {
                alert('–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ');
                return;
            }
            
            if (!auth.currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userRef = database.ref('users/' + auth.currentUser.uid);
            userRef.once('value').then(snapshot => {
                const user = snapshot.val();
                
                // –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                const chatRef = database.ref('chat').push();
                const messageData = {
                    senderId: auth.currentUser.uid,
                    senderName: user.nickname || user.email.split('@')[0],
                    text: messageText,
                    timestamp: Date.now(),
                    verified: user.verified || false,
                    adminAction: isAdmin
                };
                
                return chatRef.set(messageData);
            }).then(() => {
                chatInput.value = '';
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è');
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥—Ä—É–∑–µ–π
        function loadFriends() {
            if (!auth.currentUser) return;
            
            const friendsRef = database.ref('userFriends/' + auth.currentUser.uid);
            friendsRef.on('value', snapshot => {
                const friends = snapshot.val();
                friendsList.innerHTML = '';
                
                if (friends) {
                    const friendIds = Object.keys(friends);
                    
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞–∂–¥–æ–º –¥—Ä—É–≥–µ
                    friendIds.forEach(friendId => {
                        const userRef = database.ref('users/' + friendId);
                        userRef.once('value').then(snapshot => {
                            const friend = snapshot.val();
                            if (friend) {
                                addFriendToList(friendId, friend, friends[friendId].status);
                            }
                        });
                    });
                } else {
                    friendsList.innerHTML = '<div style="text-align: center; padding: 20px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π</div>';
                }
            });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ –≤ —Å–ø–∏—Å–æ–∫
        function addFriendToList(friendId, friend, status) {
            const friendItem = document.createElement('div');
            friendItem.className = 'friend-item';
            friendItem.id = `friend-${friendId}`;
            
            const lastActive = friend.lastActive ? new Date(friend.lastActive).toLocaleDateString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
            const isOnline = friend.lastActive && (Date.now() - friend.lastActive < 5 * 60 * 1000);
            
            friendItem.innerHTML = `
                <div class="friend-info">
                    <div class="friend-avatar">${(friend.nickname || friend.email[0]).toUpperCase()}</div>
                    <div>
                        <div>${friend.nickname || friend.email.split('@')[0]} ${friend.verified ? '<span class="verified-badge">‚úì</span>' : ''}</div>
                        <div style="font-size: 0.8rem; opacity: 0.7;">
                            ${isOnline ? '<span style="color: #4CAF50;">‚óè –û–Ω–ª–∞–π–Ω</span>' : `–ë—ã–ª(–∞): ${lastActive}`}
                        </div>
                    </div>
                </div>
                <div class="friend-actions">
                    ${status === 'pending' ? '<button onclick="acceptFriendRequest(\'' + friendId + '\')">–ü—Ä–∏–Ω—è—Ç—å</button>' : ''}
                    <button onclick="removeFriend(\'' + friendId + '\')">${status === 'pending' ? '–û—Ç–∫–ª–æ–Ω–∏—Ç—å' : '–£–¥–∞–ª–∏—Ç—å'}</button>
                </div>
            `;
            
            friendsList.appendChild(friendItem);
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥—Ä—É–∑–µ–π
        function showFriendsModal() {
            if (!auth.currentUser) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–ª—è—Ç—å –¥—Ä—É–∑–µ–π');
                return;
            }
            
            friendsModal.style.display = 'flex';
            friendSearchInput.value = '';
            friendSearchResults.innerHTML = '';
        }

        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥—Ä—É–∑–µ–π
        function hideFriendsModal() {
            friendsModal.style.display = 'none';
        }

        // –ü–æ–∏—Å–∫ –¥—Ä—É–≥–∞
        function searchFriendHandler() {
            const searchTerm = friendSearchInput.value.trim().toLowerCase();
            
            if (!searchTerm) {
                alert('–í–≤–µ–¥–∏—Ç–µ email –∏–ª–∏ –Ω–∏–∫–Ω–µ–π–º –¥–ª—è –ø–æ–∏—Å–∫–∞');
                return;
            }
            
            const usersRef = database.ref('users');
            usersRef.once('value').then(snapshot => {
                const users = snapshot.val();
                const results = [];
                
                for (let userId in users) {
                    if (userId === auth.currentUser.uid) continue;
                    
                    const emailMatch = users[userId].email.toLowerCase().includes(searchTerm);
                    const nicknameMatch = users[userId].nickname && users[userId].nickname.toLowerCase().includes(searchTerm);
                    
                    if (emailMatch || nicknameMatch) {
                        results.push({
                            id: userId,
                            ...users[userId]
                        });
                    }
                }
                
                displayFriendSearchResults(results);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥—Ä—É–∑–µ–π
        function displayFriendSearchResults(results) {
            friendSearchResults.innerHTML = '';
            
            if (results.length === 0) {
                friendSearchResults.innerHTML = '<div style="text-align: center; padding: 10px;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
                return;
            }
            
            results.forEach(user => {
                const resultItem = document.createElement('div');
                resultItem.className = 'friend-item';
                resultItem.style.marginBottom = '10px';
                
                resultItem.innerHTML = `
                    <div class="friend-info">
                        <div class="friend-avatar">${(user.nickname || user.email[0]).toUpperCase()}</div>
                        <div>
                            <div>${user.nickname || user.email.split('@')[0]} ${user.verified ? '<span class="verified-badge">‚úì</span>' : ''}</div>
                            <div style="font-size: 0.8rem; opacity: 0.7;">–ö–ª–∏–∫–∏: ${user.clicks || 0}</div>
                        </div>
                    </div>
                    <div class="friend-actions">
                        <button onclick="sendFriendRequest('${user.id}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                `;
                
                friendSearchResults.appendChild(resultItem);
            });
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.sendFriendRequest = function(friendId) {
            if (!auth.currentUser) return;
            
            const myFriendsRef = database.ref('userFriends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('userFriends/' + friendId + '/' + auth.currentUser.uid);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ –∑–∞–ø—Ä–æ—Å
            myFriendsRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —É –≤–∞—Å –≤ –¥—Ä—É–∑—å—è—Ö');
                    return;
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
                return Promise.all([
                    myFriendsRef.set({ status: 'pending', timestamp: Date.now() }),
                    theirFriendsRef.set({ status: 'requested', timestamp: Date.now() })
                ]);
            }).then(() => {
                alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
                hideFriendsModal();
                loadFriends();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è');
            });
        };

        // –ü—Ä–∏–Ω—è—Ç–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.acceptFriendRequest = function(friendId) {
            if (!auth.currentUser) return;
            
            const myFriendsRef = database.ref('userFriends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('userFriends/' + friendId + '/' + auth.currentUser.uid);
            
            Promise.all([
                myFriendsRef.update({ status: 'accepted' }),
                theirFriendsRef.update({ status: 'accepted' })
            ]).then(() => {
                alert('–ó–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è –ø—Ä–∏–Ω—è—Ç');
                loadFriends();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥—Ä—É–∑—å—è');
            });
        };

        // –£–¥–∞–ª–µ–Ω–∏–µ –¥—Ä—É–≥–∞ (–≥–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
        window.removeFriend = function(friendId) {
            if (!auth.currentUser) return;
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥—Ä—É–∑–µ–π?')) {
                return;
            }
            
            const myFriendsRef = database.ref('userFriends/' + auth.currentUser.uid + '/' + friendId);
            const theirFriendsRef = database.ref('userFriends/' + friendId + '/' + auth.currentUser.uid);
            
            Promise.all([
                myFriendsRef.remove(),
                theirFriendsRef.remove()
            ]).then(() => {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ –¥—Ä—É–∑–µ–π');
                loadFriends();
            }).catch(error => {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥—Ä—É–≥–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –¥—Ä—É–∑–µ–π');
            });
        };

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        initApp();
    </script>
</body>
</html>