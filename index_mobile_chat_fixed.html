<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Klass Messenger üòà</title>
  <style>
    :root{--accent:#2563eb}
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:0;background:#f4f6f8;color:#111 overflow-x:hidden;}
    header{background:#0f172a;color:#fff;padding:12px 16px}
    .container{margin:0 auto;padding:8px;max-width:100%;}
    .grid{display:flex;flex-direction:column;gap:16px}
    .card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(10,10,10,.06)}
    .list{height:520px;overflow:auto}
    .chat-window{display:flex;flex-direction:column;height:calc(100vh - 160px);}
    .messages{flex:1;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px}
    .msg-row{display:flex;gap:8px;align-items:flex-end}
    .msg-row.me{justify-content:flex-end}
    .bubble{max-width:72%;padding:8px;border-radius:10px}
    .me .bubble{background:#DCFCE7}
    .them .bubble{background:#EEF2FF}
    .avatar{width:36px;height:36px;border-radius:50%;object-fit:cover}
    .controls{display:flex;gap:8px;padding-top:8px;align-items:center}
    input,button,textarea,select{padding:12px;font-size:16px;border-radius:8px;border:1px solid #d0d6db}
    button{background:var(--accent);color:#fff;border:none}
    .small{font-size:12px;color:#666}
    .file-thumb{max-width:220px;display:block;margin-top:6px;border-radius:6px}
    .meta{font-size:12px;color:#666;margin-top:4px}
    .top-notice{position:fixed;left:50%;transform:translateX(-50%);top:12px;background:#111;color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:999}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    @media(max-width:980px){ .grid{display:flex;flex-direction:column;gap:16px} .list{height:160px} .chat-window{display:flex;flex-direction:column;height:calc(100vh - 160px);} }
  
/* ===== Added features: badges, mentions, small icons ===== */
.badge { background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:12px;margin-left:8px;display:inline-block;min-width:20px;text-align:center }
.msg-actions{margin-left:8px;display:flex;gap:6px;align-items:center}
.msg-actions button{background:transparent;border:none;color:#666;cursor:pointer;font-size:14px;padding:4px;border-radius:6px}
.msg-actions button:hover{background:#f3f4f6}
.mention{background:rgba(37,99,235,0.12);padding:2px 4px;border-radius:4px;color:#2563eb}
.user-controls{display:flex;gap:8px;align-items:center;margin-top:8px}
.small-muted{font-size:12px;color:#666}


/* Action popup (animated bottom sheet) */
.action-popup-backdrop{ position:fixed; left:0; right:0; bottom:0; top:0; display:none; align-items:flex-end; justify-content:center; z-index:3000; }
.action-popup{ width:100%; max-width:520px; border-radius:12px 12px 0 0; background:#fff; box-shadow:0 -8px 30px rgba(2,6,23,0.2); padding:12px; transform:translateY(100%); transition:transform .28s cubic-bezier(.2,.9,.3,1), opacity .2s; opacity:0; }
.action-popup.show{ transform:translateY(0); opacity:1; }
.action-popup .opt{ padding:12px; border-radius:8px; margin:6px 0; font-size:16px; text-align:center; cursor:pointer; }
.action-popup .opt.danger{ color:#ef4444; font-weight:600; }
.action-popup .opt.block{ color:#ef4444; }
.action-popup .opt.cancel{ background:#f3f4f6; }
@media(min-width:769px){
  .action-popup{ border-radius:8px; width:420px; margin-bottom:24px; }
  .action-popup-backdrop{ align-items:center; }
}

</style>
</head>
<body>
<script>window.currentUser = window.currentUser || null;</script>
  <header>
    <strong>Klass Messenger üòà</strong>
  </header>

  <div class="container">
    <div class="grid">
      <div class="card" id="authCard">
        <h3>–ê–∫–∫–∞—É–Ω—Ç</h3>
        <div id="auth-panel">
          <input id="email" placeholder="Email" autocomplete="username" />
          <input id="password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" autocomplete="current-password" />
          <input id="displayName" placeholder="–ò–º—è (–ø—É–±–ª–∏—á–Ω–æ–µ)" />
          <label style="display:flex;gap:8px;align-items:center"><input id="avatarInput" type="file" accept="image/*" /> <span class="small">–ê–≤–∞—Ç–∞—Ä (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span></label>
          <div class="actions">
            <button id="btnRegister">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <button id="btnLogin">–í–æ–π—Ç–∏</button>
            <button id="btnGuest">–ì–æ—Å—Ç–µ–≤–æ–π –≤—Ö–æ–¥</button>
            <button id="btnReset">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
            <button id="btnGoogle" style="background:#DB4437">–í–æ–π—Ç–∏ —Å Google</button>
          </div>
          <p class="small">–î–ª—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤–∫–ª—é—á–∏—Ç–µ Authentication + Realtime Database –≤ Firebase Console. Google Sign-In –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∫–ª—é—á—ë–Ω (Authentication ‚Üí Sign-in method ‚Üí Google), –∏ –≤ Authorized domains –¥–æ–±–∞–≤–ª–µ–Ω –¥–æ–º –≤–∞—à–µ–≥–æ GitHub Pages (–Ω–∞–ø—Ä–∏–º–µ—Ä: <code>yourname.github.io</code>).</p>
        </div>
        <div id="user-panel" style="display:none">
          <div style="display:flex;gap:8px;align-items:center">
            <img id="meAvatar" class="avatar" src="" style="display:none" />
            <div>
              <strong id="meName"></strong>
              <div class="small" id="meEmail"></div>
            </div>
          </div>
          <div style="margin-top:8px" class="actions">
            <button id="btnLogout">–í—ã–π—Ç–∏</button>
            <button id="btnCreateGroup">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
            <button id="btnMyGroups">–ú–æ–∏ –≥—Ä—É–ø–ø—ã</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h3>
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <input id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏/email" style="flex:1" />
          <button id="btnSearch">–ü–æ–∏—Å–∫</button>
        </div>
        <div class="list" id="usersList"></div>
      </div>

      <div class="card chat-window">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong id="chatTitle">–õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</strong>
            <div class="small" id="chatSub"></div>
          </div>
          <div class="actions">
            <select id="modeSelect"><option value="pm">1-–Ω–∞-1</option><option value="group">–ì—Ä—É–ø–ø–∞</option></select>
            <select id="groupsSelect" style="display:none"></select>
            <button id="btnRefresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>

        <div class="messages" id="messages"></div>

        <div class="controls">

          <input id="msgInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" style="flex:1" />
          <input id="fileInput" type="file" />
          <button id="btnSend">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <p class="small" style="margin-top:12px">–ì—Ä—É–ø–ø—ã –∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ Realtime Database. –§–∞–π–ª—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –≤–∏–¥–µ base64 –≤ –±–∞–∑–µ (–¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è).</p>
  </div>

  <div id="notice" class="top-notice"></div>

  <script type="module">
    // ============ –¢–í–û–Ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase ==============
    const firebaseConfig = {
      apiKey: "AIzaSyDTwQJ4z3vuj_3BFSfUCryooN3IYH-MKsE",
      authDomain: "best-messenger-9db3f.firebaseapp.com",
      databaseURL: "https://best-messenger-9db3f-default-rtdb.europe-west1.firebasedatabase.app/",
      projectId: "best-messenger-9db3f",
      storageBucket: "best-messenger-9db3f.firebasestorage.app",
      messagingSenderId: "626528479187",
      appId: "1:626528479187:web:7e7b094416ce8d98e57126"
    };
    // ======================================================

    const useFirebase = !!(firebaseConfig && firebaseConfig.apiKey);
    const LOCAL_KEY = 'klass_messenger_v3_local';

    // UI refs
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const displayNameEl = document.getElementById('displayName');
    const avatarInput = document.getElementById('avatarInput');
    const btnRegister = document.getElementById('btnRegister');
    const btnLogin = document.getElementById('btnLogin');
    const btnGuest = document.getElementById('btnGuest');
    const btnReset = document.getElementById('btnReset');
    const btnGoogle = document.getElementById('btnGoogle');
    const btnLogout = document.getElementById('btnLogout');
    const authPanel = document.getElementById('auth-panel');
    const userPanel = document.getElementById('user-panel');
    const meName = document.getElementById('meName');
    const meEmail = document.getElementById('meEmail');
    const meAvatar = document.getElementById('meAvatar');

    const searchInput = document.getElementById('searchInput');
    const btnSearch = document.getElementById('btnSearch');
    const usersList = document.getElementById('usersList');

    const messagesEl = document.getElementById('messages');
    const msgInput = document.getElementById('msgInput');
    const fileInput = document.getElementById('fileInput');
    const btnSend = document.getElementById('btnSend');

    const chatTitle = document.getElementById('chatTitle');
    const chatSub = document.getElementById('chatSub');
    const modeSelect = document.getElementById('modeSelect');
    const groupsSelect = document.getElementById('groupsSelect');
    const btnCreateGroup = document.getElementById('btnCreateGroup');
    const btnMyGroups = document.getElementById('btnMyGroups');
    const btnRefresh = document.getElementById('btnRefresh');

    const notice = document.getElementById('notice');
    function showNotice(text, time=3000){ notice.textContent = text; notice.style.display='block'; setTimeout(()=>notice.style.display='none', time); }

    // helpers local
    function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LOCAL_KEY)) || {users:{},groups:{},chats:{}} }catch(e){return {users:{},groups:{},chats:{}} } }
    function saveLocal(d){ localStorage.setItem(LOCAL_KEY, JSON.stringify(d)); }
    function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
    function escapeHtml(s){ return String(s||'').replace(/[&<>\\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
    function timeStr(ts){ const d=new Date(ts); return d.toLocaleString(); }

    let currentUser = null; let activeChatUid = null; let activeGroupId = null;

    // firebase vars
    let app, auth, db;

    async function init(){
      if(useFirebase){
        try{
          const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
          const authMod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
          const dbMod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js');
          app = initializeApp(firebaseConfig);
          auth = authMod.getAuth(app);
          db = dbMod.getDatabase(app);
          setupFirebase(authMod, dbMod);
          console.log('Firebase ready');
        }catch(e){ console.error('Firebase init failed', e); showNotice('Firebase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º'); startLocal(); }
      }else{ startLocal(); }
    }

    // ---------------- Firebase implementation ----------------
    function setupFirebase(authMod, dbMod){
      const { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, onAuthStateChanged, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } = authMod;
      const { ref, set, push, onValue, get } = dbMod;

      btnRegister.onclick = async ()=>{
        const email = emailEl.value.trim(); const pass = passEl.value; const displayName = displayNameEl.value.trim()||email.split('@')[0];
        if(!email||!pass){ showNotice('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
        let avatarData = null; if(avatarInput.files && avatarInput.files[0]) avatarData = await fileToDataURL(avatarInput.files[0]);
        try{
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          try{ await updateProfile(cred.user, { displayName }); }catch(e){}
          await set(ref(db,'users/'+cred.user.uid), { uid:cred.user.uid, email, displayName, avatar:avatarData||null });
          showNotice('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –∏ –≤–æ—à–ª–∏');
        }catch(err){ console.error(err); if(err.code==='auth/email-already-in-use'){ try{ await signInWithEmailAndPassword(auth,email,pass); showNotice('Email —É–∂–µ –µ—Å—Ç—å ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥'); }catch(e){ showNotice('Email –∑–∞–Ω—è—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤—Ö–æ–¥'); } } else showNotice(err.message||'–û—à–∏–±–∫–∞'); }
      };

      btnLogin.onclick = async ()=>{
        const email = emailEl.value.trim(); const pass = passEl.value;
        if(!email||!pass){ showNotice('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
        try{ await signInWithEmailAndPassword(auth, email, pass); showNotice('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω'); }catch(err){ console.error(err); showNotice(err.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞'); }
      };

      btnReset.onclick = async ()=>{
        const email = prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞—Ä–æ–ª—è:'); if(!email) return; try{ await sendPasswordResetEmail(auth,email); alert('–ü–∏—Å—å–º–æ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); }catch(e){ alert('–û—à–∏–±–∫–∞: '+(e.message||e)); }
      };

      btnGoogle.onclick = async ()=>{
        try{
          const provider = new GoogleAuthProvider();
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          // create or update user record in DB
          const snap = await get(ref(db,'users/'+user.uid));
          const existing = snap.val();
          const avatar = (user.photoURL)?user.photoURL:null;
          const displayName = user.displayName || user.email.split('@')[0];
          await set(ref(db,'users/'+user.uid), { uid:user.uid, email:user.email, displayName, avatar });
          showNotice('–í—Ö–æ–¥ —á–µ—Ä–µ–∑ Google –≤—ã–ø–æ–ª–Ω–µ–Ω');
        }catch(e){ console.error(e); showNotice('–û—à–∏–±–∫–∞ Google-–≤—Ö–æ–¥–∞'); }
      };

      btnGuest.onclick = ()=>{ const g = { uid:uid(), email:'guest@local', displayName:'–ì–æ—Å—Ç—å_'+Math.random().toString(36).slice(2,6), avatar:null, guest:true }; currentUser=g; onLoginLocalLike(); showNotice('–í–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

      btnLogout.onclick = async ()=>{ try{ await signOut(auth); }catch(e){ console.log(e); currentUser=null; authPanel.style.display=''; userPanel.style.display='none'; usersList.innerHTML=''; messagesEl.innerHTML=''; } };

      onAuthStateChanged(auth, async user=>{
        if(user){ const snap = await get(ref(db,'users/'+user.uid)); const data = snap.val() || { uid:user.uid, email:user.email, displayName:user.displayName||user.email, avatar:user.photoURL||null }; currentUser = data; onLoginFirebase(); }
        else { currentUser=null; activeChatUid=null; activeGroupId=null; authPanel.style.display=''; userPanel.style.display='none'; usersList.innerHTML=''; messagesEl.innerHTML=''; }
      });

      async function onLoginFirebase(){ authPanel.style.display='none'; userPanel.style.display='block'; meName.textContent=currentUser.displayName; meEmail.textContent=currentUser.email; if(currentUser.avatar){ meAvatar.src=currentUser.avatar; meAvatar.style.display='inline-block'; } else meAvatar.style.display='none'; await set(ref(db,'users/'+currentUser.uid), currentUser); loadUsersFirebase(); loadMyGroups(); }

      async function loadUsersFirebase(){ const snap = await get(ref(db,'users')); const data = snap.val()||{}; renderUsers(Object.values(data)); }

      btnSearch.onclick = async ()=>{ const q=(searchInput.value||'').trim().toLowerCase(); if(!q){ loadUsersFirebase(); return; } const snap = await get(ref(db,'users')); const arr = Object.values(snap.val()||{}).filter(u=> (u.displayName||u.email||'').toLowerCase().includes(q)); renderUsers(arr); };

      function renderUsers(arr){ usersList.innerHTML=''; arr.sort((a,b)=>(a.displayName||'').localeCompare(b.displayName||'')); arr.forEach(u=>{ if(!u||u.uid===currentUser.uid) return; const el=document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.innerHTML = `${u.avatar?'<img src="'+u.avatar+'" class="avatar"/>':''}<div style="flex:1"><strong>${escapeHtml(u.displayName||u.email)}</strong><div class="small">${escapeHtml(u.email||'')}</div></div>`; el.onclick = ()=>{ modeSelect.value='pm'; groupsSelect.style.display='none'; openChatFirebase(u.uid,u.displayName||u.email); }; usersList.appendChild(el); }); }

      function makeChatId(a,b){ return [a,b].sort().join('_'); }

      function openChatFirebase(uid,name){ activeGroupId=null; activeChatUid=uid; chatTitle.textContent = name; chatSub.textContent = '–õ–∏—á–Ω—ã–π —á–∞—Ç'; messagesEl.innerHTML=''; const chatId = makeChatId(currentUser.uid,uid); const msgsRef = ref(db,'chats/'+chatId+'/messages'); onValue(msgsRef, snap=>{ const v = snap.val()||{}; messagesEl.innerHTML=''; Object.entries(v).forEach(([k,m])=>{ m._key = k; renderMsg(m); }); messagesEl.scrollTop = messagesEl.scrollHeight; }); }

      // groups
      btnCreateGroup.onclick = async ()=>{ const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:'); if(!name) return; const desc = prompt('–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):')||''; const groupId = uid(); const members = [currentUser.email]; await set(ref(db,'groups/'+groupId), { id:groupId, name, desc, owner:currentUser.uid, members }); showNotice('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞'); loadMyGroups(); }

      async function loadMyGroups(){ const snap = await get(ref(db,'groups')); const data = snap.val()||{}; const groups = Object.values(data).filter(g=> (g.members||[]).includes(currentUser.email)); groupsSelect.innerHTML=''; groupsSelect.style.display='inline-block'; groups.forEach(g=>{ const opt = document.createElement('option'); opt.value=g.id; opt.textContent = g.name; groupsSelect.appendChild(opt); }); if(groups.length===0){ groupsSelect.style.display='none'; }
      }

      btnMyGroups.onclick = ()=>{ loadMyGroups(); showNotice('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –≤–∞—à–∏ –≥—Ä—É–ø–ø—ã'); }

      groupsSelect.onchange = ()=>{ const id = groupsSelect.value; if(!id) return; openGroup(id); }

      async function openGroup(id){ activeChatUid=null; activeGroupId=id; const snap = await get(ref(db,'groups/'+id)); const g = snap.val(); chatTitle.textContent = g.name; chatSub.textContent = g.desc||('–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: '+(g.members||[]).length); messagesEl.innerHTML=''; const msgsRef = ref(db,'groups/'+id+'/messages'); onValue(msgsRef, snap=>{ const v = snap.val()||{}; messagesEl.innerHTML=''; Object.entries(v).forEach(([k,m])=>{ m._key = k; renderMsg(m); }); messagesEl.scrollTop = messagesEl.scrollHeight; }); }

      btnSend.onclick = async ()=>{ const text = msgInput.value.trim(); if(!text && !fileInput.files.length) return; if(!activeChatUid && !activeGroupId){ showNotice('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—É'); return; } const payload = { from: currentUser.uid, author: currentUser.displayName, email: currentUser.email, ts: Date.now(), text: text||'' };
        if(fileInput.files.length){ const data = await fileToDataURL(fileInput.files[0]); payload.file = { name:fileInput.files[0].name, type:fileInput.files[0].type, data }; }
        if(activeChatUid){ const chatId = makeChatId(currentUser.uid, activeChatUid); await push(ref(db,'chats/'+chatId+'/messages'), payload); }
        else if(activeGroupId){ await push(ref(db,'groups/'+activeGroupId+'/messages'), payload); }
        msgInput.value=''; fileInput.value=''; };

      function renderMsg(m){ const row = document.createElement('div'); const mine = (m && m.from)===currentUser.uid; row.className = 'msg-row '+(mine?'me':''); const avatarImg = document.createElement('img'); avatarImg.className='avatar'; avatarImg.style.display='none'; const bubble = document.createElement('div'); bubble.className='bubble'; if(m.file){ if(m.file.type && m.file.type.startsWith('image/')){ const img=document.createElement('img'); img.src = m.file.data; img.className='file-thumb'; bubble.appendChild(img); } else { const a=document.createElement('a'); a.href=m.file.data; a.download=m.file.name; a.textContent = '–°–∫–∞—á–∞—Ç—å: '+m.file.name; a.className='small'; bubble.appendChild(a); } }
        if(m.text) bubble.insertBefore(document.createTextNode(m.text), bubble.firstChild);
        const meta = document.createElement('div'); meta.className='meta'; meta.textContent = (m.author?m.author+' ‚Ä¢ ':'') + timeStr(m.ts);
        bubble.appendChild(meta);
        row.appendChild(avatarImg);
        row.appendChild(bubble);
        try{
  if(m._key) row.dataset.key = m._key;
  if(m._path) row.dataset.chatpath = m._path;
  row._meta = { from: m.from||null, id: m.id||null, key: m._key||null, chatPath: m._path||null };
}catch(e){ console.error('attach meta error', e); }

      // --- Reactions UI (Firebase, personal chats only) ---
      try{
        const chatId = (typeof activeGroupId !== 'undefined' && activeGroupId) ? null : (makeChatId(currentUser.uid, activeChatUid));
        // only enable reactions for personal chats (chatId truthy and activeChatUid set)
        if(chatId){
          const reactionsPanel = document.createElement('div');
          reactionsPanel.className = 'reactions-panel';
          reactionsPanel.style.position='absolute';
          reactionsPanel.style.bottom='100%';
          reactionsPanel.style.left='50%';
          reactionsPanel.style.transform='translateX(-50%)';
          reactionsPanel.style.display='none';
          reactionsPanel.style.padding='6px';
          reactionsPanel.style.borderRadius='18px';
          reactionsPanel.style.boxShadow='0 6px 20px rgba(0,0,0,.12)';
          reactionsPanel.style.background='#fff';
          reactionsPanel.style.zIndex=9999;
          ['‚ù§Ô∏è','üòÇ','üëç','üòÆ','üò¢','üëé'].forEach(em=>{
            const b=document.createElement('button');
            b.className='reaction-btn';
            b.style.fontSize='18px';
            b.style.border='none';
            b.style.background='transparent';
            b.style.cursor='pointer';
            b.textContent=em;
            b.onclick = async (ev)=>{
              ev.stopPropagation();
              if(!currentUser || !currentUser.uid) { alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∞–∫—Ü–∏–∏'); return; }
              const msgKey = m._key || row.dataset.key;
              if(!msgKey) { alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–∫–ª—é—á –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)'); return; }
              const rRef = ref(db,'chats/'+chatId+'/messages/'+msgKey+'/reactions/'+currentUser.uid);
              try{
                // read current reaction for this user and toggle
                const snap = await get(ref(db,'chats/'+chatId+'/messages/'+msgKey+'/reactions/'+currentUser.uid));
                const cur = snap.val();
                if(cur === em){
                  await update(ref(db,'chats/'+chatId+'/messages/'+msgKey+'/reactions/'+currentUser.uid), null);
                } else {
                  await set(ref(db,'chats/'+chatId+'/messages/'+msgKey+'/reactions/'+currentUser.uid), em);
                }
              }catch(e){ console.error('reaction write failed', e); }
            };
            reactionsPanel.appendChild(b);
          });
          row.appendChild(reactionsPanel);
          // double-tap / dblclick to toggle panel
          let lastTap = 0;
          bubble.addEventListener('touchend', (e)=>{ const now=Date.now(); if(now-lastTap<400){ e.preventDefault(); reactionsPanel.style.display = reactionsPanel.style.display==='none'?'flex':'none'; } lastTap=now; });
          bubble.addEventListener('dblclick', (e)=>{ e.preventDefault(); reactionsPanel.style.display = reactionsPanel.style.display==='none'?'flex':'none'; });
          // update summary below bubble
          const summaryDiv = document.createElement('div');
          summaryDiv.className='reaction-summary';
          summaryDiv.style.marginTop='6px';
          bubble.appendChild(summaryDiv);
          // subscribe to reaction counts
          const reactRef = ref(db,'chats/'+chatId+'/messages/'+(m._key||row.dataset.key)+'/reactions');
          onValue(reactRef, snap=>{ const data=snap.val()||{}; const counts={}; Object.values(data).forEach(v=>{ if(v) counts[v] = (counts[v]||0)+1; }); summaryDiv.textContent = Object.entries(counts).map(([e,c])=>e+' '+c).join(' '); });
        }
      }catch(e){ console.error('reactions attach error', e); }
      // --- end reactions ---
      messagesEl.appendChild(row);

        // try to load author's avatar
        if((m && m.from)){ get(ref(db,'users/'+(m && m.from))).then(snap=>{ const u=snap.val(); if(u && u.avatar){ avatarImg.src = u.avatar; avatarImg.style.display='block'; } else avatarImg.style.display='none'; }); }
      }

      btnRefresh.onclick = ()=>{ if(activeGroupId) openGroup(activeGroupId); else if(activeChatUid) openChatFirebase(activeChatUid, chatTitle.textContent); else loadUsersFirebase(); };

    }

    // ---------------- Local fallback (guest/demo) ----------------
    function startLocal(){
      const data = loadLocal();
      btnRegister.onclick = async ()=>{ const email = emailEl.value.trim(); const pass = passEl.value; const displayName=displayNameEl.value.trim()||email.split('@')[0]; if(!email||!pass){ showNotice('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; } if(Object.values(data.users).some(u=>u.email===email)){ showNotice('Email –∑–∞–Ω—è—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)'); return; } const id=uid(); let avatar=null; if(avatarInput.files && avatarInput.files[0]) avatar = await fileToDataURL(avatarInput.files[0]); const user={uid:id,email,displayName,avatar}; data.users[id]=user; saveLocal(data); currentUser=user; onLoginLocal(); showNotice('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ'); };
      btnLogin.onclick = ()=>{ const email=emailEl.value.trim(); const u=Object.values(data.users).find(x=>x.email===email); if(!u){ showNotice('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)'); return; } currentUser=u; onLoginLocal(); showNotice('–í—Ö–æ–¥ –ª–æ–∫–∞–ª—å–Ω–æ'); };
      btnGuest.onclick = ()=>{ const id=uid(); const user={uid:id,email:'guest@local',displayName:'–ì–æ—Å—Ç—å_'+id.slice(-4),avatar:null}; currentUser=user; onLoginLocal(); showNotice('–í–æ—à–ª–∏ –∫–∞–∫ –≥–æ—Å—Ç—å'); };
      btnReset.onclick = ()=>{ const email=prompt('–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–ª–æ–∫–∞–ª—å–Ω–æ):'); if(email) alert('–õ–æ–∫–∞–ª—å–Ω–æ: —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Å–∏–º—É–ª—è—Ü–∏—è) –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ'); };
      btnGoogle.onclick = ()=>{ alert('Google Sign-In –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ'); };
      btnLogout.onclick = ()=>{ currentUser=null; activeChatUid=null; activeGroupId=null; authPanel.style.display=''; userPanel.style.display='none'; usersList.innerHTML=''; messagesEl.innerHTML=''; };

      function onLoginLocal(){ authPanel.style.display='none'; userPanel.style.display='block'; meName.textContent=currentUser.displayName; meEmail.textContent=currentUser.email; if(currentUser.avatar){ meAvatar.src=currentUser.avatar; meAvatar.style.display='inline-block'; } else meAvatar.style.display='none'; renderUsersLocal(); renderGroupsLocal(); }

      function renderUsersLocal(filterArr){ usersList.innerHTML=''; const arr = filterArr || Object.values(data.users).sort((a,b)=>(a.displayName||'').localeCompare(b.displayName||'')); arr.forEach(u=>{ if(u.uid===currentUser.uid) return; const el=document.createElement('div'); el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center'; el.innerHTML = `${u.avatar?'<img src="'+u.avatar+'" class="avatar"/>':''}<div style="flex:1"><strong>${escapeHtml(u.displayName)}</strong><div class="small">${escapeHtml(u.email)}</div></div>`; el.onclick=()=>{ modeSelect.value='pm'; groupsSelect.style.display='none'; openChatLocal(u.uid,u.displayName); }; usersList.appendChild(el); }); }

      function renderGroupsLocal(){ const gs = Object.values(data.groups||{}).filter(g=> (g.members||[]).includes(currentUser.email)); groupsSelect.innerHTML=''; gs.forEach(g=>{ const opt=document.createElement('option'); opt.value=g.id; opt.textContent=g.name; groupsSelect.appendChild(opt); }); if(gs.length) groupsSelect.style.display='inline-block'; }

      btnSearch.onclick = ()=>{ const q=(searchInput.value||'').trim().toLowerCase(); if(!q){ renderUsersLocal(); return; } const arr = Object.values(data.users).filter(u=> (u.displayName||u.email||'').toLowerCase().includes(q)); renderUsersLocal(arr); };

      btnCreateGroup.onclick = ()=>{ const name=prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã'); if(!name) return; const id=uid(); const desc=prompt('–û–ø–∏—Å–∞–Ω–∏–µ')||''; data.groups[id]={ id, name, desc, owner:currentUser.uid, members:[currentUser.email] }; saveLocal(data); renderGroupsLocal(); showNotice('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

      btnMyGroups.onclick = ()=>{ renderGroupsLocal(); showNotice('–í–∞—à–∏ –≥—Ä—É–ø–ø—ã (–ª–æ–∫–∞–ª—å–Ω–æ)'); };

      function makeChatId(a,b){ return [a,b].sort().join('_'); }
      function openChatLocal(uid,name){ activeGroupId=null; activeChatUid=uid; messagesEl.innerHTML=''; const chatId=makeChatId(currentUser.uid,uid); const msgs = data.chats[chatId]||[]; msgs.forEach(m=>renderMsgLocal(m)); chatTitle.textContent=name; chatSub.textContent='–õ–∏—á–Ω—ã–π —á–∞—Ç (–ª–æ–∫–∞–ª—å–Ω–æ)'; }

      function openGroupLocal(id){ activeChatUid=null; activeGroupId=id; messagesEl.innerHTML=''; const g = data.groups[id]; const msgs = g.messages||[]; msgs.forEach(m=>renderMsgLocal(m)); chatTitle.textContent=g.name; chatSub.textContent=g.desc||('–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: '+(g.members||[]).length); }

      btnSend.onclick = async ()=>{ const text = msgInput.value.trim(); if(!text && !fileInput.files.length) return; if(!activeChatUid && !activeGroupId){ showNotice('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –≥—Ä—É–ø–ø—É'); return; } const m = { id:Date.now()+Math.random(), from:currentUser.uid, author:currentUser.displayName, email:currentUser.email, ts:Date.now(), text:text||'' };
        if(fileInput.files.length){ const d = await fileToDataURL(fileInput.files[0]); m.file={ name:fileInput.files[0].name, type:fileInput.files[0].type, data:d }; }
        if(activeChatUid){ const chatId=makeChatId(currentUser.uid,activeChatUid); data.chats[chatId]=data.chats[chatId]||[]; data.chats[chatId].push(m); saveLocal(data); renderMsgLocal(m); }
        else { const g = data.groups[activeGroupId]; g.messages = g.messages||[]; g.messages.push(m); saveLocal(data); renderMsgLocal(m); }
        msgInput.value=''; fileInput.value=''; };

      function renderMsgLocal(m){ const row=document.createElement('div'); row.className=((m && m.from)===currentUser.uid?'msg-row me':'msg-row'); const avatarImg=document.createElement('img'); avatarImg.className='avatar'; avatarImg.style.display='none'; const bubble=document.createElement('div'); bubble.className='bubble'; if(m.file){ if(m.file.type && m.file.type.startsWith('image/')){ const img=document.createElement('img'); img.src=m.file.data; img.className='file-thumb'; bubble.appendChild(img); } else { const a=document.createElement('a'); a.href=m.file.data; a.download=m.file.name; a.textContent='–°–∫–∞—á–∞—Ç—å: '+m.file.name; a.className='small'; bubble.appendChild(a); } }
        if(m.text) bubble.insertBefore(document.createTextNode(m.text), bubble.firstChild);
        const meta=document.createElement('div'); meta.className='meta'; meta.textContent=(m.author?m.author+' ‚Ä¢ ':'')+timeStr(m.ts); bubble.appendChild(meta);
        row.appendChild(avatarImg); row.appendChild(bubble); try{
  if(m._key) row.dataset.key = m._key;
  if(m._path) row.dataset.chatpath = m._path;
  row._meta = { from: m.from||null, id: m.id||null, key: m._key||null, chatPath: m._path||null };
}catch(e){ console.error('attach meta error', e); }
messagesEl.appendChild(row); const u = Object.values(loadLocal().users||{}).find(x=>x.uid===(m && m.from)); if(u && u.avatar){ avatarImg.src=u.avatar; avatarImg.style.display='block'; } }

      renderUsersLocal(); renderGroupsLocal();
    }

    // helper: convert file to data URL
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const reader=new FileReader(); reader.onload=()=>res(reader.result); reader.onerror=rej; reader.readAsDataURL(file); }); }

    // start
    init();
  </script>

  <audio id="remoteAudio" autoplay></audio>




  <!-- Logs UI -->
  <button id="showLogsBtn" style="position:fixed;right:12px;bottom:12px;z-index:2000;background:#111;color:#fff;border-radius:8px;padding:8px 10px;border:none;box-shadow:0 6px 18px rgba(0,0,0,.12)">ü™µ –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏</button>
  <div id="logConsole" style="position:fixed;right:12px;bottom:56px;left:12px;max-height:40%;background:#000;color:#0f0;font-family:monospace;font-size:12px;padding:8px;overflow:auto;border-radius:8px;display:none;z-index:1999"></div>
  <script>
  (function(){
    const btn = document.getElementById('showLogsBtn');
    const pane = document.getElementById('logConsole');
    if(!btn || !pane) return;
    let visible = false;
    btn.addEventListener('click', ()=>{ visible = !visible; pane.style.display = visible ? 'block' : 'none'; btn.textContent = visible ? 'ü™µ –°–∫—Ä—ã—Ç—å –ª–æ–≥–∏' : 'ü™µ –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏'; });
    // capture console
    const origLog = console.log.bind(console);
    const origErr = console.error.bind(console);
    const origWarn = console.warn.bind(console);
    function appendLine(msg, cls){
      const div = document.createElement('div');
      if(cls) div.style.color = cls;
      div.textContent = (new Date()).toLocaleTimeString() + ' ‚Äî ' + msg;
      pane.appendChild(div);
      pane.scrollTop = pane.scrollHeight;
    }
    console.log = function(...args){ try{ origLog(...args); appendLine(args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' ')); }catch(e){ origLog('log-err',e); } };
    console.error = function(...args){ try{ origErr(...args); appendLine(args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '), 'red'); }catch(e){ origErr('error-err',e); } };
    console.warn = function(...args){ try{ origWarn(...args); appendLine(args.map(a=>typeof a==='object'?JSON.stringify(a):String(a)).join(' '), 'orange'); }catch(e){ origWarn('warn-err',e); } };
    // also capture uncaught errors
    window.addEventListener('error', function(ev){ appendLine('Uncaught error: '+ev.message+' ('+ev.filename+':'+ev.lineno+')', 'red'); });
    window.addEventListener('unhandledrejection', function(ev){ appendLine('Unhandled rejection: '+(ev.reason && ev.reason.message?ev.reason.message:JSON.stringify(ev.reason)), 'red'); });
    // initial message
    console.log('[log] Console capture started');
  })();
  </script>

<script>

// ===== Enhanced features: notifications, mentions, delete, block, edit profile, unread badges =====
async function ensureServiceWorker(){
  if('serviceWorker' in navigator){
    try{
      const reg = await navigator.serviceWorker.register('/sw_klass_messenger.js', {scope: '/'});
      console.log('Service Worker registered', reg);
      return reg;
    }catch(e){ console.error('SW reg failed', e); }
  }
  return null;
}
let swRegistration = null;
(async ()=>{ swRegistration = await ensureServiceWorker(); })();

async function ensureNotifications(){
  if(!('Notification' in window)) return false;
  if(Notification.permission === 'granted') return true;
  if(Notification.permission !== 'denied'){
    const p = await Notification.requestPermission();
    return p === 'granted';
  }
  return false;
}

function renderTextWithMentions(text){
  const frag = document.createDocumentFragment();
  const parts = text.split(/(@\S+)/g);
  parts.forEach(p=>{
    if(p.startsWith('@')){
      const span = document.createElement('span'); span.className='mention'; span.textContent=p;
      frag.appendChild(span);
    } else {
      frag.appendChild(document.createTextNode(p));
    }
  });
  return frag;
}

function enhanceMessageRow(row, m){
  try{
    const actions = document.createElement('div'); actions.className='msg-actions';
    const delBtn = document.createElement('button'); delBtn.title='–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'; delBtn.innerHTML='üóëÔ∏è';
    delBtn.onclick = async (e)=>{
      e.stopPropagation();
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) return;
      if(useFirebase && window.db){
        if(m.key && (m && m.chatPath)){
          try{
            await db.ref((m && m.chatPath) + '/'+ m.key + '/deleted').set(true);
            await db.ref((m && m.chatPath) + '/'+ m.key + '/text').set('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
          }catch(err){ console.error('Delete failed', err); }
        } else {
          row.querySelector('.bubble').textContent = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
        }
      } else {
        if(m && m.id){
          const d = loadLocal();
          for(const k of Object.keys(d.chats||{})){
            d.chats[k]=d.chats[k].map(msg=> msg.id===m.id ? {...msg, deleted:true, text:'–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'} : msg );
          }
          for(const gid of Object.keys(d.groups||{})){
            const g = d.groups[gid];
            if(g && g.messages) g.messages = g.messages.map(msg=> msg.id===m.id ? {...msg, deleted:true, text:'–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'} : msg);
          }
          saveLocal(d);
          row.querySelector('.bubble').textContent = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
        }
      }
    };
    const blockBtn = document.createElement('button'); blockBtn.title='–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'; blockBtn.innerHTML='üö´';
    blockBtn.onclick = async (e)=>{
      e.stopPropagation();
      if(!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è? –í—ã –Ω–µ –±—É–¥–µ—Ç–µ –≤–∏–¥–µ—Ç—å –µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –æ–Ω –Ω–µ —Å–º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å –≤–∞–º.')) return;
      const uidToBlock = (m && m.from);
      if(!currentUser || !currentUser.uid){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è –≤–æ—à–µ–¥—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'); return; }
      if(useFirebase && window.db){
        try{
          const userRef = db.ref('users/'+currentUser.uid+'/blocked');
          const snap = await userRef.once('value');
          const arr = snap.val() || [];
          if(arr.indexOf(uidToBlock)===-1) arr.push(uidToBlock);
          await userRef.set(arr);
          showNotice('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
        }catch(e){ console.error(e); }
      } else {
        const d = loadLocal();
        d.users = d.users||{};
        d.users[currentUser.uid] = d.users[currentUser.uid] || {};
        d.users[currentUser.uid].blocked = d.users[currentUser.uid].blocked || [];
        if(d.users[currentUser.uid].blocked.indexOf(uidToBlock)===-1) d.users[currentUser.uid].blocked.push(uidToBlock);
        saveLocal(d);
        showNotice('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
      }
      row.style.display='none';
    };
    actions.appendChild(delBtn); actions.appendChild(blockBtn);
    row.appendChild(actions);
  }catch(e){ console.error('enhanceMessageRow error', e); }
}

(function addProfileEditUI(){
  const panel = document.getElementById('user-panel');
  if(!panel) return;
  const container = document.createElement('div');
  container.className='user-controls';
  const nameInp = document.createElement('input'); nameInp.id='editDisplayName'; nameInp.placeholder='–ù–æ–≤–æ–µ –∏–º—è';
  const avatarInp = document.createElement('input'); avatarInp.type='file'; avatarInp.id='editAvatarInput'; avatarInp.accept='image/*';
  const saveBtn = document.createElement('button'); saveBtn.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
  saveBtn.onclick = async ()=>{
  // –∂–¥—ë–º, –ø–æ–∫–∞ currentUser —Ç–æ—á–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
  if(!window.currentUser){
    await new Promise(r => setTimeout(r, 500));
  }
  if(!window.currentUser || !window.currentUser.uid){
    alert('–í—ã –¥–æ–ª–∂–Ω—ã –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º –ø—Ä–æ—Ñ–∏–ª—è.');
    return;
  }

  const newName = document.getElementById('editDisplayName').value.trim();
  const file = document.getElementById('editAvatarInput').files[0];
  let avatarData = null;
  if(file) avatarData = await fileToDataURL(file);

  try{
    if(useFirebase && window.db){
      const refPath = 'users/' + window.currentUser.uid;
      await db.ref(refPath).update({
        displayName: newName || window.currentUser.displayName,
        avatar: avatarData || window.currentUser.avatar
      });
      window.currentUser.displayName = newName || window.currentUser.displayName;
      if(avatarData) window.currentUser.avatar = avatarData;
      meName.textContent = window.currentUser.displayName;
      if(window.currentUser.avatar){ meAvatar.src = window.currentUser.avatar; meAvatar.style.display='inline-block'; }
      showNotice('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
    } else {
      const d = loadLocal();
      d.users[window.currentUser.uid] = d.users[window.currentUser.uid] || {};
      d.users[window.currentUser.uid].displayName = newName || window.currentUser.displayName;
      if(avatarData) d.users[window.currentUser.uid].avatar = avatarData;
      saveLocal(d);
      window.currentUser.displayName = newName || window.currentUser.displayName;
      if(avatarData) window.currentUser.avatar = avatarData;
      meName.textContent = window.currentUser.displayName;
      if(window.currentUser.avatar){ meAvatar.src = window.currentUser.avatar; meAvatar.style.display='inline-block'; }
      showNotice('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
    }
  }catch(e){
    console.error(e);
    showNotice('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è');
  }
};
  const unblockBtn = document.createElement('button'); unblockBtn.textContent='–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'; unblockBtn.onclick = async ()=>{
    if(!currentUser) return alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
    if(useFirebase && window.db){
      const uidTo = prompt('–í–≤–µ–¥–∏—Ç–µ UID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:');
      if(!uidTo) return;
      try{
        const userRef = db.ref('users/'+currentUser.uid+'/blocked');
        const snap = await userRef.once('value');
        const arr = snap.val() || [];
        const newArr = arr.filter(x=>x!==uidTo);
        await userRef.set(newArr);
        showNotice('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
      }catch(e){ console.error(e); showNotice('–û—à–∏–±–∫–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏'); }
    } else {
      const d = loadLocal();
      const uidTo = prompt('UID –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏:');
      if(d.users[currentUser.uid] && d.users[currentUser.uid].blocked) d.users[currentUser.uid].blocked = d.users[currentUser.uid].blocked.filter(x=>x!==uidTo);
      saveLocal(d);
      showNotice('–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (–ª–æ–∫–∞–ª—å–Ω–æ)');
    }
  };
  container.appendChild(nameInp); container.appendChild(avatarInp); container.appendChild(saveBtn); container.appendChild(unblockBtn);
  panel.appendChild(container);
})();

function notifyIncoming(m, chatTitleText){
  (async ()=>{
    const ok = await ensureNotifications();
    const title = chatTitleText || '–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ';
    let body = (m.author?m.author+': ':'') + (m.text || (m.file && m.file.name) || '');
    try{
      if(swRegistration && swRegistration.showNotification){
        swRegistration.showNotification(title, { body, tag: 'klass-msg-'+(m.chatId||'') });
        return;
      }
    }catch(e){ console.error('sw showNotification', e); }
    if(ok) new Notification(title, { body });
  })();
}

// small users list postprocessor to add badge placeholders
function postProcessUsersList(){
  const list = document.getElementById('usersList');
  if(!list) return;
  Array.from(list.children).forEach(el=>{
    if(!el.getAttribute('data-email')){
      const emailEl = el.querySelector('.small');
      let email = emailEl ? emailEl.textContent.trim() : null;
      if(email) el.setAttribute('data-email', email);
    }
    let b = el.querySelector('.badge');
    if(!b){ b = document.createElement('span'); b.className='badge'; b.style.display='none'; el.querySelector('div').appendChild(b); }
  });
}
setInterval(postProcessUsersList, 1200);

</script>

<!-- Action popup markup -->
<div id="actionPopupBackdrop" class="action-popup-backdrop" aria-hidden="true">
  <div id="actionPopup" class="action-popup" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="optDelete" class="opt danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div id="optBlock" class="opt block">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>
    <div id="optCancel" class="opt cancel">‚ùå –û—Ç–º–µ–Ω–∞</div>
  </div>
</div>

<script>

// Double-tap / double-click -> show action popup (delete / block)
// Using both dblclick and touch double-tap detection for mobile
(function(){
  const backdrop = document.getElementById('actionPopupBackdrop');
  const popup = document.getElementById('actionPopup');
  const optDelete = document.getElementById('optDelete');
  const optBlock = document.getElementById('optBlock');
  const optCancel = document.getElementById('optCancel');
  let currentRow = null;
  // touch double-tap detection
  let lastTap = 0;
  function onTouchTarget(e){
    const now = Date.now();
    const diff = now - lastTap;
    lastTap = now;
    if(diff > 0 && diff < 400){ // double tap detected
      e.preventDefault();
      const row = findMsgRowFromEvent(e.target);
      if(row) showPopupForRow(row);
    }
  }
  function onDblClick(e){
    const row = findMsgRowFromEvent(e.target);
    if(row) showPopupForRow(row);
  }
  function findMsgRowFromEvent(target){
    let el = target;
    while(el && el !== document.body){
      if(el.classList && el.classList.contains('msg-row')) return el;
      el = el.parentNode;
    }
    return null;
  }
  function showPopupForRow(row){
    currentRow = row;
    backdrop.style.display = 'flex';
    setTimeout(()=>{ popup.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); popup.setAttribute('aria-hidden','false'); }, 20);
  }
  function hidePopup(){
    popup.classList.// soft delete: skip remove;
    backdrop.setAttribute('aria-hidden','true');
    popup.setAttribute('aria-hidden','true');
    setTimeout(()=>{ backdrop.style.display = 'none'; currentRow = null; }, 300);
  }
  // attach handlers globally (capture events to detect taps on dynamic elements)
  document.addEventListener('dblclick', onDblClick, true);
  document.addEventListener('touchend', onTouchTarget, true);

  // Option handlers: try to find existing icon buttons and click them; fallback to simple actions
  async function triggerDelete(row){
    // try to find button with title '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ' inside row
    const btn = row.querySelector('button[title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"]') || row.querySelector('button[title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"]');
    if(btn){ btn.click(); return; }
    // fallback: mark bubble text as deleted and attempt firebase update if metadata present
    try{
      const bubble = row.querySelector('.bubble');
      if(bubble){ bubble.textContent = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ'; }
      const meta = row._meta || {};
      if(window.db && meta && meta.key && meta.chatPath){
        await db.ref(meta.chatPath + '/'+ meta.key + '/deleted').set(true);
        await db.ref(meta.chatPath + '/'+ meta.key + '/text').set('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
      }
    }catch(e){ console.error('Fallback delete failed', e); }
  }
  async function triggerBlock(row){
    const meta = row._meta || {};
    const uidToBlock = meta.from || null;
    // try to find block button
    const btn = row.querySelector('button[title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"]') || row.querySelector('button[title="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"]');
    if(btn){ btn.click(); return; }
    if(!uidToBlock){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏'); return; }
    if(!window.currentUser || !window.currentUser.uid){ alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'); return; }
    try{
      if(window.db){
        const userRef = db.ref('users/'+window.currentUser.uid+'/blocked');
        const snap = await userRef.once('value');
        const arr = snap.val() || [];
        if(arr.indexOf(uidToBlock)===-1) arr.push(uidToBlock);
        await userRef.set(arr);
        showNotice('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
      } else {
        const d = loadLocal();
        d.users = d.users || {};
        d.users[window.currentUser.uid] = d.users[window.currentUser.uid] || {};
        d.users[window.currentUser.uid].blocked = d.users[window.currentUser.uid].blocked || [];
        if(d.users[window.currentUser.uid].blocked.indexOf(uidToBlock)===-1) d.users[window.currentUser.uid].blocked.push(uidToBlock);
        saveLocal(d);
        showNotice('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
      }
      // hide row
      row.style.display = 'none';
    }catch(e){ console.error('Block failed', e); showNotice('–û—à–∏–±–∫–∞ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ'); }
  }

  optDelete.addEventListener('click', async ()=>{ if(!currentRow) return hidePopup(); if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')){ hidePopup(); return; } await triggerDelete(currentRow); hidePopup(); });
  optBlock.addEventListener('click', async ()=>{ if(!currentRow) return hidePopup(); if(!confirm('–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')){ hidePopup(); return; } await triggerBlock(currentRow); hidePopup(); });
  optCancel.addEventListener('click', ()=>{ hidePopup(); });

  // close when tapping outside popup
  backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) hidePopup(); });

  // Utility: ensure service worker is registered on load (if not yet)
  window.addEventListener('load', async ()=>{
    try{
      if('serviceWorker' in navigator){
        await navigator.serviceWorker.register('/sw_klass_messenger.js', {scope: '/'}).then(reg=>console.log('SW registered for popup helper', reg)).catch(()=>{});
      }
    }catch(e){ console.error(e); }
  });
})();

</script>
<script>

// Helper: find a button by emoji or title text inside a row (safe, no :contains)
function findButtonInRowByHint(row, hints){
  if(!row) return null;
  const buttons = Array.from(row.querySelectorAll('button'));
  for(const b of buttons){
    const txt = (b.textContent||'').trim();
    const title = (b.title||'').trim();
    for(const h of hints){
      if(txt.includes(h) || title.includes(h)) return b;
    }
  }
  return null;
}

</script>

<!-- Groups & Profile Modals -->
<div id="groupsModalBackdrop" style="display:none; position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.4);z-index:3100;align-items:center;justify-content:center;">
  <div style="background:#fff;padding:14px;border-radius:10px;max-width:420px;margin:16px;">
    <h3 style="margin:0 0 8px 0">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
    <input id="newGroupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã" style="width:100%;padding:8px;margin-bottom:8px"/>
    <select id="newGroupType" style="width:100%;padding:8px;margin-bottom:8px">
      <option value="private">–ü—Ä–∏–≤–∞—Ç–Ω–∞—è (–ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é)</option>
      <option value="public">–ü—É–±–ª–∏—á–Ω–∞—è (–≤—Å–µ –≤–∏–¥—è—Ç)</option>
    </select>
    <label style="display:block;margin-bottom:8px">–ê–≤–∞—Ç–∞—Ä: <input type="file" id="newGroupAvatar" accept="image/*"/></label>
    <input id="newGroupMembers" placeholder="UID –∏–ª–∏ email —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é" style="width:100%;padding:8px;margin-bottom:8px"/>
    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button id="cancelCreateGroup">–û—Ç–º–µ–Ω–∞</button>
      <button id="confirmCreateGroup" style="background:#2563eb;color:#fff">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- Profile popup -->
<div id="profileBackdrop" style="display:none; position:fixed;left:0;right:0;top:0;bottom:0;background:rgba(0,0,0,0.4);z-index:3200;align-items:center;justify-content:center;">
  <div id="profileCard" style="background:#fff;padding:14px;border-radius:10px;max-width:420px;margin:16px;">
    <div style="display:flex;gap:12px;align-items:center">
      <img id="profileAvatar" src="" style="width:64px;height:64px;border-radius:8px;object-fit:cover;display:none"/>
      <div>
        <strong id="profileName"></strong>
        <div class="small" id="profileEmail"></div>
        <div class="small" id="profileUid"></div>
      </div>
    </div>
    <div style="margin-top:10px" id="profileControls"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button id="closeProfile">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<script>

// Groups and profile UI wiring
(function(){
  function showCreateGroupModal(){ document.getElementById('groupsModalBackdrop').style.display='flex'; }
  function hideCreateGroupModal(){ document.getElementById('groupsModalBackdrop').style.display='none'; }

  function showProfile(user){
    if(!user) return;
    const bd = document.getElementById('profileBackdrop');
    document.getElementById('profileName').textContent = user.displayName || user.email || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    document.getElementById('profileEmail').textContent = user.email || '';
    document.getElementById('profileUid').textContent = 'UID: ' + (user.uid || '');
    const ava = document.getElementById('profileAvatar');
    if(user.avatar){ ava.src = user.avatar; ava.style.display='block'; } else ava.style.display='none';
    const controls = document.getElementById('profileControls');
    controls.innerHTML = '';
    // If this is current user, show edit controls
    if(window.currentUser && user.uid === window.currentUser.uid){
      const nameInp = document.createElement('input'); nameInp.placeholder='–ù–æ–≤–æ–µ –∏–º—è'; nameInp.style.width='100%';
      const avatarInp = document.createElement('input'); avatarInp.type='file'; avatarInp.accept='image/*';
      const saveBtn = document.createElement('button'); saveBtn.textContent='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
      saveBtn.onclick = async ()=>{
        const newName = nameInp.value.trim();
        const file = avatarInp.files[0];
        let avatarData = null;
        if(file) avatarData = await fileToDataURL(file);
        if(window.db && window.currentUser){
          try{
            await db.ref('users/'+window.currentUser.uid).update({ displayName: newName || window.currentUser.displayName, avatar: avatarData || window.currentUser.avatar });
            window.currentUser.displayName = newName || window.currentUser.displayName;
            if(avatarData) window.currentUser.avatar = avatarData;
            meName.textContent = window.currentUser.displayName;
            if(window.currentUser.avatar){ meAvatar.src = window.currentUser.avatar; meAvatar.style.display='inline-block'; }
            showNotice('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω');
          }catch(e){ console.error(e); showNotice('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è'); }
        } else {
          const d = loadLocal();
          d.users = d.users || {};
          d.users[window.currentUser.uid] = d.users[window.currentUser.uid] || {};
          d.users[window.currentUser.uid].displayName = newName || window.currentUser.displayName;
          if(avatarData) d.users[window.currentUser.uid].avatar = avatarData;
          saveLocal(d);
          window.currentUser.displayName = newName || window.currentUser.displayName;
          if(avatarData) window.currentUser.avatar = avatarData;
          meName.textContent = window.currentUser.displayName;
          if(window.currentUser.avatar){ meAvatar.src = window.currentUser.avatar; meAvatar.style.display='inline-block'; }
          showNotice('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)');
        }
      };
      controls.appendChild(nameInp); controls.appendChild(avatarInp); controls.appendChild(saveBtn);
    } else {
      // show actions: write message, block/unblock
      const msgBtn = document.createElement('button'); msgBtn.textContent='–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ';
      msgBtn.onclick = ()=>{ if(user.uid) { modeSelect.value='pm'; groupsSelect.style.display='none'; openChatFirebase && openChatFirebase(user.uid, user.displayName||user.email); openChatLocal && openChatLocal(user.uid,user.displayName||user.email); hideProfile(); } };
      const blockBtn = document.createElement('button'); blockBtn.textContent='–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å / –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
      blockBtn.onclick = async ()=>{
        if(!window.currentUser || !window.currentUser.uid) return alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏');
        if(window.db){
          const refBlocked = db.ref('users/'+window.currentUser.uid+'/blocked');
          const snap = await refBlocked.once('value');
          let arr = snap.val() || [];
          if(!arr) arr = [];
          if(arr.indexOf(user.uid)===-1) arr.push(user.uid); else arr = arr.filter(x=>x!==user.uid);
          await refBlocked.set(arr);
          showNotice('–û–±–Ω–æ–≤–ª—ë–Ω —Å–ø–∏—Å–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫');
        } else {
          const d = loadLocal();
          d.users = d.users || {};
          d.users[window.currentUser.uid] = d.users[window.currentUser.uid] || {};
          d.users[window.currentUser.uid].blocked = d.users[window.currentUser.uid].blocked || [];
          const b = d.users[window.currentUser.uid].blocked;
          if(b.indexOf(user.uid)===-1) b.push(user.uid); else d.users[window.currentUser.uid].blocked = b.filter(x=>x!==user.uid);
          saveLocal(d);
          showNotice('–û–±–Ω–æ–≤–ª—ë–Ω —Å–ø–∏—Å–æ–∫ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ (–ª–æ–∫–∞–ª—å–Ω–æ)');
        }
      };
      controls.appendChild(msgBtn); controls.appendChild(blockBtn);
    }
    bd.style.display='flex';
  }
  function hideProfile(){ document.getElementById('profileBackdrop').style.display='none'; }

  document.getElementById('cancelCreateGroup').onclick = hideCreateGroupModal;
  document.getElementById('confirmCreateGroup').onclick = async function(){
    const name = document.getElementById('newGroupName').value.trim();
    const type = document.getElementById('newGroupType').value;
    const avatarFile = document.getElementById('newGroupAvatar').files[0];
    const membersRaw = document.getElementById('newGroupMembers').value.trim();
    if(!name){ alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
    let avatarData = null;
    if(avatarFile) avatarData = await fileToDataURL(avatarFile);
    const members = {};
    if(membersRaw){
      membersRaw.split(',').map(x=>x.trim()).forEach(id=>{
        if(!id) return;
        members[id]=true;
      });
    }
    if(window.currentUser && window.currentUser.uid) members[window.currentUser.uid]=true;
    const gid = 'g'+Math.random().toString(36).slice(2,9);
    const groupObj = { id: gid, name, type, avatar: avatarData, members };
    if(window.db){
      await db.ref('groups/'+gid).set(groupObj);
      showNotice('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞');
      hideCreateGroupModal();
      renderGroupsInSidebar();
    } else {
      const d = loadLocal();
      d.groups = d.groups || {};
      d.groups[gid]=groupObj;
      saveLocal(d);
      showNotice('–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)');
      hideCreateGroupModal();
      renderGroupsInSidebar();
    }
  };

  document.getElementById('closeProfile').onclick = hideProfile;
  // close on backdrop click
  document.getElementById('profileBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='profileBackdrop') hideProfile(); });

  // render groups into usersList (as top section)
  async function renderGroupsInSidebar(){
    const list = document.getElementById('usersList');
    if(!list) return;
    // remove existing groups section
    const existing = document.getElementById('groupsHeader');
    if(existing) existing.// soft delete: skip remove;
    const header = document.createElement('div'); header.id='groupsHeader';
    header.style.padding='8px';
    header.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center"><strong>–ì—Ä—É–ø–ø—ã</strong><button id="btnCreateGroupSidebar" title="–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É">‚ûï</button></div><div id="groupsList" style="margin-top:8px"></div>';
    list.parentNode.insertBefore(header, list);
    document.getElementById('btnCreateGroupSidebar').onclick = showCreateGroupModal;

    // load groups
    if(window.db){
      const snap = await db.ref('groups').once('value');
      const data = snap.val() || {};
      const arr = Object.values(data).filter(g=> g && g.members && g.members[window.currentUser && window.currentUser.uid]);
      const gl = document.getElementById('groupsList');
      gl.innerHTML = '';
      arr.forEach(g=>{
        const el = document.createElement('div');
        el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center';
        el.innerHTML = (g.avatar?'<img src="'+g.avatar+'" class="avatar" style="width:36px;height:36px;border-radius:6px;object-fit:cover"/>':'<div class="avatar" style="width:36px;height:36px;border-radius:6px;background:#eee;display:inline-block"></div>') + '<div style="flex:1"><strong>'+escapeHtml(g.name)+'</strong><div class="small">'+(g.type||'')+'</div></div>';
        el.onclick = ()=>{ modeSelect.value='group'; groupsSelect.style.display='none'; openGroup && openGroup(g.id); };
        gl.appendChild(el);
      });
    } else {
      const d = loadLocal();
      const arr = Object.values(d.groups||{}).filter(g=> g && g.members && g.members[window.currentUser && window.currentUser.uid]);
      const gl = document.getElementById('groupsList');
      gl.innerHTML = '';
      arr.forEach(g=>{
        const el = document.createElement('div');
        el.style.padding='8px'; el.style.borderBottom='1px solid #f0f0f0'; el.style.display='flex'; el.style.gap='8px'; el.style.alignItems='center';
        el.innerHTML = (g.avatar?'<img src="'+g.avatar+'" class="avatar" style="width:36px;height:36px;border-radius:6px;object-fit:cover"/>':'<div class="avatar" style="width:36px;height:36px;border-radius:6px;background:#eee;display:inline-block"></div>') + '<div style="flex:1"><strong>'+escapeHtml(g.name)+'</strong><div class="small">'+(g.type||'')+'</div></div>';
        el.onclick = ()=>{ modeSelect.value='group'; groupsSelect.style.display='none'; openGroupLocal && openGroupLocal(g.id); };
        gl.appendChild(el);
      });
    }
  }

  // attach click on user list entries to open profile
  function attachProfileToUsers(){
    const list = document.getElementById('usersList');
    if(!list) return;
    Array.from(list.children).forEach(child=>{
      // avoid modifying entries we already processed
      if(child.dataset.profileAttached) return;
      child.dataset.profileAttached = '1';
      // keep existing onclick if present (so chat opening stays)
      // add a small info button to open profile without interfering with chat click
      const infoBtn = document.createElement('button');
      infoBtn.type = 'button';
      infoBtn.title = '–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
      infoBtn.style.marginLeft = '8px';
      infoBtn.style.border = 'none';
      infoBtn.style.background = 'transparent';
      infoBtn.style.cursor = 'pointer';
      infoBtn.textContent = '‚ÑπÔ∏è';
      infoBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const small = child.querySelector('.small');
        const email = small ? small.textContent.trim() : null;
        try{
          if(window._loadedUsers){
            const u = Object.values(window._loadedUsers).find(x=> (x.email||'') === email);
            if(u){ showProfile(u); return; }
          }
          if(typeof db !== 'undefined' && db && db.ref){
            db.ref('users').orderByChild('email').equalTo(email).once('value').then(snap=>{
              const val = snap.val();
              if(val){ const u = Object.values(val)[0]; showProfile(u); }
            }).catch(()=>{});
            return;
          }
        }catch(err){ console.error('profile open error', err); }
        const d = loadLocal();
        const u = Object.values(d.users||{}).find(x=> (x.email||'') === email);
        if(u) showProfile(u);
      });
      // append info button to the user's inner div (not to whole child)
      const innerDiv = child.querySelector('div');
      if(innerDiv) innerDiv.appendChild(infoBtn);
    });
  }

  // re-run periodically to catch dynamic list updates
  setInterval(()=>{ try{ attachProfileToUsers(); }catch(e){} }, 2500);


  // Make popup swipe-to-close for action popup (touch)
  (function enableSwipeClose(){
    const backdrop = document.getElementById('actionPopupBackdrop');
    const popup = document.getElementById('actionPopup');
    if(!backdrop || !popup) return;
    let startY = null;
    let currentY = null;
    let dragging = false;
    popup.addEventListener('touchstart', e=>{
      startY = e.touches[0].clientY;
      dragging = true;
      popup.style.transition = 'none';
    });
    popup.addEventListener('touchmove', e=>{
      if(!dragging) return;
      currentY = e.touches[0].clientY;
      const diff = currentY - startY;
      if(diff>0){
        popup.style.transform = 'translateY('+diff+'px)';
        backdrop.style.background = 'rgba(0,0,0,'+Math.max(0.1, 0.4 - diff/800)+')';
      }
    });
    popup.addEventListener('touchend', e=>{
      if(!dragging) return;
      dragging = false;
      popup.style.transition = '';
      const diff = (currentY||0) - (startY||0);
      if(diff>120){
        // close
        popup.classList.// soft delete: skip remove;
        backdrop.style.display='none';
      } else {
        popup.style.transform='';
        backdrop.style.background='';
      }
    });
  })();

  // initial render
  setTimeout(()=>{
    renderGroupsInSidebar().catch(()=>{});
    attachProfileToUsers();
    // also re-run periodically to catch dynamic list updates
    setInterval(()=>{ renderGroupsInSidebar().catch(()=>{}); attachProfileToUsers(); }, 2500);
  }, 1200);
})();

</script>

<script>
// ==== Compatibility & helpers (injected) ====
window.currentUser = window.currentUser || null;
(function(){
  // Local storage key helper (uses existing LOCAL_KEY if present)
  function getLocalKey(){
    try{ if(typeof LOCAL_KEY !== 'undefined' && LOCAL_KEY) return LOCAL_KEY; }catch(e){};
    return 'klass_messenger_v3_local';
  }

  // file -> dataURL
  if(typeof fileToDataURL === 'undefined'){
    window.fileToDataURL = async function(file){
      return new Promise((resolve, reject)=>{
        try{
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.onerror = err => reject(err);
          reader.readAsDataURL(file);
        }catch(e){ reject(e); }
      });
    };
  }

  // local storage helpers
  if(typeof loadLocal === 'undefined'){
    window.loadLocal = function(){
      try{
        const key = getLocalKey();
        const raw = localStorage.getItem(key);
        if(!raw) {
          // initialize default structure
          const init = { users:{}, groups:{}, chats:{} };
          localStorage.setItem(key, JSON.stringify(init));
          return init;
        }
        return JSON.parse(raw || '{}');
      }catch(e){
        console.error('loadLocal error', e);
        return { users:{}, groups:{}, chats:{} };
      }
    };
  }
  if(typeof saveLocal === 'undefined'){
    window.saveLocal = function(data){
      try{
        const key = getLocalKey();
        localStorage.setItem(key, JSON.stringify(data || { users:{}, groups:{}, chats:{} }));
      }catch(e){ console.error('saveLocal error', e); }
    };
  }

  // Ensure init local storage if empty
  try{
    const key = getLocalKey();
    if(!localStorage.getItem(key)){
      localStorage.setItem(key, JSON.stringify({ users:{}, groups:{}, chats:{} }));
    }
  }catch(e){ console.error('local init error', e); }

  // Safe service worker registration: only on http/https
  window.safeRegisterSW = async function(path='/sw_klass_messenger.js'){
    try{
      if(!('serviceWorker' in navigator)) return null;
      // only register on http(s) contexts (file:// or content:// won't work)
      if(!(location.protocol==='https:' || location.protocol==='http:')){
        console.warn('Service Worker not registered: unsupported protocol', location.protocol);
        return null;
      }
      const reg = await navigator.serviceWorker.register(path, {scope: '/'});
      console.log('SW registered safely', reg);
      return reg;
    }catch(e){
      console.warn('SW reg failed', e);
      return null;
    }
  };

  // Try to register on load (non-blocking)
  window.addEventListener('load', function(){
    try{ safeRegisterSW('/sw_klass_messenger.js').then(r=>{ window._swReg = r; }).catch(()=>{}); }catch(e){}
  });

})(); // end wrapper
</script>


<script>
// === FIX: –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —á–∞—Ç–∞ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ===
function openChatByUID(uid, name){
  try{
    if(typeof openChatFirebase === 'function' && window.db){
      modeSelect.value = 'pm';
      groupsSelect.style.display = 'none';
      openChatFirebase(uid, name);
    } else if(typeof openChatLocal === 'function'){
      modeSelect.value = 'pm';
      groupsSelect.style.display = 'none';
      openChatLocal(uid, name);
    }
    document.getElementById('chatTitle').textContent = name || '–ß–∞—Ç';
    const chatWindow = document.querySelector('.chat-window');
    if(chatWindow){ chatWindow.scrollIntoView({behavior:'smooth'}); }
  }catch(e){ console.error('openChatByUID error', e); }
}

// –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
setInterval(()=>{
  const list = document.getElementById('usersList');
  if(!list) return;
  Array.from(list.children).forEach(el=>{
    if(!el.dataset.fixed){
      el.dataset.fixed = '1';
      el.addEventListener('click', e=>{
        const strong = el.querySelector('strong');
        const small = el.querySelector('.small');
        const name = strong ? strong.textContent.trim() : '';
        const email = small ? small.textContent.trim() : '';
        if(window.db){
          import('https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js').then(dbMod=>{
            const { get, ref, query, orderByChild, equalTo } = dbMod;
            get(query(ref(db,'users'), orderByChild('email'), equalTo(email))).then(snap=>{
              const val = snap.val(); if(val){ const u = Object.values(val)[0]; openChatByUID(u.uid, u.displayName||u.email); }
            });
          });
        } else {
          const d = loadLocal();
          const u = Object.values(d.users||{}).find(x=>x.email===email);
          if(u) openChatByUID(u.uid, u.displayName||u.email);
        }
      });
    }
  });
}, 1500);
</script>


<!-- Image Lightbox -->
<div id="imgLightbox" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:9999;align-items:center;justify-content:center;">
  <img id="imgLightboxImg" src="" style="max-width:90%;max-height:90%;border-radius:10px;box-shadow:0 0 20px rgba(255,255,255,0.2)"/>
  <button id="imgLightboxClose" style="position:absolute;top:20px;right:30px;font-size:28px;color:#fff;background:none;border:none;cursor:pointer;">‚ùå</button>
</div>

<script>
(function(){
  const lb = document.getElementById('imgLightbox');
  const img = document.getElementById('imgLightboxImg');
  const closeBtn = document.getElementById('imgLightboxClose');
  if(!lb || !img || !closeBtn) return;

  function openLightbox(src){
    img.src = src;
    lb.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
  function closeLightbox(){
    lb.style.display = 'none';
    img.src = '';
    document.body.style.overflow = '';
  }
  closeBtn.onclick = closeLightbox;
  lb.addEventListener('click', e=>{ if(e.target === lb) closeLightbox(); });
  document.addEventListener('keydown', e=>{ if(e.key === 'Escape') closeLightbox(); });

  // –î–µ–ª–µ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–∏–Ω–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
  document.addEventListener('click', e=>{
    const target = e.target;
    if(target && target.classList && target.classList.contains('file-thumb')){
      e.preventDefault();
      openLightbox(target.src);
    }
  });
})();
</script>





<!-- Fix: Ensure action popup cancel/close works reliably -->
<script>
(function(){
  const backdrop = document.getElementById('actionPopupBackdrop');
  const popup = document.getElementById('actionPopup');
  const optCancel = document.getElementById('optCancel');
  // Helper to hide popup safely (idempotent)
  function hideActionPopup(){
    try{
      if(!popup || !backdrop) return;
      popup.classList.remove('show');
      popup.setAttribute('aria-hidden','true');
      backdrop.setAttribute('aria-hidden','true');
      // give transition time then hide backdrop
      setTimeout(()=>{ backdrop.style.display = 'none'; }, 280);
    }catch(e){ console.error('hideActionPopup error', e); }
  }
  // Attach handler to optCancel if present
  if(optCancel){
    optCancel.removeEventListener && optCancel.removeEventListener('click', hideActionPopup);
    optCancel.addEventListener('click', function(ev){
      ev.stopPropagation();
      hideActionPopup();
    }, false);
  }
  // Also ensure backdrop click hides popup when clicking outside popup
  if(backdrop){
    backdrop.addEventListener('click', function(e){
      if(e.target === backdrop) hideActionPopup();
    }, false);
  }
  // Also ensure Escape key hides popup
  document.addEventListener('keydown', function(e){
    if(e.key === 'Escape') hideActionPopup();
  }, false);
  // Expose function for other scripts if needed
  window.hideActionPopup = hideActionPopup;
})();
</script>





<!-- HARD DELETE PATCH -->
<script>
(function(){
  document.addEventListener('click', async e => {
    const btn = e.target;
    if(btn && btn.title === '–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ'){
      e.stopPropagation();
      const row = btn.closest('.msg-row');
      if(!row) return;
      if(!confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞–≤—Å–µ–≥–¥–∞?')) return;
      const bubble = row.querySelector('.bubble');
      try{
        const key = row.dataset.key || (row._meta && row._meta.key) || null;
        const chatPath = row.dataset.chatpath || (row._meta && row._meta.chatPath) || null;
        if(window.db && key && chatPath){
          try{
            const mod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js');
            const { ref, remove } = mod;
            await remove(ref(db, chatPath + '/' + key));
            row.remove();
            return;
          }catch(err){
            console.error('Firebase remove failed', err);
          }
        }
        // fallback –ª–æ–∫–∞–ª—å–Ω—ã–π
        if(bubble) bubble.textContent = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
        const meta = row._meta || {};
        const d = loadLocal();
        for(const cid of Object.keys(d.chats||{})){
          d.chats[cid] = (d.chats[cid]||[]).map(m => m.id===meta.id ? Object.assign({}, m, { deleted:true, text:'–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ' }) : m);
        }
        for(const gid of Object.keys(d.groups||{})){
          const g = d.groups[gid];
          if(g && g.messages) g.messages = g.messages.map(m => m.id===meta.id ? Object.assign({}, m, { deleted:true, text:'–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ' }) : m);
        }
        saveLocal(d);
      }catch(err){
        console.error('Hard delete handler failed', err);
        if(bubble) bubble.textContent = '–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ';
      }
    }
  }, true);
})();
</script>


<!-- REACTIONS PATCH -->
<style>
.reaction-btn {
  background:none;
  border:none;
  cursor:pointer;
  font-size:18px;
  margin-left:6px;
  opacity:0.7;
}
.reaction-btn:hover { opacity:1; }

.reaction-panel {
  position:absolute;
  display:flex;
  gap:8px;
  background:#222;
  padding:6px 10px;
  border-radius:20px;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s;
}
.reaction-panel.show {
  opacity:1;
  pointer-events:auto;
}
.reaction-option {
  font-size:22px;
  cursor:pointer;
  transition:transform .1s;
}
.reaction-option:hover {
  transform:scale(1.2);
}
.reactions-summary {
  font-size:14px;
  margin-top:2px;
  opacity:0.8;
}
</style>

<script>
(function(){
  const REACTIONS = ['üòÄ','‚ù§Ô∏è','üò¢','üëç','üëé'];
  let panel = null;
  let activeMsg = null;

  function createPanel(){
    panel = document.createElement('div');
    panel.className='reaction-panel';
    REACTIONS.forEach(r=>{
      const span = document.createElement('span');
      span.textContent=r;
      span.className='reaction-option';
      span.onclick=()=>selectReaction(r);
      panel.appendChild(span);
    });
    document.body.appendChild(panel);
    document.addEventListener('click', e=>{
      if(panel && !panel.contains(e.target)) hidePanel();
    });
  }

  function showPanel(btn){
    if(!panel) createPanel();
    const rect = btn.getBoundingClientRect();
    panel.style.top = (window.scrollY + rect.top - 45) + 'px';
    panel.style.left = (window.scrollX + rect.left - 10) + 'px';
    panel.classList.add('show');
    activeMsg = btn.closest('.msg-row');
  }

  function hidePanel(){
    if(panel) panel.classList.remove('show');
    activeMsg = null;
  }

  async function selectReaction(emoji){
    hidePanel();
    if(!activeMsg) return;
    const key = activeMsg.dataset.key || (activeMsg._meta && activeMsg._meta.key);
    const path = activeMsg.dataset.chatpath || (activeMsg._meta && activeMsg._meta.chatPath);
    if(!path || !key) return;
    try{
      if(window.db && window.currentUser){
        const mod = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js');
        const { ref, get, set, remove } = mod;
        const reactRef = ref(db, 'reactions/' + path.replace(/\//g,'_') + '/' + key + '/' + currentUser.uid);
        const snap = await get(reactRef);
        const val = snap.val();
        if(val === emoji){
          await remove(reactRef);
        }else{
          await set(reactRef, emoji);
        }
      } else {
        const d = loadLocal();
        const rid = path.replace(/\//g,'_');
        if(!d.reactions) d.reactions={};
        if(!d.reactions[rid]) d.reactions[rid]={};
        d.reactions[rid][key]=emoji;
        saveLocal(d);
      }
    }catch(e){ console.error('reaction failed', e); }
  }

  const origRenderMsg = window.renderMsg;
  window.renderMsg = function(m){
    origRenderMsg(m);
    const rows = document.querySelectorAll('.msg-row');
    const row = rows[rows.length-1];
    if(!row) return;
    const bubble = row.querySelector('.bubble');
    if(!bubble) return;

    const btn = document.createElement('button');
    btn.textContent='üòä';
    btn.className='reaction-btn';
    btn.onclick=(ev)=>{
      ev.stopPropagation();
      showPanel(btn);
    };
    bubble.appendChild(btn);

    const summary = document.createElement('div');
    summary.className='reactions-summary';
    bubble.appendChild(summary);

    if(window.db && m._path && m._key){
      import('https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js').then(mod=>{
        const { ref, onValue } = mod;
        const reactPath = 'reactions/' + m._path.replace(/\//g,'_') + '/' + m._key;
        onValue(ref(db, reactPath), snap=>{
          const v = snap.val()||{};
          const counts = {};
          Object.values(v).forEach(r=>{ counts[r]=(counts[r]||0)+1; });
          summary.innerHTML = Object.entries(counts).map(([emo,c])=> emo + (c>1?'√ó'+c:'' )).join(' ');
        });
      });
    }
  };
})();
</script>

</body>
</html>
